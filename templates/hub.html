<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ hub.name }} - Study Hub</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Lora:wght@400;600&display=swap" rel="stylesheet">
    
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
    <!-- NEW: Adding Lucide Icons for the edit buttons -->
    <script src="https://unpkg.com/lucide-react@0.292.0/dist/lucide-react.js"></script>

    <style>
        :root {
            --primary-color: #4f46e5;
            --primary-hover: #4338ca;
            --primary-light: #eef2ff;
            --danger-color: #ef4444;
            --danger-hover: #dc2626;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --text-main: #1f2937;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
            --background-body: #f4f5f7;
            --background-card: #ffffff;
            --background-sidebar: #f9fafb;
            --background-interactive-hover: #f3f4f6;
            --card-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.07), 0 2px 4px -2px rgb(0 0 0 / 0.07);
            --card-shadow-hover: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            --green: #10b981; --yellow: #f59e0b; --red: #ef4444;
            
            /* FullCalendar variables */
            --fc-border-color: var(--border-color);
            --fc-daygrid-event-dot-width: 8px;
            --fc-today-bg-color: rgba(79, 70, 229, 0.05);
            --fc-button-bg-color: var(--primary-color);
            --fc-button-active-bg-color: var(--primary-hover);
            --fc-button-hover-bg-color: var(--primary-hover);
            --fc-button-text-color: #fff;
            --fc-button-border-color: var(--primary-color);
        }

        html[data-theme="dark"] {
            --primary-color: #6366f1;
            --primary-hover: #4f46e5;
            --primary-light: #312e81;
            --danger-color: #f87171;
            --danger-hover: #ef4444;
            --text-main: #f9fafb;
            --text-secondary: #9ca3af;
            --border-color: #374151;
            --background-body: #111827;
            --background-card: #1f2937;
            --background-sidebar: #1f2937;
            --background-interactive-hover: #374151;
            --card-shadow: 0 0 0 1px rgba(255, 255, 255, 0.08);
            --card-shadow-hover: 0 0 0 1px rgba(255, 255, 255, 0.12);

            /* FullCalendar dark theme variables */
            --fc-border-color: var(--border-color);
            --fc-today-bg-color: rgba(99, 102, 241, 0.15);
            --fc-event-bg-color: var(--primary-light);
            --fc-event-border-color: var(--primary-color);
            --fc-button-bg-color: var(--primary-color);
            --fc-button-border-color: var(--primary-color);
        }
        
        body {
            font-family: 'Lora', serif;
            background-color: var(--background-body);
            margin: 0;
            padding: 2rem;
            color: var(--text-main);
            transition: background-color 0.3s, color 0.3s;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        h1, h2, h3, h4, h5, .button, .tab-button, .stat-label, .upload-form .file-upload-text {
            font-family: 'Poppins', sans-serif;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 2rem;
            align-items: start;
        }
        .button {
            display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;
            text-decoration: none; font-weight: 600; padding: 0.625rem 1rem;
            border-radius: 8px; border: 1px solid transparent;
            transition: all 0.2s ease-in-out; cursor: pointer; font-size: 0.9rem;
            outline: none;
        }
        .button:hover {
            transform: translateY(-2px);
            box-shadow: var(--card-shadow);
        }
        .button:disabled {
             background: var(--text-secondary) !important;
             border-color: var(--text-secondary) !important;
             cursor: not-allowed !important;
             transform: none !important;
             box-shadow: none !important;
             opacity: 0.7 !important;
        }
        .button-primary { background: linear-gradient(to right, #6366f1, var(--primary-color)); color: white; }
        .button-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(79, 70, 229, 0.3); }
        .button-secondary { background-color: var(--background-card); border-color: var(--border-color); color: var(--text-secondary); }
        .button-secondary:hover { background-color: var(--background-interactive-hover); color: var(--text-main); }
        .button-danger { background-color: var(--danger-color); color: white; }
        .button-danger:hover { background-color: var(--danger-hover); }
        
        .main-content {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }
        .content-card {
            background-color: var(--background-card);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            box-shadow: var(--card-shadow);
            padding: 1.5rem 2rem;
        }
        .page-header {
            display: flex; justify-content: space-between; align-items: center;
        }
        .page-header-left {
            display: flex; align-items: center; gap: 1rem; position: relative;
        }
        .page-header h1 { font-size: 1.875rem; font-weight: 700; margin: 0; }
        .progress-stats {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-top: 1.5rem;
        }
        .stat-item { text-align: center; }
        .stat-value {
            display: block;
            font-size: 2.75rem;
            font-weight: 700;
            color: var(--primary-color);
        }
        .stat-value.is-zero {
            color: var(--text-secondary);
            opacity: 0.6;
        }
        .stat-label { font-size: 0.9rem; color: var(--text-secondary); }
        
        .tabs-container { border-radius: 12px; box-shadow: var(--card-shadow); background-color: var(--background-card); border: 1px solid var(--border-color); }
        
        .tab-nav { 
            display: flex; 
            border-bottom: 1px solid var(--border-color); 
            padding: 0.5rem 2rem 0 2rem; 
            flex-wrap: nowrap;
            overflow-x: auto;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .tab-nav::-webkit-scrollbar {
            display: none;
        }

        .tab-button {
            padding: 1rem 0.5rem; margin-right: 1.5rem; margin-bottom: -1px; cursor: pointer; border: none; background: none; font-size: 1rem; font-weight: 600;
            color: var(--text-secondary); border-bottom: 2px solid transparent; transition: color 0.2s, border-color 0.2s;
            white-space: nowrap;
        }
        .tab-button.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
        .tab-content { display: none; padding: 1.5rem; }
        .tab-content.active { display: block; }
        .asset-list-header { display: flex; justify-content: space-between; align-items: center; padding: 0 0.5rem 1rem; border-bottom: 1px solid var(--border-color); margin-bottom: 1rem; }
        .select-all-container { display: flex; align-items: center; gap: 0.5rem; }
        .select-all-container label { font-weight: 500; cursor: pointer; }
        .asset-checkbox, .select-all-checkbox { width: 1.1rem; height: 1.1rem; accent-color: var(--primary-color); cursor: pointer;}
        .asset-list { list-style: none; padding: 0; margin: 0; }
        .asset-item { display: flex; align-items: center; gap: 1rem; padding: 0.5rem; border-radius: 8px; border: 1px solid transparent; transition: background-color 0.2s; }
        .asset-item:not(:last-child) { margin-bottom: 0.5rem; }
        .asset-item.selected { background-color: var(--primary-light); border-color: var(--primary-color); }
        .asset-link { display: flex; align-items: center; gap: 1rem; text-decoration: none; color: inherit; flex-grow: 1; }
        .asset-icon { flex-shrink: 0; width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; }
        .asset-icon-note { background-color: #e0e7ff; color: #4338ca; }
        .asset-icon-flashcards { background-color: #dcfce7; color: #166534; }
        .asset-icon-quiz { background-color: #fef9c3; color: #854d0e; }
        .asset-icon-session { background-color: #e0e7ff; color: #312e81; }
        .asset-details h5 { margin: 0 0 0.25rem 0; font-weight: 600; color: var(--text-main); }
        .asset-details span { font-size: 0.85rem; color: var(--text-secondary); }
        .asset-score { font-size: 1.1rem; font-weight: 700; color: var(--primary-color); padding: 0 1rem; }
        .asset-actions { display: flex; gap: 0.5rem; }
        .empty-state-text { text-align: center; padding: 2rem; color: var(--text-secondary); }
        .study-tools-container.disabled { pointer-events: none; user-select: none; }
        .study-tools-container.disabled .workflow-button, .study-tools-container.disabled .quick-tool-btn { opacity: 0.6; }

        /* NEW: Styles for in-place editing */
        .edit-btn {
            background: none; border: none; cursor: pointer; color: var(--text-secondary);
            opacity: 0.2; transition: opacity 0.2s; padding: 0.25rem;
            line-height: 1; /* Helps with alignment */
        }
        .asset-item:hover .edit-btn, .folder-header:hover .edit-btn { opacity: 1; }
        .edit-btn:hover { color: var(--primary-color); }
        .edit-container { display: flex; align-items: center; gap: 0.5rem; width: 100%; }
        .edit-container input {
            flex-grow: 1; padding: 0.25rem 0.5rem; font-size: 1.1rem; font-family: 'Poppins', sans-serif; font-weight: 600;
            border: 1px solid var(--primary-color); border-radius: 4px;
            background-color: var(--background-body); color: var(--text-main);
        }
        
        .workflow-grid { display: grid; grid-template-columns: 1fr; gap: 1.5rem; }
        .workflow-button { 
            border-radius: 12px; padding: calc(2rem - 2px); color: white; cursor: pointer; 
            border: 2px solid transparent; box-shadow: var(--card-shadow); text-align: left; 
            width: 100%; transition: box-shadow 0.3s ease, border-color 0.3s ease;
        }
        .workflow-button.session-btn { background: linear-gradient(135deg, #6366f1 0%, var(--primary-color) 100%); }
        .workflow-button.exam-btn { background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%); }
        .workflow-button.revision-btn { background: linear-gradient(135deg, #22c55e 0%, #10b981 100%); }
        
        a.workflow-button:hover:not(:disabled) {
            border-color: #a78bfa; 
            box-shadow: 0 0 12px 2px rgba(167, 139, 250, 0.5);
        }
        .workflow-button.session-btn:hover:not(:disabled) {
            border-color: #a78bfa;
            box-shadow: 0 0 12px 2px rgba(167, 139, 250, 0.5);
        }
        .workflow-button.exam-btn:hover:not(:disabled) {
            border-color: #fca5a5;
            box-shadow: 0 0 12px 2px rgba(252, 165, 165, 0.5);
        }
        .workflow-button.revision-btn:hover:not(:disabled) {
            border-color: #6ee7b7;
            box-shadow: 0 0 12px 2px rgba(110, 231, 183, 0.6);
        }

        .workflow-content { display: flex; align-items: center; justify-content: space-between; }
        .workflow-text { display: flex; align-items: center; gap: 1.5rem; }
        .workflow-button h4 { font-size: 1.75rem; font-weight: 700; margin: 0; }
        .workflow-button p { font-size: 1rem; margin: 0.5rem 0 0 0; opacity: 0.9; font-family: 'Poppins', sans-serif; }
        .workflow-arrow { font-size: 2rem; opacity: 0.7; }

        #study-tools-container {
            position: relative;
            overflow: hidden;
        }
        .workflow-page {
            width: 100%;
            transition: transform 0.5s cubic-bezier(0.45, 0, 0.55, 1), opacity 0.5s;
        }
        #tools-page-workflow-selection {
            position: absolute;
            top: 0; left: 0;
            transform: translateX(105%);
            opacity: 0;
            z-index: 10;
        }
        #study-tools-container.selection-active #tools-page-1,
        #study-tools-container.selection-active #tools-page-2 {
            transform: translateX(-105%);
            opacity: 0;
            position: absolute;
        }
        #study-tools-container.selection-active #tools-page-workflow-selection {
            transform: translateX(0);
            opacity: 1;
            position: relative;
        }
        #back-to-tools-btn {
            margin-bottom: 1.5rem;
        }
        #workflow-title {
            margin-top: 0;
            font-size: 1.75rem;
            font-weight: 700;
        }
        #workflow-options-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .checkbox-label {
            display: flex;
            align-items: center;
            padding: 1rem;
            background-color: var(--background-interactive-hover);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.2s;
        }
        .checkbox-label:hover {
            border-color: var(--primary-color);
            background-color: var(--primary-light);
        }
        .checkbox-label input {
            width: 1.2rem;
            height: 1.2rem;
            accent-color: var(--primary-color);
            margin-right: 1rem;
        }
        .checkbox-label span {
            font-weight: 500;
            font-family: 'Poppins', sans-serif;
        }
        #workflow-selection-form button[type="submit"] {
            padding: 0.75rem 2rem;
            font-size: 1rem;
        }

        .feature-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1.5rem; }
        .feature-card { background-color: var(--background-card); border: 1px solid var(--border-color); border-radius: 12px; padding: 1.5rem; text-align: left; cursor: pointer; display: flex; flex-direction: column; gap: 1rem; transition: all 0.2s; box-shadow: var(--card-shadow);}
        .feature-card:hover:not(:disabled) { transform: translateY(-5px) scale(1.02); box-shadow: var(--card-shadow-hover); border-color: var(--primary-color); }
        .feature-icon-wrapper { width: 48px; height: 48px; border-radius: 8px; display: flex; align-items: center; justify-content: center; }
        .feature-text h4 { margin: 0 0 0.25rem 0; font-size: 1.1rem; font-weight: 600; color: var(--text-main); }
        .feature-text p { margin: 0; font-size: 0.9rem; color: var(--text-secondary); line-height: 1.5; font-family: 'Poppins', sans-serif; }
        .feature-arrow { margin-top: auto; align-self: flex-end; font-size: 1.5rem; color: var(--text-secondary); transition: color 0.2s, transform 0.2s; }
        .feature-card:hover:not(:disabled) .feature-arrow { color: var(--primary-color); transform: translateX(4px); }
        .pro-label {
            font-size: 0.75rem;
            font-weight: bold;
            color: #854d0e;
            background-color: #fef9c3;
            padding: 0.1rem 0.5rem;
            border-radius: 99px;
            margin-left: 0.5rem;
        }
        
        .progress-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; }
        .progress-card { border-radius: 12px; padding: 1.5rem; color: white; position: relative; overflow: hidden; transition: transform 0.2s; box-shadow: var(--card-shadow); }
        .progress-card:hover { transform: translateY(-5px); box-shadow: var(--card-shadow-hover); }
        .progress-card h2 { font-size: 1rem; text-transform: uppercase; letter-spacing: 0.5px; margin: 0 0 0.5rem 0; opacity: 0.8; font-weight: 600; }
        .stat-large { font-size: 3rem; font-weight: 700; }
        .stat-large span { font-size: 1.25rem; font-weight: 500; opacity: 0.7; margin-left: 0.5rem; }
        .card-icon { position: absolute; right: 1rem; top: 1rem; opacity: 0.2; font-size: 3rem; }
        .xp-card { background: linear-gradient(135deg, #8b5cf6, #6366f1); }
        .streak-card { background: linear-gradient(135deg, #f59e0b, #ef4444); }
        .score-card { background: linear-gradient(135deg, #22c55e, #10b981); }
        .spotlight-card { background: linear-gradient(135deg, #0ea5e9, #2563eb); }
        .spotlight-card h2 { opacity: 1; font-weight: 600; }
        .spotlight-topic { font-size: 1.5rem; font-weight: 600; margin: 0.5rem 0; }
        .spotlight-topic-score { color: var(--red); font-weight: 700; background: white; padding: 0.1rem 0.5rem; border-radius: 6px; }
        .spotlight-topic-improvement { color: var(--green); font-weight: 700; background: white; padding: 0.1rem 0.5rem; border-radius: 6px; }
        .spotlight-card .button { background: rgba(255,255,255,0.2); color: white; margin-top: 1rem; border: 1px solid rgba(255,255,255,0.5); }
        .spotlight-card .button:hover { background: rgba(255,255,255,0.3); }
        .large-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
        .large-grid-card { background-color: var(--background-card); border-radius: 12px; padding: 1.5rem; box-shadow: var(--card-shadow); }
        .large-grid-card h2 { color: var(--text-main); font-size: 1.1rem; font-weight: 600; margin: 0 0 1.5rem 0;}
        .topic-list .topic-item { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; }
        .topic-name { font-weight: 600; }
        .topic-bar-container { flex-grow: 1; height: 10px; background-color: var(--background-interactive-hover); border-radius: 5px; margin: 0 1rem; overflow: hidden; }
        .topic-bar { height: 100%; border-radius: 5px; transition: width 0.5s ease-in-out; }
        .mastery-high { background-color: var(--green); }
        .mastery-mid { background-color: var(--yellow); }
        .mastery-low { background-color: var(--red); }
        .topic-score { font-weight: 700; font-size: 1.1rem; }
        .level-header { display: flex; justify-content: space-between; font-weight: 600; margin-bottom: 0.5rem; }
        .level-bar-container { width: 100%; height: 20px; background-color: var(--primary-light); border-radius: 10px; overflow: hidden; border: 1px solid var(--border-color); }
        .level-bar { height: 100%; border-radius: 10px; background: var(--primary-color); transition: width 0.5s ease-in-out; }
        .recent-activity-card p { margin: 0; font-weight: 500; font-family: 'Poppins', sans-serif;}
        .recent-activity-card strong { color: var(--text-main); }
        .recent-activity-card span { color: var(--text-secondary); }
        .files-panel { background-color: var(--background-card); border-radius: 12px; border: 1px solid var(--border-color); box-shadow: var(--card-shadow); padding: 1.5rem; position: sticky; top: 2rem; transition: opacity 0.3s ease; }
        .sidebar-section { margin-bottom: 2rem; } .sidebar-section:last-child { margin-bottom: 0; }
        .files-panel h3 { font-size: 1.125rem; margin: 0; }
        .file-list .file-item { display: flex; justify-content: space-between; align-items: center; padding: 0.625rem 0.5rem; border-radius: 8px; transition: background-color 0.2s; margin-bottom: 0.25rem; }
        .file-list .file-item:hover { background-color: var(--background-interactive-hover); }
        .file-item .file-info { display: flex; align-items: center; gap: 0.75rem; flex-grow: 1; cursor: pointer; overflow: hidden; }
        .file-info span { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .file-item input[type="checkbox"] { width: 1rem; height: 1rem; accent-color: var(--primary-color); flex-shrink: 0; }
        .delete-btn { background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 0.25rem; border-radius: 50%; display: inline-flex; transition: color 0.2s, background-color 0.2s; opacity: 0.5; flex-shrink: 0; }
        .file-item:hover .delete-btn { opacity: 1; }
        .delete-btn:hover { color: var(--danger-color); background-color: #fee2e2; }
        html[data-theme="dark"] .delete-btn:hover { background-color: var(--danger-hover); color: white; }
        .delete-btn svg { width: 16px; height: 16px; }
        .upload-form { margin-top: 1.5rem; }
        .upload-form .file-upload-wrapper { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 0.75rem; border: 2px dashed var(--border-color); border-radius: 8px; padding: 1.5rem 1rem; text-align: center; cursor: pointer; transition: border-color 0.2s, background-color 0.2s; }
        .upload-form .file-upload-wrapper:hover { border-color: var(--primary-color); background-color: var(--background-interactive-hover); }
        .upload-form input[type="file"] { display: none; }
        .upload-form .file-upload-text { color: var(--text-secondary); font-weight: 500; }
        .upload-form .upload-icon { color: var(--text-secondary); transition: color 0.2s; }
        .upload-form .file-upload-wrapper:hover .upload-icon { color: var(--primary-color); }
        .loading-card { display: flex; align-items: center; gap: 1.5rem; padding: 1.5rem; background-color: var(--primary-light); border: 1px solid var(--primary-color); border-radius: 12px; margin-bottom: 2rem; }
        .spinner { border: 4px solid rgba(79, 70, 229, 0.2); border-top: 4px solid var(--primary-color); border-radius: 50%; width: 32px; height: 32px; animation: spin 1s linear infinite; flex-shrink: 0; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading-text h4 { margin: 0 0 0.25rem 0; color: var(--text-main); }
        .loading-text p { margin: 0; color: var(--primary-color); }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(17, 24, 39, 0.8); backdrop-filter: blur(8px); display: none; justify-content: center; align-items: center; z-index: 1000; }
        
        .modal-content { background: var(--background-card); padding: 2rem; border-radius: 12px; width: 90%; max-height: 90vh; display: flex; flex-direction: column; }
        #add-items-modal .modal-content { max-width: 500px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; margin-bottom: 1.5rem; }
        .modal-header h3 { margin: 0; font-family: 'Poppins', sans-serif; }
        .close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-secondary); }
        .modal-body { overflow-y: auto; padding-right: 1rem; }
        .modal-footer { margin-top: 2rem; text-align: right; border-top: 1px solid var(--border-color); padding-top: 1.5rem; }
        .modal-body .form-group { margin-bottom: 1.25rem; }

        #schedule-event-modal .modal-content, #import-ics-modal .modal-content, #event-details-modal .modal-content {
            background-color: var(--background-card);
            border: 1px solid var(--border-color);
            max-width: 550px;
        }
        #schedule-event-modal .modal-header h3, #import-ics-modal .modal-header h3, #event-details-modal .modal-header h3 {
            color: var(--text-main);
        }
        #schedule-event-modal .modal-body label, #import-ics-modal .modal-body label {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--text-secondary);
            font-weight: 600;
            margin-bottom: 0.5rem;
            display: block;
        }
        #schedule-event-modal .modal-body input[type="text"],
        #schedule-event-modal .modal-body input[type="datetime-local"],
        #schedule-event-modal .modal-body select,
        #schedule-event-modal .modal-body textarea,
        #import-ics-modal .modal-body input[type="file"] {
            background-color: var(--background-interactive-hover);
            html[data-theme="dark"] & { background-color: #374151; }
            border: 1px solid var(--border-color);
            html[data-theme="dark"] & { border-color: #4b5563; }
            color: var(--text-main);
            width: 100%;
            padding: 0.75rem;
            border-radius: 6px;
            font-family: 'Poppins';
            font-size: 0.9rem;
            box-sizing: border-box;
        }
        #schedule-event-modal .modal-body input::placeholder,
        #schedule-event-modal .modal-body textarea::placeholder {
            color: var(--text-secondary);
        }
        #schedule-event-modal .modal-footer, #import-ics-modal .modal-footer {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 1rem;
        }
        #schedule-event-modal .modal-footer .close-btn, #import-ics-modal .modal-footer .close-btn {
            font-size: 0.9rem;
            font-weight: 600;
            padding: 0.625rem 1.25rem;
            background-color: transparent;
            color: var(--text-secondary);
            border: none;
        }
        #schedule-event-modal .modal-footer .close-btn:hover, #import-ics-modal .modal-footer .close-btn:hover {
            background-color: var(--background-interactive-hover);
            transform: none;
            box-shadow: none;
        }
        #schedule-event-modal .modal-footer .button-primary, #import-ics-modal .modal-footer .button-primary {
            padding: 0.625rem 1.25rem;
            background: var(--primary-color);
        }
        #modal-file-list {
            background-color: var(--background-interactive-hover);
            html[data-theme="dark"] & { background-color: #374151; }
            border: 1px solid var(--border-color);
            html[data-theme="dark"] & { border-color: #4b5563; }
            max-height: 150px;
            overflow-y: auto;
            border-radius: 6px;
            padding: 0.5rem;
        }
        .modal-file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem;
            border-radius: 4px;
        }
        .modal-file-item:hover {
             background-color: var(--background-card);
             html[data-theme="dark"] & { background-color: #4b5563; }
        }
        .modal-file-item label {
            font-size: 0.9rem;
            color: var(--text-main);
            text-transform: none;
            font-weight: 500;
            cursor: pointer;
        }

        .folder-accordion-item { border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 1rem; }
        .folder-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem; cursor: pointer; }
        .folder-header:hover { background-color: var(--background-interactive-hover); }
        .folder-header-title { display: flex; align-items: center; gap: 1rem; }
        .folder-header-title h5 { margin: 0; font-size: 1.1rem; }
        .folder-header-title span { font-size: 0.9rem; color: var(--text-secondary); }
        .folder-actions { display: flex; align-items: center; gap: 0.5rem; }
        .folder-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; background-color: #fdfdff; }
        html[data-theme="dark"] .folder-content { background-color: var(--background-body); }
        .folder-content.open { max-height: 1000px; transition: max-height 0.5s ease-in; }
        .folder-content .asset-list { padding: 1rem; border-top: 1px solid var(--border-color); }
        .folder-content .remove-item-btn { padding: 0.3rem 0.8rem; }

        .notification-bell {
            position: relative;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: background-color 0.2s;
        }
        .notification-bell:hover { background-color: var(--primary-light); }
        .notification-dot {
            position: absolute;
            top: 6px; right: 6px;
            width: 10px; height: 10px;
            background-color: var(--danger-color);
            border-radius: 50%;
            border: 2px solid var(--background-card);
            display: none;
        }
        .notification-dot.visible { display: block; }

        #notification-panel {
            display: none;
            position: absolute;
            top: 50px;
            left: 0;
            width: 350px;
            background-color: var(--background-card);
            border-radius: 8px;
            box-shadow: var(--card-shadow-hover);
            border: 1px solid var(--border-color);
            z-index: 100;
            max-height: 400px;
            overflow-y: auto;
        }
        #notification-panel.visible { display: block; }
        .notification-header {
            padding: 0.75rem 1rem;
            font-weight: 600;
            border-bottom: 1px solid var(--border-color);
        }
        .notification-list { list-style: none; padding: 0; margin: 0; }
        .notification-item {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color);
            display: block;
            text-decoration: none;
            color: var(--text-main);
        }
        .notification-item:last-child { border-bottom: none; }
        .notification-item:hover { background-color: var(--background-interactive-hover); }
        .notification-item p { margin: 0; font-size: 0.9rem; line-height: 1.4; font-family: 'Poppins', sans-serif;}
        .notification-item span { font-size: 0.75rem; color: var(--text-secondary); font-family: 'Poppins', sans-serif;}
        .notification-item.unread { background-color: var(--primary-light); }

        .theme-switch {
            display: inline-block;
            height: 34px;
            position: relative;
            width: 70px;
            cursor: pointer;
        }
        .theme-switch input { display:none; }
        .theme-switch .track {
            background: linear-gradient(to right, #89cff0, #b6d8f2);
            bottom: 0;
            left: 0;
            position: absolute;
            right: 0;
            top: 0;
            transition: .4s ease-in-out;
            border-radius: 34px;
            overflow: hidden;
        }
        .theme-switch .handle {
            background-color: #f9d71c;
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            transition: .4s ease-in-out;
            border-radius: 50%;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
            z-index: 2;
        }
        .theme-switch input:checked + .track {
            background: linear-gradient(to right, #000428, #004e92);
        }
        .theme-switch input:checked + .track .handle {
            transform: translateX(36px);
            background-color: #f5f3ce;
        }
        .theme-switch .track-elements {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
        }
        .theme-switch .cloud, .theme-switch .star {
            position: absolute;
            transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out;
        }
        .theme-switch .cloud {
            background-color: white;
            border-radius: 50%;
            opacity: 1;
        }
        .theme-switch .cloud.c1 { width: 15px; height: 10px; top: 8px; left: 35px; }
        .theme-switch .cloud.c2 { width: 10px; height: 8px; top: 15px; left: 45px; }
        .theme-switch .cloud.c3 { width: 12px; height: 9px; top: 6px; left: 55px; }
        .theme-switch .cloud:before, .theme-switch .cloud:after {
            content: '';
            position: absolute;
            background: white;
            border-radius: 50%;
        }
        .theme-switch .cloud.c1:before { width: 8px; height: 8px; top: -4px; left: 3px; }
        .theme-switch .cloud.c1:after { width: 10px; height: 10px; top: -2px; right: 2px; }
        .theme-switch .star {
            background-color: white;
            border-radius: 50%;
            opacity: 0;
            transform: scale(0.5);
        }
        .theme-switch .star.s1 { width: 2px; height: 2px; top: 8px; left: 10px; }
        .theme-switch .star.s2 { width: 3px; height: 3px; top: 18px; left: 20px; }
        .theme-switch .star.s3 { width: 2px; height: 2px; top: 10px; left: 30px; }
        .theme-switch .star.s4 { width: 1px; height: 1px; top: 20px; left: 5px; }
        .theme-switch input:checked + .track .cloud { opacity: 0; transform: translateX(-20px); }
        .theme-switch input:checked + .track .star { opacity: 1; transform: scale(1); }

        #calendar-container {
            padding: 0;
        }
        #fullcalendar {
            min-height: 700px;
            font-family: 'Poppins', sans-serif;
        }
        .fc-event {
            cursor: pointer;
            border: none !important;
            padding: 5px 8px;
            font-weight: 500;
        }
        .fc-daygrid-day.fc-day-today {
             background-color: var(--fc-today-bg-color) !important;
        }
        html[data-theme="dark"] .fc-daygrid-day-number, 
        html[data-theme="dark"] .fc-col-header-cell-cushion {
            color: var(--text-secondary);
        }
        html[data-theme="dark"] .fc-button {
            background-color: #374151 !important;
            border-color: #4b5563 !important;
            color: var(--text-main) !important;
        }
        html[data-theme="dark"] .fc-button-primary:not(:disabled).fc-button-active {
            background-color: var(--primary-color) !important;
            border-color: var(--primary-color) !important;
        }
        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 1rem;
        }
        .sidebar-header h3 {
            padding-bottom: 0;
            border-bottom: none;
            margin-bottom: 0;
        }
        .sidebar-actions {
            display: flex;
            gap: 0.5rem;
        }
        #event-details-modal .modal-body p {
            margin: 0.5rem 0 1.5rem 0;
            line-height: 1.6;
            color: var(--text-secondary);
        }
        #event-details-modal .modal-body strong {
            display: block;
            font-size: 0.8rem;
            color: var(--text-main);
            font-weight: 600;
            text-transform: uppercase;
        }
        #event-details-modal .event-type-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.8rem;
            font-weight: 600;
            color: white;
            margin-left: 1rem;
        }
    </style>
    <script>
        (function() {
            const theme = localStorage.getItem('theme');
            if (theme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
            }
        })();
    </script>
</head>
<body>
    <div class="container">
        <main class="main-content">
            <div class="content-card">
                <div class="page-header">
                    <div class="page-header-left">
                        <h1>{{ hub.name }}</h1>
                        <div class="notification-bell" id="notification-bell">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
                            <div class="notification-dot {% if unread_notifications_count > 0 %}visible{% endif %}" id="notification-dot"></div>
                        </div>
                        <div id="notification-panel">
                            <div class="notification-header">Notifications</div>
                            <ul class="notification-list">
                                {% for notification in notifications %}
                                <a href="{{ notification.link }}" class="notification-item {% if not notification.read %}unread{% endif %}" data-id="{{ notification.id }}">
                                    <p>{{ notification.message }}</p>
                                    <span>{{ notification.created_at|timesince }} ago</span>
                                </a>
                                {% else %}
                                <li style="padding: 1rem; text-align: center; color: var(--text-secondary);">No new notifications.</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 1.5rem;">
                         <label class="theme-switch" for="theme-toggle">
                            <input type="checkbox" id="theme-toggle" />
                            <div class="track">
                                <div class="handle"></div>
                                <div class="track-elements">
                                    <div class="cloud c1"></div><div class="cloud c2"></div><div class="cloud c3"></div>
                                    <div class="star s1"></div><div class="star s2"></div><div class="star s3"></div><div class="star s4"></div>
                                </div>
                            </div>
                        </label>
                        <a href="{{ url_for('dashboard') }}" class="button button-secondary">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
                            Dashboard
                        </a>
                    </div>
                </div>
                <div class="progress-stats">
                    <div class="stat-item">
                        <span class="stat-value {% if hub.notes_count == 0 %}is-zero{% endif %}">{{ hub.notes_count or 0 }}</span>
                        <span class="stat-label">Notes Saved</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value {% if hub.flashcard_count == 0 %}is-zero{% endif %}">{{ hub.flashcard_count or 0 }}</span>
                        <span class="stat-label">Flashcards</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value {% if hub.quizzes_taken == 0 %}is-zero{% endif %}">{{ hub.quizzes_taken or 0 }}</span>
                        <span class="stat-label">Quizzes Taken</span>
                    </div>
                </div>
            </div>

            <div id="loading-status-container"></div>

            <div class="tabs-container">
                <div class="tab-nav">
                    <button class="tab-button active" onclick="openTab(event, 'tools')">Study Tools</button>
                    <button class="tab-button" onclick="openTab(event, 'progress')">Progress</button>
                    <button class="tab-button" onclick="openTab(event, 'calendar')">Calendar</button>
                    <button class="tab-button" onclick="openTab(event, 'sessions')">My Sessions</button>
                    <button class="tab-button" onclick="openTab(event, 'folders')">My Folders</button>
                    <button class="tab-button" onclick="openTab(event, 'notes')">My Notes</button>
                    <button class="tab-button" onclick="openTab(event, 'flashcards')">My Flashcards</button>
                    <button class="tab-button" onclick="openTab(event, 'quizzes')">My Quizzes</button>
                </div>
                
                <div id="tools" class="tab-content active">
                    <div id="study-tools-container" class="study-tools-container">
                        
                        <div id="tools-page-1" class="workflow-page">
                            <div class="workflow-grid">
                                
                                <a href="{{ url_for('start_assignment', hub_id=hub.id) }}" class="workflow-button" style="background: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%);">
                                    <div class="workflow-content">
                                        <div class="workflow-text">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25zM6.75 12h.008v.008H6.75V12zm0 3h.008v.008H6.75V15zm0 3h.008v.008H6.75V18z" /></svg>
                                            <div><h4>Complete Your Assignment <span class="pro-label">PRO</span></h4><p>Turn your brief and sources into a first draft.</p></div>
                                        </div>
                                        <span class="workflow-arrow">→</span>
                                    </div>
                                </a>

                                <form action="{{ url_for('setup_session', hub_id=hub.id) }}" method="POST" class="workflow-form">
                                    <button type="submit" class="workflow-button session-btn">
                                        <div class="workflow-content">
                                            <div class="workflow-text">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.59 14.37a6 6 0 01-5.84 7.38v-4.8m5.84-2.58a14.98 14.98 0 006.16-12.12A14.98 14.98 0 009.63 2.18a14.98 14.98 0 00-5.84 7.38m5.84 2.58a14.98 14.98 0 017.38 5.84m-7.38-5.84l-2.58 5.84m2.58-5.84l5.84 2.58m-5.84-2.58l5.84-2.58m-5.84-2.58l-5.84 2.58m-2.58 5.84A14.98 14.98 0 002.18 9.63a14.98 14.98 0 007.38-5.84m-7.38 5.84l2.58-5.84" /></svg>
                                                <div><h4>Start Interactive Session <span class="pro-label">PRO</span></h4><p>Let AI guide you through a personalized study walkthrough.</p></div>
                                            </div>
                                            <span class="workflow-arrow">→</span>
                                        </div>
                                    </button>
                                </form>

                                <button type="button" id="exam-prep-btn" class="workflow-button exam-btn">
                                    <div class="workflow-content">
                                        <div class="workflow-text">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                                            <div><h4>Get Exam Ready <span class="pro-label">PRO</span></h4><p>Generate quizzes, cheat sheets, and more.</p></div>
                                        </div>
                                        <span class="workflow-arrow">→</span>
                                    </div>
                                </button>
                                
                                <button type="button" id="revision-btn" class="workflow-button revision-btn">
                                    <div class="workflow-content">
                                        <div class="workflow-text">
                                             <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
                                            <div><h4>Make Revision Resources</h4><p>Create notes and flashcard decks.</p></div>
                                        </div>
                                        <span class="workflow-arrow">→</span>
                                    </div>
                                </button>
                            </div>
                            <div style="text-align: center; margin-top: 2rem;">
                                <button id="show-page-2-btn" class="button button-secondary">Show All Individual Tools ↓</button>
                            </div>
                        </div>

                        <div id="tools-page-workflow-selection" class="workflow-page">
                            <button id="back-to-tools-btn" class="button button-secondary">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
                                Back
                            </button>
                            <h3 id="workflow-title"></h3>
                            <p style="color: var(--text-secondary); margin-top: 0;">Select the resources you want to create. They will be added to a new folder in 'My Folders'.</p>
                            <form id="workflow-selection-form">
                                <div id="workflow-options-container">
                                    </div>
                                <input type="hidden" name="workflow_type" id="workflow-type-input">
                                <button type="submit" class="button button-primary">Generate Folder</button>
                            </form>
                        </div>

                        <div id="tools-page-2" class="workflow-page" style="display: none;">
                            <div class="feature-grid">
                                <button type="button" class="feature-card quick-tool-btn" value="notes">
                                    <div class="feature-icon-wrapper" style="background-color: #e0e7ff;"><svg style="color: #4338ca;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg></div>
                                    <div class="feature-text"><h4>Quick Notes</h4><p>Generate static notes to save or print.</p></div>
                                    <span class="feature-arrow">→</span>
                                </button>
                                <button type="button" class="feature-card quick-tool-btn" value="flashcards">
                                    <div class="feature-icon-wrapper" style="background-color: #dcfce7;"><svg style="color: #166534;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="15" rx="2" ry="2"></rect><polyline points="17 2 12 7 7 2"></polyline></svg></div>
                                    <div class="feature-text"><h4>Quick Flashcards</h4><p>Generate a set of flashcards to study.</p></div>
                                    <span class="feature-arrow">→</span>
                                </button>
                                <button type="button" class="feature-card quick-tool-btn" value="quiz">
                                    <div class="feature-icon-wrapper" style="background-color: #fef9c3;"><svg style="color: #854d0e;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"></path><path d="m9 12 2 2 4-4"></path></svg></div>
                                    <div class="feature-text"><h4>Generate Quiz <span class="pro-label">PRO</span></h4><p>Test your knowledge with practice questions.</p></div>
                                    <span class="feature-arrow">→</span>
                                </button>
                                <button type="button" class="feature-card quick-tool-btn" value="cheatsheet">
                                    <div class="feature-icon-wrapper" style="background-color: #fecaca; color: #991b1b;"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75l3 3m0 0l3-3m-3 3v-7.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div>
                                    <div class="feature-text"><h4>Cheat Sheet <span class="pro-label">PRO</span></h4><p>Create a dense, one-page summary.</p></div>
                                    <span class="feature-arrow">→</span>
                                </button>
                                <button type="button" class="feature-card quick-tool-btn" value="analyse">
                                    <div class="feature-icon-wrapper" style="background-color: #e0f2fe;"><svg style="color: #0369a1;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"></path><path d="M18.7 8.7l-7.2 7.2-2.5-2.5L3 17"></path></svg></div>
                                    <div class="feature-text"><h4>Exam Predictor <span class="pro-label">PRO</span></h4><p>Generate a full report outlining likely topics using past papers.</p></div>
                                    <span class="feature-arrow">→</span>
                                </button>
                            </div>
                             <div style="text-align: center; margin-top: 2rem;">
                                <button id="show-page-1-btn" class="button button-secondary">↑ Back to Main Workflows</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="calendar" class="tab-content">
                    <div id="calendar-container">
                        <div id="fullcalendar"></div>
                    </div>
                </div>
                
                <div id="progress" class="tab-content">
                    <div class="progress-grid">
                        <div class="progress-card xp-card"><div class="card-icon">🏆</div><h2>Total XP</h2><div class="stat-large">{{ total_xp }} <span>XP</span></div></div>
                        <div class="progress-card streak-card"><div class="card-icon">🔥</div><h2>Study Streak</h2><div class="stat-large">{{ streak_days }} <span>Days</span></div></div>
                        <div class="progress-card score-card"><div class="card-icon">🎯</div><h2>Average Score</h2><div class="stat-large">{{ (topic_mastery | map(attribute='score') | sum / (topic_mastery | length if (topic_mastery | length) > 0 else 1)) | round(0) | int }}<span>%</span></div></div>
                    </div>
                    <div style="margin-top: 1.5rem; display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem; align-items: start;">
                        <div class="progress-card spotlight-card">
                            {% if spotlight %}
                                {% if spotlight.type == 'weakest' %}{% set topic_str = spotlight.topic|string %}{% set hub_id_str = hub.id|string %}<h2>Weakness Spotlight</h2><p class="spotlight-topic">{{ spotlight.topic }} <span class="spotlight-topic-score">{{ spotlight.score }}%</span></p><a href="{{ url_for('generate_weakness_quiz', hub_id=hub_id_str, topic=topic_str) }}" class="button">5-Question Quiz Now</a>
                                {% elif spotlight.type == 'improved' %}<h2>Most Improved!</h2><p class="spotlight-topic">{{ spotlight.topic }} <span class="spotlight-topic-improvement">+{{ spotlight.change }}%</span></p><p style="opacity: 0.8; margin-top: 1rem;">Great work! Keep up the momentum.</p>
                                {% elif spotlight.type == 'recommend' %}{% set topic_str = spotlight.topic|string %}{% set hub_id_str = hub.id|string %}<h2>Time to Review</h2><p class="spotlight-topic">{{ spotlight.topic }}</p><a href="{{ url_for('generate_weakness_quiz', hub_id=hub_id_str, topic=topic_str) }}" class="button">Review with a Quiz</a>
                                {% endif %}
                            {% else %}<h2>Study Tip</h2><p>Complete a few more quizzes to unlock personalized recommendations!</p>{% endif %}
                        </div>
                        <div class="large-grid-card recent-activity-card">
                            <h2>Recent Activity</h2>
                            <p><strong>Today:</strong> <span>You've earned +{{ today_xp }} XP.</span></p>
                            <p style="margin-top: 1rem;"><strong>Yesterday:</strong><span>{% if yesterday_activities.quizzes > 0 or yesterday_activities.flashcards > 0 %}Completed {% if yesterday_activities.quizzes > 0 %}{{ yesterday_activities.quizzes }} quiz(zes){% endif %}{% if yesterday_activities.quizzes > 0 and yesterday_activities.flashcards > 0 %} and {% endif %}{% if yesterday_activities.flashcards > 0 %}{{ yesterday_activities.flashcards }} flashcard session(s).{% endif %}{% else %}No activity recorded.{% endif %}</span></p>
                        </div>
                    </div>
                    <div class="large-grid" style="margin-top: 1.5rem;">
                        <div class="large-grid-card">
                            <h2>Topic Mastery</h2>
                            <div class="topic-list">
                                {% for item in topic_mastery %}<div class="topic-item"><span class="topic-name">{{ item.topic }}</span><div class="topic-bar-container"><div class="topic-bar {{ 'mastery-high' if item.score >= 80 else 'mastery-mid' if item.score >= 50 else 'mastery-low' }}" style="width: {{ item.score }}%;"></div></div><span class="topic-score">{{ item.score }}%</span></div>{% else %}<p class="empty-state-text">Complete quizzes to see your topic mastery breakdown!</p>{% endfor %}
                            </div>
                        </div>
                        <div class="large-grid-card">
                             <h2>Level Progress</h2>
                             {% if level_data %}<div class="level-header"><span>Level {{ level_data.current_level }} Scholar</span><span>{{ level_data.xp_in_level }} / {{ level_data.xp_for_next_level }} XP</span></div><div class="level-bar-container"><div class="level-bar" style="width: {{ (level_data.xp_in_level / level_data.xp_for_next_level) * 100 }}%;"></div></div>{% else %}<p class="empty-state-text">Start studying to gain XP and level up!</p>{% endif %}
                        </div>
                    </div>
                </div>

                <div id="sessions" class="tab-content">
                    <div class="asset-list-header">
                        <div class="select-all-container"><input type="checkbox" class="select-all-checkbox" id="select-all-sessions"><label for="select-all-sessions">Select All</label></div>
                        <button class="button button-danger delete-selected-btn" style="display: none;">Delete Selected</button>
                    </div>
                    <ul class="asset-list">
                        {% for session in all_sessions %}
                        <li class="asset-item" data-id="{{ session.id }}" data-type="session">
                            <input type="checkbox" class="asset-checkbox">
                            <a href="{{ url_for('session_report', session_id=session.id) }}" class="asset-link">
                                <div class="asset-icon asset-icon-session"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15.59 14.37a6 6 0 01-5.84 7.38v-4.8m5.84-2.58a14.98 14.98 0 006.16-12.12A14.98 14.98 0 009.63 2.18a14.98 14.98 0 00-5.84 7.38m5.84 2.58a14.98 14.98 0 017.38 5.84"/></svg></div>
                                <div class="asset-details"><h5 class="asset-title">{{ session.title }}</h5><span>Completed {{ session.created_at|timesince }} ago</span></div>
                            </a>
                        </li>
                        {% else %}
                        <li class="empty-state-text"><p>No sessions yet.</p></li>
                        {% endfor %}
                    </ul>
                </div>
                
                <div id="folders" class="tab-content">
                    <div class="content-card" style="margin-bottom: 2rem; padding: 1.5rem;">
                        <form action="{{ url_for('create_folder', hub_id=hub.id) }}" method="POST">
                            <h4 style="margin-top:0; margin-bottom: 1rem;">Create a New Folder</h4>
                            <div style="display: flex; gap: 1rem;">
                                <input type="text" name="folder_name" placeholder="e.g., Midterm Review" required style="flex-grow:1; padding: 0.5rem; border-radius: 6px; border: 1px solid var(--border-color); background-color: var(--background-body); color: var(--text-main);">
                                <button type="submit" class="button button-primary">Create</button>
                            </div>
                        </form>
                    </div>
                    <div id="folder-accordion-container">
                        {% for folder in all_folders %}
                        <div class="folder-accordion-item" data-id="{{ folder.id }}" data-type="folder">
                            <div class="folder-header" data-folder-id="{{ folder.id }}">
                                <div class="folder-header-title">
                                    <div class="asset-icon" style="background-color: #fefce8; color: #a16207;"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.75V12A2.25 2.25 0 014.5 9.75h15A2.25 2.25 0 0121.75 12v.75m-8.69-6.44l-2.12-2.12a1.5 1.5 0 00-1.061-.44H4.5A2.25 2.25 0 002.25 6v12a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9a2.25 2.25 0 00-2.25-2.25h-5.379a1.5 1.5 0 01-1.06-.44z" /></svg></div>
                                    <div>
                                        <h5 class="asset-title">{{ folder.name }}</h5>
                                        <span>{{ folder.hydrated_items|length }} items</span>
                                    </div>
                                </div>
                                <div class="folder-actions">
                                    <button class="button button-secondary add-items-to-folder-btn">Add Items</button>
                                    <button class="button edit-btn" title="Edit folder name"><i data-lucide="pencil" size="16"></i></button>
                                    <button class="button button-danger delete-folder-btn">Delete</button>
                                </div>
                            </div>
                            <div class="folder-content">
                                <ul class="asset-list">
                                    {% for item in folder.hydrated_items %}
                                    <li class="asset-item" data-id="{{ item.id }}" data-type="{{ item.type.lower() if item.type else 'note' }}">
                                        {% set item_type = item.type.lower() if item.type else 'note' %}
                                        {% if item_type == 'note' %}
                                        <a href="{{ url_for('view_note', note_id=item.id) }}" class="asset-link">
                                            <div class="asset-icon asset-icon-note"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg></div>
                                            <div class="asset-details"><h5 class="asset-title">{{ item.title }}</h5><span>Note</span></div>
                                        </a>
                                        {% elif item_type == 'quiz' %}
                                            {% if item.status == 'graded' %}
                                                <a href="{{ url_for('quiz_results', activity_id=item.id) }}" class="asset-link">
                                                    <div class="asset-icon asset-icon-quiz"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"></path><path d="m9 12 2 2 4-4"></path></svg></div>
                                                    <div class="asset-details"><h5 class="asset-title">{{ item.title }}</h5><span>Quiz ({{ item.score }}%)</span></div>
                                                </a>
                                            {% else %}
                                                 <a href="{{ url_for('take_lecture_quiz', activity_id=item.id) }}" class="asset-link">
                                                    <div class="asset-icon asset-icon-quiz"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"></path><path d="m9 12 2 2 4-4"></path></svg></div>
                                                    <div class="asset-details"><h5 class="asset-title">{{ item.title }}</h5><span>Quiz (Not Taken)</span></div>
                                                </a>
                                            {% endif %}
                                        {% elif item_type == 'flashcards' %}
                                        <a href="{{ url_for('edit_flashcard_set', activity_id=item.id) }}" class="asset-link">
                                           <div class="asset-icon asset-icon-flashcards"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="15" rx="2" ry="2"></rect><polyline points="17 2 12 7 7 2"></polyline></svg></div>
                                           <div class="asset-details"><h5 class="asset-title">{{ item.title }}</h5><span>Flashcards</span></div>
                                        </a>
                                        {% endif %}
                                        <button class="button button-danger remove-item-btn">Remove</button>
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                        {% else %}
                        <p class="empty-state-text">You haven't created any folders yet.</p>
                        {% endfor %}
                    </div>
                </div>

                <div id="notes" class="tab-content">
                    <div class="asset-list-header">
                        <div class="select-all-container"><input type="checkbox" class="select-all-checkbox" id="select-all-notes"><label for="select-all-notes">Select All</label></div>
                        <button class="button button-danger delete-selected-btn" style="display: none;">Delete Selected</button>
                    </div>
                    <ul class="asset-list">
                        {% for note in all_notes %}
                        <li class="asset-item" data-id="{{ note.id }}" data-type="note">
                            <input type="checkbox" class="asset-checkbox">
                            <a href="{{ url_for('view_note', note_id=note.id) }}" class="asset-link">
                                <div class="asset-icon asset-icon-note"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg></div>
                                <div class="asset-details"><h5 class="asset-title">{{ note.title }}</h5><span>Created {{ note.created_at|timesince }} ago</span></div>
                            </a>
                            <button class="button edit-btn" title="Edit note title"><i data-lucide="pencil" size="16"></i></button>
                        </li>
                        {% else %}
                        <li class="empty-state-text"><p>You haven't generated any notes yet.</p></li>
                        {% endfor %}
                    </ul>
                </div>
                <div id="flashcards" class="tab-content">
                     <div class="asset-list-header">
                        <div class="select-all-container"><input type="checkbox" class="select-all-checkbox" id="select-all-flashcards"><label for="select-all-flashcards">Select All</label></div>
                        <button class="button button-danger delete-selected-btn" style="display: none;">Delete Selected</button>
                    </div>
                    <ul class="asset-list">
                        {% for card_set in all_flashcards %}
                        <li class="asset-item" data-id="{{ card_set.id }}" data-type="flashcards">
                             <input type="checkbox" class="asset-checkbox">
                            <a href="{{ url_for('edit_flashcard_set', activity_id=card_set.id) }}" class="asset-link">
                                <div class="asset-icon asset-icon-flashcards"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="15" rx="2" ry="2"></rect><polyline points="17 2 12 7 7 2"></polyline></svg></div>
                                <div class="asset-details"><h5 class="asset-title">{{ card_set.title or 'Flashcard Set' }}</h5><span>Created {{ card_set.created_at|timesince }} ago</span></div>
                            </a>
                             <button class="button edit-btn" title="Edit flashcard set title"><i data-lucide="pencil" size="16"></i></button>
                        </li>
                        {% else %}
                        <li class="empty-state-text"><p>You haven't generated any flashcards yet.</p></li>
                        {% endfor %}
                    </ul>
                </div>
                
                <div id="quizzes" class="tab-content">
                    <div class="asset-list-header">
                        <div class="select-all-container"><input type="checkbox" class="select-all-checkbox" id="select-all-quizzes"><label for="select-all-quizzes">Select All</label></div>
                        <button class="button button-danger delete-selected-btn" style="display: none;">Delete Selected</button>
                    </div>
                    <ul class="asset-list">
                        {% for quiz in all_quizzes_and_exams %}
                        <li class="asset-item" data-id="{{ quiz.id }}" data-type="quiz">
                            <input type="checkbox" class="asset-checkbox">
                            {% if quiz.status == 'graded' %}
                                <a href="{{ url_for('quiz_results', activity_id=quiz.id) }}" class="asset-link">
                                    <div class="asset-icon asset-icon-quiz"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"></path><path d="m9 12 2 2 4-4"></path></svg></div>
                                    <div class="asset-details"><h5 class="asset-title">{{ quiz.title or quiz.type }}</h5><span>Completed {{ quiz.created_at|timesince }} ago</span></div>
                                </a>
                                <div class="asset-score"><span>{{ quiz.score }}%</span></div>
                            {% else %}
                                <a href="{{ url_for('take_lecture_quiz', activity_id=quiz.id) }}" class="asset-link">
                                    <div class="asset-icon asset-icon-quiz"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"></path><path d="m9 12 2 2 4-4"></path></svg></div>
                                    <div class="asset-details"><h5 class="asset-title">{{ quiz.title or quiz.type }}</h5><span>Ready to take</span></div>
                                </a>
                                <a href="{{ url_for('take_lecture_quiz', activity_id=quiz.id) }}" class="button button-primary" style="padding: 0.5rem 1rem;">Take Quiz</a>
                            {% endif %}
                             <button class="button edit-btn" title="Edit quiz title"><i data-lucide="pencil" size="16"></i></button>
                        </li>
                        {% else %}
                        <li class="empty-state-text"><p>You haven't completed any quizzes yet.</p></li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </main>
        
        <aside class="files-panel" id="files-panel-sidebar">
            <div class="sidebar-section">
                <div class="sidebar-header">
                    <h3>Documents</h3>
                </div>
                <form id="tools-form">
                    <div class="file-list">
                        {% for file in hub.files %}
                        <div class="file-item">
                            <label class="file-info" for="file-{{ loop.index }}">
                                <input type="checkbox" class="file-checkbox" name="selected_files" value="{{ file.path }}" id="file-{{ loop.index }}" data-filename="{{ file.name }}">
                                <span class="file-icon"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg></span>
                                <span>{{ file.name }}</span>
                            </label>
                            <a href="{{ url_for('delete_file', hub_id=hub.id, file_path=file.path) }}" class="delete-btn" title="Delete file" onclick="return confirm('Are you sure you want to delete this file?');">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                            </a>
                        </div>
                        {% else %}
                        <p style="color: var(--text-secondary); text-align: center; padding: 1rem 0;">Upload a PDF to begin.</p>
                        {% endfor %}
                    </div>
                </form>
                <form class="upload-form" action="{{ url_for('upload_file', hub_id=hub.id) }}" method="POST" enctype="multipart/form-data">
                    <label for="pdf-upload" class="file-upload-wrapper">
                        <span class="upload-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg></span>
                        <span class="file-upload-text">Click or drag to upload</span>
                    </label>
                    <input id="pdf-upload" type="file" name="pdf" accept=".pdf" required onchange="this.form.submit()">
                </form>
            </div>
            
            <div class="sidebar-section">
                <div class="sidebar-header">
                    <h3>My Schedule</h3>
                    <div class="sidebar-actions">
                        <button id="show-import-modal-btn" class="button button-secondary" style="padding: 0.4rem 0.8rem; font-size: 0.8rem;">Import</button>
                        <button id="show-schedule-modal-btn" class="button button-secondary" style="padding: 0.4rem 0.8rem; font-size: 0.8rem;">+ Schedule</button>
                    </div>
                </div>
                <p style="font-size: 0.9rem; color: var(--text-secondary); margin-top: -0.5rem; line-height: 1.5;">View and manage your events in the "Calendar" tab.</p>
            </div>

        </aside>
    </div>

    <div class="modal-overlay" id="add-items-modal">
        <div class="modal-content">
            <div class="modal-header"><h3>Add Items to Folder</h3><button class="close-btn">&times;</button></div>
            <div class="modal-body">
                {% if all_notes %}<h4>Notes</h4><ul class="asset-list">{% for note in all_notes %}<li class="asset-item"><label style="display:flex;width:100%;cursor:pointer;"><input type="checkbox" data-id="{{ note.id }}" data-type="note" style="margin-right:1rem;"> {{ note.title }}</label></li>{% endfor %}</ul>{% endif %}
                {% if all_quizzes_and_exams %}<h4>Quizzes</h4><ul class="asset-list">{% for quiz in all_quizzes_and_exams %}<li class="asset-item"><label style="display:flex;width:100%;cursor:pointer;"><input type="checkbox" data-id="{{ quiz.id }}" data-type="quiz" style="margin-right:1rem;"> {{ quiz.title }}</label></li>{% endfor %}</ul>{% endif %}
                {% if all_flashcards %}<h4>Flashcards</h4><ul class="asset-list">{% for fc in all_flashcards %}<li class="asset-item"><label style="display:flex;width:100%;cursor:pointer;"><input type="checkbox" data-id="{{ fc.id }}" data-type="flashcards" style="margin-right:1rem;"> {{ fc.title }}</label></li>{% endfor %}</ul>{% endif %}
            </div>
            <div class="modal-footer"><button class="button button-secondary close-btn">Cancel</button><button class="button button-primary" id="save-added-items-btn">Add Selected Items</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="schedule-event-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Schedule a New Session</h3>
                <button class="close-btn">&times;</button>
            </div>
            <form id="schedule-event-form">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="event-title">Event Title</label>
                        <input type="text" id="event-title" name="title" placeholder="e.g., Mid-term revision" required>
                    </div>
                    <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <label for="event-type">Type</label>
                            <select id="event-type" name="event_type">
                                <option>Study Session</option>
                                <option>Mock Exam</option>
                                <option>Flashcard Review</option>
                                <option>Draft Review</option>
                                <option>Custom</option>
                            </select>
                        </div>
                        <div>
                            <label for="event-duration">Duration (minutes)</label>
                            <select id="event-duration" name="duration">
                                <option value="20">20 mins</option>
                                <option value="40" selected>40 mins</option>
                                <option value="60">60 mins</option>
                                <option value="90">90 mins</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="event-start-time">Start Time</label>
                        <input type="datetime-local" id="event-start-time" name="start_time" required>
                    </div>
                    <div class="form-group">
                        <label for="event-focus">Focus / Goal</label>
                        <textarea id="event-focus" name="focus" rows="3" placeholder="e.g., Review weak topics from last quiz"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Source Files (Optional)</label>
                        <div id="modal-file-list">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="button button-secondary close-btn">Cancel</button>
                    <button type="submit" class="button button-primary">Create Event</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal-overlay" id="import-ics-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Import Calendar</h3>
                <button class="close-btn">&times;</button>
            </div>
            <form id="import-ics-form" action="{{ url_for('import_ics', hub_id=hub.id) }}" method="POST" enctype="multipart/form-data">
                <div class="modal-body">
                    <p>Upload your university calendar file (.ics format) to add all your lectures and deadlines to your study hub schedule.</p>
                    <div class="form-group">
                        <label for="ics-file-upload">Select .ics file</label>
                        <input type="file" id="ics-file-upload" name="ics_file" accept=".ics" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="button button-secondary close-btn">Cancel</button>
                    <button type="submit" class="button button-primary">Import Events</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal-overlay" id="event-details-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="details-modal-title">Event Details</h3>
                <button class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <strong>Time & Date</strong>
                <p id="details-modal-time"></p>
                <strong>Focus / Details</strong>
                <p id="details-modal-focus"></p>
            </div>
            <div class="modal-footer" style="justify-content: flex-end;">
                <a href="#" id="details-modal-export-btn" class="button button-secondary">Export .ics</a>
            </div>
        </div>
    </div>


    <script>
        function openTab(evt, tabName) {
            document.querySelectorAll('.tab-content').forEach(tc => tc.style.display = 'none');
            document.querySelectorAll('.tab-button').forEach(tb => tb.classList.remove('active'));
            document.getElementById(tabName).style.display = 'block';
            evt.currentTarget.classList.add('active');
            window.location.hash = tabName;
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons(); // Initialize icons
            
            const hubId = '{{ hub.id }}';
            let calendar; 

            const calendarEl = document.getElementById('fullcalendar');
            const scheduleModal = document.getElementById('schedule-event-modal');
            const detailsModal = document.getElementById('event-details-modal');
            const importModal = document.getElementById('import-ics-modal');

            function initializeCalendar() {
                if (calendar) {
                    calendar.destroy();
                }
                calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'dayGridMonth,timeGridWeek,timeGridDay'
                    },
                    events: `/hub/${hubId}/events`,
                    editable: false, 
                    selectable: true,
                    dateClick: function(info) {
                        const startTimeInput = document.getElementById('event-start-time');
                        const now = new Date();
                        const selectedDate = info.date;
                        selectedDate.setHours(now.getHours(), now.getMinutes());
                        const localIsoString = new Date(selectedDate.getTime() - (selectedDate.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
                        startTimeInput.value = localIsoString;
                        
                        populateModalFileList();
                        scheduleModal.style.display = 'flex';
                    },
                    eventClick: function(info) {
                        const event = info.event;
                        const props = event.extendedProps;
                        
                        document.getElementById('details-modal-title').innerHTML = `${event.title} <span class="event-type-badge" style="background-color:${event.backgroundColor};">${props.eventType}</span>`;

                        const startTime = event.start.toLocaleString([], { dateStyle: 'medium', timeStyle: 'short' });
                        const endTime = event.end ? event.end.toLocaleString([], { timeStyle: 'short' }) : '';
                        document.getElementById('details-modal-time').textContent = endTime ? `${startTime} - ${endTime}` : startTime;
                        document.getElementById('details-modal-focus').textContent = props.focus;
                        document.getElementById('details-modal-export-btn').href = props.exportUrl;

                        detailsModal.style.display = 'flex';
                    }
                });
                calendar.render();
            }

            const anchor = window.location.hash.substring(1);
            if (anchor) {
                const tabButton = document.querySelector(`.tab-button[onclick*="'${anchor}'"]`);
                if (tabButton) {
                    tabButton.click();
                }
            } else {
                document.querySelector(".tab-button[onclick*='tools']").classList.add('active');
                document.getElementById('tools').style.display = 'block';
            }

            document.querySelector("button[onclick*='calendar']").addEventListener('click', () => {
                 if (!calendar) {
                    initializeCalendar();
                 } else {
                    setTimeout(() => calendar.render(), 10);
                 }
            });

            if (anchor === 'calendar') {
                initializeCalendar();
            }

            const themeToggle = document.getElementById('theme-toggle');
            if (localStorage.getItem('theme') === 'dark') {
                themeToggle.checked = true;
            }
            themeToggle.addEventListener('change', function() {
                if (this.checked) {
                    document.documentElement.setAttribute('data-theme', 'dark');
                    localStorage.setItem('theme', 'dark');
                } else {
                    document.documentElement.setAttribute('data-theme', 'light');
                    localStorage.setItem('theme', 'light');
                }
            });

            const studyToolsContainer = document.getElementById('study-tools-container');
            const loadingContainer = document.getElementById('loading-status-container');
            const sidebarPanel = document.getElementById('files-panel-sidebar');
            let isAITaskRunning = false;
            
            const page1 = document.getElementById('tools-page-1');
            const page2 = document.getElementById('tools-page-2');
            const showPage2Btn = document.getElementById('show-page-2-btn');
            const showPage1Btn = document.getElementById('show-page-1-btn');
            
            showPage2Btn.addEventListener('click', () => {
                page1.style.display = 'none';
                page2.style.display = 'block';
            });
            showPage1Btn.addEventListener('click', () => {
                page2.style.display = 'none';
                page1.style.display = 'block';
            });

            const workflowOptions = {
                exam: {
                    title: 'Get Exam Ready',
                    tools: [
                        { value: 'quiz', label: 'Practice Quiz' },
                        { value: 'exam', label: 'Mock Exam' },
                        { value: 'cheatsheet', label: 'Cheat Sheet' },
                        { value: 'analyse', label: 'Past Paper Analysis' }
                    ]
                },
                revision: {
                    title: 'Make Revision Resources',
                    tools: [
                        { value: 'notes', label: 'Interactive Notes' },
                        { value: 'flashcards', label: 'Flashcard Deck' }
                    ]
                }
            };

            const workflowTitleEl = document.getElementById('workflow-title');
            const workflowOptionsContainer = document.getElementById('workflow-options-container');
            const workflowTypeInput = document.getElementById('workflow-type-input');
            const workflowForm = document.getElementById('workflow-selection-form');

            function showWorkflowSelection(type) {
                const config = workflowOptions[type];
                workflowTitleEl.textContent = config.title;
                workflowTypeInput.value = type;

                workflowOptionsContainer.innerHTML = '';
                config.tools.forEach(tool => {
                    const label = document.createElement('label');
                    label.className = 'checkbox-label';
                    label.innerHTML = `
                        <input type="checkbox" name="selected_tools" value="${tool.value}">
                        <span>${tool.label}</span>
                    `;
                    workflowOptionsContainer.appendChild(label);
                });

                studyToolsContainer.classList.add('selection-active');
            }

            document.getElementById('exam-prep-btn').addEventListener('click', () => showWorkflowSelection('exam'));
            document.getElementById('revision-btn').addEventListener('click', () => showWorkflowSelection('revision'));
            document.getElementById('back-to-tools-btn').addEventListener('click', () => {
                studyToolsContainer.classList.remove('selection-active');
            });

            workflowForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (isAITaskRunning) return;

                const selectedFiles = Array.from(document.querySelectorAll('.sidebar-section .file-checkbox:checked')).map(cb => cb.value);
                const selectedTools = Array.from(document.querySelectorAll('#workflow-options-container input:checked')).map(cb => cb.value);
                
                if (selectedFiles.length === 0) {
                    alert("Please select at least one document to generate resources.");
                    return;
                }
                if (selectedTools.length === 0) {
                    alert("Please select at least one resource to generate.");
                    return;
                }

                isAITaskRunning = true;
                studyToolsContainer.classList.add('disabled');
                sidebarPanel.classList.add('disabled');
                loadingContainer.innerHTML = `<div class="loading-card"><div class="spinner"></div><div class="loading-text"><h4>Generating your resources...</h4><p>This may take a moment. A new folder will be created upon completion.</p></div></div>`;
                
                studyToolsContainer.classList.remove('selection-active');
                page2.style.display = 'none';
                page1.style.display = 'block';

                try {
                    const response = await fetch(`/hub/${hubId}/generate_workflow_folder`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            workflow_type: workflowTypeInput.value,
                            selected_tools: selectedTools,
                            selected_files: selectedFiles
                        })
                    });
                    const result = await response.json();
                    if (result.success) {
                        window.location.hash = 'folders';
                        window.location.reload();
                    } else {
                        alert(`An error occurred: ${result.message}`);
                    }
                } catch (error) {
                    alert('A network or server error occurred. Please try again.');
                } finally {
                    loadingContainer.innerHTML = '';
                    isAITaskRunning = false;
                    updateUIBasedOnSelection();
                    sidebarPanel.classList.remove('disabled');
                }
            });
            
            document.querySelectorAll('.quick-tool-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    if (isAITaskRunning) { return; }
                    
                    const toolName = e.currentTarget.value;
                    const selectedFiles = Array.from(document.querySelectorAll('.sidebar-section .file-checkbox:checked')).map(cb => cb.value);
                    if (selectedFiles.length === 0) {
                        alert("Please select at least one document to use this tool.");
                        return;
                    }

                    isAITaskRunning = true;
                    studyToolsContainer.classList.add('disabled');
                    sidebarPanel.classList.add('disabled');
                    loadingContainer.innerHTML = `<div class="loading-card"><div class="spinner"></div><div class="loading-text"><h4>Generating ${toolName.charAt(0).toUpperCase() + toolName.slice(1)}...</h4><p>This may take a moment. Please wait.</p></div></div>`;
                    
                    try {
                        const response = await fetch(`/hub/${hubId}/run_async_tool`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ tool: toolName, selected_files: selectedFiles })
                        });
                        const result = await response.json();
                        if (result.success) {
                            window.location.href = result.redirect_url;
                        } else {
                            alert(`An error occurred: ${result.message}`);
                        }
                    } catch (error) {
                        alert('A network or server error occurred. Please try again.');
                    } finally {
                        isAITaskRunning = false; 
                        loadingContainer.innerHTML = '';
                        updateUIBasedOnSelection();
                        sidebarPanel.classList.remove('disabled');
                    }
                });
            });

            function updateUIBasedOnSelection() {
                if (isAITaskRunning) return;
                const selectedCount = document.querySelectorAll('.sidebar-section .file-checkbox:checked').length;
                const isDisabled = selectedCount === 0;
                
                studyToolsContainer.classList.toggle('disabled', isDisabled);
            }

            document.querySelectorAll('.sidebar-section .file-checkbox').forEach(cb => {
                cb.addEventListener('change', updateUIBasedOnSelection);
            });
            updateUIBasedOnSelection();

            document.querySelectorAll('.workflow-form').forEach(form => {
                form.addEventListener('submit', function(e) {
                    if (isAITaskRunning) { e.preventDefault(); return; }
                    const selectedFiles = document.querySelectorAll('.sidebar-section .file-checkbox:checked');
                    if (selectedFiles.length === 0) {
                        e.preventDefault();
                        alert("Please select at least one document to start a workflow.");
                        return;
                    }
                    isAITaskRunning = true;
                    sidebarPanel.classList.add('disabled');
                    this.querySelectorAll('input[type="hidden"]').forEach(input => input.remove());
                    selectedFiles.forEach(checkbox => {
                        const hiddenInput = document.createElement('input');
                        hiddenInput.type = 'hidden';
                        hiddenInput.name = 'selected_files';
                        hiddenInput.value = checkbox.value;
                        this.appendChild(hiddenInput);
                    });
                });
            });
            
            const tabsContainer = document.querySelector('.tabs-container');
            tabsContainer.addEventListener('click', async (e) => {
                const target = e.target;
                const tabContent = target.closest('.tab-content');

                function updateSelectionUI(currentTab) {
                    if (!currentTab) return;
                    const deleteBtn = currentTab.querySelector('.delete-selected-btn');
                    const selectAllCheckbox = currentTab.querySelector('.select-all-checkbox');
                    const allCheckboxes = currentTab.querySelectorAll('.asset-checkbox');
                    const selectedCheckboxes = currentTab.querySelectorAll('.asset-checkbox:checked');

                    if (deleteBtn) {
                        deleteBtn.style.display = selectedCheckboxes.length > 0 ? 'inline-flex' : 'none';
                        if (selectedCheckboxes.length > 0) {
                            deleteBtn.textContent = `Delete Selected (${selectedCheckboxes.length})`;
                        }
                    }
                    if (selectAllCheckbox) {
                        selectAllCheckbox.checked = allCheckboxes.length > 0 && selectedCheckboxes.length === allCheckboxes.length;
                    }
                }

                if (target.classList.contains('asset-checkbox')) {
                    target.closest('.asset-item').classList.toggle('selected', target.checked);
                    updateSelectionUI(tabContent);
                }

                if (target.classList.contains('select-all-checkbox')) {
                    const isChecked = target.checked;
                    tabContent.querySelectorAll('.asset-checkbox').forEach(cb => {
                        cb.checked = isChecked;
                        cb.closest('.asset-item').classList.toggle('selected', isChecked);
                    });
                    updateSelectionUI(tabContent);
                }

                if (target.classList.contains('delete-selected-btn')) {
                    const selectedItems = tabContent.querySelectorAll('.asset-item.selected');
                    if (selectedItems.length === 0 || !confirm(`Are you sure you want to delete these ${selectedItems.length} item(s)?`)) return;
                    
                    const itemsToDelete = Array.from(selectedItems).map(item => ({ id: item.dataset.id, type: item.dataset.type }));
                    target.textContent = 'Deleting...';
                    target.disabled = true;

                    fetch('/hub/batch_delete', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ items: itemsToDelete })
                    }).then(res => res.json()).then(result => {
                        if (result.success) {
                            selectedItems.forEach(item => item.remove());
                        } else {
                            alert(`Error: ${result.message}`);
                        }
                    }).catch(() => alert('A network error occurred.'))
                    .finally(() => {
                        updateSelectionUI(tabContent);
                    });
                }
            });

            const folderContainer = document.getElementById('folder-accordion-container');
            const addItemsModal = document.getElementById('add-items-modal');
            let currentFolderId = null;

            folderContainer.addEventListener('click', async (e) => {
                const header = e.target.closest('.folder-header');
                const addBtn = e.target.closest('.add-items-to-folder-btn');
                const deleteBtn = e.target.closest('.delete-folder-btn');
                const removeBtn = e.target.closest('.remove-item-btn');

                if (header && !addBtn && !deleteBtn && !e.target.closest('.edit-btn')) {
                    header.nextElementSibling.classList.toggle('open');
                }
                if (addBtn) {
                    currentFolderId = addBtn.closest('.folder-accordion-item').querySelector('.folder-header').dataset.folderId;
                    addItemsModal.style.display = 'flex';
                }
                if (deleteBtn) {
                    const folderItem = deleteBtn.closest('.folder-accordion-item');
                    const folderId = folderItem.querySelector('.folder-header').dataset.folderId;
                    if (confirm('Are you sure you want to delete this folder? (Items inside will not be deleted).')) {
                        fetch(`/folder/${folderId}/delete`, { method: 'POST' }).then(res => {
                            if (res.ok) folderItem.remove(); else alert('Failed to delete folder.');
                        });
                    }
                }
                if (removeBtn) {
                    const itemEl = removeBtn.closest('.asset-item');
                    const folderId = removeBtn.closest('.folder-accordion-item').querySelector('.folder-header').dataset.folderId;
                    const item = { id: itemEl.dataset.id, type: itemEl.dataset.type };
                    fetch(`/folder/${folderId}/remove_item`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ item: item })
                    }).then(res => {
                        if (res.ok) itemEl.remove(); else alert('Failed to remove item.');
                    });
                }
            });

            addItemsModal.querySelectorAll('.close-btn').forEach(btn => btn.addEventListener('click', () => addItemsModal.style.display = 'none'));
            document.getElementById('save-added-items-btn').addEventListener('click', async () => {
                const selectedItems = Array.from(addItemsModal.querySelectorAll('input[type="checkbox"]:checked'))
                    .map(cb => ({ id: cb.dataset.id, type: cb.dataset.type }));
                
                if (selectedItems.length > 0 && currentFolderId) {
                    fetch(`/folder/${currentFolderId}/add_items`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ items: selectedItems })
                    }).then(res => {
                        if (res.ok) window.location.reload(); else alert('Failed to add items.');
                    });
                } else {
                    addItemsModal.style.display = 'none';
                }
            });            
            const showScheduleModalBtn = document.getElementById('show-schedule-modal-btn');
            const scheduleForm = document.getElementById('schedule-event-form');
            const showImportModalBtn = document.getElementById('show-import-modal-btn');
            
            function populateModalFileList() {
                const modalFileList = document.getElementById('modal-file-list');
                modalFileList.innerHTML = '';
                const hubFiles = document.querySelectorAll('.sidebar-section .file-checkbox');
                
                if (hubFiles.length > 0) {
                    hubFiles.forEach(fileCheckbox => {
                        const fileName = fileCheckbox.dataset.filename;
                        const filePath = fileCheckbox.value;
                        const div = document.createElement('div');
                        div.className = 'modal-file-item';
                        div.innerHTML = `
                            <label for="modal-file-${filePath}">${fileName}</label>
                            <input type="checkbox" name="source_files" value="${filePath}" id="modal-file-${filePath}">
                        `;
                        modalFileList.appendChild(div);
                    });
                } else {
                    modalFileList.innerHTML = '<p style="font-size: 0.9rem; color: var(--text-secondary); padding: 0.5rem;">No documents in hub.</p>';
                }
            }

            showScheduleModalBtn.addEventListener('click', () => {
                populateModalFileList();
                scheduleModal.style.display = 'flex';
            });
            showImportModalBtn.addEventListener('click', () => {
                importModal.style.display = 'flex';
            });


            [scheduleModal, importModal, detailsModal, addItemsModal].forEach(modal => {
                if(modal) {
                    modal.querySelectorAll('.close-btn').forEach(btn => btn.addEventListener('click', () => modal.style.display = 'none'));
                }
            });

            scheduleForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(scheduleForm);
                const selectedFiles = Array.from(scheduleForm.querySelectorAll('input[name="source_files"]:checked')).map(cb => cb.value);

                const eventData = {
                    title: formData.get('title'),
                    event_type: formData.get('event_type'),
                    duration: formData.get('duration'),
                    start_time: formData.get('start_time'),
                    focus: formData.get('focus'),
                    source_files: selectedFiles
                };

                fetch(`/hub/${hubId}/create_calendar_event`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(eventData)
                }).then(res => res.json()).then(result => {
                    if (result.success) {
                        scheduleModal.style.display = 'none';
                        scheduleForm.reset();
                        if(calendar) calendar.refetchEvents();
                    } else {
                        alert(`Error: ${result.message}`);
                    }
                }).catch(() => alert('A network error occurred.'));
            });

            const bell = document.getElementById('notification-bell');
            const panel = document.getElementById('notification-panel');
            const dot = document.getElementById('notification-dot');

            bell.addEventListener('click', async (event) => {
                event.stopPropagation();
                const isVisible = panel.classList.toggle('visible');

                if (isVisible && dot.classList.contains('visible')) {
                    const unreadItems = panel.querySelectorAll('.notification-item.unread');
                    const idsToMarkRead = Array.from(unreadItems).map(item => item.dataset.id);
                    
                    if (idsToMarkRead.length > 0) {
                        try {
                            dot.classList.remove('visible');
                            unreadItems.forEach(item => item.classList.remove('unread'));
                            await fetch('/notifications/mark_read', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ ids: idsToMarkRead })
                            });
                        } catch (error) {
                            console.error("Failed to mark notifications as read:", error);
                            dot.classList.add('visible');
                            unreadItems.forEach(item => item.classList.add('unread'));
                        }
                    }
                }
            });

            document.addEventListener('click', (event) => {
                if (!panel.contains(event.target) && !bell.contains(event.target)) {
                    panel.classList.remove('visible');
                }
            });

            // =================================================================
            // NEW: IN-PLACE EDITING FUNCTIONALITY
            // =================================================================
            document.body.addEventListener('click', function(e) {
                const editBtn = e.target.closest('.edit-btn');
                if (!editBtn) return;

                const itemElement = editBtn.closest('.asset-item, .folder-accordion-item');
                if (!itemElement) return;

                const titleElement = itemElement.querySelector('.asset-title');
                if (!titleElement) return;

                const currentTitle = titleElement.textContent.trim();
                const container = titleElement.parentElement;

                // Create input field
                const input = document.createElement('input');
                input.type = 'text';
                input.value = currentTitle;
                
                // Replace title with input
                container.innerHTML = '';
                const editContainer = document.createElement('div');
                editContainer.className = 'edit-container';
                editContainer.appendChild(input);
                container.appendChild(editContainer);
                input.focus();
                input.select();

                const saveChanges = async () => {
                    const newTitle = input.value.trim();
                    if (newTitle === '' || newTitle === currentTitle) {
                        // If no change or empty, revert without saving
                        container.innerHTML = `<h5 class="asset-title">${currentTitle}</h5>`;
                        return;
                    }

                    const itemId = itemElement.dataset.id;
                    const itemType = itemElement.dataset.type;
                    
                    let endpoint = '';
                    if (itemType === 'note') endpoint = `/note/${itemId}/edit`;
                    else if (itemType === 'flashcards') endpoint = `/flashcards/${itemId}/edit`;
                    else if (itemType === 'quiz') endpoint = `/quiz/${itemId}/edit`;
                    else if (itemType === 'folder') endpoint = `/folder/${itemId}/update_name`;
                    
                    if (!endpoint) return;

                    try {
                        const response = await fetch(endpoint, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ new_title: newTitle })
                        });
                        const result = await response.json();
                        if (result.success) {
                            container.innerHTML = `<h5 class="asset-title">${newTitle}</h5>`;
                        } else {
                            alert(result.message);
                            container.innerHTML = `<h5 class="asset-title">${currentTitle}</h5>`;
                        }
                    } catch (err) {
                        alert('An error occurred. Please try again.');
                        container.innerHTML = `<h5 class="asset-title">${currentTitle}</h5>`;
                    }
                };
                
                input.addEventListener('keydown', e => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        saveChanges();
                    } else if (e.key === 'Escape') {
                         container.innerHTML = `<h5 class="asset-title">${currentTitle}</h5>`;
                    }
                });

                input.addEventListener('blur', saveChanges);
            });

        });
    </script>
</body>
</html>