<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ hub.name }} - Study Hub</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Lora:wght@400;600&display=swap" rel="stylesheet">
    
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>

    <!-- NEW: Spotify Web Playback SDK -->
    <script src="https://sdk.scdn.co/spotify-player.js"></script>


    <style>
        :root {
            --primary-color: #4f46e5;
            --primary-hover: #4338ca;
            --primary-light: #eef2ff;
            --danger-color: #ef4444;
            --danger-hover: #dc2626;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --text-main: #1f2937;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
            --background-body: #f9fafb;
            --background-card: #ffffff;
            --background-interactive-hover: #f3f4f6;
            --sidebar-width: 260px;
            --sidebar-width-collapsed: 80px;
            --top-bar-height: 72px;
            --card-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.07), 0 2px 4px -2px rgb(0 0 0 / 0.07);
            --card-shadow-hover: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            --green: #10b981; --yellow: #f59e0b; --red: #ef4444;
            
            --fc-border-color: var(--border-color);
            --fc-daygrid-event-dot-width: 8px;
            --fc-today-bg-color: rgba(79, 70, 229, 0.05);
            --fc-button-bg-color: var(--primary-color);
            --fc-button-active-bg-color: var(--primary-hover);
            --fc-button-hover-bg-color: var(--primary-hover);
        }

        html[data-theme="dark"] {
            --primary-color: #6366f1;
            --primary-hover: #4f46e5;
            --primary-light: #312e81;
            --danger-color: #f87171;
            --danger-hover: #ef4444;
            --text-main: #f9fafb;
            --text-secondary: #9ca3af;
            --border-color: #374151;
            --background-body: #111827;
            --background-card: #1f2937;
            --background-interactive-hover: #374151;
            --card-shadow: 0 0 0 1px rgba(255, 255, 255, 0.08);
            --card-shadow-hover: 0 0 0 1px rgba(255, 255, 255, 0.12);
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--background-body);
            margin: 0;
            color: var(--text-main);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .hub-container {
            display: flex;
        }

        /* --- Sidebar Styles --- */
        .sidebar {
            width: var(--sidebar-width);
            height: 100vh;
            position: fixed;
            top: 0; left: 0;
            background-color: var(--background-card);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            padding: 1.5rem 1rem;
            transition: width 0.3s ease;
            overflow-y: auto;
            overflow-x: hidden;
            z-index: 100;
            -ms-overflow-style: none; scrollbar-width: none;
        }
        .sidebar::-webkit-scrollbar { display: none; }
        
        /* Enhanced sidebar styling for background themes */
        body:not([data-background="default"]) .sidebar {
            background-color: var(--background-dark) !important;
            background-image: none !important;
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Enhanced top bar styling for background themes */
        body:not([data-background="default"]) .top-bar {
            background-color: rgba(255, 255, 255, 0.1) !important;
            background-image: none !important;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        /* Make all sidebar nav links visible when background theme is applied */
        body:not([data-background="default"]) .sidebar-nav a {
            background-color: rgba(255, 255, 255, 0.1) !important;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }
        
        body:not([data-background="default"]) .sidebar-nav a:hover {
            background-color: rgba(255, 255, 255, 0.2) !important;
            transform: translateY(-1px);
        }
        
        body:not([data-background="default"]) .sidebar-nav a.active {
            background-color: rgba(255, 255, 255, 0.25) !important;
            border-color: rgba(255, 255, 255, 0.4);
        }
        
        .sidebar.collapsed {
            width: var(--sidebar-width-collapsed);
            padding: 1.5rem 0.5rem;
        }
        .sidebar.collapsed .sidebar-header .hub-title {
            display: none;
        }
        .sidebar.collapsed .sidebar-nav {
            padding: 0.5rem 0;
        }
        .sidebar.collapsed .sidebar-footer {
            padding: 0.5rem;
            margin-top: auto;
        }
        .sidebar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 0.5rem 1.5rem 0.5rem;
            flex-shrink: 0;
        }
        .sidebar-header .hub-title {
            font-size: 1.25rem;
            font-weight: 700;
            white-space: nowrap;
            opacity: 1;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .sidebar.collapsed .sidebar-header .hub-title {
            opacity: 0;
            transform: translateX(-20px);
            pointer-events: none;
        }
        #sidebar-toggle {
            background: var(--primary-color); 
            border: none; 
            cursor: pointer; 
            color: white;
            padding: 0.75rem; 
            border-radius: 8px;
            display: flex; 
            align-items: center; 
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(79, 70, 229, 0.2);
            min-width: 48px;
            min-height: 48px;
        }
        #sidebar-toggle:hover {
            background-color: var(--primary-hover);
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }
        
        /* Floating toggle button when sidebar is collapsed */
        .sidebar.collapsed #sidebar-toggle {
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 1000;
            background: transparent;
            box-shadow: none;
            min-width: 40px;
            min-height: 40px;
            padding: 0.5rem;
        }
        .sidebar.collapsed #sidebar-toggle:hover {
            background: rgba(79, 70, 229, 0.1);
            transform: scale(1.05);
        }
        .sidebar.collapsed #sidebar-toggle svg {
            width: 20px;
            height: 20px;
        }
        .sidebar-nav {
            flex-grow: 1;
            overflow-y: auto;
            -ms-overflow-style: none; scrollbar-width: none;
            margin-bottom: 1rem;
        }
        .sidebar-nav::-webkit-scrollbar { display: none; }
        .sidebar-nav ul { list-style: none; padding: 0; margin: 0; }
        .sidebar-nav a {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem 1rem;
            text-decoration: none;
            color: var(--text-secondary);
            font-weight: 500;
            border-radius: 8px;
            margin-bottom: 0.25rem;
            white-space: nowrap;
            transition: background-color 0.2s, color 0.2s;
        }
        .sidebar-nav a:hover {
            background-color: var(--background-interactive-hover);
            color: var(--text-main);
        }
        .sidebar-nav a.active {
            background-color: var(--primary-light);
            color: var(--primary-color);
            font-weight: 600;
        }
        .sidebar-nav a .nav-icon {
            flex-shrink: 0;
            width: 24px; height: 24px;
        }
        .sidebar-nav a .nav-text {
            opacity: 1;
            transition: opacity 0.2s ease;
        }
        .sidebar.collapsed .sidebar-nav a {
            justify-content: center;
            padding: 0.75rem;
        }
        .sidebar.collapsed .sidebar-nav a .nav-text {
            opacity: 0;
            pointer-events: none;
            width: 0;
            overflow: hidden;
        }
        .sidebar.collapsed .sidebar-nav a .nav-icon {
            margin: 0;
        }
        .sidebar-footer {
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
            margin-top: auto;
            flex-shrink: 0;
        }
        
        /* Earn Money Banner */
        .earn-money-banner {
            margin: 1rem 0.5rem;
            background: linear-gradient(135deg, #fbbf24, #f59e0b, #d97706);
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 4px 12px rgba(251, 191, 36, 0.3);
            border: 1px solid rgba(251, 191, 36, 0.2);
            position: relative;
            overflow: hidden;
        }
        
        .earn-money-banner::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 50%, rgba(255, 255, 255, 0.1) 100%);
            pointer-events: none;
        }
        
        .banner-content {
            position: relative;
            z-index: 1;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .banner-text {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .banner-title {
            font-size: 1rem;
            font-weight: 700;
            color: #1f2937;
            line-height: 1.2;
        }
        
        .banner-subtitle {
            font-size: 0.8rem;
            color: #374151;
            font-weight: 500;
            opacity: 0.9;
        }
        
        .banner-button {
            background: rgba(31, 41, 55, 0.9);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0.6rem 1rem;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .banner-button:hover {
            background: rgba(31, 41, 55, 1);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        .banner-button:active {
            transform: translateY(0);
        }
        
        .banner-arrow {
            width: 16px;
            height: 16px;
            transition: transform 0.2s ease;
        }
        
        .banner-button:hover .banner-arrow {
            transform: translateX(2px);
        }
        
        /* Collapsed state for banner */
        .sidebar.collapsed .earn-money-banner {
            margin: 0.5rem 0.25rem;
            padding: 0.75rem 0.5rem;
        }
        
        .sidebar.collapsed .banner-content {
            gap: 0.5rem;
        }
        
        .sidebar.collapsed .banner-title {
            font-size: 0.85rem;
        }
        
        .sidebar.collapsed .banner-subtitle {
            font-size: 0.7rem;
        }
        
        .sidebar.collapsed .banner-button {
            padding: 0.5rem 0.75rem;
            font-size: 0.75rem;
        }
        
        .sidebar.collapsed .banner-arrow {
            width: 14px;
            height: 14px;
        }

        /* --- Main Content Wrapper --- */
        .main-wrapper {
            margin-left: var(--sidebar-width);
            width: calc(100% - var(--sidebar-width));
            transition: margin-left 0.3s ease, width 0.3s ease;
        }
        .sidebar.collapsed + .main-wrapper {
            margin-left: var(--sidebar-width-collapsed);
            width: calc(100% - var(--sidebar-width-collapsed));
        }

        /* --- Top Bar Styles --- */
        .top-bar {
            height: var(--top-bar-height);
            background-color: var(--background-card);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding: 0 2rem;
            position: sticky;
            top: 0;
            z-index: 50;
        }
        .search-container {
            position: relative;
            color: var(--text-secondary);
        }
        .search-container .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
        }
        .search-container input {
            background-color: var(--background-body);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.6rem 1rem 0.6rem 2.75rem;
            width: 300px;
            font-family: 'Poppins', sans-serif;
            color: var(--text-main);
        }
        .top-bar-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .user-profile-section { 
            display: flex; 
            align-items: center; 
            gap: 1rem; 
            position: relative; 
        }
        .notification-bell {
            position: relative;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: background-color 0.2s;
            color: var(--text-secondary);
        }
        .notification-bell:hover { background-color: var(--primary-light); color: var(--primary-color);}
        .notification-dot {
            position: absolute; top: 6px; right: 6px; width: 10px; height: 10px;
            background-color: var(--danger-color); border-radius: 50%;
            border: 2px solid var(--background-card); display: none;
        }
        .notification-dot.visible { display: block; }
        #notification-panel {
            display: none; position: absolute; top: 50px; right: 0; width: 350px;
            background-color: var(--background-card); border-radius: 8px;
            box-shadow: var(--card-shadow-hover); border: 1px solid var(--border-color);
            z-index: 100; max-height: 400px; overflow-y: auto;
        }
         #notification-panel.visible { display: block; }
        .notification-header {
            padding: 0.75rem 1rem;
            font-weight: 600;
            border-bottom: 1px solid var(--border-color);
        }
        .notification-list { list-style: none; padding: 0; margin: 0; }
        .notification-item {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color);
            display: block;
            text-decoration: none;
            color: var(--text-main);
        }
        .notification-item:last-child { border-bottom: none; }
        .notification-item:hover { background-color: var(--background-interactive-hover); }
        .notification-item p { margin: 0; font-size: 0.9rem; line-height: 1.4; font-family: 'Poppins', sans-serif;}
        .notification-item span { font-size: 0.75rem; color: var(--text-secondary); font-family: 'Poppins', sans-serif;}
        .notification-item.unread { background-color: var(--primary-light); }
        .profile-dropdown {
            position: relative;
        }
        .profile-trigger {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: background-color 0.2s;
        }
        .profile-trigger:hover {
            background-color: var(--background-interactive-hover);
        }
        .profile-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
        }
        .profile-name {
            font-weight: 500;
            color: var(--text-main);
        }
        .dropdown-arrow {
            transition: transform 0.2s ease;
            color: var(--text-secondary);
        }
        .profile-dropdown.active .dropdown-arrow {
            transform: rotate(180deg);
        }
        .profile-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--background-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            min-width: 220px;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s ease;
            margin-top: 0.5rem;
            overflow: hidden;
        }
        .profile-dropdown.active .profile-menu {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        .profile-menu-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.875rem 1rem;
            color: var(--text-main);
            text-decoration: none;
            transition: all 0.2s ease;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.95rem;
            font-weight: 500;
            min-height: 44px;
            border-radius: 0;
        }
        .profile-menu-item:last-child {
            border-bottom: none;
        }
        .profile-menu-item:hover {
            background-color: var(--background-interactive-hover);
            color: var(--text-main);
            transform: translateX(2px);
        }
        .profile-menu-item svg {
            color: var(--text-secondary);
            width: 18px;
            height: 18px;
            flex-shrink: 0;
        }
        .profile-menu-divider {
            height: 1px;
            background: var(--border-color);
            margin: 0.5rem 0;
        }
        .profile-menu-item.spotify-toggle {
            background: none;
            border: none;
            width: 100%;
            text-align: left;
            cursor: pointer;
            min-height: 44px;
            font-size: 0.95rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        .profile-menu-item.spotify-toggle:hover {
            background-color: var(--background-interactive-hover);
            transform: translateX(2px);
        }
        .theme-toggle-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.875rem 1rem;
            min-height: 44px;
            font-size: 0.95rem;
            font-weight: 500;
            transition: all 0.2s ease;
            color: var(--text-main);
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            cursor: pointer;
        }
        .theme-toggle-item:hover {
            background-color: var(--background-interactive-hover);
            transform: translateX(2px);
        }
        .theme-toggle-item span {
            flex: 1;
            margin-left: 0.75rem;
        }
        .theme-toggle-item svg {
            width: 18px;
            height: 18px;
            flex-shrink: 0;
            color: var(--text-secondary);
        }
        .theme-switch-inline {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
            margin-left: auto;
        }
        .theme-switch-inline input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider-inline {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border-color);
            transition: 0.3s;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 2px;
        }
        .slider-inline:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
            z-index: 2;
        }
        .theme-switch-inline input:checked + .slider-inline {
            background-color: var(--primary-color);
        }
        .theme-switch-inline input:checked + .slider-inline:before {
            transform: translateX(20px);
        }
        .slider-inline .icon-wrapper {
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
        }
        .slider-inline .sun {
            opacity: 1;
            color: #f59e0b;
        }
        .slider-inline .moon {
            opacity: 0;
            color: white;
        }
        .theme-switch-inline input:checked + .slider-inline .sun {
            opacity: 0;
        }
        .theme-switch-inline input:checked + .slider-inline .moon {
            opacity: 1;
        }

        /* --- Workspace Styles --- */
        .workspace {
            padding: 2.5rem;
            max-width: 1400px;
            margin: 0 auto;
        }
        .workspace-header {
            margin-bottom: 2rem;
        }
        .workspace-header h1 {
            font-size: 2.25rem; font-weight: 700; margin: 0;
        }
        .workspace-header p {
            font-size: 1.1rem; color: var(--text-secondary); margin: 0.5rem 0 0 0;
            font-family: 'Lora', serif;
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* --- Retained and Adapted Styles --- */
        .button {
            display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;
            text-decoration: none; font-weight: 600; padding: 0.6rem 1rem;
            border-radius: 8px; border: 1px solid transparent;
            transition: all 0.2s ease-in-out; cursor: pointer; font-size: 0.9rem;
        }
        .button.button-icon-only {
            padding: 0.6rem;
        }
        .button-primary { background-color: var(--primary-color); color: white; }
        .button-primary:hover { background-color: var(--primary-hover); }
        
        /* Upload button specific styling */
        #quick-action-upload {
            padding: 0.75rem 1.25rem;
            font-size: 0.95rem;
            gap: 0.75rem;
        }
        
        #quick-action-upload svg {
            width: 18px;
            height: 18px;
        }
        .button-secondary { background-color: var(--background-interactive-hover); border-color: var(--border-color); color: var(--text-main); }
        .button-secondary:hover { background-color: var(--border-color); }
        .button-danger { background-color: var(--danger-color); color: white; }
        .button-danger:hover { background-color: var(--danger-hover); }
        .button:disabled {
             background: var(--text-secondary) !important;
             border-color: var(--text-secondary) !important;
             cursor: not-allowed !important;
             transform: none !important;
             box-shadow: none !important;
             opacity: 0.7 !important;
        }
        
        /* --- NEW: Theme Toggle Styles (from dashboard) --- */
        .theme-switch {
            position: relative;
            display: inline-block;
            width: 64px;
            height: 34px;
            cursor: pointer;
        }
        .theme-switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #374151; /* Default for dark mode OFF */
            border-radius: 34px;
            transition: .4s;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            border-radius: 50%;
            transition: .4s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .slider .icon-wrapper {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 26px;
            color: #111827;
            transition: opacity 0.2s ease-in-out;
            z-index: 10;
        }
        .slider .sun { left: 4px; opacity: 1; }
        .slider .moon { right: 4px; opacity: 0; color: white; }
        
        input:checked#theme-toggle + .slider {
            background-color: var(--background-interactive-hover);
            border: 1px solid var(--border-color);
        }
        html[data-theme="dark"] input:checked#theme-toggle + .slider {
            background-color: var(--background-interactive-hover);
        }
        input:checked#theme-toggle + .slider:before {
            transform: translateX(30px);
            background-color: var(--text-main);
        }
        html[data-theme="dark"] input:checked#theme-toggle + .slider:before {
            background-color: white;
        }
        input:checked#theme-toggle + .slider .sun { opacity: 0; }
        input:checked#theme-toggle + .slider .moon { opacity: 1; }
        html[data-theme="light"] input:checked#theme-toggle + .slider {
             background-color: #374151;
        }
        html[data-theme="light"] input#theme-toggle + .slider {
             background-color: white;
             border: 1px solid var(--border-color);
        }
        html[data-theme="light"] input#theme-toggle + .slider:before {
             background-color: #111827;
        }
        html[data-theme="light"] input:checked#theme-toggle + .slider:before {
             transform: translateX(30px);
             background-color: white;
        }

        .file-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
        }
        .file-item-card {
            background-color: var(--background-card); border: 1px solid var(--border-color);
            border-radius: 12px; padding: 1.5rem;
            display: flex; flex-direction: column;
            gap: 1rem;
            box-shadow: var(--card-shadow);
            transition: all 0.3s ease;
        }
        
        .file-item-card.clickable-file {
            cursor: pointer;
        }
        
        .file-item-card.clickable-file:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border-color: var(--primary-color);
        }
        .file-item-card .file-info { display: flex; align-items: center; gap: 1rem; flex-grow: 1; }
        .file-item-card .file-info .file-icon { color: var(--primary-color); }
        .file-item-card .file-info .file-name { font-weight: 600; color: var(--text-main); }
        .file-item-card .file-actions { display: flex; justify-content: space-between; align-items: center; margin-top: auto; }
        .file-item-card .file-actions .action-buttons { display: flex; align-items: center; gap: 0.25rem; }
        .file-item-card .file-actions .file-size { font-size: 0.85rem; color: var(--text-secondary); }
        
        .view-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.75rem;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            margin-right: 0.25rem;
            min-width: 44px;
            min-height: 44px;
        }
        
        .view-btn svg {
            width: 24px;
            height: 24px;
        }
        
        .view-btn:hover {
            background: var(--primary-hover);
            transform: scale(1.05);
        }
        
        .delete-btn {
            background: var(--danger-color);
            color: white;
            padding: 0.75rem;
            border-radius: 8px;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            min-width: 44px;
            min-height: 44px;
        }
        
        .delete-btn svg {
            width: 24px;
            height: 24px;
        }
        
        .delete-btn:hover {
            background: #dc2626;
            transform: scale(1.05);
        }

        /* Note Type Options Styles */
        .note-type-options {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .note-type-option {
            display: block;
            cursor: pointer;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            background: var(--background-card);
        }
        
        .note-type-option:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .note-type-option input[type="radio"] {
            display: none;
        }
        
        .note-type-option input[type="radio"]:checked + .option-content {
            opacity: 1;
        }
        
        .note-type-option:has(input[type="radio"]:checked) {
            border-color: var(--primary-color);
            background: rgba(var(--primary-color-rgb), 0.05);
            box-shadow: 0 0 0 3px rgba(var(--primary-color-rgb), 0.1);
        }
        
        .option-content {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .option-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .option-text h4 {
            margin: 0 0 0.5rem 0;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-main);
        }
        
        .option-text p {
            margin: 0;
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        /* --- ALL ORIGINAL STYLES FOR COMPONENTS --- */
        h1, h2, h3, h4, h5, .button, .tab-button, .stat-label, .upload-form .file-upload-text {
            font-family: 'Poppins', sans-serif;
        }
        .content-card {
            background-color: var(--background-card);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            box-shadow: var(--card-shadow);
            padding: 1.5rem 2rem;
        }
        .asset-list-header { display: flex; justify-content: space-between; align-items: center; padding: 0 0.5rem 1rem; border-bottom: 1px solid var(--border-color); margin-bottom: 1rem; }
        .select-all-container { display: flex; align-items: center; gap: 0.5rem; }
        .select-all-container label { font-weight: 500; cursor: pointer; }
        .asset-checkbox, .select-all-checkbox { width: 1.1rem; height: 1.1rem; accent-color: var(--primary-color); cursor: pointer;}
        .asset-list { list-style: none; padding: 0; margin: 0; }
        .asset-item { display: flex; align-items: center; gap: 1rem; padding: 0.75rem; border-radius: 8px; transition: background-color 0.2s; border: 1px solid var(--border-color); }
        .asset-item:not(:last-child) { margin-bottom: 0.5rem; }
        .asset-item:hover { background-color: var(--background-interactive-hover); border-color: var(--primary-color);}
        .asset-item.selected { background-color: var(--primary-light); border-color: var(--primary-color); }
        .asset-link { display: flex; align-items: center; gap: 1rem; text-decoration: none; color: inherit; flex-grow: 1; }
        .asset-icon { flex-shrink: 0; width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; }
        .asset-icon-note { background-color: #e0e7ff; color: #4338ca; }
        .asset-icon-slides { background-color: #FEF3C7; color: #B45309; } /* NEW */
        .asset-icon-flashcards { background-color: #dcfce7; color: #166534; }
        .asset-icon-quiz { background-color: #fef9c3; color: #854d0e; }
        .asset-details h5 { margin: 0 0 0.25rem 0; font-weight: 600; color: var(--text-main); }
        .asset-details span { font-size: 0.85rem; color: var(--text-secondary); }
        .empty-state-text { text-align: center; padding: 2rem; color: var(--text-secondary); }
        
        .section-heading { font-size: 1.5rem; font-weight: 700; margin: 0 0 1.5rem 0; padding-bottom: 0.75rem; border-bottom: 1px solid var(--border-color); }
        
        .pro-label { font-size: 0.75rem; font-weight: bold; color: #854d0e; background-color: #fef9c3; padding: 0.2rem 0.6rem; border-radius: 99px; margin-left: 0.5rem; }
        .new-label { font-size: 0.75rem; font-weight: bold; color: #155e75; background-color: #cffafe; padding: 0.2rem 0.6rem; border-radius: 99px; margin-left: 0.5rem; }
        
        .feature-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; }
        .feature-card { background-color: var(--background-card); border: 1px solid var(--border-color); border-radius: 12px; padding: 1.5rem; text-align: left; cursor: pointer; display: flex; flex-direction: column; gap: 1rem; transition: all 0.2s; box-shadow: var(--card-shadow); text-decoration: none; color: var(--text-main); backdrop-filter: blur(8px);}
        .feature-card:hover:not(:disabled) { transform: translateY(-5px) scale(1.02); box-shadow: var(--card-shadow-hover); border-color: var(--primary-color); }
        .feature-icon-wrapper { width: 48px; height: 48px; border-radius: 8px; display: flex; align-items: center; justify-content: center; }
        .feature-text h4 { margin: 0 0 0.25rem 0; font-size: 1.1rem; font-weight: 600; color: var(--text-main); }
        .feature-text p { margin: 0; font-size: 0.9rem; color: var(--text-secondary); line-height: 1.5; font-family: 'Poppins', sans-serif; flex-grow: 1;}
        .feature-arrow-svg { margin-top: auto; align-self: flex-end; color: var(--text-secondary); transition: color 0.2s, transform 0.2s; }
        .feature-card:hover:not(:disabled) .feature-arrow-svg { color: var(--primary-color); transform: translateX(4px); }
        .progress-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; }
        .progress-card { border-radius: 12px; padding: 1.5rem; color: white; position: relative; overflow: hidden; transition: transform 0.2s; box-shadow: var(--card-shadow); }
        .progress-card:hover { transform: translateY(-5px); box-shadow: var(--card-shadow-hover); }
        .progress-card h2 { font-size: 1rem; text-transform: uppercase; letter-spacing: 0.5px; margin: 0 0 0.5rem 0; opacity: 0.8; font-weight: 600; }
        .stat-large { font-size: 3rem; font-weight: 700; }
        .stat-large span { font-size: 1.25rem; font-weight: 500; opacity: 0.7; margin-left: 0.5rem; }
        .xp-card { background: linear-gradient(135deg, #8b5cf6, #6366f1); }
        .streak-card { background: linear-gradient(135deg, #f59e0b, #ef4444); }
        .score-card { background: linear-gradient(135deg, #22c55e, #10b981); }
        .spotlight-card { background: linear-gradient(135deg, #0ea5e9, #2563eb); }
        .spotlight-topic { font-size: 1.5rem; font-weight: 600; margin: 0.5rem 0; }
        .large-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
        .large-grid-card { background-color: var(--background-card); border-radius: 12px; padding: 1.5rem; box-shadow: var(--card-shadow); }
        .large-grid-card h2 { color: var(--text-main); font-size: 1.1rem; font-weight: 600; margin: 0 0 1.5rem 0;}
        .topic-list .topic-item { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; }
        .topic-name { font-weight: 600; }
        .topic-bar-container { flex-grow: 1; height: 10px; background-color: var(--background-interactive-hover); border-radius: 5px; margin: 0 1rem; overflow: hidden; }
        .topic-bar { height: 100%; border-radius: 5px; transition: width 0.5s ease-in-out; }
        .mastery-high { background-color: var(--green); }
        .mastery-mid { background-color: var(--yellow); }
        .mastery-low { background-color: var(--red); }
        .topic-score { font-weight: 700; font-size: 1.1rem; }
        .level-header { display: flex; justify-content: space-between; font-weight: 600; margin-bottom: 0.5rem; }
        .level-bar-container { width: 100%; height: 20px; background-color: var(--primary-light); border-radius: 10px; overflow: hidden; border: 1px solid var(--border-color); }
        .level-bar { height: 100%; border-radius: 10px; background: var(--primary-color); transition: width 0.5s ease-in-out; }
        .recent-activity-card p { margin: 0; font-weight: 500; font-family: 'Poppins', sans-serif;}
        .recent-activity-card strong { color: var(--text-main); }
        .recent-activity-card span { color: var(--text-secondary); }
        .loading-card { display: flex; align-items: center; gap: 1.5rem; padding: 1.5rem; background-color: var(--primary-light); border: 1px solid var(--primary-color); border-radius: 12px; margin-bottom: 2rem; }
        .spinner { border: 4px solid rgba(79, 70, 229, 0.2); border-top: 4px solid var(--primary-color); border-radius: 50%; width: 32px; height: 32px; animation: spin 1s linear infinite; flex-shrink: 0; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading-text h4 { margin: 0 0 0.25rem 0; color: var(--text-main); }
        .loading-text p { margin: 0; color: var(--primary-color); }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(17, 24, 39, 0.8); backdrop-filter: blur(8px); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: var(--background-card); padding: 2rem; border-radius: 12px; width: 90%; max-width: 700px; max-height: 90vh; display: flex; flex-direction: column; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; margin-bottom: 1.5rem; }
        .modal-header h3 { margin: 0; font-family: 'Poppins', sans-serif; }
        .close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-secondary); }
        .modal-body { overflow-y: auto; padding-right: 1rem; }
        .modal-footer { margin-top: 2rem; text-align: right; border-top: 1px solid var(--border-color); padding-top: 1.5rem; }
        .modal-body .form-group { margin-bottom: 1.25rem; }
        .modal-body label, .modal-body .label { font-size: 0.9rem; font-weight: 600; margin-bottom: 0.5rem; display: block; }
        .modal-body input[type="text"], .modal-body input[type="date"], .modal-body input[type="datetime-local"], .modal-body select, .modal-body textarea, .modal-body input[type="file"] { width: 100%; padding: 0.75rem; border-radius: 6px; border: 1px solid var(--border-color); background-color: var(--background-body); color: var(--text-main); box-sizing: border-box; font-family: 'Poppins'; font-size: 0.9rem; }
        .slider-group { display: flex; align-items: center; gap: 1rem; }
        .slider-group input[type="range"] { flex-grow: 1; }
        .slider-group .slider-value { font-weight: 600; min-width: 30px; text-align: center; }
        .modal-body p.modal-description { font-size: 0.9rem; color: var(--text-secondary); margin-top: 0; margin-bottom: 1.5rem; line-height: 1.6; font-family: 'Lora', serif; }
        .modal-file-list { background-color: var(--background-interactive-hover); border: 1px solid var(--border-color); max-height: 250px; overflow-y: auto; border-radius: 8px; padding: 0.75rem; }
        .modal-file-item label { display: flex; width: 100%; align-items: center; gap: 0.75rem; padding: 0.75rem; border-radius: 6px; font-weight: 500; font-family: 'Poppins', sans-serif; font-size: 0.9rem; cursor: pointer; transition: background-color 0.2s, box-shadow 0.2s; }
        .modal-file-item input[type="checkbox"], .modal-file-item input[type="radio"] { width: 1.1rem; height: 1.1rem; flex-shrink: 0; accent-color: var(--primary-color); }
        
        .folder-accordion-item { border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 1rem; }
        .folder-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem; cursor: pointer; }
        .folder-header:hover { background-color: var(--background-interactive-hover); }
        .folder-header-title { display: flex; align-items: center; gap: 1rem; }
        .folder-header-title h5 { margin: 0; font-size: 1.1rem; }
        .folder-header-title span { font-size: 0.9rem; color: var(--text-secondary); }
        .folder-actions { display: flex; align-items: center; gap: 0.5rem; }
        .folder-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; background-color: var(--background-body); }
        .folder-content.open { max-height: 1000px; transition: max-height 0.5s ease-in; }
        .folder-content .asset-list { padding: 1rem; border-top: 1px solid var(--border-color); }
        
        #fullcalendar { min-height: 700px; font-family: 'Poppins', sans-serif; }
        .fc-event { cursor: pointer; border: none !important; padding: 5px 8px; font-weight: 500; }
        .fc-daygrid-day.fc-day-today { background-color: var(--fc-today-bg-color) !important; }
        
        #ai-tutor-panel { display: flex; flex-direction: column; height: 70vh; border: 1px solid var(--border-color); border-radius: 12px; overflow: hidden; background-color: var(--background-body); }
        #tutor-messages-list { flex-grow: 1; overflow-y: auto; padding: 1.5rem; display: flex; flex-direction: column; gap: 1.5rem; }
        .tutor-message { display: flex; gap: 1rem; max-width: 80%; }
        .tutor-message .avatar { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; flex-shrink: 0; }
        .tutor-message .message-content { padding: 0.75rem 1rem; border-radius: 12px; line-height: 1.6; }
        .tutor-message.user-message { align-self: flex-end; flex-direction: row-reverse; }
        .user-message .avatar { background-color: #dcfce7; color: #166534; }
        .user-message .message-content { background-color: var(--primary-color); color: white; border-bottom-right-radius: 2px; }
        .tutor-message.ai-message { align-self: flex-start; }
        .ai-message .avatar { background-color: #e0e7ff; color: #3730a3; }
        .ai-message .message-content { background-color: var(--background-card); color: var(--text-main); border-bottom-left-radius: 2px; }
        #tutor-input-form { display: flex; gap: 1rem; padding: 1rem; border-top: 1px solid var(--border-color); background-color: var(--background-card); }
        #tutor-input-form input { flex-grow: 1; padding: 0.75rem; border-radius: 8px; border: 1px solid var(--border-color); background-color: var(--background-body); color: var(--text-main); font-size: 1rem; }
        #tutor-welcome-message { text-align: center; padding: 4rem 2rem; color: var(--text-secondary); }
        #tutor-welcome-message h3 { font-size: 1.5rem; color: var(--text-main); margin-bottom: 0.5rem; }
        
        /* --- "Stuck on a Question" Modal Styles --- */
        #stuck-question-modal .modal-content {
            max-width: 800px;
            max-height: 90vh;       /* give more space */
            overflow-y: auto;       /* allow vertical scrolling */
        }

        #stuck-question-body {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
         padding: 0;
         overflow-y: auto;       /* allow content scroll */
            min-height: 0;
        }

        #sq-screen-start {
            padding: 2rem;
            text-align: center;
        }
        #sq-upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 3rem;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
            margin-bottom: 1.5rem;
        }
        #sq-upload-area:hover {
            background-color: var(--background-interactive-hover);
            border-color: var(--primary-color);
        }
        #sq-screen-confirm {
            padding: 2rem;
            text-align: center;
        }
        #sq-question-preview {
            background-color: var(--background-body);
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            margin-top: 1rem;
            margin-bottom: 1.5rem;
            text-align: left;
            max-height: 40vh;
            overflow-y: auto;
        }
        #sq-screen-solving {
            display: flex;
            flex-direction: column;
            flex-grow: 1; /* Changed from height: 100% */
        }
        #sq-messages {
            flex-grow: 1;
            overflow-y: auto;
            min-height: 0; /* Prevents the flex item from overflowing its container, enabling scroll */
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }
        .sq-message {
            display: flex;
            gap: 1rem;
            max-width: 90%;
            line-height: 1.6;
        }
        .sq-message.tutor .avatar { background-color: #e0e7ff; color: #3730a3; }
        .sq-message.user .avatar { background-color: #dcfce7; color: #166534; }
        .sq-message .avatar {
            width: 36px; height: 36px; border-radius: 50%; flex-shrink: 0;
            display: flex; align-items: center; justify-content: center; font-weight: 600;
        }
        .sq-message .content {
            padding: 0.75rem 1rem; border-radius: 12px;
            background-color: var(--background-body);
            border: 1px solid var(--border-color);
        }
        .sq-message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }
        .sq-message.user .content {
            background-color: var(--primary-light);
            border-color: var(--primary-color);
        }
        .sq-message.system {
            align-self: center;
            max-width: 100%;
            text-align: center;
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-style: italic;
        }
        .sq-message.system .content {
            background-color: transparent; border: none; padding: 0;
        }
        #sq-input-container {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border-color);
            background-color: var(--background-card);
        }
        #sq-actions, #sq-practice-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }
         #sq-clarification-form {
            display: none; /* Initially hidden */
            margin-top: 1rem;
        }
        #sq-practice-form {
            display: none; /* Initially hidden */
        }
        .sq-message pre {
            background-color: var(--background-interactive-hover);
            padding: 1rem;
            border-radius: 8px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .sq-message code {
            font-family: 'Courier New', Courier, monospace;
        }
        
        /* === MODIFIED STYLES FOR TOOL CATEGORY BUTTONS === */
        .tool-category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
        }
        .tool-category-button {
            position: relative;
            border: 1px solid transparent;
            border-radius: 12px;
            padding: 2rem 2rem 5.5rem 2rem; /* Increased vertical padding */
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            transition: all 0.2s ease-in-out;
            box-shadow: var(--card-shadow);
            cursor: pointer;
            overflow: hidden; /* Important for gradients */
        }
        .tool-category-button:hover {
            transform: translateY(-5px);
            box-shadow: var(--card-shadow-hover);
        }
        /* Gradient for "In a Lecture" */
        .tool-category-button[data-target="in-lecture-tools"] {
            background-image: linear-gradient(135deg, #f8b195 0%, #f67280 100%);
            color: #ffffff;
            position: relative;
            overflow: hidden;
        }
        
        
        
        /* Gradient for "Revision & Exams" */
        .tool-category-button[data-target="revision-exams-tools"] {
            background-image: linear-gradient(135deg, #3bb78f 0%, #0bab64 100%);
            color: #ffffff;
        }
        .tool-category-header {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }
        .tool-category-icon {
            width: 56px;
            height: 56px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            background-color: rgba(255, 255, 255, 0.15); /* Semi-transparent background for icons */
        }
        .tool-category-title h3 {
            margin: 0;
            font-size: 1.75rem; /* Larger text */
            font-weight: 700;
            color: inherit;
        }
        .tool-category-description {
            font-size: 1.1rem; /* Larger text */
            color: inherit;
            opacity: 0.9;
            line-height: 1.6;
            font-family: 'Lora', serif;
        }
        .tool-category-cta {
            position: absolute;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.2);
            padding: 0.6rem 1.5rem;
            border-radius: 99px;
            font-weight: 600;
            font-size: 1rem;
            font-family: 'Poppins', sans-serif;
            color: inherit;
            border: 1px solid rgba(255, 255, 255, 0.3);
            white-space: nowrap;
        }
        .tool-category-back-button {
            margin-bottom: 2rem;
        }

        /* Back to Dashboard Button in Navigation */
        .nav-link.back-to-dashboard {
            background: var(--primary-color) !important;
            color: white !important;
            border: 1px solid var(--primary-color) !important;
            margin-top: 0.5rem;
        }
        .nav-link.back-to-dashboard:hover {
            background: var(--primary-hover) !important;
            border-color: var(--primary-hover) !important;
            color: white !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }
        .nav-link.back-to-dashboard .nav-icon {
            color: white;
        }

        /* Task Queue Styles */
        .task-queue-section {
            margin: 1rem 0;
            padding: 1rem;
            background: var(--background-interactive);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        .task-queue-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        .task-queue-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-main);
            margin: 0;
        }
        .task-count {
            font-size: 0.75rem;
            color: var(--text-secondary);
            background: var(--background-card);
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
        }
        .task-queue-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .task-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: var(--background-card);
            border-radius: 6px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .task-item:hover {
            background: var(--background-interactive-hover);
            border-color: var(--primary-color);
        }
        .task-item.completed {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border-color: #10b981;
            color: white;
            animation: glow 2s ease-in-out infinite alternate;
        }
        .task-item.completed:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        .task-item.processing {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border-color: #3b82f6;
            color: white;
        }
        .task-item.queued {
            background: var(--background-card);
            border-color: var(--border-color);
            color: var(--text-secondary);
        }
        .task-icon {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }
        .task-content {
            flex: 1;
            min-width: 0;
        }
        .task-title {
            font-size: 0.8rem;
            font-weight: 500;
            margin: 0 0 0.25rem 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .task-status {
            font-size: 0.7rem;
            opacity: 0.8;
            margin: 0;
        }
        .task-progress {
            width: 100%;
            height: 3px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 0.5rem;
        }
        .task-progress-bar {
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 2px;
            transition: width 0.3s ease;
            width: 0%;
        }
        .task-item.completed .task-progress-bar {
            width: 100%;
        }
        
        @keyframes glow {
            from { box-shadow: 0 0 5px rgba(16, 185, 129, 0.5); }
            to { box-shadow: 0 0 20px rgba(16, 185, 129, 0.8); }
        }
        
        /* Collapsed state for task queue */
        .sidebar.collapsed .task-queue-section {
            padding: 0.5rem;
        }

        /* --- Favourites Section Styles --- */
        .favourites-section {
            margin-bottom: 0.5rem;
        }

        .favourites-toggle {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem 1rem 0.75rem 1rem;
            text-decoration: none;
            color: var(--text-secondary);
            font-weight: 500;
            border-radius: 8px;
            margin-bottom: 0.25rem;
            white-space: nowrap;
            transition: background-color 0.2s, color 0.2s;
            cursor: pointer;
            background-color: transparent;
            border: none;
            width: 100%;
            position: relative;
            box-sizing: border-box;
        }

        .favourites-toggle:hover {
            background-color: var(--background-interactive-hover);
            color: var(--text-main);
        }

        .favourites-toggle .nav-icon {
            flex-shrink: 0;
            width: 24px; height: 24px;
        }

        .favourites-toggle .nav-text {
            opacity: 1;
            transition: opacity 0.2s ease;
        }

        .favourites-toggle .favourites-arrow {
            margin-left: auto;
            margin-right: 0.5rem;
            width: 18px;
            height: 18px;
            transition: all 0.2s ease;
            opacity: 0.7;
            color: var(--text-secondary);
            flex-shrink: 0;
        }

        .favourites-toggle:hover .favourites-arrow {
            opacity: 1;
            color: var(--text-main);
        }


        .favourites-section.expanded .favourites-toggle .favourites-arrow {
            transform: rotate(180deg);
            opacity: 1;
            color: var(--primary-color);
        }

        .favourites-dropdown {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background-color: var(--background-interactive);
            border-radius: 8px;
            margin-top: 0.25rem;
            opacity: 0;
            visibility: hidden;
        }

        .favourites-section.expanded .favourites-dropdown {
            max-height: 400px;
            opacity: 1;
            visibility: visible;
        }

        .favourites-content {
            padding: 0.5rem;
        }

        .favourite-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem;
            margin-bottom: 0.25rem;
            background-color: var(--background-card);
            border-radius: 6px;
            transition: background-color 0.2s;
            cursor: pointer;
        }

        .favourite-item:hover {
            background-color: var(--background-interactive-hover);
        }

        .favourite-item .favourite-icon {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        .favourite-item .favourite-name {
            flex-grow: 1;
            font-size: 0.9rem;
            color: var(--text-main);
        }

        .favourite-item .favourite-remove {
            width: 16px;
            height: 16px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: color 0.2s;
        }

        .favourite-item .favourite-remove:hover {
            color: var(--red);
        }

        .favourites-actions {
            padding: 0.5rem;
            border-top: 1px solid var(--border-color);
        }

        .favourites-help-text {
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-align: center;
            padding: 0.5rem;
            line-height: 1.3;
        }

        .favourites-empty {
            text-align: center;
            padding: 1rem;
            color: var(--text-secondary);
            font-style: italic;
            font-size: 0.85rem;
        }

        /* Collapsed state for favourites */
        .sidebar.collapsed .favourites-toggle {
            justify-content: center;
            padding: 0.75rem;
        }

        .sidebar.collapsed .favourites-toggle .nav-text {
            opacity: 0;
            pointer-events: none;
            width: 0;
            overflow: hidden;
        }

        .sidebar.collapsed .favourites-toggle .favourites-arrow {
            display: none;
        }

        .sidebar.collapsed .favourites-dropdown {
            display: none;
        }

        /* Hover Star Styles */
        .tool-favourite-star {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            width: 24px;
            height: 24px;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.2s ease;
            cursor: pointer;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .feature-card {
            position: relative;
        }

        .feature-card:hover .tool-favourite-star {
            opacity: 1;
        }

        .tool-favourite-star:hover {
            transform: scale(1.1);
            background-color: #ffd700;
        }

        .tool-favourite-star.favourited {
            opacity: 1;
            background-color: #ffd700;
        }

        .tool-favourite-star svg {
            width: 14px;
            height: 14px;
            color: #666;
            transition: color 0.2s ease;
        }

        .tool-favourite-star:hover svg,
        .tool-favourite-star.favourited svg {
            color: #ff6b35;
        }

        .selected-tools-info .selected-count {
            color: var(--primary-color);
            font-weight: 600;
        }
        .sidebar.collapsed .task-queue-header {
            flex-direction: column;
            gap: 0.25rem;
        }
        .sidebar.collapsed .task-queue-title {
            font-size: 0.75rem;
        }
        .sidebar.collapsed .task-count {
            font-size: 0.7rem;
        }
        .sidebar.collapsed .task-item {
            padding: 0.5rem;
            justify-content: center;
        }
        .sidebar.collapsed .task-content {
            display: none;
        }
        .sidebar.collapsed .task-icon {
            width: 16px;
            height: 16px;
        }

        /* --- IMPROVED SPOTIFY PLAYER CSS --- */
        #spotify-player-container {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 380px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 16px;
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.2);
            padding: 1.5rem;
            z-index: 1001;
            transform: translateY(calc(100% + 2rem));
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            backdrop-filter: blur(10px);
        }
        #spotify-player-container.visible {
            transform: translateY(0);
        }
        
        .sp-track-info { 
            display: flex; 
            align-items: center; 
            gap: 1rem; 
            margin-bottom: 1rem; 
        }
        
        .sp-album-art { 
            width: 70px; 
            height: 70px; 
            border-radius: 12px; 
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            object-fit: cover;
        }
        
        .sp-track-details { 
            flex-grow: 1; 
            min-width: 0; 
            color: white;
        }
        
        .sp-track-title { 
            font-weight: 600; 
            margin: 0; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }
        
        .sp-track-artist { 
            font-size: 0.9rem; 
            color: rgba(255, 255, 255, 0.8); 
            margin: 0.25rem 0 0; 
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }
        
        .sp-progress-bar { 
            width: 100%; 
            height: 6px; 
            background: rgba(255, 255, 255, 0.3); 
            border-radius: 3px; 
            cursor: pointer; 
            margin-bottom: 1rem;
        }
        
        .sp-progress { 
            height: 100%; 
            width: 0%; 
            background: white; 
            border-radius: 3px; 
            transition: width 0.1s ease;
        }
        
        .sp-controls { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 1rem;
        }
        
        .sp-main-controls { 
            display: flex; 
            align-items: center; 
            gap: 0.75rem; 
        }
        
        .sp-main-controls button { 
            background: rgba(255, 255, 255, 0.2); 
            border: none; 
            cursor: pointer; 
            color: white; 
            padding: 0.5rem; 
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
        }
        
        .sp-main-controls button:hover { 
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }
        
        .sp-play-btn { 
            background: white !important; 
            color: #333 !important; 
            width: 48px !important;
            height: 48px !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .sp-play-btn:hover { 
            background: #f0f0f0 !important;
            transform: scale(1.05);
        }
        
        .sp-volume-control { 
            display: flex; 
            align-items: center; 
            gap: 0.5rem; 
            color: white;
        }
        
        .sp-volume-control svg {
            color: rgba(255, 255, 255, 0.8);
        }
        
        .sp-volume-control input[type=range] { 
            width: 80px; 
            background: transparent;
        }
        
        .sp-playlist-select { 
            margin-top: 1rem; 
            width: 100%; 
            padding: 0.75rem; 
            border-radius: 8px; 
            border: 1px solid rgba(255, 255, 255, 0.2); 
            background: rgba(255, 255, 255, 0.1); 
            color: white; 
            backdrop-filter: blur(10px);
        }
        
        .sp-playlist-select option {
            background: #333;
            color: white;
        }
        
        /* Dynamic background colors based on album art */
        .sp-player-bg-purple { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .sp-player-bg-blue { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .sp-player-bg-pink { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
        .sp-player-bg-green { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); }
        .sp-player-bg-orange { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); }
        .sp-player-bg-red { background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); }
        
/* Onboarding specific styles */
        /* Onboarding Spotlight */
        #onboarding-spotlight-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background-color: rgba(17, 24, 39, 0.8); backdrop-filter: blur(4px); 
            z-index: 1002; pointer-events: none; opacity: 0; 
            transition: opacity 0.5s ease; 
        }
        #onboarding-spotlight-overlay.visible { opacity: 1; }
        
        #onboarding-tooltip { 
            position: fixed; z-index: 1003; background-color: var(--background-card); 
            color: var(--text-main); padding: 1rem 1.5rem; border-radius: 12px; 
            box-shadow: var(--card-shadow-hover); max-width: 300px; font-weight: 500; 
            font-size: 0.95rem; line-height: 1.6; opacity: 0; transform: translateY(10px); 
            transition: all 0.3s ease; pointer-events: none; 
        }
        #onboarding-tooltip.visible { opacity: 1; transform: translateY(0); }
        #onboarding-tooltip.right.visible { 
            opacity: 1; 
            transform: translateY(-50%); 
            pointer-events: auto; 
        }
        #onboarding-tooltip.left.visible { 
            opacity: 1; 
            transform: translateY(-50%); 
            pointer-events: auto; 
        }
        
        /* Completion Modal */
        #onboarding-completion-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 1006;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.6s ease;
        }
        #onboarding-completion-modal.visible {
            opacity: 1;
            visibility: visible;
        }
        .completion-content {
            background: white;
            border-radius: 20px;
            padding: 3rem;
            max-width: 600px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            transform: scale(0.9);
            transition: transform 0.6s ease;
        }
        #onboarding-completion-modal.visible .completion-content {
            transform: scale(1);
        }
        .completion-content h1 {
            font-size: 2.5rem;
            font-weight: 900;
            margin: 0 0 1.5rem 0;
            color: var(--text-main);
        }
        .completion-content p {
            font-size: 1.1rem;
            color: var(--text-secondary);
            margin: 0 0 2rem 0;
            line-height: 1.6;
        }
        .completion-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .onboarding-highlight { 
            position: relative; z-index: 1003; pointer-events: auto !important; 
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.3); border-radius: 8px; 
        }

        /* Study Hub Intro Modal */
        #onboarding-hub-intro-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 1004; display: flex; align-items: center; justify-content: center;
            opacity: 0; visibility: hidden; transition: all 0.6s ease;
        }
        #onboarding-hub-intro-modal.visible { opacity: 1; visibility: visible; }
        
        .hub-intro-content {
            text-align: center; color: white; max-width: 600px; padding: 2rem;
        }
        .hub-intro-content h1 {
            font-size: 3rem; font-weight: 900; margin: 0 0 1rem 0;
        }
        .hub-intro-content p {
            font-size: 1.2rem; margin: 0 0 2rem 0; opacity: 0.9;
        }
        #onboarding-hub-continue-btn {
            background: linear-gradient(45deg, #10b981, #34d399); color: white;
            border: none; padding: 1rem 2.5rem; font-size: 1.2rem; font-weight: 600;
            border-radius: 50px; cursor: pointer; transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
        }
        #onboarding-hub-continue-btn:hover {
            transform: translateY(-2px); box-shadow: 0 12px 35px rgba(16, 185, 129, 0.4);
        }

        /* AI Tutor Modal */
        #onboarding-tutor-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(10px);
            z-index: 1005; display: flex; align-items: center; justify-content: center;
            opacity: 0; visibility: hidden; transition: all 0.4s ease;
        }
        #onboarding-tutor-modal.visible { opacity: 1; visibility: visible; }
        
        .tutor-intro-content {
            background: white; border-radius: 20px; padding: 3rem; max-width: 500px;
            width: 90%; text-align: center; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
        }
        .tutor-intro-content h1 {
            font-size: 2rem; font-weight: 700; margin: 0 0 1rem 0; color: var(--text-main);
        }
        .tutor-intro-content p {
            color: var(--text-secondary); margin: 0 0 2rem 0; font-size: 1.1rem;
        }
        .tutor-demo-area {
            background: #f8f9fa; border-radius: 12px; padding: 1.5rem; margin: 2rem 0;
        }
        .demo-chat {
            text-align: left;
        }
        .demo-message {
            margin: 1rem 0; padding: 0.75rem 1rem; border-radius: 8px;
        }
        .demo-message.user-message {
            background: #e3f2fd; border-left: 4px solid #2196f3;
        }
        .demo-message.ai-message {
            background: #f3e5f5; border-left: 4px solid #9c27b0;
        }
        #onboarding-tutor-continue-btn {
            background: linear-gradient(45deg, #ff6b6b, #ff8e8e); color: white;
            border: none; padding: 1rem 2rem; font-size: 1.1rem; font-weight: 600;
            border-radius: 50px; cursor: pointer; transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.3);
        }
        #onboarding-tutor-continue-btn:hover {
            transform: translateY(-2px); box-shadow: 0 12px 35px rgba(255, 107, 107, 0.4);
        }


        /* Edit functionality styles */
        .edit-button {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
            transition: all 0.2s ease;
            opacity: 0;
            margin-left: 0.5rem;
        }
        
        .asset-item:hover .edit-button,
        .folder-header:hover .edit-button {
            opacity: 1;
        }
        
        .edit-button:hover {
            color: var(--primary-color);
            background-color: var(--background-interactive-hover);
        }
        
        .delete-button {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            opacity: 0;
            margin-left: 0.5rem;
        }
        
        .asset-item:hover .delete-button {
            opacity: 1;
        }
        
        .delete-button:hover {
            color: #dc2626;
            background-color: #fef2f2;
        }
        
        .edit-input {
            background: var(--background-white);
            border: 2px solid var(--primary-color);
            border-radius: 4px;
            padding: 0.25rem 0.5rem;
            font-size: inherit;
            font-weight: inherit;
            color: var(--text-main);
            width: 100%;
            max-width: 300px;
        }
        
        .edit-input:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .edit-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .edit-save-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .edit-save-btn:hover {
            background: var(--primary-dark);
        }
        
        .edit-cancel-btn {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .edit-cancel-btn:hover {
            background: var(--background-interactive-hover);
        }

        /* Success Modal Styles */
        .success-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(8px);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .success-modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .success-modal-content {
            background: var(--background-card);
            border-radius: 20px;
            padding: 2rem;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            transform: scale(0.8) translateY(20px);
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            max-width: 400px;
            width: 90%;
        }

        .success-modal-overlay.visible .success-modal-content {
            transform: scale(1) translateY(0);
        }

        .success-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            animation: successBounce 0.6s ease-out;
        }

        .success-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-main);
            margin-bottom: 0.5rem;
            animation: slideInUp 0.5s ease-out 0.2s both;
        }

        .success-message {
            color: var(--text-secondary);
            font-size: 1rem;
            margin-bottom: 1.5rem;
            animation: slideInUp 0.5s ease-out 0.3s both;
        }

        .success-button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            animation: slideInUp 0.5s ease-out 0.4s both;
        }

        .success-button:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.3);
        }

        /* Animations */
        @keyframes successBounce {
            0% {
                transform: scale(0);
                opacity: 0;
            }
            50% {
                transform: scale(1.2);
                opacity: 1;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes slideInUp {
            0% {
                transform: translateY(20px);
                opacity: 0;
            }
            100% {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Pulse animation for the checkmark */
        .success-icon::before {
            content: "";
            display: inline-block;
            animation: pulse 1s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
        }
        .universal-notification-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .universal-notification-modal.visible {
            opacity: 1;
        }
        
        .universal-notification-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            max-width: 400px;
            width: 90%;
            transform: scale(0.9);
            transition: transform 0.3s ease;
            overflow: hidden;
        }
        
        .universal-notification-modal.visible .universal-notification-content {
            transform: scale(1);
        }
        
        .universal-notification-header {
            display: flex;
            align-items: center;
            padding: 1.5rem 1.5rem 1rem 1.5rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .universal-notification-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
            flex-shrink: 0;
        }
        
        .universal-notification-content.success .universal-notification-icon {
            background-color: #dcfce7;
            color: #166534;
        }
        
        .universal-notification-content.error .universal-notification-icon {
            background-color: #fee2e2;
            color: #dc2626;
        }
        
        .universal-notification-content.warning .universal-notification-icon {
            background-color: #fef3c7;
            color: #d97706;
        }
        
        .universal-notification-content.info .universal-notification-icon {
            background-color: #dbeafe;
            color: #2563eb;
        }
        
        .universal-notification-content.confirm .universal-notification-icon {
            background-color: #f3e8ff;
            color: #7c3aed;
        }
        
        .universal-notification-title {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
            flex-grow: 1;
        }
        
        .universal-notification-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #6b7280;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
            transition: color 0.2s, background-color 0.2s;
        }
        
        .universal-notification-close:hover {
            color: #374151;
            background-color: #f3f4f6;
        }
        
        .universal-notification-body {
            padding: 0 1.5rem 1rem 1.5rem;
        }
        
        .universal-notification-body p {
            margin: 0;
            color: #4b5563;
            line-height: 1.5;
        }
        
        .universal-notification-footer {
            padding: 1rem 1.5rem 1.5rem 1.5rem;
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
        }
        
        .universal-notification-footer .button {
            min-width: 80px;
        }

        /* ===== COMPREHENSIVE ANIMATION SYSTEM ===== */
        
        /* Button Click Animations */
        @keyframes buttonClick {
            0% { transform: scale(1); }
            50% { transform: scale(0.95); }
            100% { transform: scale(1); }
        }
        
        @keyframes buttonSparkle {
            0% { opacity: 0; transform: scale(0) rotate(0deg); }
            50% { opacity: 1; transform: scale(1) rotate(180deg); }
            100% { opacity: 0; transform: scale(0) rotate(360deg); }
        }
        
        @keyframes buttonRipple {
            0% { transform: scale(0); opacity: 1; }
            100% { transform: scale(4); opacity: 0; }
        }

        /* Card Hover Animations */
        @keyframes cardFloat {
            0% { transform: translateY(0px); }
            100% { transform: translateY(-4px); }
        }
        
        @keyframes cardGlow {
            0% { box-shadow: var(--card-shadow); }
            100% { box-shadow: var(--card-shadow-hover); }
        }

        /* Loading Animations */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes bounce {
            0%, 20%, 53%, 80%, 100% { transform: translateY(0); }
            40%, 43% { transform: translateY(-8px); }
            70% { transform: translateY(-4px); }
            90% { transform: translateY(-2px); }
        }

        /* Success Animations */
        @keyframes successPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        @keyframes confetti {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(-100px) rotate(360deg); opacity: 0; }
        }
        
        @keyframes checkmark {
            0% { stroke-dashoffset: 100; }
            100% { stroke-dashoffset: 0; }
        }

        /* Form Animations */
        @keyframes inputFocus {
            0% { transform: scale(1); }
            100% { transform: scale(1.02); }
        }
        
        @keyframes inputShake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-2px); }
            20%, 40%, 60%, 80% { transform: translateX(2px); }
        }

        /* Navigation Animations */
        @keyframes slideInFromLeft {
            0% { transform: translateX(-100%); opacity: 0; }
            100% { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideInFromRight {
            0% { transform: translateX(100%); opacity: 0; }
            100% { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes fadeInUp {
            0% { transform: translateY(20px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }

        /* Sparkle Animation */
        @keyframes sparkle {
            0%, 100% { opacity: 0; transform: scale(0) rotate(0deg); }
            50% { opacity: 1; transform: scale(1) rotate(180deg); }
        }

        /* Celebration Animations */
        @keyframes confettiFall {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }
        }
        
        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        @keyframes wiggle {
            0%, 7%, 14%, 21%, 28%, 35%, 42%, 49%, 56%, 63%, 70%, 77%, 84%, 91%, 100% { transform: rotate(0deg); }
            3.5% { transform: rotate(5deg); }
            10.5% { transform: rotate(-5deg); }
            17.5% { transform: rotate(3deg); }
            24.5% { transform: rotate(-3deg); }
            31.5% { transform: rotate(2deg); }
            38.5% { transform: rotate(-2deg); }
            45.5% { transform: rotate(1deg); }
            52.5% { transform: rotate(-1deg); }
            59.5% { transform: rotate(0.5deg); }
            66.5% { transform: rotate(-0.5deg); }
            73.5% { transform: rotate(0.2deg); }
            80.5% { transform: rotate(-0.2deg); }
            87.5% { transform: rotate(0.1deg); }
            94.5% { transform: rotate(-0.1deg); }
        }

        /* Loading Shimmer */
        @keyframes loadingShimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        /* ===== ANIMATION CLASSES ===== */
        
        .animate-fade-in {
            animation: fadeInUp 0.6s ease forwards;
        }
        
        .animate-slide-left {
            animation: slideInFromLeft 0.6s ease forwards;
        }
        
        .animate-slide-right {
            animation: slideInFromRight 0.6s ease forwards;
        }
        
        .animate-bounce {
            animation: bounce 1s ease;
        }
        
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        
        .celebrate {
            animation: bounceIn 0.8s ease;
        }
        
        .wiggle {
            animation: wiggle 1s ease;
        }
        
        .confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
            overflow: hidden;
        }
        
        .confetti-piece {
            position: absolute;
            width: 10px;
            height: 10px;
            background: var(--primary-color);
            animation: confettiFall 3s linear forwards;
        }

        /* ===== ENHANCED BUTTON ANIMATIONS ===== */
        
        .button {
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .button:hover::before {
            width: 300px;
            height: 300px;
        }
        
        .button.clicked {
            animation: buttonClick 0.3s ease;
        }
        
        .button.success {
            animation: successPulse 0.6s ease;
        }
        
        .button:hover {
            transform: translateY(-2px);
            box-shadow: var(--card-shadow-hover);
        }
        
        .button:active {
            transform: translateY(0);
            transition: transform 0.1s ease;
        }

        /* ===== ENHANCED CARD ANIMATIONS ===== */
        
        .hub-card, .content-card, .file-item-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .hub-card::before, .content-card::before, .file-item-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: left 0.5s;
        }
        
        .hub-card:hover::before, .content-card:hover::before, .file-item-card:hover::before {
            left: 100%;
        }
        
        .hub-card:hover, .content-card:hover, .file-item-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--card-shadow-hover);
        }

        /* ===== ENHANCED FORM ANIMATIONS ===== */
        
        .form-group input, .form-group textarea, .form-group select {
            transition: all 0.3s ease;
            position: relative;
        }
        
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            animation: inputFocus 0.3s ease;
            transform: scale(1.02);
        }
        
        .form-group input.error, .form-group textarea.error, .form-group select.error {
            border-color: var(--danger-color);
            animation: inputShake 0.5s ease;
        }
        
        .form-group input.success, .form-group textarea.success, .form-group select.success {
            border-color: var(--success-color);
            animation: successPulse 0.6s ease;
        }
        
        .form-group input.loading {
            background: linear-gradient(90deg, #f3f4f6 25%, #e5e7eb 50%, #f3f4f6 75%);
            background-size: 200% 100%;
            animation: loadingShimmer 1.5s infinite;
        }

        /* ===== LOADING SPINNER ===== */
        
        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #f3f4f6;
            border-top: 2px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s ease-in-out infinite;
        }
        
        .loading-spinner.large {
            width: 40px;
            height: 40px;
            border-width: 4px;
        }

        /* ===== SUCCESS CHECKMARK ===== */
        
        .success-checkmark {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: inline-block;
            stroke-width: 2;
            stroke: #22c55e;
            stroke-miterlimit: 10;
            box-shadow: inset 0px 0px 0px #22c55e;
            animation: successPulse 0.6s ease;
        }
        
        .success-checkmark circle {
            stroke-dasharray: 166;
            stroke-dashoffset: 166;
            stroke-width: 2;
            stroke-miterlimit: 10;
            stroke: #22c55e;
            fill: none;
            animation: checkmark 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
        }
        
        .success-checkmark path {
            transform-origin: 50% 50%;
            stroke-dasharray: 48;
            stroke-dashoffset: 48;
            animation: checkmark 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards;
        }

        /* ===== SPARKLE EFFECTS ===== */
        
        .sparkle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #fbbf24;
            border-radius: 50%;
            animation: sparkle 1s ease-in-out infinite;
        }
        
        .sparkle:nth-child(1) { top: 20%; left: 20%; animation-delay: 0s; }
        .sparkle:nth-child(2) { top: 80%; left: 80%; animation-delay: 0.2s; }
        .sparkle:nth-child(3) { top: 40%; left: 70%; animation-delay: 0.4s; }
        .sparkle:nth-child(4) { top: 70%; left: 30%; animation-delay: 0.6s; }
        .sparkle:nth-child(5) { top: 10%; left: 60%; animation-delay: 0.8s; }
    </style>

    <!-- Custom Modal Functions -->
    <script>
        // Custom confirmation and alert modals
        let confirmationCallback = null;
        let confirmationData = null;

        function getEmojiForMessage(message) {
            const msg = message.toLowerCase();
            if (msg.includes('delete') || msg.includes('remove')) return '';
            if (msg.includes('upload') || msg.includes('ready')) return '';
            if (msg.includes('error') || msg.includes('failed')) return '';
            if (msg.includes('warning') || msg.includes('careful')) return '';
            if (msg.includes('success') || msg.includes('complete')) return '';
            if (msg.includes('info') || msg.includes('information')) return '';
            if (msg.includes('question') || msg.includes('ask')) return '';
            if (msg.includes('pro') || msg.includes('upgrade')) return '';
            if (msg.includes('password') || msg.includes('security')) return '';
            if (msg.includes('calendar') || msg.includes('schedule')) return '';
            if (msg.includes('study') || msg.includes('learn')) return '';
            if (msg.includes('file') || msg.includes('document')) return '';
            if (msg.includes('flashcard') || msg.includes('quiz')) return '';
            return ''; // Default
        }

        function showCustomConfirmation(message, callback, data = null, buttonText = 'Confirm') {
            // Wait for DOM to be ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => showCustomConfirmation(message, callback, data, buttonText));
                return;
            }
            
            const emoji = getEmojiForMessage(message);
            const confirmationModal = document.getElementById('custom-confirmation-modal');
            const confirmationTitle = document.getElementById('confirmation-title');
            const confirmationMessage = document.getElementById('confirmation-message');
            const confirmActionBtn = document.getElementById('confirm-action-btn');
            
            if (!confirmationModal || !confirmationTitle || !confirmationMessage || !confirmActionBtn) {
                console.error('Modal elements not found');
                return;
            }
            
            confirmationTitle.textContent = `${emoji} Are you sure?`;
            confirmationMessage.textContent = message;
            confirmActionBtn.textContent = buttonText;
            confirmationCallback = callback;
            confirmationData = data;
            confirmationModal.style.display = 'flex';
        }

        function showCustomAlert(message, title = 'Information') {
            // Wait for DOM to be ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => showCustomAlert(message, title));
                return;
            }
            
            const emoji = getEmojiForMessage(message);
            const alertModal = document.getElementById('custom-alert-modal');
            const alertTitle = document.getElementById('alert-title');
            const alertMessage = document.getElementById('alert-message');
            
            if (!alertModal || !alertTitle || !alertMessage) {
                console.error('Alert modal elements not found');
                return;
            }
            
            alertTitle.textContent = `${emoji} ${title}`;
            alertMessage.textContent = message;
            alertModal.style.display = 'flex';
        }

        function closeCustomModal() {
            document.getElementById('custom-confirmation-modal').style.display = 'none';
            confirmationCallback = null;
            confirmationData = null;
        }

        function closeCustomAlert() {
            document.getElementById('custom-alert-modal').style.display = 'none';
        }

        function confirmAction() {
            if (confirmationCallback) {
                confirmationCallback(confirmationData);
            }
            closeCustomModal();
        }

        // ===== COMPREHENSIVE ANIMATION SYSTEM =====
        
        // Button click animations
        function addButtonClickAnimation(button) {
            button.addEventListener('click', function(e) {
                // Add click animation class
                this.classList.add('clicked');
                
                // Create ripple effect
                createRippleEffect(this, e);
                
                // Create sparkle effect
                createSparkleEffect(this);
                
                // Remove animation class after animation completes
                setTimeout(() => {
                    this.classList.remove('clicked');
                }, 300);
            });
        }
        
        // Ripple effect for buttons
        function createRippleEffect(button, event) {
            const ripple = document.createElement('span');
            const rect = button.getBoundingClientRect();
            const size = Math.max(rect.width, rect.height);
            const x = event.clientX - rect.left - size / 2;
            const y = event.clientY - rect.top - size / 2;
            
            ripple.style.width = ripple.style.height = size + 'px';
            ripple.style.left = x + 'px';
            ripple.style.top = y + 'px';
            ripple.style.position = 'absolute';
            ripple.style.borderRadius = '50%';
            ripple.style.background = 'rgba(255, 255, 255, 0.6)';
            ripple.style.transform = 'scale(0)';
            ripple.style.animation = 'buttonRipple 0.6s linear';
            ripple.style.pointerEvents = 'none';
            
            button.appendChild(ripple);
            
            setTimeout(() => {
                ripple.remove();
            }, 600);
        }
        
        // Sparkle effect for buttons
        function createSparkleEffect(element) {
            const sparkleContainer = document.createElement('div');
            sparkleContainer.style.position = 'absolute';
            sparkleContainer.style.top = '0';
            sparkleContainer.style.left = '0';
            sparkleContainer.style.width = '100%';
            sparkleContainer.style.height = '100%';
            sparkleContainer.style.pointerEvents = 'none';
            sparkleContainer.style.overflow = 'hidden';
            
            // Create 5 sparkles
            for (let i = 0; i < 5; i++) {
                const sparkle = document.createElement('div');
                sparkle.className = 'sparkle';
                sparkle.style.left = Math.random() * 100 + '%';
                sparkle.style.top = Math.random() * 100 + '%';
                sparkle.style.animationDelay = Math.random() * 0.5 + 's';
                sparkleContainer.appendChild(sparkle);
            }
            
            element.appendChild(sparkleContainer);
            
            setTimeout(() => {
                sparkleContainer.remove();
            }, 1000);
        }
        
        // Card hover animations
        function addCardHoverAnimations() {
            const cards = document.querySelectorAll('.hub-card, .content-card, .file-item-card, .feature-card');
            cards.forEach(card => {
                card.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-4px)';
                    this.style.boxShadow = 'var(--card-shadow-hover)';
                });
                
                card.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0)';
                    this.style.boxShadow = 'var(--card-shadow)';
                });
            });
        }
        
        // Form input animations
        function addFormAnimations() {
            const inputs = document.querySelectorAll('input, textarea, select');
            inputs.forEach(input => {
                input.addEventListener('focus', function() {
                    this.classList.add('focus');
                    this.style.transform = 'scale(1.02)';
                });
                
                input.addEventListener('blur', function() {
                    this.classList.remove('focus');
                    this.style.transform = 'scale(1)';
                });
                
                input.addEventListener('invalid', function() {
                    this.classList.add('error');
                    this.classList.add('animate-shake');
                    setTimeout(() => {
                        this.classList.remove('animate-shake');
                    }, 500);
                });
            });
        }
        
        // Loading animations
        function showLoadingAnimation(element, text = 'Loading...') {
            const originalContent = element.innerHTML;
            element.innerHTML = `
                <div class="loading-spinner"></div>
                <span style="margin-left: 0.5rem;">${text}</span>
            `;
            element.disabled = true;
            element.classList.add('loading');
            
            return () => {
                element.innerHTML = originalContent;
                element.disabled = false;
                element.classList.remove('loading');
            };
        }
        
        // Success animation
        function showSuccessAnimation(element, duration = 2000) {
            const originalContent = element.innerHTML;
            element.innerHTML = `
                <svg class="success-checkmark" viewBox="0 0 52 52">
                    <circle class="success-checkmark-circle" cx="26" cy="26" r="25" fill="none"/>
                    <path class="success-checkmark-check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
                </svg>
                <span style="margin-left: 0.5rem;">Success!</span>
            `;
            element.classList.add('success');
            
            setTimeout(() => {
                element.innerHTML = originalContent;
                element.classList.remove('success');
            }, duration);
        }
        
        // Celebration effects
        function createConfetti() {
            const confettiContainer = document.createElement('div');
            confettiContainer.className = 'confetti-container';
            
            const colors = ['#4f46e5', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'];
            
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti-piece';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = Math.random() * 3 + 's';
                confetti.style.animationDuration = (Math.random() * 3 + 2) + 's';
                confettiContainer.appendChild(confetti);
            }
            
            document.body.appendChild(confettiContainer);
            
            setTimeout(() => {
                confettiContainer.remove();
            }, 5000);
        }
        
        // Wiggle animation
        function addWiggleAnimation(element) {
            element.classList.add('wiggle');
            setTimeout(() => {
                element.classList.remove('wiggle');
            }, 1000);
        }
        
        // Bounce animation
        function addBounceAnimation(element) {
            element.classList.add('animate-bounce');
            setTimeout(() => {
                element.classList.remove('animate-bounce');
            }, 1000);
        }
        
        // Fade in animation
        function addFadeInAnimation(element) {
            element.classList.add('animate-fade-in');
        }
        
        // Pulse animation
        function addPulseAnimation(element) {
            element.classList.add('animate-pulse');
        }
        
        // Remove pulse animation
        function removePulseAnimation(element) {
            element.classList.remove('animate-pulse');
        }
        
        // Initialize all animations
        function initializeAnimations() {
            console.log(' Initializing animations...');
            
            // Add button animations
            const buttons = document.querySelectorAll('.button, .btn, button:not([type="submit"]):not([type="button"])');
            buttons.forEach(button => {
                addButtonClickAnimation(button);
            });
            
            // Add card hover animations
            addCardHoverAnimations();
            
            // Add form animations
            addFormAnimations();
            
            // Add fade-in animations to cards
            const cards = document.querySelectorAll('.hub-card, .content-card, .file-item-card');
            cards.forEach((card, index) => {
                setTimeout(() => {
                    addFadeInAnimation(card);
                }, index * 100);
            });
            
            console.log(' Animations initialized successfully');
        }
        
        // Enhanced button interactions
        function enhanceButtonInteractions() {
            const buttons = document.querySelectorAll('.button, .btn, button');
            buttons.forEach(button => {
                // Add hover effect
                button.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-2px)';
                    this.style.boxShadow = 'var(--card-shadow-hover)';
                });
                
                button.addEventListener('mouseleave', function() {
                    if (!this.classList.contains('clicked')) {
                        this.style.transform = 'translateY(0)';
                        this.style.boxShadow = '';
                    }
                });
                
                // Add active state
                button.addEventListener('mousedown', function() {
                    this.style.transform = 'translateY(0)';
                });
                
                button.addEventListener('mouseup', function() {
                    this.style.transform = 'translateY(-2px)';
                });
            });
        }
        
        // File upload animations
        function enhanceFileUploadAnimations() {
            const fileInputs = document.querySelectorAll('input[type="file"]');
            fileInputs.forEach(input => {
                input.addEventListener('change', function() {
                    if (this.files.length > 0) {
                        const label = this.previousElementSibling;
                        if (label) {
                            showSuccessAnimation(label, 1500);
                        }
                    }
                });
            });
        }
        
        // Modal animations
        function enhanceModalAnimations() {
            const modals = document.querySelectorAll('.modal-overlay');
            modals.forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        // Add fade out animation before closing
                        this.style.opacity = '0';
                        this.style.transform = 'scale(0.95)';
                        setTimeout(() => {
                            this.style.display = 'none';
                            this.style.opacity = '1';
                            this.style.transform = 'scale(1)';
                        }, 200);
                    }
                });
            });
        }
        
        // Progress bar animations
        function animateProgressBars() {
            const progressBars = document.querySelectorAll('.progress-bar');
            progressBars.forEach(bar => {
                const width = bar.style.width || bar.getAttribute('data-width') || '0%';
                bar.style.width = '0%';
                setTimeout(() => {
                    bar.style.transition = 'width 1s ease';
                    bar.style.width = width;
                }, 100);
            });
        }
        
        // Initialize all enhanced interactions
        function initializeEnhancedInteractions() {
            console.log(' Initializing enhanced interactions...');
            
            enhanceButtonInteractions();
            enhanceFileUploadAnimations();
            enhanceModalAnimations();
            animateProgressBars();
            
            console.log(' Enhanced interactions initialized');
        }
    </script>
</head>
<body>
    <div class="hub-container">
        <!-- ======================= -->
        <!--      SIDEBAR          -->
        <!-- ======================= -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <span class="hub-title">{{ hub.name }}</span>
                <button id="sidebar-toggle" title="Toggle Sidebar">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="9" y1="3" x2="9" y2="21"></line></svg>
                </button>
            </div>

            <nav class="sidebar-nav">
                <ul>
                    <li><a href="#tools" class="nav-link active" data-tab="tools">
                        <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></svg>
                        <span class="nav-text">Study Tools</span>
                    </a></li>
                    
                    <!-- Favourites Section -->
                    <li class="favourites-section">
                        <div class="favourites-toggle" id="favourites-toggle">
                            <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                            <span class="nav-text">Favourites</span>
                            <svg class="favourites-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6,9 12,15 18,9"></polyline></svg>
                        </div>
                        <div class="favourites-dropdown" id="favourites-dropdown">
                            <div class="favourites-content" id="favourites-content">
                                <!-- Favourites will be loaded here -->
                            </div>
                            <div class="favourites-actions">
                                <div class="favourites-help-text">
                                    Hover over any tool and click the star to add it to favourites
                                </div>
                            </div>
                        </div>
                    </li>
                    <li><a href="#progress" class="nav-link" data-tab="progress">
                        <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20V10M18 20V4M6 20V16"></path></svg>
                        <span class="nav-text">Progress</span>
                    </a></li>
                    <li><a href="#tutor" class="nav-link" data-tab="tutor">
                        <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                        <span class="nav-text">AI Tutor</span>
                    </a></li>
                    <li><a href="#documents" class="nav-link" data-tab="documents">
                        <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
                        <span class="nav-text">Documents</span>
                    </a></li>
                    <li><a href="#calendar" class="nav-link" data-tab="calendar">
                        <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                        <span class="nav-text">Calendar</span>
                    </a></li>
                    <li><a href="#folders" class="nav-link" data-tab="folders">
                        <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>
                        <span class="nav-text">My Folders</span>
                    </a></li>
                    <!-- NEW: Sidebar link for slide notes -->
                    <li><a href="#lecture_notes" class="nav-link" data-tab="lecture_notes">
                        <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="18" rx="2" ry="2"></rect><line x1="2" y1="8" x2="22" y2="8"></line><line x1="7" y1="13" x2="7.01" y2="13"></line><line x1="7" y1="18" x2="7.01" y2="18"></line></svg>
                        <span class="nav-text">Lecture Notes</span>
                    </a></li>
                    <li><a href="#notes" class="nav-link" data-tab="notes">
                        <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline></svg>
                        <span class="nav-text">My Notes</span>
                    </a></li>
                    <li><a href="#flashcards" class="nav-link" data-tab="flashcards">
                        <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="15" rx="2" ry="2"></rect><polyline points="17 2 12 7 7 2"></polyline></svg>
                        <span class="nav-text">My Flashcards</span>
                    </a></li>
                    <li><a href="#quizzes" class="nav-link" data-tab="quizzes">
                        <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"></path><path d="m9 12 2 2 4-4"></path></svg>
                        <span class="nav-text">My Quizzes</span>
                    </a></li>
                    <li><a href="{{ url_for('dashboard') }}" class="nav-link back-to-dashboard">
                        <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9,22 9,12 15,12 15,22"></polyline></svg>
                        <span class="nav-text">Back to Dashboard</span>
                    </a></li>
                </ul>
            </nav>


            <!-- Task Queue Section -->
            <div class="task-queue-section">
                <div class="task-queue-header">
                    <h4 class="task-queue-title">Task Queue</h4>
                    <span class="task-count" id="task-count">0/3</span>
                </div>
                <div class="task-queue-list" id="task-queue-list">
                    <!-- Tasks will be dynamically added here -->
                </div>
            </div>

            <div class="sidebar-footer">
                <!-- Footer content can be added here if needed -->
            </div>
        </aside>

        <!-- ======================= -->
        <!--    MAIN CONTENT       -->
        <!-- ======================= -->
        <div class="main-wrapper">
            <!-- Top Bar -->
            <header class="top-bar">
                <div class="user-profile-section">
                        <button class="button button-primary" id="quick-action-upload">
                             <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M7 14l5-5 5 5"></path><path d="M12 9v12"></path></svg>
                            Upload
                        </button>
                         <input id="pdf-upload" type="file" name="pdf" accept=".pdf,.docx,.pptx" style="display:none;">
                        <div class="notification-bell" id="notification-bell">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
                            <div class="notification-dot {% if unread_notifications_count > 0 %}visible{% endif %}" id="notification-dot"></div>
                             <div id="notification-panel">
                                <div class="notification-header">Notifications</div>
                                <ul class="notification-list">
                                    {% for notification in notifications %}
                                    <a href="{{ notification.link }}" class="notification-item {% if not notification.read %}unread{% endif %}" data-id="{{ notification.id }}">
                                        <p>{{ notification.message }}</p>
                                        <span>{{ notification.created_at|timesince }} ago</span>
                                    </a>
                                    {% else %}
                                    <li style="padding: 1rem; text-align: center; color: var(--text-secondary);">No new notifications.</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    <div class="profile-dropdown" id="profile-dropdown">
                        <div class="profile-trigger">
                            <div class="profile-avatar">{{ current_user.email[0]|upper }}</div>
                            <span class="profile-name">{{ current_user.display_name or current_user.email.split('@')[0] }}</span>
                            <svg class="dropdown-arrow" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>
                        </div>
                        <div class="profile-menu">
                            <a href="{{ url_for('profile') }}" class="profile-menu-item">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                                Edit Profile
                            </a>
                            <a href="#settings" class="profile-menu-item" data-tab="settings">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                                Settings
                            </a>
                            <div class="profile-menu-divider"></div>
                            {% if not spotify_connected %}
                                <a href="{{ url_for('spotify_login') }}" class="profile-menu-item">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0m3.669 11.538a.498.498 0 0 1-.686.165c-1.879-1.147-4.243-1.407-7.028-.77a.5.5 0 0 1-.422-.648c.181-.723.6-1.39,1.152-1.884a.5.5 0 0 1 .632-.078c2.448 1.545 5.006 1.158 6.516.33a.5.5 0 0 1 .165.686m.979-2.178a.624.624 0 0 1-.858.205c-2.15-1.321-5.428-1.704-7.972-.932a.625.625 0 0 1-.493-.812c.244-.921.75-1.748,1.41-2.368a.625.625 0 0 1 .78-.098c2.978 1.834 5.922 1.48 7.42.54a.625.625 0 0 1 .205.858m.13-2.522a.75.75 0 0 1-1.028.246c-2.522-1.54-6.57-1.84-9.088-.99a.75.75 0 0 1-.613-.97c.32-1.107.96-2.112,1.868-2.87a.75.75 0 0 1 .948-.12c3.468 2.115 7.152 1.705 8.71.493a.75.75 0 0 1 .246 1.028"/></svg>
                                    Connect Spotify
                                </a>
                            {% else %}
                                <button id="spotify-player-toggle-btn-hub" class="profile-menu-item spotify-toggle">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>
                                    <span>Music Player</span>
                                </button>
                            {% endif %}
                            <div class="profile-menu-item theme-toggle-item">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                                <span>Dark Mode</span>
                                <label class="theme-switch-inline" for="theme-toggle-dropdown">
                                    <input type="checkbox" id="theme-toggle-dropdown" />
                                    <div class="slider-inline">
                                        <div class="icon-wrapper sun">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                                        </div>
                                        <div class="icon-wrapper moon">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                                        </div>
                                </div>
                            </label>
                        </div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Workspace -->
            <main class="workspace">
                <div id="loading-status-container"></div>
                
                <div id="documents" class="tab-content">
                     <div class="workspace-header">
                        <h1>Documents</h1>
                        <p>Manage and upload your course materials and lecture notes here.</p>
                    </div>
                    <div class="file-list" id="main-file-list">
                        {% for file in hub.files %}
                        <div class="file-item-card clickable-file" data-file-path="{{ file.path }}" data-file-name="{{ file.name }}">
                            <div class="file-info">
                                <span class="file-icon">
                                    {% set file_ext = file.name.split('.')[-1].lower() %}
                                    {% if file_ext == 'pdf' %}
                                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="1.5" style="color: #dc2626;"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><text x="12" y="16" text-anchor="middle" font-family="Arial" font-size="6" font-weight="bold">PDF</text></svg>
                                    {% elif file_ext in ['docx', 'doc'] %}
                                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="1.5" style="color: #2563eb;"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><text x="12" y="16" text-anchor="middle" font-family="Arial" font-size="5" font-weight="bold">DOC</text></svg>
                                    {% elif file_ext in ['pptx', 'ppt'] %}
                                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="1.5" style="color: #dc2626;"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><text x="12" y="16" text-anchor="middle" font-family="Arial" font-size="5" font-weight="bold">PPT</text></svg>
                                    {% else %}
                                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
                                    {% endif %}
                                </span>
                                <span class="file-name">{{ file.name }}</span>
                            </div>
                            <div class="file-actions">
                                <span class="file-size">{{ (file.size / 1024)|round(1) }} KB</span>
                                <div class="action-buttons">
                                    <button class="view-btn" title="Open file" data-file-path="{{ file.path }}" data-file-name="{{ file.name }}">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                                    </button>
                                    <a href="{{ url_for('delete_file', hub_id=hub.id, file_path=file.path) }}" class="delete-btn delete-file-btn" title="Delete file" data-file-path="{{ file.path }}">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                                    </a>
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <p class="empty-state-text" id="empty-file-list-message">Upload a document (PDF, Word, or PowerPoint) to begin.</p>
                        {% endfor %}
                    </div>
                </div>

                <div id="tutor" class="tab-content">
                    <div class="workspace-header">
                        <h1>AI Tutor</h1>
                        <p>Ask questions and get instant help based on your uploaded documents.</p>
                    </div>
                    <div id="ai-tutor-panel">
                        <div id="tutor-messages-list">
                            <div id="tutor-welcome-message">
                                <h3>Your Personal AI Tutor</h3>
                                <p>Ask me anything about the documents you've uploaded in this hub. <br> For example: "Summarize the key arguments in lecture 3" or "Explain the formula for X".</p>
                            </div>
                        </div>
                        <form id="tutor-input-form">
                            <input type="text" id="tutor-user-input" placeholder="Ask a question about your documents..." autocomplete="off" required>
                            <button type="submit" class="button button-primary">Send</button>
                        </form>
                    </div>
                </div>
                
                <div id="tools" class="tab-content">
                    <div class="workspace-header">
                        <h1>Study Tools</h1>
                        <p>Generate study materials, get ready for exams, and plan your schedule.</p>
                    </div>
                    
                    <!-- NEW: Tool Category Selection -->
                    <div id="tool-category-selection">
                        <div class="tool-category-grid">
                            <div class="tool-category-button" data-target="in-lecture-tools">
                                <div class="tool-category-header">
                                    <div class="tool-category-icon"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 17.25v1.007a3 3 0 01-.879 2.122L7.5 21h9l-.621-.621A3 3 0 0115 18.257V17.25m6-12V15a2.25 2.25 0 01-2.25 2.25H5.25A2.25 2.25 0 013 15V5.25m18 0A2.25 2.25 0 0018.75 3H5.25A2.25 2.25 0 003 5.25m18 0V12a2.25 2.25 0 01-2.25 2.25H5.25A2.25 2.25 0 013 12V5.25" /></svg></div>
                                    <div class="tool-category-title"><h3>In a Lecture</h3></div>
                                </div>
                                <p class="tool-category-description">Tools designed for use during class to help you capture information and take better notes in real-time.</p>
                                <span class="tool-category-cta">See Tools</span>
                            </div>
                            <div class="tool-category-button" data-target="revision-exams-tools">
                                <div class="tool-category-header">
                                    <div class="tool-category-icon"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" /></svg></div>
                                    <div class="tool-category-title"><h3>Revision & Exams</h3></div>
                                </div>
                                <p class="tool-category-description">Prepare for assessments by generating study materials, getting help with problems, and planning your schedule.</p>
                                <span class="tool-category-cta">See Tools</span>
                            </div>
                        </div>
                    </div>

                    <!-- NEW: In Lecture Tools (hidden by default) -->
                    <div id="in-lecture-tools" style="display: none;">
                        <button class="button button-secondary tool-category-back-button">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" /></svg>
                            Back to Categories
                        </button>
                        <div class="feature-grid">
                            <a href="{{ url_for('live_lecture_page', hub_id=hub.id) }}" class="feature-card" id="pipeline-live-lecture">
                                <div class="tool-favourite-star" data-tool-id="pipeline-live-lecture">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"></polygon></svg>
                                </div>
                                <div class="feature-icon-wrapper" style="background-color: #fee2e2; color: #991b1b;"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z" /><path stroke-linecap="round" stroke-linejoin="round" d="M19 10v2a7 7 0 0 1-14 0v-2" /><line x1="12" y1="19" x2="12" y2="23" /><line x1="8" y1="23" x2="16" y2="23" /></svg></div>
                                <div class="feature-text">
                                    <h4>Live Lecture Capture<span class="pro-label">PRO</span></h4>
                                    <p>Record your lecture in real-time and let AI generate structured notes and summaries automatically.</p>
                                </div>
                                <svg xmlns="http://www.w3.org/2000/svg" class="feature-arrow-svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>
                            </a>
                            <button type="button" class="feature-card" id="pipeline-slide-notes">
                                <div class="tool-favourite-star" data-tool-id="pipeline-slide-notes">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"></polygon></svg>
                                </div>
                                <div class="feature-icon-wrapper" style="background-color: #FEF3C7; color: #B45309;"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 17.25v1.007a3 3 0 01-.879 2.122L7.5 21h9l-1.621-.621A3 3 0 0115 18.257V17.25m6-12V15a2.25 2.25 0 01-2.25 2.25H5.25A2.25 2.25 0 013 15V5.25A2.25 2.25 0 015.25 3h13.5A2.25 2.25 0 0121 5.25z" /></svg></div>
                                <div class="feature-text">
                                    <h4>Take Notes with Slides</h4>
                                    <p>Upload your lecture slides (PDF, Word, or PowerPoint) to open a split-screen workspace with AI tutor, quiz generation, and flashcard creation.</p>
                                </div>
                                <svg xmlns="http://www.w3.org/2000/svg" class="feature-arrow-svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>
                            </button>
                        </div>
                    </div>

                    <!-- NEW: Revision & Exams Tools (hidden by default) -->
                    <div id="revision-exams-tools" style="display: none;">
                        <button class="button button-secondary tool-category-back-button">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" /></svg>
                            Back to Categories
                        </button>
                        <div class="feature-grid">
                            <!-- FREE FEATURES FIRST -->
                            <button type="button" class="feature-card" id="individual-notes-generator">
                                <div class="tool-favourite-star" data-tool-id="individual-notes-generator">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"></polygon></svg>
                                </div>
                                <div class="feature-icon-wrapper" style="background-color: #dbeafe; color: #1e40af;"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg></div>
                                <div class="feature-text">
                                    <h4>Interactive Notes</h4>
                                    <p>Generate comprehensive, interactive study notes from your documents with key concepts highlighted.</p>
                                </div>
                                <svg xmlns="http://www.w3.org/2000/svg" class="feature-arrow-svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>
                            </button>
                            <button type="button" class="feature-card" id="individual-flashcards-generator">
                                <div class="tool-favourite-star" data-tool-id="individual-flashcards-generator">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"></polygon></svg>
                                </div>
                                <div class="feature-icon-wrapper" style="background-color: #dcfce7; color: #166534;"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z" /></svg></div>
                                <div class="feature-text">
                                    <h4>Flashcards</h4>
                                    <p>Create custom flashcards from your study materials. Perfect for memorizing key concepts.</p>
                                </div>
                                <svg xmlns="http://www.w3.org/2000/svg" class="feature-arrow-svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>
                            </button>
                            <button type="button" class="feature-card" id="individual-quiz-generator">
                                <div class="tool-favourite-star" data-tool-id="individual-quiz-generator">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"></polygon></svg>
                                </div>
                                <div class="feature-icon-wrapper" style="background-color: #fef3c7; color: #92400e;"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9 5.25h.008v.008H12v-.008z" /></svg></div>
                                <div class="feature-text">
                                    <h4>Practice Quiz</h4>
                                    <p>Generate practice quizzes to test your knowledge and identify areas for improvement.</p>
                                </div>
                                <svg xmlns="http://www.w3.org/2000/svg" class="feature-arrow-svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>
                            </button>
                            <button type="button" class="feature-card" id="individual-cheatsheet-generator">
                                <div class="tool-favourite-star" data-tool-id="individual-cheatsheet-generator">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"></polygon></svg>
                                </div>
                                <div class="feature-icon-wrapper" style="background-color: #fce7f3; color: #be185d;"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25z" /></svg></div>
                                <div class="feature-text">
                                    <h4>Cheat Sheet</h4>
                                    <p>Create one-page reference sheets with key formulas, concepts, and quick facts.</p>
                                </div>
                                <svg xmlns="http://www.w3.org/2000/svg" class="feature-arrow-svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>
                            </button>
                            <button type="button" class="feature-card" id="pipeline-revision-pack">
                                <div class="tool-favourite-star" data-tool-id="pipeline-revision-pack">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"></polygon></svg>
                                </div>
                                <div class="feature-icon-wrapper" style="background-color: #dcfce7; color: #166534;"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 3.75V16.5L12 14.25 7.5 16.5V3.75m9 0H7.5A2.25 2.25 0 005.25 6v13.5A2.25 2.25 0 007.5 21.75h9A2.25 2.25 0 0018.75 19.5V6A2.25 2.25 0 0016.5 3.75z" /></svg></div>
                                <div class="feature-text">
                                    <h4>Revision Pack Builder</h4>
                                    <p>Turn documents into a kit with notes, flashcards, and quizzes in a new folder.</p>
                                </div>
                                <svg xmlns="http://www.w3.org/2000/svg" class="feature-arrow-svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>
                            </button>
                            
                            <!-- PRO FEATURES AFTER -->
                            <button type="button" class="feature-card" id="pipeline-stuck-question">
                                <div class="tool-favourite-star" data-tool-id="pipeline-stuck-question">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"></polygon></svg>
                                </div>
                                <div class="feature-icon-wrapper" style="background-color: #f3e8ff; color: #7e22ce;"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9 5.25h.008v.008H12v-.008z" /></svg></div>
                                <div class="feature-text">
                                    <h4>Stuck on a Question?<span class="pro-label">PRO</span></h4>
                                    <p>Get a step-by-step, interactive solution for any problem. Upload a photo or paste text.</p>
                                </div>
                                <svg xmlns="http://www.w3.org/2000/svg" class="feature-arrow-svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>
                            </button>
                            <button type="button" class="feature-card" id="pipeline-exam-kit">
                                <div class="tool-favourite-star" data-tool-id="pipeline-exam-kit">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"></polygon></svg>
                                </div>
                                <div class="feature-icon-wrapper" style="background-color: #fef3c7; color: #92400e;"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" /></svg></div>
                                <div class="feature-text">
                                    <h4>Exam Builder<span class="pro-label">PRO</span></h4>
                                    <p>Generate one-page cheatsheets and a timed mock exam from your course materials.</p>
                                </div>
                                <svg xmlns="http://www.w3.org/2000/svg" class="feature-arrow-svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>
                            </button>
                            <a href="{{ url_for('start_assignment', hub_id=hub.id) }}" class="feature-card" id="pipeline-assignment-assistant">
                                <div class="tool-favourite-star" data-tool-id="pipeline-assignment-assistant">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"></polygon></svg>
                                </div>
                                <div class="feature-icon-wrapper" style="background-color: #e0f2fe; color: #0369a1;"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25z" /></svg></div>
                                <div class="feature-text">
                                    <h4>Assignment Assistant<span class="pro-label">PRO</span></h4>
                                    <p>Go from a brief and your source documents to a structured outline and first draft.</p>
                                </div>
                                <svg xmlns="http://www.w3.org/2000/svg" class="feature-arrow-svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>
                            </a>
                            <button type="button" class="feature-card" id="pipeline-study-planner">
                                <div class="tool-favourite-star" data-tool-id="pipeline-study-planner">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"></polygon></svg>
                                </div>
                                <div class="feature-icon-wrapper" style="background-color: #e0e7ff; color: #4338ca;"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" /></svg></div>
                                <div class="feature-text">
                                    <h4>Smart Study Planner<span class="pro-label">PRO</span></h4>
                                    <p>Upload a syllabus and deadline to automatically create a schedule in your calendar.</p>
                                </div>
                                <svg xmlns="http://www.w3.org/2000/svg" class="feature-arrow-svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>
                            </button>
                            <button type="button" class="feature-card quick-tool-btn" value="analyse">
                                <div class="feature-icon-wrapper" style="background-color: #e0f2fe;"><svg style="color: #0369a1;" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"></path><path d="M18.7 8.7l-7.2 7.2-2.5-2.5L3 17"></path></svg></div>
                                <div class="feature-text">
                                    <h4>Exam Predictor <span class="pro-label">PRO</span></h4>
                                    <p>Generate a report outlining likely topics by analyzing past papers.</p>
                                </div>
                                <svg xmlns="http://www.w3.org/2000/svg" class="feature-arrow-svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>
                            </button>
                        </div>
                    </div>
                </div>

                <div id="progress" class="tab-content">
                    <div class="workspace-header">
                        <h1>Your Progress</h1>
                        <p>Track your study habits, topic mastery, and overall performance.</p>
                    </div>
                    <div class="progress-grid">
                        <div class="progress-card xp-card"><h2>Total XP</h2><div class="stat-large">{{ total_xp }} <span>XP</span></div></div>
                        <div class="progress-card streak-card"><h2>Study Streak</h2><div class="stat-large">{{ streak_days }} <span>Days</span></div></div>
                        <div class="progress-card score-card"><h2>Average Score</h2><div class="stat-large">{{ (topic_mastery | map(attribute='score') | sum / (topic_mastery | length if (topic_mastery | length) > 0 else 1)) | round(0) | int }}<span>%</span></div></div>
                    </div>
                     {% if spotlight %}
                     <div style="margin-top: 2rem;">
                         <div class="progress-card spotlight-card">
                            {% if spotlight.type == 'weakest' %}{% set topic_str = spotlight.topic|string %}{% set hub_id_str = hub.id|string %}<h2>Weakness Spotlight</h2><p class="spotlight-topic">{{ spotlight.topic }}</p><a href="{{ url_for('generate_weakness_quiz', hub_id=hub_id_str, topic=topic_str) }}" class="button">5-Question Quiz Now</a>
                            {% elif spotlight.type == 'improved' %}<h2>Most Improved!</h2><p class="spotlight-topic">{{ spotlight.topic }}</p><p>Great work! Keep up the momentum.</p>
                            {% elif spotlight.type == 'recommend' %}{% set topic_str = spotlight.topic|string %}{% set hub_id_str = hub.id|string %}<h2>Time to Review</h2><p class="spotlight-topic">{{ spotlight.topic }}</p><a href="{{ url_for('generate_weakness_quiz', hub_id=hub_id_str, topic=topic_str) }}" class="button">Review with a Quiz</a>
                            {% endif %}
                         </div>
                     </div>
                    {% endif %}
                    <div class="large-grid" style="margin-top: 1.5rem;">
                        <div class="large-grid-card">
                            <h2>Topic Mastery</h2>
                            <div class="topic-list">
                                {% for item in topic_mastery %}<div class="topic-item"><span class="topic-name">{{ item.topic }}</span><div class="topic-bar-container"><div class="topic-bar {{ 'mastery-high' if item.score >= 80 else 'mastery-mid' if item.score >= 50 else 'mastery-low' }}" style="width: {{ item.score }}%;"></div></div><span class="topic-score">{{ item.score }}%</span></div>{% else %}<p class="empty-state-text">Complete quizzes to see your topic mastery breakdown!</p>{% endfor %}
                            </div>
                        </div>
                        <div class="large-grid-card">
                             <h2>Level Progress</h2>
                             {% if level_data %}<div class="level-header"><span>Level {{ level_data.current_level }} Scholar</span><span>{{ level_data.xp_in_level }} / {{ level_data.xp_for_next_level }} XP</span></div><div class="level-bar-container"><div class="level-bar" style="width: {{ (level_data.xp_in_level / level_data.xp_for_next_level) * 100 }}%;"></div></div>{% else %}<p class="empty-state-text">Start studying to gain XP and level up!</p>{% endif %}
                        </div>
                    </div>
                    <div class="large-grid" style="grid-template-columns: 1fr; margin-top: 1.5rem;">
                        <div class="large-grid-card">
                            <h2>Recent Quiz Performance</h2>
                            <div style="height: 400px; position: relative;">
                                <canvas id="quiz-score-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="calendar" class="tab-content">
                     <div class="workspace-header">
                        <h1>Study Calendar</h1>
                        <p>Schedule study sessions and keep track of important deadlines.</p>
                    </div>
                     <div style="display: flex; justify-content: flex-end; gap: 1rem; margin-bottom: 1.5rem;">
                        <button id="show-import-modal-btn" class="button button-secondary">Import Calendar (.ics)</button>
                        <button id="show-schedule-modal-btn" class="button button-primary">+ Schedule New Session</button>
                    </div>
                    <div class="content-card">
                        <div id="fullcalendar"></div>
                    </div>
                </div>

                <div id="folders" class="tab-content">
                    <div class="workspace-header">
                        <h1>My Folders</h1>
                        <p>Organize your generated notes, quizzes, and flashcards into folders.</p>
                    </div>
                    <div class="content-card" style="margin-bottom: 2rem; padding: 1.5rem;">
                        <form action="{{ url_for('create_folder', hub_id=hub.id) }}" method="POST">
                            <h4 style="margin-top:0; margin-bottom: 1rem;">Create a New Folder</h4>
                            <div style="display: flex; gap: 1rem;">
                                <input type="text" name="folder_name" placeholder="e.g., Midterm Review" required style="flex-grow:1; padding: 0.5rem; border-radius: 6px; border: 1px solid var(--border-color); background-color: var(--background-body); color: var(--text-main);">
                                <button type="submit" class="button button-primary">Create</button>
                            </div>
                        </form>
                    </div>
                    <div id="folder-accordion-container">
                        {% for folder in all_folders %}
                        <div class="folder-accordion-item" data-folder-id="{{ folder.id }}">
                            <div class="folder-header">
                                <div class="folder-header-title">
                                    <div class="asset-icon" style="background-color: #fefce8; color: #a16207;"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.75V12A2.25 2.25 0 014.5 9.75h15A2.25 2.25 0 0121.75 12v.75m-8.69-6.44l-2.12-2.12a1.5 1.5 0 00-1.061-.44H4.5A2.25 2.25 0 002.25 6v12a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9a2.25 2.25 0 00-2.25-2.25h-5.379a1.5 1.5 0 01-1.06-.44z" /></svg></div>
                                    <div>
                                        <h5 id="folder-title-{{ folder.id }}">{{ folder.name }}</h5>
                                        <button class="edit-button" data-type="folder" data-id="{{ folder.id }}" title="Edit folder name">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="m18.5 2.5 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                                        </button>
                                        <span>{{ folder.hydrated_items|length }} items</span>
                                    </div>
                                </div>
                                <div class="folder-actions">
                                    <button class="button button-secondary add-items-to-folder-btn">Add Items</button>
                                    <button class="button button-danger delete-folder-btn">Delete</button>
                                </div>
                            </div>
                            <div class="folder-content">
                                <ul class="asset-list">
                                    {% for item in folder.hydrated_items %}
                                    <li class="asset-item" data-id="{{ item.id }}" data-type="{{ item.type.lower() if item.type else 'note' }}">
                                        {% set item_type = item.type.lower() if item.type else 'note' %}
                                        {% if item_type == 'note' or item_type == 'notes' or (item.data and item.data.type == 'note') %}
                                        <a href="{{ url_for('view_note', note_id=item.id) }}" class="asset-link" target="_blank">
                                            <div class="asset-icon asset-icon-note"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg></div>
                                            <div class="asset-details"><h5>{{ item.title }}</h5><span>Note</span></div>
                                        </a>
                                        {% elif item_type == 'quiz' %}
                                            {% if item.status == 'graded' %}
                                                <a href="{{ url_for('quiz_results', activity_id=item.id) }}" class="asset-link" target="_blank">
                                                    <div class="asset-icon asset-icon-quiz"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"></path><path d="m9 12 2 2 4-4"></path></svg></div>
                                                    <div class="asset-details"><h5>{{ item.title }}</h5><span>Quiz ({{ item.score }}%)</span></div>
                                                </a>
                                            {% else %}
                                                 <a href="{{ url_for('take_lecture_quiz', activity_id=item.id) }}" class="asset-link" target="_blank">
                                                    <div class="asset-icon asset-icon-quiz"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"></path><path d="m9 12 2 2 4-4"></path></svg></div>
                                                    <div class="asset-details"><h5>{{ item.title }}</h5><span>Quiz (Not Taken)</span></div>
                                                </a>
                                            {% endif %}
                                        {% elif item_type == 'flashcards' %}
                                        <a href="{{ url_for('edit_flashcard_set', activity_id=item.id) }}" class="asset-link" target="_blank">
                                           <div class="asset-icon asset-icon-flashcards"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="15" rx="2" ry="2"></rect><polyline points="17 2 12 7 7 2"></polyline></svg></div>
                                           <div class="asset-details"><h5>{{ item.title }}</h5><span>Flashcards</span></div>
                                        </a>
                                        {% endif %}
                                        <button class="delete-btn delete-folder-item-btn" data-id="{{ item.id }}" data-type="{{ item_type }}" title="Delete item">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                                        </button>
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                        {% else %}
                        <p class="empty-state-text">You haven't created any folders yet.</p>
                        {% endfor %}
                    </div>
                </div>

                <!-- NEW: Lecture Notes Tab Content -->
                <div id="lecture_notes" class="tab-content">
                     <div class="workspace-header">
                        <h1>Lecture Notes</h1>
                        <p>Your interactive note-taking sessions with uploaded slides are saved here.</p>
                    </div>
                    <ul class="asset-list">
                        {% for slide_note in all_slide_notes %}
                        <li class="asset-item" data-id="{{ slide_note.id }}" data-type="slide_notes">
                            <a href="{{ url_for('slide_notes_workspace', session_id=slide_note.id) }}" class="asset-link" target="_blank">
                                <div class="asset-icon asset-icon-slides"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="18" rx="2" ry="2"></rect><line x1="2" y1="8" x2="22" y2="8"></line><line x1="7" y1="13" x2="7.01" y2="13"></line><line x1="7" y1="18" x2="7.01" y2="18"></line></svg></div>
                                <div class="asset-details">
                                    <h5 id="slide_notes-title-{{ slide_note.id }}">{{ slide_note.title }}</h5>
                                    <button class="edit-button" data-type="slide_notes" data-id="{{ slide_note.id }}" title="Edit slide notes title">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="m18.5 2.5 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                                    </button>
                                    <span>Created {{ slide_note.created_at|timesince }} ago</span>
                                </div>
                            </a>
                            <button class="delete-button delete-slide-note-btn" data-id="{{ slide_note.id }}" title="Delete lecture notes">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3,6 5,6 21,6"></polyline><path d="m19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                            </button>
                        </li>
                        {% else %}
                        <li class="empty-state-text"><p>You haven't started any lecture note sessions yet. Go to 'Study Tools' to begin.</p></li>
                        {% endfor %}
                    </ul>
                </div>

                <div id="notes" class="tab-content">
                     <div class="workspace-header">
                        <h1>My Notes</h1>
                        <p>All the notes you have generated or created.</p>
                    </div>
                    <div class="asset-list-header">
                        <div class="select-all-container"><input type="checkbox" class="select-all-checkbox" id="select-all-notes"><label for="select-all-notes">Select All</label></div>
                        <button class="button button-danger delete-selected-btn" style="display: none;">Delete Selected</button>
                    </div>
                    <ul class="asset-list">
                        {% for note in all_notes %}
                        <li class="asset-item" data-id="{{ note.id }}" data-type="note">
                            <input type="checkbox" class="asset-checkbox">
                            <a href="{{ url_for('view_note', note_id=note.id) }}" class="asset-link" target="_blank">
                                <div class="asset-icon asset-icon-note"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg></div>
                                <div class="asset-details">
                                    <h5 id="note-title-{{ note.id }}">{{ note.title }}</h5>
                                    <button class="edit-button" data-type="note" data-id="{{ note.id }}" title="Edit note title">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="m18.5 2.5 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                                    </button>
                                    <span>Created {{ note.created_at|timesince }} ago</span>
                                </div>
                            </a>
                            <button class="delete-btn delete-note-btn" data-id="{{ note.id }}" title="Delete note">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                            </button>
                        </li>
                        {% else %}
                        <li class="empty-state-text"><p>You haven't generated any notes yet.</p></li>
                        {% endfor %}
                    </ul>
                </div>

                <div id="flashcards" class="tab-content">
                    <div class="workspace-header">
                        <h1>My Flashcards</h1>
                        <p>All the flashcard sets you have generated or created.</p>
                    </div>
                    <div class="asset-list-header">
                        <div class="select-all-container"><input type="checkbox" class="select-all-checkbox" id="select-all-flashcards"><label for="select-all-flashcards">Select All</label></div>
                        <button class="button button-danger delete-selected-btn" style="display: none;">Delete Selected</button>
                    </div>
                    <ul class="asset-list">
                        {% for fc_set in all_flashcards %}
                        <li class="asset-item" data-id="{{ fc_set.id }}" data-type="flashcards">
                            <input type="checkbox" class="asset-checkbox">
                            <a href="{{ url_for('edit_flashcard_set', activity_id=fc_set.id) }}" class="asset-link" target="_blank">
                                <div class="asset-icon asset-icon-flashcards"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="15" rx="2" ry="2"></rect><polyline points="17 2 12 7 7 2"></polyline></svg></div>
                                <div class="asset-details">
                                    <h5 id="flashcards-title-{{ fc_set.id }}">{{ fc_set.title }}</h5>
                                    <button class="edit-button" data-type="flashcards" data-id="{{ fc_set.id }}" title="Edit flashcard title">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="m18.5 2.5 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                                    </button>
                                    <span>Created {{ fc_set.created_at|timesince }} ago</span>
                                </div>
                            </a>
                            <button class="delete-btn delete-activity-btn" data-id="{{ fc_set.id }}" title="Delete flashcards">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                            </button>
                        </li>
                        {% else %}
                        <li class="empty-state-text"><p>You haven't generated any flashcards yet.</p></li>
                        {% endfor %}
                    </ul>
                </div>
                
                <div id="quizzes" class="tab-content">
                    <div class="workspace-header">
                        <h1>My Quizzes</h1>
                        <p>Review your completed quizzes or take new ones.</p>
                    </div>
                    <div class="asset-list-header">
                        <div class="select-all-container"><input type="checkbox" class="select-all-checkbox" id="select-all-quizzes"><label for="select-all-quizzes">Select All</label></div>
                        <button class="button button-danger delete-selected-btn" style="display: none;">Delete Selected</button>
                    </div>
                    <ul class="asset-list">
                        {% for quiz in all_quizzes_and_exams %}
                        <li class="asset-item" data-id="{{ quiz.id }}" data-type="quiz">
                            <input type="checkbox" class="asset-checkbox">
                            {% if quiz.status == 'graded' %}
                                <a href="{{ url_for('quiz_results', activity_id=quiz.id) }}" class="asset-link" target="_blank">
                                    <div class="asset-icon asset-icon-quiz"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"></path><path d="m9 12 2 2 4-4"></path></svg></div>
                                    <div class="asset-details">
                                        <h5 id="quiz-title-{{ quiz.id }}">{{ quiz.title or quiz.type }}</h5>
                                        <button class="edit-button" data-type="quiz" data-id="{{ quiz.id }}" title="Edit quiz title">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="m18.5 2.5 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                                        </button>
                                        <span>Completed {{ quiz.created_at|timesince }} ago</span>
                                    </div>
                                </a>
                                <div class="asset-score"><span>{{ quiz.score }}%</span></div>
                            {% else %}
                                <a href="{{ url_for('take_lecture_quiz', activity_id=quiz.id) }}" class="asset-link" target="_blank">
                                    <div class="asset-icon asset-icon-quiz"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"></path><path d="m9 12 2 2 4-4"></path></svg></div>
                                    <div class="asset-details">
                                        <h5 id="quiz-title-{{ quiz.id }}">{{ quiz.title or quiz.type }}</h5>
                                        <button class="edit-button" data-type="quiz" data-id="{{ quiz.id }}" title="Edit quiz title">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="m18.5 2.5 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                                        </button>
                                        <span>Ready to take</span>
                                    </div>
                                </a>
                                <a href="{{ url_for('take_lecture_quiz', activity_id=quiz.id) }}" class="button button-primary" style="padding: 0.5rem 1rem;" target="_blank">Take Quiz</a>
                            {% endif %}
                            <button class="delete-btn delete-activity-btn" data-id="{{ quiz.id }}" title="Delete quiz">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                            </button>
                        </li>
                        {% else %}
                        <li class="empty-state-text"><p>You haven't completed any quizzes yet.</p></li>
                        {% endfor %}
                    </ul>
                </div>
            </main>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal-overlay" id="tool-file-select-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="tool-file-select-title">Select Files for Tool</h3>
                <button class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <p class="modal-description" id="tool-file-select-desc">Select up to 3 documents to use for this tool.</p>
                <div id="tool-file-select-list" class="modal-file-list"></div>
                <p id="tool-file-select-counter" style="text-align: right; margin-top: 0.5rem; font-size: 0.9rem; color: var(--text-secondary);"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="button button-secondary close-btn">Cancel</button>
                <button type="button" class="button button-primary" id="tool-file-select-submit">Generate</button>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="slide-notes-modal">
        <div class="modal-content">
            <div class="modal-header"><h3>Take Notes with Slides</h3><button class="close-btn">&times;</button></div>
            <form id="slide-notes-form" action="{{ url_for('create_slide_notes_session', hub_id=hub.id) }}" method="POST" enctype="multipart/form-data" target="_blank">
                <div class="modal-body">
                    <p class="modal-description">Select a document from your hub to begin a new note-taking session.</p>
                    <div class="form-group">
                        <label for="slide-notes-title">Session Title</label>
                        <input type="text" id="slide-notes-title" name="title" placeholder="e.g., Week 1: Intro to Business Law" required>
                    </div>
                    <div class="form-group">
                        <label class="label">Select Document</label>
                        <div id="slide-notes-files" class="modal-file-list"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="button button-secondary close-btn">Cancel</button>
                    <button type="submit" class="button button-primary">Start Note-Taking</button>
                </div>
            </form>
        </div>
    </div>
    <div class="modal-overlay" id="revision-pack-modal"> <div class="modal-content"> <div class="modal-header"><h3>Revision Pack Builder</h3><button class="close-btn">&times;</button></div> <form id="revision-pack-form"> <div class="modal-body"> <p class="modal-description">Turn your documents into a complete study kit with notes, flashcards, and quizzes, all organized in a new folder.</p> <div class="form-group"> <label class="label">Select Documents</label> <div id="revision-pack-files" class="modal-file-list"></div> </div> <div class="form-group"> <label for="num-flashcards">Number of Flashcards</label> <div class="slider-group"> <input type="range" id="num-flashcards" name="num_flashcards" min="0" max="100" value="20" step="5"> <span class="slider-value" id="num-flashcards-value">20</span> </div> </div> <div class="form-group"> <label for="num-quiz-questions">Number of Quiz Questions</label> <div class="slider-group"> <input type="range" id="num-quiz-questions" name="num_quiz_questions" min="0" max="50" value="10" step="5"> <span class="slider-value" id="num-quiz-questions-value">10</span> </div> </div> <div class="form-group checkbox-group"> <label> <input type="checkbox" id="include-notes" name="include_notes" checked> Include condensed revision notes </label> </div> </div> <div class="modal-footer"><button type="button" class="button button-secondary close-btn">Cancel</button><button type="submit" class="button button-primary">Generate Pack</button></div> </form> </div> </div>
    <div class="modal-overlay" id="exam-kit-modal"> <div class="modal-content"> <div class="modal-header"><h3>Exam Readiness Kit</h3><button class="close-btn">&times;</button></div> <form id="exam-kit-form"> <div class="modal-body"> <p class="modal-description">Generate one-page cheatsheets, a timed mock exam, and analyze past papers to predict likely topics.</p> <div class="form-group"> <label class="label">Select Main Lectures/Syllabi</label> <div id="exam-kit-lecture-files" class="modal-file-list"></div> </div> <div class="form-group"> <label class="label">Select Past Papers (Optional)</label> <div id="exam-kit-past-paper-files" class="modal-file-list"></div> </div> </div> <div class="modal-footer"><button type="button" class="button button-secondary close-btn">Cancel</button><button type="submit" class="button button-primary">Generate Kit</button></div> </form> </div> </div>
    <div class="modal-overlay" id="study-plan-modal"> <div class="modal-content"> <div class="modal-header"><h3>Smart Study Planner</h3><button class="close-btn">&times;</button></div> <form id="study-plan-form"> <div class="modal-body"> <p class="modal-description">Select your course syllabus and set your deadline. The AI will create a schedule and add it to your calendar.</p> <div class="form-group"> <label class="label">Select Syllabus Document(s)</label> <div id="study-plan-files" class="modal-file-list"></div> </div> <div class="form-group"> <label for="study-plan-deadline">Exam/Assignment Deadline</label> <input type="date" id="study-plan-deadline" name="deadline" required> </div> </div> <div class="modal-footer"><button type="button" class="button button-secondary close-btn">Cancel</button><button type="submit" class="button button-primary">Generate Plan</button></div> </form> </div> </div>
    <div class="modal-overlay" id="add-items-modal"> <div class="modal-content"> <div class="modal-header"><h3>Add Items to Folder</h3><button class="close-btn">&times;</button></div> <div class="modal-body"> {% if all_notes %}<h4>Notes</h4><ul class="asset-list">{% for note in all_notes %}<li class="asset-item"><label style="display:flex;width:100%;cursor:pointer;"><input type="checkbox" data-id="{{ note.id }}" data-type="note" style="margin-right:1rem;"> {{ note.title }}</label></li>{% endfor %}</ul>{% endif %} {% if all_quizzes_and_exams %}<h4>Quizzes</h4><ul class="asset-list">{% for quiz in all_quizzes_and_exams %}<li class="asset-item"><label style="display:flex;width:100%;cursor:pointer;"><input type="checkbox" data-id="{{ quiz.id }}" data-type="quiz" style="margin-right:1rem;"> {{ quiz.title }}</label></li>{% endfor %}</ul>{% endif %} </div> <div class="modal-footer"><button class="button button-secondary close-btn">Cancel</button><button class="button button-primary" id="save-added-items-btn">Add Selected Items</button></div> </div> </div>
    <div class="modal-overlay" id="schedule-event-modal"> <div class="modal-content"> <div class="modal-header"><h3>Schedule a New Session</h3><button class="close-btn">&times;</button></div> <form id="schedule-event-form"> <div class="modal-body"> <div class="form-group"><label for="event-title">Event Title</label><input type="text" id="event-title" name="title" placeholder="e.g., Mid-term revision" required></div> <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;"> <div><label for="event-type">Type</label><select id="event-type" name="event_type"><option>Study Session</option><option>Mock Exam</option><option>Flashcard Review</option><option>Draft Review</option><option>Custom</option></select></div> <div><label for="event-duration">Duration (minutes)</label><select id="event-duration" name="duration"><option value="20">20 mins</option><option value="40" selected>40 mins</option><option value="60">60 mins</option><option value="90">90 mins</option></select></div> </div> <div class="form-group"><label for="event-start-time">Start Time</label><input type="datetime-local" id="event-start-time" name="start_time" required></div> <div class="form-group"><label for="event-focus">Focus / Goal</label><textarea id="event-focus" name="focus" rows="3" placeholder="e.g., Review weak topics from last quiz"></textarea></div> <div class="form-group"><label>Source Files (Optional)</label><div id="modal-file-list" class="modal-file-list"></div></div> </div> <div class="modal-footer"><button type="button" class="button button-secondary close-btn">Cancel</button><button type="submit" class="button button-primary">Create Event</button></div> </form> </div> </div>
    <div class="modal-overlay" id="import-ics-modal"> <div class="modal-content"> <div class="modal-header"><h3>Import Calendar</h3><button class="close-btn">&times;</button></div> <form id="import-ics-form" action="{{ url_for('import_ics', hub_id=hub.id) }}" method="POST" enctype="multipart/form-data"> <div class="modal-body"> <p class="modal-description">Upload your university calendar file (.ics format) to add all your lectures and deadlines to your study hub schedule.</p> <div class="form-group"><label for="ics-file-upload">Select .ics file</label><input type="file" id="ics-file-upload" name="ics_file" accept=".ics" required></div> </div> <div class="modal-footer"><button type="button" class="button button-secondary close-btn">Cancel</button><button type="submit" class="button button-primary">Import Events</button></div> </form> </div> </div>
    <div class="modal-overlay" id="event-details-modal"> <div class="modal-content"> <div class="modal-header"><h3 id="details-modal-title">Event Details</h3><button class="close-btn">&times;</button></div> <div class="modal-body"> <strong>Time & Date</strong><p id="details-modal-time"></p> <strong>Focus / Details</strong><p id="details-modal-focus"></p> </div> <div class="modal-footer" style="justify-content: flex-end;"><a href="#" id="details-modal-export-btn" class="button button-secondary">Export .ics</a></div> </div> </div>
    
    <!-- Individual Tool Modals -->
    <div class="modal-overlay" id="individual-notes-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Generate Interactive Notes</h3>
                <button class="close-btn">&times;</button>
            </div>
            <form id="individual-notes-form">
                <div class="modal-body">
                    <p class="modal-description">Choose the type of notes you'd like to generate from your documents.</p>
                    
                    <div class="form-group">
                        <label class="label">Note Type</label>
                        <div class="note-type-options">
                            <label class="note-type-option">
                                <input type="radio" name="note_type" value="key_points" checked>
                                <div class="option-content">
                                    <div class="option-icon" style="background-color: #fef3c7; color: #92400e;">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24" stroke-width="2" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M9.568 3H5.25A2.25 2.25 0 003 5.25v4.318c0 .597.237 1.17.659 1.591l9.581 9.581c.699.699 1.78.872 2.607.33a18.095 18.095 0 005.223-5.223c.542-.827.369-1.908-.33-2.607L11.16 3.66A2.25 2.25 0 009.568 3z" />
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 6h.008v.008H6V6z" />
                                        </svg>
                                    </div>
                                    <div class="option-text">
                                        <h4>Key Points</h4>
                                        <p>Essential concepts and main ideas with brief descriptions</p>
                                    </div>
                                </div>
                            </label>
                            
                            <label class="note-type-option">
                                <input type="radio" name="note_type" value="condensed">
                                <div class="option-content">
                                    <div class="option-icon" style="background-color: #dbeafe; color: #1e40af;">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24" stroke-width="2" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
                                        </svg>
                                    </div>
                                    <div class="option-text">
                                        <h4>Condensed Notes</h4>
                                        <p>Comprehensive notes that are well-organized and easy to review</p>
                                    </div>
                                </div>
                            </label>
                            
                            <label class="note-type-option">
                                <input type="radio" name="note_type" value="detailed">
                                <div class="option-content">
                                    <div class="option-icon" style="background-color: #dcfce7; color: #166534;">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24" stroke-width="2" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" />
                                        </svg>
                                    </div>
                                    <div class="option-text">
                                        <h4>Detailed Notes</h4>
                                        <p>Full, comprehensive notes with complete explanations and examples</p>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="label">Select Documents</label>
                        <div id="individual-notes-files" class="modal-file-list"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="button button-secondary close-btn">Cancel</button>
                    <button type="submit" class="button button-primary">Generate Notes</button>
                </div>
            </form>
        </div>
    </div>
    
    <div class="modal-overlay" id="individual-flashcards-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Generate Flashcards</h3>
                <button class="close-btn">&times;</button>
            </div>
            <form id="individual-flashcards-form">
                <div class="modal-body">
                    <p class="modal-description">Create custom flashcards from your study materials. Perfect for memorizing key concepts and definitions.</p>
                    <div class="form-group">
                        <label class="label">Select Documents</label>
                        <div id="individual-flashcards-files" class="modal-file-list"></div>
                    </div>
                    <div class="form-group">
                        <label for="individual-num-flashcards">Number of Flashcards</label>
                        <div class="slider-group">
                            <input type="range" id="individual-num-flashcards" name="num_flashcards" min="5" max="50" value="20" step="5">
                            <span class="slider-value" id="individual-num-flashcards-value">20</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="button button-secondary close-btn">Cancel</button>
                    <button type="submit" class="button button-primary">Generate Flashcards</button>
                </div>
            </form>
        </div>
    </div>
    
    <div class="modal-overlay" id="individual-quiz-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Generate Practice Quiz</h3>
                <button class="close-btn">&times;</button>
            </div>
            <form id="individual-quiz-form">
                <div class="modal-body">
                    <p class="modal-description">Generate practice quizzes to test your knowledge and identify areas for improvement.</p>
                    <div class="form-group">
                        <label class="label">Select Documents</label>
                        <div id="individual-quiz-files" class="modal-file-list"></div>
                    </div>
                    <div class="form-group">
                        <label for="individual-num-quiz-questions">Number of Questions</label>
                        <div class="slider-group">
                            <input type="range" id="individual-num-quiz-questions" name="num_questions" min="5" max="30" value="10" step="5">
                            <span class="slider-value" id="individual-num-quiz-questions-value">10</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="button button-secondary close-btn">Cancel</button>
                    <button type="submit" class="button button-primary">Generate Quiz</button>
                </div>
            </form>
        </div>
    </div>
    
    <div class="modal-overlay" id="individual-cheatsheet-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Generate Cheat Sheet</h3>
                <button class="close-btn">&times;</button>
            </div>
            <form id="individual-cheatsheet-form">
                <div class="modal-body">
                    <p class="modal-description">Create one-page reference sheets with key formulas, concepts, and quick facts for quick revision.</p>
                    <div class="form-group">
                        <label class="label">Select Documents</label>
                        <div id="individual-cheatsheet-files" class="modal-file-list"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="button button-secondary close-btn">Cancel</button>
                    <button type="submit" class="button button-primary">Generate Cheat Sheet</button>
                </div>
            </form>
        </div>
    </div>

    <!-- "Stuck on a Question" Modal -->
    <div class="modal-overlay" id="stuck-question-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Stuck on a Question? Let's solve it.</h3>
                <button class="close-btn">&times;</button>
            </div>
            <div class="modal-body" id="stuck-question-body">
                <!-- Screen 1: Start -->
                <div id="sq-screen-start">
                    <form id="sq-start-form">
                        <input type="file" id="sq-file-input" accept="image/png, image/jpeg, application/pdf" style="display:none;">
                        <div id="sq-upload-area" onclick="document.getElementById('sq-file-input').click();">
                            <h4>Upload a photo or PDF of your question</h4>
                            <p style="color: var(--text-secondary); font-size: 0.9rem;">Click here to select a file</p>
                            <span id="sq-file-name" style="font-weight: 500;"></span>
                        </div>
                        <p style="margin: 1.5rem 0; font-weight: 600;">OR</p>
                        <textarea id="sq-text-input" rows="4" placeholder="Paste or type your question here..." style="width: 100%; box-sizing: border-box;"></textarea>
                        <div class="modal-footer" style="padding: 1.5rem 0 0 0; border: none;">
                            <button type="submit" class="button button-primary" id="sq-submit-btn">Let's Go!</button>
                        </div>
                    </form>
                </div>
                <!-- Screen 2: Confirm -->
                <div id="sq-screen-confirm" style="display: none;">
                    <h4>Is this your question?</h4>
                    <div id="sq-question-preview"></div>
                    <div style="display: flex; justify-content: center; gap: 1rem; margin-top: 1.5rem;">
                        <button class="button button-danger" id="sq-confirm-no-btn">No, try again</button>
                        <button class="button button-primary" id="sq-confirm-yes-btn">Yes, start solving!</button>
                    </div>
                </div>
                <!-- Screen 3: Solving Interface -->
                <div id="sq-screen-solving" style="display: none;">
                    <div id="sq-messages">
                        <!-- Messages will be injected here -->
                    </div>
                    <div id="sq-input-container">
                         <div id="sq-actions" style="display: none;">
                            <button class="button button-secondary" id="sq-action-confused-btn"> I don't understand this step</button>
                            <button class="button button-primary" id="sq-action-continue-btn"> I understand, continue</button>
                        </div>
                        <form id="sq-clarification-form" style="display: none;">
                            <label for="sq-clarification-input">Ask a specific question about this step...</label>
                            <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
                                <input type="text" id="sq-clarification-input" placeholder="e.g., Why did we divide by 2?" required>
                                <button type="submit" class="button button-primary">Ask</button>
                            </div>
                        </form>
                         <div id="sq-practice-actions" style="display: none;">
                            <button class="button button-secondary" id="sq-action-end-btn">No thanks, I'm done</button>
                            <button class="button button-primary" id="sq-action-practice-btn">Yes, give me a practice question!</button>
                        </div>
                        <form id="sq-practice-form" style="display: none;">
                            <label for="sq-practice-input">Type your answer here:</label>
                            <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
                                <input type="text" id="sq-practice-input" required>
                                <button type="submit" class="button button-primary">Check My Answer</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- NEW: Comprehensive Onboarding System for Hub Page -->
    
    <!-- Onboarding Spotlight Elements -->
    <div id="onboarding-spotlight-overlay"></div>
    <div id="onboarding-tooltip"></div>
    
    <!-- Onboarding Completion Modal -->
    <div id="onboarding-completion-modal">
        <div class="completion-content">
            <h1> Amazing!</h1>
            <p>Great! You've explored only a couple of the dozens of features on this site to truly transform your university life. Keep exploring with this sample lecture and, when you're ready, feel free to create your very own Study Hub!</p>
            
            <div class="completion-actions">
                <button id="completion-explore-btn" class="button button-primary">Keep Exploring </button>
                <button id="completion-create-hub-btn" class="button button-secondary">Create My Own Hub</button>
            </div>
        </div>
    </div>

    <!-- Study Hub Intro Modal -->
    <div id="onboarding-hub-intro-modal">
        <div class="hub-intro-content">
            <h1> Welcome to Your Study Hub!</h1>
            <p>Each module gets its own hub. Here, FociAI turns your lectures, notes, and assignments into powerful study tools  all in one place.</p>
            
            
            <button id="onboarding-hub-continue-btn">Let's Explore! </button>
        </div>
    </div>

    <!-- AI Tutor Exploration Modal -->
    <div id="onboarding-tutor-modal">
        <div class="tutor-intro-content">
            <h1> Meet Your AI Tutor</h1>
            <p>This is your personal AI tutor. You can ask questions about any content in this hub and get instant, detailed explanations.</p>
            
            <div class="tutor-demo-area">
                <div class="demo-chat">
                    <div class="demo-message user-message">
                        <strong>You:</strong> "What is machine learning?"
                    </div>
                    <div class="demo-message ai-message">
                        <strong>AI Tutor:</strong> "Machine learning is a subset of artificial intelligence that enables computers to learn and improve from experience without being explicitly programmed..."
                    </div>
                </div>
            </div>
            
            <button id="onboarding-tutor-continue-btn">Got it! Continue </button>
        </div>
    </div>


    

    <!-- NEW: Spotify Player HTML -->
    {% if spotify_connected %}
    <div id="spotify-player-container">
        <div class="sp-track-info">
            <img id="sp-album-art" src="" alt="Album Art" class="sp-album-art">
            <div class="sp-track-details">
                <p id="sp-track-title">Connecting to Spotify...</p>
                <p id="sp-track-artist">Please wait</p>
            </div>
        </div>
        <div class="sp-progress-bar"><div id="sp-progress" class="sp-progress"></div></div>
        <div class="sp-controls">
            <div class="sp-main-controls">
                <button id="sp-prev-btn"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="19 20 9 12 19 4 19 20"></polygon><line x1="5" y1="19" x2="5" y2="5"></line></svg></button>
                <button id="sp-play-btn" class="sp-play-btn"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="currentColor" stroke="currentColor" stroke-width="0"><path d="M8 5v14l11-7z"></path></svg></button>
                <button id="sp-next-btn"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 4 15 12 5 20 5 4"></polygon><line x1="19" y1="5" x2="19" y2="19"></line></svg></button>
            </div>
            <div class="sp-volume-control">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon></svg>
                <input type="range" id="sp-volume" min="0" max="100" value="80">
            </div>
        </div>
        
        <select id="sp-playlist-select" class="sp-playlist-select">
            <option value="">Select a playlist...</option>
        </select>
    </div>
    {% endif %}

    <script>
        // Hub files data for modals
        window.hubFiles = {{ all_files | tojson }};
        console.log(' Hub files loaded:', window.hubFiles.length);
        console.log(' Hub files data:', window.hubFiles);
        console.log(' First file structure:', window.hubFiles[0]);
        
        // Universal Notification System (copied from dashboard)
        const NOTIFICATION_TYPES = {
            SUCCESS: 'success',
            ERROR: 'error', 
            WARNING: 'warning',
            INFO: 'info',
            CONFIRM: 'confirm'
        };
        
        function showNotification(message, type = NOTIFICATION_TYPES.INFO, title = null, options = {}) {
            if (!title) {
                switch(type) {
                    case NOTIFICATION_TYPES.SUCCESS: title = 'Success!'; break;
                    case NOTIFICATION_TYPES.ERROR: title = 'Error'; break;
                    case NOTIFICATION_TYPES.WARNING: title = 'Warning'; break;
                    case NOTIFICATION_TYPES.CONFIRM: title = 'Confirm Action'; break;
                    default: title = 'Information'; break;
                }
            }
            
            const modal = document.createElement('div');
            modal.className = 'universal-notification-modal';
            modal.innerHTML = `
                <div class="universal-notification-content ${type}">
                    <div class="universal-notification-header">
                        <div class="universal-notification-icon">
                            ${getNotificationIcon(type)}
                        </div>
                        <h3 class="universal-notification-title">${title}</h3>
                        <button class="universal-notification-close" onclick="closeUniversalNotification(this)"></button>
                    </div>
                    <div class="universal-notification-body">
                        <p>${message}</p>
                    </div>
                    <div class="universal-notification-footer">
                        ${getNotificationButtons(type, options)}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            setTimeout(() => modal.classList.add('visible'), 10);
            
            modal.callback = options.callback;
            modal.confirmCallback = options.confirmCallback;
            modal.cancelCallback = options.cancelCallback;
            
            if (type !== NOTIFICATION_TYPES.CONFIRM && options.autoClose !== false) {
                setTimeout(() => {
                    if (modal.parentNode) {
                        closeUniversalNotification(modal.querySelector('.universal-notification-close'));
                    }
                }, options.autoCloseDelay || 5000);
            }
        }
        
        function getNotificationIcon(type) {
            switch(type) {
                case NOTIFICATION_TYPES.SUCCESS:
                    return '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22,4 12,14.01 9,11.01"></polyline></svg>';
                case NOTIFICATION_TYPES.ERROR:
                    return '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>';
                case NOTIFICATION_TYPES.WARNING:
                    return '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>';
                case NOTIFICATION_TYPES.CONFIRM:
                    return '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><path d="M9,12l2,2l4,-4"></path></svg>';
                default:
                    return '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><path d="M12,16v-4"></path><path d="M12,8h.01"></path></svg>';
            }
        }
        
        function getNotificationButtons(type, options) {
            if (type === NOTIFICATION_TYPES.CONFIRM) {
                return `
                    <button class="button button-secondary" onclick="handleNotificationAction(this, 'cancel')">Cancel</button>
                    <button class="button button-primary" onclick="handleNotificationAction(this, 'confirm')">Confirm</button>
                `;
            } else {
                return `<button class="button button-primary" onclick="closeUniversalNotification(this)">OK</button>`;
            }
        }
        
        function handleNotificationAction(button, action) {
            const modal = button.closest('.universal-notification-modal');
            if (action === 'confirm' && modal.confirmCallback) {
                modal.confirmCallback();
            } else if (action === 'cancel' && modal.cancelCallback) {
                modal.cancelCallback();
            }
            closeUniversalNotification(button);
        }
        
        function closeUniversalNotification(button) {
            const modal = button.closest('.universal-notification-modal');
            modal.classList.remove('visible');
            setTimeout(() => {
                if (modal.parentNode) {
                    modal.parentNode.removeChild(modal);
                }
            }, 300);
        }
        
        function showSuccess(message, title = null, options = {}) {
            showNotification(message, NOTIFICATION_TYPES.SUCCESS, title, options);
        }
        
        function showError(message, title = null, options = {}) {
            showNotification(message, NOTIFICATION_TYPES.ERROR, title, options);
        }
        
        function showWarning(message, title = null, options = {}) {
            showNotification(message, NOTIFICATION_TYPES.WARNING, title, options);
        }
        
        function showInfo(message, title = null, options = {}) {
            showNotification(message, NOTIFICATION_TYPES.INFO, title, options);
        }
        
        function showConfirm(message, title = null, options = {}) {
            showNotification(message, NOTIFICATION_TYPES.CONFIRM, title, options);
        }
        
        // Replace window.alert globally
        window.alert = function(message) {
            showInfo(message, 'Information');
        };

        document.addEventListener('DOMContentLoaded', () => {
            const hubId = '{{ hub.id }}';
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebar-toggle');
            const navLinks = document.querySelectorAll('.sidebar-nav .nav-link');
            const tabContents = document.querySelectorAll('.tab-content');
            let calendar; 
            const loadingContainer = document.getElementById('loading-status-container');
            let isAITaskRunning = false;
            
            // Add event listener for slide notes file upload
            const slideFileUpload = document.getElementById('slide-file-upload');
            if (slideFileUpload) {
                slideFileUpload.addEventListener('change', updateSlideNotesFormValidation);
            }
            
            // Add event listener for slide notes form submission
            const slideNotesForm = document.getElementById('slide-notes-form');
            if (slideNotesForm) {
                slideNotesForm.addEventListener('submit', handleSlideNotesFormSubmission);
            }
            
            // Check for onboarding completion modal
            console.log(' Checking for onboarding completion modal flag in hub...');
            console.log(' Current sessionStorage keys:', Object.keys(sessionStorage));
            console.log(' showOnboardingCompletionModal value:', sessionStorage.getItem('showOnboardingCompletionModal'));
            
            // Only show completion modal if we're not in the middle of onboarding
            const isOnboarding = sessionStorage.getItem('onboardingStep') === 'hub_entry';
            console.log(' Is currently onboarding:', isOnboarding);
            
            // Always clear the completion modal flag when hub loads to prevent premature display
            if (sessionStorage.getItem('showOnboardingCompletionModal') === '1') {
                console.log(' Clearing completion modal flag on hub load to prevent premature display');
                sessionStorage.removeItem('showOnboardingCompletionModal');
            }
            
            console.log(' Completion modal check completed - flag cleared if present');
            
            // Completion modal button handlers
            const completionExploreBtn = document.getElementById('completion-explore-btn');
            const completionCreateHubBtn = document.getElementById('completion-create-hub-btn');
            
            if (completionExploreBtn) {
                completionExploreBtn.addEventListener('click', () => {
                    hideCompletionModal();
                    // User can continue exploring the hub
                });
            }
            
            if (completionCreateHubBtn) {
                completionCreateHubBtn.addEventListener('click', () => {
                    hideCompletionModal();
                    // Redirect to dashboard to create a new hub
                    window.location.href = '/dashboard';
                });
            }
            
            // --- Task Queue System ---
            const taskQueue = {
                tasks: [],
                maxTasks: 3,
                processing: false,
                
                addTask: function(type, title, files, options = {}) {
                    if (this.tasks.length >= this.maxTasks) {
                        showCustomAlert(`Maximum ${this.maxTasks} tasks allowed. Please wait for current tasks to complete.`, 'Task Limit Reached');
                        return false;
                    }
                    
                    const taskId = 'task_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    const task = {
                        id: taskId,
                        type: type,
                        title: title,
                        files: files,
                        options: options,
                        status: 'queued',
                        progress: 0,
                        result: null,
                        createdAt: new Date()
                    };
                    
                    this.tasks.push(task);
                    this.renderTasks();
                    this.processNext();
                    return taskId;
                },
                
                updateTaskStatus: function(taskId, status, progress = 0, result = null) {
                    const task = this.tasks.find(t => t.id === taskId);
                    if (task) {
                        task.status = status;
                        task.progress = progress;
                        if (result) task.result = result;
                        this.renderTasks();
                        
                        if (status === 'completed') {
                            this.processing = false;
                            this.processNext();
                        }
                    }
                },
                
                removeTask: function(taskId) {
                    this.tasks = this.tasks.filter(t => t.id !== taskId);
                    this.renderTasks();
                    this.processing = false;
                    this.processNext();
                },
                
                processNext: function() {
                    if (this.processing) return;
                    
                    const nextTask = this.tasks.find(t => t.status === 'queued');
                    if (nextTask) {
                        this.processing = true;
                        this.updateTaskStatus(nextTask.id, 'processing', 0);
                        this.executeTask(nextTask);
                    }
                },
                
                executeTask: function(task) {
                    // Simulate progress updates
                    let progress = 0;
                    const progressInterval = setInterval(() => {
                        progress += Math.random() * 15;
                        if (progress > 90) progress = 90;
                        this.updateTaskStatus(task.id, 'processing', progress);
                    }, 500);
                    
                    // Execute the actual task
                    this.performTask(task).then(result => {
                        clearInterval(progressInterval);
                        this.updateTaskStatus(task.id, 'completed', 100, result);
                    }).catch(error => {
                        clearInterval(progressInterval);
                        this.updateTaskStatus(task.id, 'error', 0);
                        console.error('Task failed:', error);
                    });
                },
                
                performTask: async function(task) {
                    const { type, files, options } = task;
                    const hubId = "{{ hub.id }}";
                    
                    let endpoint, payload;
                    
                    switch (type) {
                        case 'notes':
                            endpoint = `/hub/${hubId}/generate_individual_notes`;
                            payload = { 
                                selected_files: files,
                                note_type: options.note_type || 'condensed'
                            };
                            console.log(' Notes task payload:', payload);
                            break;
                        case 'flashcards':
                            endpoint = `/hub/${hubId}/generate_individual_flashcards`;
                            payload = { selected_files: files, num_flashcards: options.num_flashcards || 5 };
                            break;
                        case 'quiz':
                            endpoint = `/hub/${hubId}/generate_individual_quiz`;
                            payload = { selected_files: files, num_quiz_questions: options.num_quiz_questions || 5 };
                            break;
                        case 'cheatsheet':
                            endpoint = `/hub/${hubId}/generate_individual_cheatsheet`;
                            payload = { selected_files: files };
                            break;
                        case 'revision_pack':
                            endpoint = `/hub/${hubId}/build_revision_pack`;
                            payload = { 
                                selected_files: files, 
                                include_notes: options.include_notes || true,
                                num_flashcards: options.num_flashcards || 5,
                                num_quiz_questions: options.num_quiz_questions || 5
                            };
                            break;
                        default:
                            throw new Error('Unknown task type');
                    }
                    
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const result = await response.json();
                    if (!result.success) {
                        throw new Error(result.message || 'Task failed');
                    }
                    
                    return result;
                },
                
                renderTasks: function() {
                    const container = document.getElementById('task-queue-list');
                    const countElement = document.getElementById('task-count');
                    
                    if (!container || !countElement) return;
                    
                    countElement.textContent = `${this.tasks.length}/${this.maxTasks}`;
                    
                    if (this.tasks.length === 0) {
                        container.innerHTML = '<div class="task-item queued"><div class="task-content"><div class="task-title">No tasks in queue</div></div></div>';
                        return;
                    }
                    
                    container.innerHTML = this.tasks.map(task => {
                        const icon = this.getTaskIcon(task.type);
                        const statusText = this.getStatusText(task.status);
                        
                        return `
                            <div class="task-item ${task.status}" data-task-id="${task.id}">
                                <div class="task-icon">${icon}</div>
                                <div class="task-content">
                                    <div class="task-title">${task.title}</div>
                                    <div class="task-status">${statusText}</div>
                                    ${task.status === 'processing' || task.status === 'completed' ? 
                                        `<div class="task-progress"><div class="task-progress-bar" style="width: ${task.progress}%"></div></div>` : 
                                        ''
                                    }
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    // Add click handlers for completed tasks
                    container.querySelectorAll('.task-item.completed').forEach(item => {
                        item.addEventListener('click', () => this.handleTaskClick(item.dataset.taskId));
                    });
                },
                
                getTaskIcon: function(type) {
                    const icons = {
                        'notes': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14,2 14,8 20,8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10,9 9,9 8,9"></polyline></svg>',
                        'flashcards': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="9" y1="9" x2="15" y2="9"></line><line x1="9" y1="15" x2="15" y2="15"></line></svg>',
                        'quiz': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>',
                        'cheatsheet': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14,2 14,8 20,8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10,9 9,9 8,9"></polyline></svg>',
                        'revision_pack': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>'
                    };
                    return icons[type] || icons['notes'];
                },
                
                getStatusText: function(status) {
                    const statusTexts = {
                        'queued': 'Queued',
                        'processing': 'Processing...',
                        'completed': 'Click to view',
                        'error': 'Failed'
                    };
                    return statusTexts[status] || status;
                },
                
                handleTaskClick: function(taskId) {
                    const task = this.tasks.find(t => t.id === taskId);
                    if (!task || task.status !== 'completed') return;
                    
                    // Handle real activities from database
                    if (task.activityId) {
                        if (task.isPack) {
                            // For pack-based tasks, go to folders tab
                            const foldersTab = document.querySelector('.nav-link[data-tab="folders"]');
                            if (foldersTab) foldersTab.click();
                            
                            // Only remove this task if it's the last completed task in the pack
                            const packTasks = this.tasks.filter(t => t.folderName === task.folderName);
                            const completedPackTasks = packTasks.filter(t => t.status === 'completed');
                            
                            if (completedPackTasks.length === packTasks.length) {
                                // All tasks in pack are completed, remove all pack tasks
                                packTasks.forEach(packTask => {
                                    this.removeTask(packTask.id);
                                });
                            } else {
                                // Some tasks still processing, just remove this completed task
                                this.removeTask(taskId);
                            }
                        } else {
                            // For individual tasks, redirect to the activity
                            if (task.type === 'notes') {
                                window.location.href = `/note/${task.activityId}`;
                            } else if (task.type === 'quiz') {
                                window.location.href = `/quiz/${task.activityId}`;
                            } else if (task.type === 'flashcards') {
                                window.location.href = `/flashcards/${task.activityId}`;
                            }
                            this.removeTask(taskId);
                        }
                    } else if (task.type === 'revision_pack') {
                        // For revision packs, go to folders tab
                        const foldersTab = document.querySelector('.nav-link[data-tab="folders"]');
                        if (foldersTab) foldersTab.click();
                        this.removeTask(taskId);
                    } else if (task.result && task.result.redirect_url) {
                        // For individual tools, redirect to the generated content
                        window.location.href = task.result.redirect_url;
                        this.removeTask(taskId);
                    }
                }
            };
            
            // Function to initialize task queue with real activities from database
            function initializeTaskQueueWithRealActivities() {
                // Get activities from the template data
                const activities = {{ all_activities | tojson }};
                
                // Filter for pending/processing activities
                const pendingActivities = activities.filter(activity => 
                    activity.status === 'pending' || activity.status === 'processing'
                );
                
                // Group activities by folder (for pack-based tasks)
                const activityGroups = {};
                pendingActivities.forEach(activity => {
                    // Find which folder this activity belongs to
                    const folders = {{ all_folders | tojson }};
                    let folderName = 'Individual Task';
                    
                    for (const folder of folders) {
                        if (folder.items && folder.items.some(item => item.id === activity.id)) {
                            folderName = folder.name;
                            break;
                        }
                    }
                    
                    if (!activityGroups[folderName]) {
                        activityGroups[folderName] = [];
                    }
                    activityGroups[folderName].push(activity);
                });
                
                // Add grouped activities to task queue
                Object.keys(activityGroups).forEach(folderName => {
                    const groupActivities = activityGroups[folderName];
                    const isPack = groupActivities.length > 1;
                    
                    groupActivities.forEach(activity => {
                        const taskId = 'real_' + activity.id;
                        const task = {
                            id: taskId,
                            type: activity.type.toLowerCase(),
                            title: activity.title,
                            status: activity.status,
                            progress: activity.status === 'processing' ? 50 : 0,
                            result: null,
                            createdAt: new Date(activity.created_at),
                            activityId: activity.id,
                            folderName: folderName,
                            isPack: isPack,
                            groupSize: groupActivities.length
                        };
                        
                        taskQueue.tasks.push(task);
                    });
                });
                
                taskQueue.renderTasks();
            }
            
            // Initialize task queue with real activities from database
            initializeTaskQueueWithRealActivities();
            
            // Refresh task queue every 5 seconds to check for status updates
            setInterval(refreshTaskQueue, 5000);
            
            function refreshTaskQueue() {
                // Only refresh if there are pending/processing tasks
                const hasActiveTasks = taskQueue.tasks.some(task => 
                    task.status === 'pending' || task.status === 'processing'
                );
                
                if (hasActiveTasks) {
                    // Fetch updated activities via AJAX
                    fetch(`/hub/{{ hub.id }}/get_activities_status`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                updateTaskQueueWithNewStatuses(data.activities);
                            }
                        })
                        .catch(error => {
                            console.error('Error refreshing task queue:', error);
                        });
                }
            }
            
            function updateTaskQueueWithNewStatuses(activities) {
                // Update existing tasks with new statuses
                taskQueue.tasks.forEach(task => {
                    if (task.activityId) {
                        const activity = activities.find(a => a.id === task.activityId);
                        if (activity) {
                            const oldStatus = task.status;
                            task.status = activity.status;
                            task.progress = activity.status === 'processing' ? 50 : 
                                           activity.status === 'completed' ? 100 : 0;
                            
                            // If status changed, re-render
                            if (oldStatus !== activity.status) {
                                taskQueue.renderTasks();
                            }
                        }
                    }
                });
            }
            
            // --- UI Elements ---
            const allModals = document.querySelectorAll('.modal-overlay');
            const revisionModal = document.getElementById('revision-pack-modal');
            const examKitModal = document.getElementById('exam-kit-modal');
            const studyPlanModal = document.getElementById('study-plan-modal');
            const calendarEl = document.getElementById('fullcalendar');
            const scheduleModal = document.getElementById('schedule-event-modal');
            const detailsModal = document.getElementById('event-details-modal');
            const importModal = document.getElementById('import-ics-modal');
            const addItemsModal = document.getElementById('add-items-modal');
            const uploadInput = document.getElementById('pdf-upload');
            const themeToggle = document.getElementById('theme-toggle');
            const slideNotesModal = document.getElementById('slide-notes-modal');
            const studyToolsTab = document.getElementById('tools');
            const toolFileSelectModal = document.getElementById('tool-file-select-modal');

            // --- Tool Category Navigation Elements ---
            const toolCategorySelection = document.getElementById('tool-category-selection');
            const inLectureTools = document.getElementById('in-lecture-tools');
            const revisionExamsTools = document.getElementById('revision-exams-tools');
            const backToCategoriesBtns = document.querySelectorAll('.tool-category-back-button');

            // --- Sidebar and Navigation Logic ---
            const iconCollapse = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="9" y1="3" x2="9" y2="21"></line></svg>`;
            const iconExpand = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>`;

            sidebarToggle.addEventListener('click', () => {
                const isCurrentlyCollapsed = sidebar.classList.contains('collapsed');
                sidebar.classList.toggle('collapsed');
                sidebarToggle.innerHTML = isCurrentlyCollapsed ? iconCollapse : iconExpand;
                
                // Add visual feedback
                sidebarToggle.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    sidebarToggle.style.transform = '';
                }, 150);

                if (calendar) {
                    setTimeout(() => calendar.updateSize(), 350);
                }
            });
            
            // Initialize the correct icon based on current state
            sidebarToggle.innerHTML = sidebar.classList.contains('collapsed') ? iconExpand : iconCollapse;

            function showTab(tabId) {
                navLinks.forEach(link => link.classList.toggle('active', link.dataset.tab === tabId));
                tabContents.forEach(content => content.classList.toggle('active', content.id === tabId));
                window.location.hash = tabId;

                if (tabId === 'calendar' && calendarEl) {
                    if (!calendar) initializeCalendar();
                    else setTimeout(() => calendar.render(), 10);
                }
                 if (tabId === 'progress') {
                    renderQuizChart();
                }
            }
            
            function goToEarnMoney() {
                // Redirect to dashboard with earn money tab
                window.location.href = "{{ url_for('dashboard') }}#earn-money";
            }

            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    // Allow the Back to Dashboard button to navigate normally
                    if (link.classList.contains('back-to-dashboard')) {
                        return; // Let the default link behavior work
                    }
                    e.preventDefault();
                    showTab(e.currentTarget.dataset.tab);
                    
                    // Check if we're in onboarding and clicked Study Tools
                    const onboardingStep = sessionStorage.getItem('onboardingStep');
                    console.log(' Study Tools clicked - onboardingStep:', onboardingStep);
                    console.log(' Tab clicked:', e.currentTarget.dataset.tab);
                    
                    if (e.currentTarget.dataset.tab === 'tools' && onboardingStep === 'hub_entry') {
                        console.log(' Study Tools clicked during onboarding, triggering next step...');
                        // Wait for the Study Tools content to load, then guide to "In a Lecture"
                        setTimeout(() => {
                            guideToInLecture();
                        }, 1000);
                    } else {
                        console.log(' Study Tools click not triggering onboarding - conditions not met');
                        console.log('   - Tab is tools:', e.currentTarget.dataset.tab === 'tools');
                        console.log('   - Onboarding step is hub_entry:', onboardingStep === 'hub_entry');
                    }
                });
            });

            const currentHash = window.location.hash.substring(1);
            if (currentHash && document.getElementById(currentHash)) {
                showTab(currentHash);
            } else {
                showTab('tools'); // Default to Study Tools
            }

            // --- Quick Action Buttons ---
            document.getElementById('quick-action-upload').addEventListener('click', () => {
                uploadInput.click();
            });

            // --- Profile Dropdown ---
            const profileDropdown = document.getElementById('profile-dropdown');
            const profileTrigger = profileDropdown.querySelector('.profile-trigger');
            
            profileTrigger.addEventListener('click', (e) => {
                e.stopPropagation();
                profileDropdown.classList.toggle('active');
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!profileDropdown.contains(e.target)) {
                    profileDropdown.classList.remove('active');
                }
            });


            // --- Generic Modal Handling ---
            allModals.forEach(modal => {
                if(modal){
                    modal.querySelectorAll('.close-btn').forEach(btn => btn.addEventListener('click', () => modal.style.display = 'none'));
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) modal.style.display = 'none';
                    });
                }
            });
             document.getElementById('show-schedule-modal-btn')?.addEventListener('click', () => scheduleModal.style.display = 'flex');
             document.getElementById('show-import-modal-btn')?.addEventListener('click', () => importModal.style.display = 'flex');

            function showLoading(message, subtext) {
                isAITaskRunning = true;
                loadingContainer.innerHTML = `<div class="loading-card"><div class="spinner"></div><div class="loading-text"><h4>${message}</h4><p>${subtext}</p></div></div>`;
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            function hideLoading() {
                isAITaskRunning = false;
                loadingContainer.innerHTML = '';
            }

            // --- File Upload & Post-Upload Options ---
            uploadInput.addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if (!file) return;

                showLoading('Uploading your document...', 'Please wait while we process the file.');
                const formData = new FormData();
                formData.append('pdf', file);

                try {
                    const response = await fetch(`/hub/${hubId}/upload`, { method: 'POST', body: formData });
                    const result = await response.json();
                    hideLoading();
                    if (result.success) {
                        addFileToUI(result.file_info);
                        // --- SECOND "AHA" MOMENT LOGIC ---
                        const isWelcomeHub = "{{ hub.name }}".includes("Welcome");
                        const fileCount = document.querySelectorAll('#main-file-list .file-item-card').length;
                        if (!isWelcomeHub && fileCount === 1) {
                            setTimeout(() => {
                                showCustomAlert("Your document is ready! Why not ask the AI Tutor to summarize its key concepts for you?", 'Document Ready');
                                showTab('tutor');
                                const tutorInput = document.getElementById('tutor-user-input');
                                tutorInput.value = `Summarize the key concepts of the document I just uploaded.`;
                                tutorInput.focus();
                            }, 500);
                        } else {
                            // Show simple success message instead of modal
                            showMessage('success', `"${result.file_info.name}" uploaded successfully!`);
                        }
                    } else {
                        showCustomAlert(`Upload failed: ${result.message}`, 'Upload Error');
                    }
                } catch (error) {
                    hideLoading();
                    showCustomAlert('An error occurred during upload. Please try again.', 'Upload Error');
                    console.error('Upload error:', error);
                } finally {
                    event.target.value = '';
                }
            });

            function addFileToUI(fileInfo) {
                const emptyMessage = document.getElementById('empty-file-list-message');
                if (emptyMessage) emptyMessage.remove();
                const fileList = document.getElementById('main-file-list');
                
                // Determine file extension and create appropriate icon
                const fileExt = fileInfo.name.split('.').pop().toLowerCase();
                let fileIcon = '';
                
                if (fileExt === 'pdf') {
                    fileIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="1.5" style="color: #dc2626;"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><text x="12" y="16" text-anchor="middle" font-family="Arial" font-size="6" font-weight="bold">PDF</text></svg>`;
                } else if (['docx', 'doc'].includes(fileExt)) {
                    fileIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="1.5" style="color: #2563eb;"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><text x="12" y="16" text-anchor="middle" font-family="Arial" font-size="5" font-weight="bold">DOC</text></svg>`;
                } else if (['pptx', 'ppt'].includes(fileExt)) {
                    fileIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="1.5" style="color: #dc2626;"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><text x="12" y="16" text-anchor="middle" font-family="Arial" font-size="5" font-weight="bold">PPT</text></svg>`;
                } else {
                    fileIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>`;
                }
                
                const fileItemHTML = `
                    <div class="file-item-card clickable-file" data-file-path="${fileInfo.path}" data-file-name="${fileInfo.name}">
                        <div class="file-info">
                            <span class="file-icon">${fileIcon}</span>
                            <span class="file-name">${fileInfo.name}</span>
                        </div>
                        <div class="file-actions">
                            <span class="file-size">${(fileInfo.size / 1024).toFixed(1)} KB</span>
                            <div class="action-buttons">
                                <button class="view-btn" title="Open file" data-file-path="${fileInfo.path}" data-file-name="${fileInfo.name}">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                                </button>
                                <a href="/hub/${hubId}/delete_file?file_path=${encodeURIComponent(fileInfo.path)}" class="delete-btn delete-file-btn" title="Delete file" data-file-path="${fileInfo.path}">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                                </a>
                            </div>
                        </div>
                    </div>`;
                fileList.insertAdjacentHTML('beforeend', fileItemHTML);
                
                // Add event listeners to the new file card
                const newCard = fileList.lastElementChild;
                addFileCardEventListeners(newCard);
            }

            function addFileCardEventListeners(fileCard) {
                // Handle file card clicks
                fileCard.addEventListener('click', function(e) {
                    // Don't trigger if clicking on buttons or links
                    if (e.target.closest('.view-btn') || e.target.closest('.delete-btn')) {
                        return;
                    }
                    
                    const filePath = this.dataset.filePath;
                    const fileName = this.dataset.fileName;
                    
                    if (filePath) {
                        console.log(' Opening file:', fileName);
                        // Open file in new tab
                        const viewUrl = `/hub/{{ hub.id }}/view_file?file_path=${encodeURIComponent(filePath)}`;
                        window.open(viewUrl, '_blank');
                    }
                });
                
                // Handle view button clicks
                const viewBtn = fileCard.querySelector('.view-btn');
                if (viewBtn) {
                    viewBtn.addEventListener('click', function(e) {
                        e.stopPropagation(); // Prevent card click
                        
                        const filePath = this.dataset.filePath;
                        const fileName = this.dataset.fileName;
                        
                        if (filePath) {
                            console.log(' Viewing file:', fileName);
                            // Open file in new tab
                            const viewUrl = `/hub/{{ hub.id }}/view_file?file_path=${encodeURIComponent(filePath)}`;
                            window.open(viewUrl, '_blank');
                        }
                    });
                }
                
                // Handle delete button clicks with confirmation
                const deleteBtn = fileCard.querySelector('.delete-file-btn');
                if (deleteBtn) {
                    deleteBtn.addEventListener('click', function(e) {
                        e.stopPropagation(); // Prevent card click
                        e.preventDefault(); // Prevent default link behavior
                        
                        const filePath = this.dataset.filePath;
                        const fileName = fileCard.dataset.fileName;
                        
                        if (filePath) {
                            showCustomConfirmation(
                                `Are you sure you want to delete "${fileName}"? This action cannot be undone.`,
                                function() {
                                    console.log(' Deleting file:', fileName);
                                    // Proceed with deletion
                                    window.location.href = this.href;
                                },
                                null,
                                'Delete'
                            );
                        }
                    });
                }
            }

            function populateModalFileList(containerId, fileList, { multiSelect = true, preselectPaths = [] } = {}) {
                const container = document.getElementById(containerId);
                if (!container) return;
                container.innerHTML = '';
                const inputType = multiSelect ? 'checkbox' : 'radio';
                fileList.forEach(file => {
                    const isChecked = preselectPaths.includes(file.path) ? 'checked' : '';
                    const itemHTML = `
                        <div class="modal-file-item">
                            <label>
                                <input type="${inputType}" name="${containerId}_files" value="${file.path}" ${isChecked}>
                                <span class="file-icon-modal">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
                                </span>
                                ${file.name}
                            </label>
                        </div>`;
                    container.insertAdjacentHTML('beforeend', itemHTML);
                });
            }

            function openRevisionPackModal(preselectPaths = []) {
                if(getAllFiles().length === 0) return showCustomAlert("Please upload at least one document first.", 'No Documents');
                populateModalFileList('revision-pack-files', getAllFiles(), { preselectPaths });
                revisionModal.style.display = 'flex';
            }
            
            document.getElementById('revision-pack-form')?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const selectedFiles = Array.from(form.querySelectorAll('input[name="revision-pack-files_files"]:checked')).map(cb => cb.value);
                if (selectedFiles.length === 0) return showCustomAlert("Please select at least one document.", 'No Selection');
                
                const payload = {
                    selected_files: selectedFiles,
                    num_flashcards: form.num_flashcards.value,
                    num_quiz_questions: form.num_quiz_questions.value,
                    include_notes: form.include_notes.checked
                };
                
                // Show loading state
                const submitButton = form.querySelector('button[type="submit"]');
                const originalButtonText = submitButton.textContent;
                submitButton.disabled = true;
                submitButton.innerHTML = '<i data-lucide="loader-2" class="animate-spin"></i> Generating Pack...';
                
                // Close modal but keep loading state
                revisionModal.style.display = 'none';
                
                // Show loading overlay
                showLoadingOverlay('Generating your revision pack...', 'This may take 30-60 seconds depending on document size.');
                
                try {
                    const response = await fetch(`/hub/${hubId}/build_revision_pack`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
                    const result = await response.json();
                    
                    hideLoadingOverlay();
                    
                    if (result.success) {
                        // Check if this is during onboarding
                        const isOnboarding = sessionStorage.getItem('onboardingStep') === 'hub_entry' || 
                                           sessionStorage.getItem('showOnboardingCelebration') === '1' ||
                                           sessionStorage.getItem('onboardingGenerating') === '1';
                        
                        if (isOnboarding) {
                            // Set flag to show Task Queue tooltip after page reload
                            sessionStorage.setItem('showTaskQueueTooltip', '1');
                            
                            // Don't complete onboarding yet - let the user finish the full flow
                            // Keep onboardingStep for the Study Tools click handler
                            
                            // Persist a flag to show celebration after reload so folders reflect the new pack
                            sessionStorage.setItem('showOnboardingCelebration', '1');
                            sessionStorage.removeItem('onboardingGenerating');
                        } else {
                            // Show regular success message for non-onboarding users
                            showSuccessMessage('Revision pack created successfully!');
                        }
                        
                        // Navigate to folders and reload after a short delay
                        setTimeout(() => {
                            window.location.hash = 'folders';
                            window.location.reload();
                        }, 1500);
                    } else {
                        showErrorMessage(`Error: ${result.message}`);
                        // Reset button state
                        submitButton.disabled = false;
                        submitButton.textContent = originalButtonText;
                        revisionModal.style.display = 'flex';
                    }
                } catch (error) {
                    hideLoadingOverlay();
                    showErrorMessage('A network or server error occurred. Please try again.');
                    console.error('Revision pack generation error:', error);
                    
                    // Reset button state
                    submitButton.disabled = false;
                    submitButton.textContent = originalButtonText;
                    revisionModal.style.display = 'flex';
                }
            });

            function openExamKitModal(preselectPaths = []) {
                 if(getAllFiles().length === 0) return showCustomAlert("Please upload at least one document first.", 'No Documents');
                 populateModalFileList('exam-kit-lecture-files', getAllFiles(), { preselectPaths });
                 populateModalFileList('exam-kit-past-paper-files', getAllFiles());
                 examKitModal.style.display = 'flex';
            }

            function openIndividualNotesModal(preselectPaths = []) {
                if(getAllFiles().length === 0) return showCustomAlert("Please upload at least one document first.", 'No Documents');
                populateModalFileList('individual-notes-files', getAllFiles(), { preselectPaths });
                document.getElementById('individual-notes-modal').style.display = 'flex';
            }

            function openIndividualFlashcardsModal(preselectPaths = []) {
                if(getAllFiles().length === 0) return showCustomAlert("Please upload at least one document first.", 'No Documents');
                populateModalFileList('individual-flashcards-files', getAllFiles(), { preselectPaths });
                document.getElementById('individual-flashcards-modal').style.display = 'flex';
            }

            function openIndividualQuizModal(preselectPaths = []) {
                if(getAllFiles().length === 0) return showCustomAlert("Please upload at least one document first.", 'No Documents');
                populateModalFileList('individual-quiz-files', getAllFiles(), { preselectPaths });
                document.getElementById('individual-quiz-modal').style.display = 'flex';
            }

            function openIndividualCheatsheetModal(preselectPaths = []) {
                if(getAllFiles().length === 0) return showCustomAlert("Please upload at least one document first.", 'No Documents');
                populateModalFileList('individual-cheatsheet-files', getAllFiles(), { preselectPaths });
                document.getElementById('individual-cheatsheet-modal').style.display = 'flex';
            }

            // Individual tool form handlers
            document.getElementById('individual-notes-form')?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const selectedFiles = Array.from(form.querySelectorAll('input[name="individual-notes-files_files"]:checked')).map(cb => cb.value);
                const noteType = form.querySelector('input[name="note_type"]:checked').value;
                
                if (selectedFiles.length === 0) return showCustomAlert("Please select at least one document.", 'No Selection');
                
                document.getElementById('individual-notes-modal').style.display = 'none';
                
                // Add to task queue with note type
                const firstFileName = selectedFiles[0].split('/').pop().replace(/\.[^/.]+$/, '');
                const taskTitle = `${noteType === 'key_points' ? 'Key Points' : noteType === 'condensed' ? 'Condensed Notes' : 'Detailed Notes'}: ${firstFileName}`;
                taskQueue.addTask('notes', taskTitle, selectedFiles, { note_type: noteType });
            });

            document.getElementById('individual-flashcards-form')?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const selectedFiles = Array.from(form.querySelectorAll('input[name="individual-flashcards-files_files"]:checked')).map(cb => cb.value);
                const numFlashcards = parseInt(form.num_flashcards.value);
                if (selectedFiles.length === 0) return showCustomAlert("Please select at least one document.", 'No Selection');
                
                document.getElementById('individual-flashcards-modal').style.display = 'none';
                
                // Add to task queue instead of direct generation
                const firstFileName = selectedFiles[0].split('/').pop().replace('.pdf', '');
                taskQueue.addTask('flashcards', `Flashcards: ${firstFileName} (${numFlashcards} cards)`, selectedFiles, { num_flashcards: numFlashcards });
            });

            document.getElementById('individual-quiz-form')?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const selectedFiles = Array.from(form.querySelectorAll('input[name="individual-quiz-files_files"]:checked')).map(cb => cb.value);
                const numQuestions = parseInt(form.num_questions.value);
                if (selectedFiles.length === 0) return showCustomAlert("Please select at least one document.", 'No Selection');
                
                document.getElementById('individual-quiz-modal').style.display = 'none';
                
                // Add to task queue instead of direct generation
                const firstFileName = selectedFiles[0].split('/').pop().replace('.pdf', '');
                taskQueue.addTask('quiz', `Quiz: ${firstFileName} (${numQuestions} questions)`, selectedFiles, { num_quiz_questions: numQuestions });
            });

            document.getElementById('individual-cheatsheet-form')?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const selectedFiles = Array.from(form.querySelectorAll('input[name="individual-cheatsheet-files_files"]:checked')).map(cb => cb.value);
                if (selectedFiles.length === 0) return showCustomAlert("Please select at least one document.", 'No Selection');
                
                document.getElementById('individual-cheatsheet-modal').style.display = 'none';
                
                // Add to task queue instead of direct generation
                const firstFileName = selectedFiles[0].split('/').pop().replace('.pdf', '');
                taskQueue.addTask('cheatsheet', `Cheat Sheet: ${firstFileName}`, selectedFiles);
            });

            document.getElementById('exam-kit-form')?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const lectureFiles = Array.from(form.querySelectorAll('input[name="exam-kit-lecture-files_files"]:checked')).map(cb => cb.value);
                const pastPaperFiles = Array.from(form.querySelectorAll('input[name="exam-kit-past-paper-files_files"]:checked')).map(cb => cb.value);
                if(lectureFiles.length === 0) return showWarning("Please select at least one main lecture document.");
                examKitModal.style.display = 'none';
                showLoading("Assembling Your Exam Kit...", "Analyzing documents and generating resources.");
                 try {
                    const response = await fetch(`/hub/${hubId}/build_exam_kit`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ lecture_files: lectureFiles, past_paper_files: pastPaperFiles }) });
                    const result = await response.json();
                    if (result.success) { window.location.hash = 'folders'; window.location.reload(); } 
                    else { showError(`Error: ${result.message}`); hideLoading(); }
                } catch (error) { showError('A network or server error occurred.'); hideLoading(); }
            });
            
            function openStudyPlanModal() {
                 if(getAllFiles().length === 0) return showWarning("Please upload at least one syllabus document first.");
                 populateModalFileList('study-plan-files', getAllFiles());
                 studyPlanModal.style.display = 'flex';
            }

            document.getElementById('study-plan-form')?.addEventListener('submit', async (e) => {
                 e.preventDefault();
                 const form = e.target;
                 const syllabusFiles = Array.from(form.querySelectorAll('input[name="study-plan-files_files"]:checked')).map(cb => cb.value);
                 const deadline = form.deadline.value;
                 if (syllabusFiles.length === 0) return showWarning("Please select a syllabus document.");
                 showLoading("Generating Your Study Plan...", "This will be added to your calendar automatically.");
                try {
                    const response = await fetch(`/hub/${hubId}/create_study_plan`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ syllabus_files: syllabusFiles, deadline: deadline }) });
                    const result = await response.json();
                     if (result.success) { window.location.hash = 'calendar'; window.location.reload(); }
                     else { showError(`Error: ${result.message}`); hideLoading(); }
                } catch (error) { showError('A network or server error occurred.'); hideLoading(); }
            });
            
            async function handleQuickToolSubmit(toolName, selectedFiles) {
                if (isAITaskRunning) return;
                showLoading(`Generating ${toolName}...`, "This may take a moment.");
                try {
                    const response = await fetch(`/hub/${hubId}/run_async_tool`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ tool: toolName, selected_files: selectedFiles }) });
                    const result = await response.json();
                    if (result.success) {
                        window.location.href = result.redirect_url;
                    } else { showError(`Error: ${result.message}`); hideLoading(); }
                } catch (error) { showError('A network or server error occurred.'); hideLoading(); }
            }

            function getAllFiles() {
                return Array.from(document.querySelectorAll('.file-item-card[data-file-path]')).map(card => ({ 
                    name: card.dataset.fileName, 
                    path: card.dataset.filePath 
                }));
            }
            
            function initializeCalendar() {
                if (calendarEl && !calendar) {
                    calendar = new FullCalendar.Calendar(calendarEl, {
                        initialView: 'dayGridMonth',
                        headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,listWeek' },
                        events: `/hub/${hubId}/events`,
                        eventClick: function(info) {
                            const event = info.event, props = event.extendedProps;
                            document.getElementById('details-modal-title').innerHTML = `${event.title} <span class="event-type-badge" style="background-color:${event.backgroundColor};">${props.eventType}</span>`;
                            const startTime = event.start.toLocaleString([], { dateStyle: 'medium', timeStyle: 'short' });
                            const endTime = event.end ? event.end.toLocaleString([], { timeStyle: 'short' }) : '';
                            document.getElementById('details-modal-time').textContent = endTime ? `${startTime} - ${endTime}` : startTime;
                            document.getElementById('details-modal-focus').textContent = props.focus;
                            document.getElementById('details-modal-export-btn').href = props.exportUrl;
                            detailsModal.style.display = 'flex';
                        }
                    });
                    calendar.render();
                }
            }

             document.getElementById('schedule-event-form')?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const payload = {
                    title: form.title.value, event_type: form.event_type.value,
                    start_time: form.start_time.value, duration: form.duration.value,
                    focus: form.focus.value,
                };
                try {
                    const response = await fetch(`/hub/${hubId}/create_calendar_event`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
                    const result = await response.json();
                    if(result.success) {
                        scheduleModal.style.display = 'none';
                        calendar.refetchEvents();
                    } else { showError(`Error: ${result.message}`); }
                } catch(err) { showError('A network error occurred.'); }
            });
            
            const bell = document.getElementById('notification-bell');
            const panel = document.getElementById('notification-panel');
            bell.addEventListener('click', (event) => { event.stopPropagation(); panel.classList.toggle('visible'); });
            document.addEventListener('click', (event) => { if (!panel.contains(event.target) && !bell.contains(event.target)) panel.classList.remove('visible'); });

            document.querySelectorAll('.folder-header').forEach(header => {
                header.addEventListener('click', () => {
                    const content = header.nextElementSibling;
                    if (content && content.classList.contains('folder-content')) {
                        content.classList.toggle('open');
                    }
                });
            });

            const tutorForm = document.getElementById('tutor-input-form');
            const tutorInput = document.getElementById('tutor-user-input');
            const messagesList = document.getElementById('tutor-messages-list');
            const welcomeMessage = document.getElementById('tutor-welcome-message');
            let chatHistory = [];

            function appendMessage(role, content) {
                if (welcomeMessage) welcomeMessage.style.display = 'none';
                const messageClass = role === 'user' ? 'user-message' : 'ai-message';
                const avatarText = role === 'user' ? 'You' : 'AI';
                messagesList.insertAdjacentHTML('beforeend', `<div class="tutor-message ${messageClass}"><div class="avatar">${avatarText}</div><div class="message-content">${content}</div></div>`);
                messagesList.scrollTop = messagesList.scrollHeight;
            }

            function showTypingIndicator() {
                messagesList.insertAdjacentHTML('beforeend', `<div class="tutor-message ai-message" id="typing-indicator"><div class="avatar">AI</div><div class="message-content"><div class="typing-indicator"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div></div>`);
                messagesList.scrollTop = messagesList.scrollHeight;
            }

            function removeTypingIndicator() {
                document.getElementById('typing-indicator')?.remove();
            }

            tutorForm?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const userInput = tutorInput.value.trim();
                if (!userInput) return;

                appendMessage('user', userInput);
                chatHistory.push({ role: 'user', content: userInput });
                tutorInput.value = '';
                showTypingIndicator();

                try {
                    const response = await fetch(`/hub/${hubId}/tutor_chat`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ message: userInput, history: chatHistory.slice(-10) })
                    });
                    removeTypingIndicator();
                    if (!response.ok) {
                        const errorData = await response.json();
                        appendMessage('ai', `<p style="color:var(--danger-color);">Error: ${errorData.answer || 'Could not get a response.'}</p>`);
                        return;
                    }
                    const result = await response.json();
                    appendMessage('ai', marked.parse(result.answer));
                    chatHistory.push({ role: 'assistant', content: result.answer });
                } catch (error) {
                    removeTypingIndicator();
                    appendMessage('ai', `<p style="color:var(--danger-color);">Sorry, a connection error occurred.</p>`);
                    console.error("Tutor chat error:", error);
                }
            });
             let quizChart = null;
            function renderQuizChart() {
                const ctx = document.getElementById('quiz-score-chart');
                if (!ctx) return;

                if (quizChart) {
                    quizChart.destroy();
                }

                try {
                    const scoreData = JSON.parse('{{ recent_quiz_scores_json|safe }}');
                    if (scoreData.length === 0) {
                        ctx.style.display = 'none';
                         if (!document.getElementById('no-quiz-data-msg')) {
                            const noDataMessage = document.createElement('p');
                            noDataMessage.id = 'no-quiz-data-msg';
                            noDataMessage.textContent = "Complete a few quizzes to see your performance over time!";
                            noDataMessage.className = 'empty-state-text';
                            ctx.parentElement.appendChild(noDataMessage);
                        }
                        return;
                    } else {
                         ctx.style.display = 'block';
                         document.getElementById('no-quiz-data-msg')?.remove();
                    }

                    const labels = scoreData.map(d => new Date(d.x).toLocaleDateString());
                    const dataPoints = scoreData.map(d => d.y);

                    const data = {
                        labels: labels,
                        datasets: [{
                            label: 'Quiz Score',
                            data: dataPoints,
                            fill: true,
                            backgroundColor: 'rgba(79, 70, 229, 0.1)',
                            borderColor: 'rgba(79, 70, 229, 1)',
                            tension: 0.4,
                            pointBackgroundColor: 'rgba(79, 70, 229, 1)',
                            pointBorderColor: '#fff',
                            pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: 'rgba(79, 70, 229, 1)',
                        }]
                    };

                    quizChart = new Chart(ctx, {
                        type: 'line',
                        data: data,
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 100,
                                    grid: { color: 'rgba(107, 114, 128, 0.1)' }
                                },
                                x: {
                                    grid: { display: false }
                                }
                            },
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    backgroundColor: '#1f2937',
                                    titleFont: { size: 14, weight: 'bold' },
                                    bodyFont: { size: 12 },
                                    padding: 12,
                                    cornerRadius: 8,
                                    displayColors: false,
                                    callbacks: {
                                        label: function(context) {
                                            return `Score: ${context.raw}%`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                } catch (e) {
                    console.error("Failed to parse quiz score data or render chart:", e);
                }
            }
             
            let currentToolSelection = { tool: null, callback: null };

            function openToolFileSelectModal(toolName) {
                const fileCards = Array.from(document.querySelectorAll('#main-file-list .file-item-card[data-file-path]'));
                if (fileCards.length === 0) {
                    showWarning("Please upload a document first to use this tool.");
                    return;
                }
                
                const toolFriendlyName = toolName.charAt(0).toUpperCase() + toolName.slice(1);
                document.getElementById('tool-file-select-title').textContent = `Select Files for ${toolFriendlyName}`;
                
                const fileListContainer = document.getElementById('tool-file-select-list');
                populateModalFileList('tool-file-select-list', getAllFiles(), { multiSelect: true });
                
                const checkboxes = fileListContainer.querySelectorAll('input[type="checkbox"]');
                const counter = document.getElementById('tool-file-select-counter');
                
                const updateCounter = () => {
                    const selectedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
                    counter.textContent = `${selectedCount} / 3 selected`;
                    if (selectedCount >= 3) {
                        checkboxes.forEach(cb => { if (!cb.checked) cb.disabled = true; });
                    } else {
                        checkboxes.forEach(cb => cb.disabled = false);
                    }
                };
                
                checkboxes.forEach(cb => cb.addEventListener('change', updateCounter));
                updateCounter();

                currentToolSelection.tool = toolName;
                toolFileSelectModal.style.display = 'flex';
            }

            document.getElementById('tool-file-select-submit').addEventListener('click', () => {
                const selectedFiles = Array.from(document.querySelectorAll('#tool-file-select-list input:checked')).map(cb => cb.value);
                if (selectedFiles.length === 0) {
                    showWarning("Please select at least one file.");
                    return;
                }
                toolFileSelectModal.style.display = 'none';
                handleQuickToolSubmit(currentToolSelection.tool, selectedFiles);
            });


            // --- Pro Feature UI Enforcement & Study Tools Event Delegation ---
            const isProUser = "{{ current_user.subscription_tier }}" === 'pro' || "{{ current_user.subscription_tier }}" === 'admin';
            
            if (studyToolsTab) {
                // NEW: Handle category selection
                toolCategorySelection.addEventListener('click', (e) => {
                    const categoryButton = e.target.closest('.tool-category-button');
                    if (!categoryButton) return;
                    
                    const targetId = categoryButton.dataset.target;
                    const targetEl = document.getElementById(targetId);
                    
                    if (targetEl) {
                        toolCategorySelection.style.display = 'none';
                        targetEl.style.display = 'block';
                    }
                });
                
                // NEW: Handle back buttons
                backToCategoriesBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        inLectureTools.style.display = 'none';
                        revisionExamsTools.style.display = 'none';
                        toolCategorySelection.style.display = 'block';
                    });
                });

                // Handle clicks on the actual tool cards
                studyToolsTab.addEventListener('click', (e) => {
                    const toolCard = e.target.closest('.feature-card');
                    if (!toolCard) return;

                    const isProFeature = toolCard.querySelector('.pro-label');
                    if (isProFeature && !isProUser) {
                        e.preventDefault();
                        e.stopPropagation();
                        showCustomAlert('This is a Pro feature. Please upgrade your plan to use it.', 'Pro Feature');
                        return;
                    }

                    e.preventDefault();
                    const toolId = toolCard.id;
                    const toolValue = toolCard.getAttribute('value');
                    
                    if (toolId) {
                         switch (toolId) {
                            case 'pipeline-slide-notes':
                                // Use window.hubFiles instead of getAllFiles() for slide notes
                                const slideNotesFiles = window.hubFiles || [];
                                console.log(' Slide notes modal - window.hubFiles:', window.hubFiles);
                                console.log(' Slide notes modal - slideNotesFiles:', slideNotesFiles);
                                console.log(' Slide notes modal - slideNotesFiles.length:', slideNotesFiles.length);
                                if (slideNotesFiles.length === 0) return showCustomAlert("Please upload at least one document first.", 'No Documents');
                                
                                // Convert hubFiles to the format expected by populateModalFileList
                                const filesForModal = slideNotesFiles.map(file => ({
                                    name: file.original_filename || file.filename || 'Unknown file',
                                    path: file.file_path || file.path
                                }));
                                
                                populateModalFileList('slide-notes-files', filesForModal, { multiSelect: false });
                                
                                // Add event listeners for form validation
                                const slideNotesFileInputs = document.querySelectorAll('#slide-notes-files input[name="slide-notes-files_files"]');
                                slideNotesFileInputs.forEach(input => {
                                    input.addEventListener('change', updateSlideNotesFormValidation);
                                });
                                
                                // Update form validation when modal opens
                                updateSlideNotesFormValidation();
                                
                                slideNotesModal.style.display = 'flex';
                                break;
                            case 'pipeline-stuck-question':
                                resetSqState();
                                sqModal.style.display = 'flex';
                                break;
                            case 'pipeline-revision-pack':
                                openRevisionPackModal();
                                break;
                            case 'pipeline-exam-kit':
                                openExamKitModal();
                                break;
                            case 'individual-notes-generator':
                                openIndividualNotesModal();
                                break;
                            case 'individual-flashcards-generator':
                                openIndividualFlashcardsModal();
                                break;
                            case 'individual-quiz-generator':
                                openIndividualQuizModal();
                                break;
                            case 'individual-cheatsheet-generator':
                                openIndividualCheatsheetModal();
                                break;
                            case 'pipeline-study-planner':
                                openStudyPlanModal();
                                break;
                            case 'pipeline-assignment-assistant':
                            case 'pipeline-live-lecture':
                                window.location.href = toolCard.href;
                                break;
                        }
                    } else if (toolValue) {
                        openToolFileSelectModal(toolValue);
                    }
                });
            }
            
            // --- "Stuck on a Question" Feature Logic ---
            const sqModal = document.getElementById('stuck-question-modal');
            
            // --- Screens
            const sqScreenStart = document.getElementById('sq-screen-start');
            const sqScreenConfirm = document.getElementById('sq-screen-confirm');
            const sqScreenSolving = document.getElementById('sq-screen-solving');

            // --- Forms & Inputs
            const sqStartForm = document.getElementById('sq-start-form');
            const sqFileInput = document.getElementById('sq-file-input');
            const sqTextInput = document.getElementById('sq-text-input');
            const sqFileName = document.getElementById('sq-file-name');
            const sqSubmitBtn = document.getElementById('sq-submit-btn');
            
            // --- Confirmation
            const sqQuestionPreview = document.getElementById('sq-question-preview');
            const sqConfirmYesBtn = document.getElementById('sq-confirm-yes-btn');
            const sqConfirmNoBtn = document.getElementById('sq-confirm-no-btn');

            // --- Solving Interface
            const sqMessages = document.getElementById('sq-messages');
            const sqActions = document.getElementById('sq-actions');
            const sqContinueBtn = document.getElementById('sq-action-continue-btn');
            const sqConfusedBtn = document.getElementById('sq-action-confused-btn');
            
            const sqClarificationForm = document.getElementById('sq-clarification-form');
            const sqClarificationInput = document.getElementById('sq-clarification-input');

            const sqPracticeActions = document.getElementById('sq-practice-actions');
            const sqPracticeBtn = document.getElementById('sq-action-practice-btn');
            const sqEndBtn = document.getElementById('sq-action-end-btn');

            const sqPracticeForm = document.getElementById('sq-practice-form');
            const sqPracticeInput = document.getElementById('sq-practice-input');

            // --- State Variables
            let sqState = {};

            function resetSqState() {
                sqState = {
                    originalQuestion: '',
                    fullSolutionSteps: [],
                    currentStepIndex: -1,
                    practiceQuestion: '',
                    isPracticeMode: false
                };
                 sqMessages.innerHTML = '';
                 sqStartForm.reset();
                 sqClarificationForm.reset();
                 sqPracticeForm.reset();
                 sqFileName.textContent = '';
                 showSqScreen('start');
            }

            function showSqScreen(screenName) {
                [sqScreenStart, sqScreenConfirm, sqScreenSolving].forEach(s => s.style.display = 'none');
                document.getElementById(`sq-screen-${screenName}`).style.display = 'block';
            }
            
            function appendSqMessage(htmlContent, role = 'tutor') {
                const avatar = role === 'tutor' ? 'AI' : (role === 'user' ? 'You' : '');
                const messageEl = document.createElement('div');
                messageEl.className = `sq-message ${role}`;
                messageEl.innerHTML = `
                    ${avatar ? `<div class="avatar">${avatar}</div>` : ''}
                    <div class="content">${htmlContent}</div>
                `;
                sqMessages.appendChild(messageEl);
                sqMessages.scrollTop = sqMessages.scrollHeight;
            }

            function setSqLoading(isLoading, message = "Thinking...") {
                sqSubmitBtn.disabled = isLoading;
                sqConfirmYesBtn.disabled = isLoading;
                if (isLoading) {
                    appendSqMessage(message, 'system');
                } else {
                    const systemMessages = sqMessages.querySelectorAll('.sq-message.system');
                    if(systemMessages.length > 0) systemMessages[systemMessages.length - 1].remove();
                }
            }
            
            function showSqInput(type) {
                // Hide all input types first
                sqActions.style.display = 'none';
                sqClarificationForm.style.display = 'none';
                sqPracticeActions.style.display = 'none';
                sqPracticeForm.style.display = 'none';
                // Then show the requested one
                if (type) document.getElementById(`sq-${type}`).style.display = 'flex';
            }

            sqFileInput.addEventListener('change', () => {
                sqFileName.textContent = sqFileInput.files.length > 0 ? sqFileInput.files[0].name : '';
            });

            sqStartForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const textInput = sqTextInput.value.trim();
                const fileInput = sqFileInput.files[0];
                if (!textInput && !fileInput) {
                    return showWarning("Please type a question or upload a file.");
                }

                setSqLoading(true, "Reading your question...");
                const formData = new FormData();
                if (textInput) formData.append('question_text', textInput);
                if (fileInput) formData.append('question_file', fileInput);
                
                try {
                    const response = await fetch(`/hub/${hubId}/stuck_on_question/start`, {
                        method: 'POST',
                        body: formData
                    });
                    const result = await response.json();
                    if (!response.ok || !result.success) throw new Error(result.message);
                    
                    sqState.originalQuestion = result.extracted_question;
                    sqQuestionPreview.innerHTML = marked.parse(result.extracted_question);
                    showSqScreen('confirm');
                } catch (error) {
                    showError(`Error: ${error.message}`);
                } finally {
                    setSqLoading(false);
                }
            });
            
            sqConfirmNoBtn.addEventListener('click', () => {
                resetSqState();
            });

            sqConfirmYesBtn.addEventListener('click', async () => {
                setSqLoading(true, "Generating step-by-step solution...");
                showSqScreen('solving');
                appendSqMessage(marked.parse(sqState.originalQuestion), 'user');

                try {
                    const response = await fetch(`/hub/${hubId}/stuck_on_question/generate_solution`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ question: sqState.originalQuestion })
                    });
                    const result = await response.json();
                    if (!response.ok || !result.success) throw new Error(result.message);

                    sqState.fullSolutionSteps = result.solution.steps;
                    sqState.currentStepIndex = 0;
                    renderCurrentStep();
                } catch (error) {
                     appendSqMessage(`<p style="color: var(--danger-color)">Sorry, I couldn't generate a solution. Please try rephrasing the question or uploading a clearer image.</p>`);
                } finally {
                    setSqLoading(false);
                }
            });
            
            function renderCurrentStep() {
                if (sqState.currentStepIndex < sqState.fullSolutionSteps.length) {
                    const stepText = sqState.fullSolutionSteps[sqState.currentStepIndex];
                    appendSqMessage(marked.parse(stepText));
                    showSqInput('actions');
                } else {
                    const recapMessage = sqState.isPracticeMode
                        ? `That's the correct way to solve the practice problem. Nicely done!`
                        : `And that's the final answer! I hope that makes sense.`;
                    appendSqMessage(`<strong>Final Recap:</strong> ${recapMessage}`);
                    showSqInput('practice-actions');
                }
            }

            sqContinueBtn.addEventListener('click', () => {
                showSqInput(null);
                sqState.currentStepIndex++;
                renderCurrentStep();
            });

            sqConfusedBtn.addEventListener('click', () => {
                showSqInput('clarification-form');
                sqClarificationInput.focus();
            });

            sqClarificationForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const userQuery = sqClarificationInput.value.trim();
                if (!userQuery) return;
                
                showSqInput(null);
                appendSqMessage(marked.parse(userQuery), 'user');
                setSqLoading(true, "Let me explain that...");

                 try {
                     const response = await fetch(`/hub/${hubId}/stuck_on_question/clarify_step`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            stuck_step: sqState.fullSolutionSteps[sqState.currentStepIndex],
                            clarification_request: userQuery,
                            original_question: sqState.originalQuestion,
                            solution_context: sqState.fullSolutionSteps.slice(0, sqState.currentStepIndex)
                        })
                    });
                    const result = await response.json();
                    if (!response.ok || !result.success) throw new Error(result.message);
                    
                    appendSqMessage(marked.parse(result.clarification));
                    showSqInput('actions');
                } catch (error) {
                     appendSqMessage(`<p style="color: var(--danger-color)">Sorry, I had trouble generating an explanation. Let's try continuing to the next step.</p>`);
                     showSqInput('actions');
                } finally {
                    setSqLoading(false);
                    sqClarificationForm.reset();
                }
            });

            sqEndBtn.addEventListener('click', () => {
                sqModal.style.display = 'none';
            });

            sqPracticeBtn.addEventListener('click', async () => {
                showSqInput(null);
                setSqLoading(true, "Generating a practice question...");

                 try {
                     const response = await fetch(`/hub/${hubId}/stuck_on_question/generate_practice`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            question: sqState.originalQuestion,
                            solution_steps: sqState.fullSolutionSteps
                        })
                    });
                    const result = await response.json();
                    if (!response.ok || !result.success) throw new Error(result.message);
                    
                    sqState.practiceQuestion = result.practice_question;
                    appendSqMessage(marked.parse(sqState.practiceQuestion));
                    showSqInput('practice-form');
                    sqPracticeInput.focus();
                } catch (error) {
                     appendSqMessage(`<p style="color: var(--danger-color)">Sorry, I couldn't generate a practice question right now.</p>`);
                     showSqInput('practice-actions');
                } finally {
                    setSqLoading(false);
                }
            });

            sqPracticeForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const userAnswer = sqPracticeInput.value.trim();
                if(!userAnswer) return;

                showSqInput(null);
                appendSqMessage(userAnswer, 'user');
                setSqLoading(true, "Checking your answer...");

                 try {
                     const response = await fetch(`/hub/${hubId}/stuck_on_question/evaluate_practice`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            practice_question: sqState.practiceQuestion,
                            student_answer: userAnswer,
                            original_question: sqState.originalQuestion
                        })
                    });
                    const result = await response.json();
                    if (!response.ok || !result.success) throw new Error(result.message);
                    
                    const { is_correct, feedback } = result.evaluation;
                    appendSqMessage(feedback);

                    if (is_correct) {
                        showSqInput('practice-actions');
                    } else {
                        setSqLoading(true, "Let's walk through it step-by-step...");
                        const solutionResponse = await fetch(`/hub/${hubId}/stuck_on_question/generate_solution`, {
                             method: 'POST',
                             headers: {'Content-Type': 'application/json'},
                             body: JSON.stringify({ question: sqState.practiceQuestion })
                         });
                         const solutionResult = await solutionResponse.json();
                         if (!solutionResponse.ok || !solutionResult.success) throw new Error(solutionResult.message);

                        sqState.isPracticeMode = true;
                        sqState.fullSolutionSteps = solutionResult.solution.steps;
                        sqState.currentStepIndex = 0;
                        renderCurrentStep();
                    }

                } catch (error) {
                     appendSqMessage(`<p style="color: var(--danger-color)">Sorry, an error occurred while checking your answer.</p>`);
                     showSqInput('practice-actions');
                } finally {
                    setSqLoading(false);
                    sqPracticeForm.reset();
                }
            });

        });

        // --- Dark Mode Toggle Logic ---
            const themeToggle = document.getElementById('theme-toggle');
            const dropdownThemeToggle = document.getElementById('theme-toggle-dropdown');
            
            function applyTheme(theme) {
                if (theme === 'dark') {
                    document.documentElement.setAttribute('data-theme', 'dark');
                    if(themeToggle) themeToggle.checked = true;
                    if(dropdownThemeToggle) dropdownThemeToggle.checked = true;
                } else {
                    document.documentElement.removeAttribute('data-theme');
                    if(themeToggle) themeToggle.checked = false;
                    if(dropdownThemeToggle) dropdownThemeToggle.checked = false;
                }
            }
            
            if(themeToggle) {
                themeToggle.addEventListener('change', () => {
                    const newTheme = themeToggle.checked ? 'dark' : 'light';
                    localStorage.setItem('theme', newTheme);
                    applyTheme(newTheme);
                });
            }
            
            if(dropdownThemeToggle) {
                dropdownThemeToggle.addEventListener('change', () => {
                    const newTheme = dropdownThemeToggle.checked ? 'dark' : 'light';
                    localStorage.setItem('theme', newTheme);
                    applyTheme(newTheme);
                });
            }
            // Initialize theme based on localStorage on page load
            applyTheme(localStorage.getItem('theme') || 'light');

            // Initialize background image
            function initializeBackgroundImage() {
                let currentBackground = '{{ current_user.background_preference or "default" }}';
                
                console.log('Hub - Current background from template:', currentBackground);
                console.log('Hub - User background preference:', '{{ current_user.background_preference }}');
                
                // Fallback to localStorage if template value is not working
                if (currentBackground === 'default' || !currentBackground) {
                    const savedBackground = localStorage.getItem('background_preference');
                    if (savedBackground) {
                        currentBackground = savedBackground;
                        console.log('Hub - Using saved background from localStorage:', currentBackground);
                    }
                }
                
                applyBackgroundImage(currentBackground);
            }
            
            // Apply background image
            function applyBackgroundImage(backgroundName) {
                // Set data attribute for CSS targeting
                document.body.setAttribute('data-background', backgroundName);
                
                if (backgroundName === 'default') {
                    // Remove any background styling from all elements
                    document.body.style.backgroundImage = '';
                    document.body.style.backgroundAttachment = '';
                    document.body.style.backgroundSize = '';
                    document.body.style.backgroundPosition = '';
                    document.body.style.backgroundRepeat = '';
                    
                    const mainContent = document.querySelector('.main-content');
                    
                    if (mainContent) {
                        mainContent.style.backgroundImage = '';
                        mainContent.style.backgroundAttachment = '';
                        mainContent.style.backgroundSize = '';
                        mainContent.style.backgroundPosition = '';
                        mainContent.style.backgroundRepeat = '';
                    }
                    return;
                }
                
                // Apply background image with proper file extension
                const imageExtensions = {
                    'citynight': 'citynight.jpg',
                    'darkcity': 'darkcity.jpg',
                    'sky': 'sky.jpg',
                    'space': 'space.jpg',
                    'sunset': 'sunset.png',
                    'night': 'night.png_large',
                    'mountains': 'mountains.png',
                    'nature': 'nature.png',
                    'sea': 'sea.png'
                };
                
                const imageFile = imageExtensions[backgroundName] || backgroundName;
                
                // Apply to body and all main containers
                document.body.style.backgroundImage = `url('/static/background-images/${imageFile}')`;
                document.body.style.backgroundAttachment = 'fixed';
                document.body.style.backgroundSize = 'cover';
                document.body.style.backgroundPosition = 'center';
                document.body.style.backgroundRepeat = 'no-repeat';
                
                // Apply to main content area only (keep sidebar clean)
                const mainContent = document.querySelector('.main-content');
                
                if (mainContent) {
                    mainContent.style.backgroundImage = `url('/static/background-images/${imageFile}')`;
                    mainContent.style.backgroundAttachment = 'fixed';
                    mainContent.style.backgroundSize = 'cover';
                    mainContent.style.backgroundPosition = 'center';
                    mainContent.style.backgroundRepeat = 'no-repeat';
                }
            }
            
            // Initialize background on page load
            initializeBackgroundImage();

            // --- Favourites System ---
            const favouritesSystem = {
                favourites: [],
                availableTools: [
                    // In a Lecture Tools
                    { id: 'pipeline-live-lecture', name: 'Live Lecture Capture', description: 'Record and transcribe live lectures', url: '#tools', icon: 'M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z M19 10v2a7 7 0 0 1-14 0v-2 M12 19v4 M8 23h8' },
                    { id: 'pipeline-slide-notes', name: 'Take Notes with Slides', description: 'Upload slides and take interactive notes', url: '#tools', icon: 'M9 17.25v1.007a3 3 0 01-.879 2.122L7.5 21h9l-1.621-.621A3 3 0 0115 18.257V17.25m6-12V15a2.25 2.25 0 01-2.25 2.25H5.25A2.25 2.25 0 013 15V5.25A2.25 2.25 0 015.25 3h13.5A2.25 2.25 0 0121 5.25z' },
                    
                    // Revision & Exams Tools
                    { id: 'individual-notes-generator', name: 'Interactive Notes', description: 'Generate comprehensive study notes', url: '#tools', icon: 'M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z' },
                    { id: 'individual-flashcards-generator', name: 'Flashcards', description: 'Create flashcards for active recall', url: '#tools', icon: 'M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z' },
                    { id: 'individual-quiz-generator', name: 'Practice Quiz', description: 'Generate practice questions and tests', url: '#tools', icon: 'M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9 5.25h.008v.008H12v-.008z' },
                    { id: 'individual-cheatsheet-generator', name: 'Cheat Sheet', description: 'Create one-page study summaries', url: '#tools', icon: 'M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25z' },
                    { id: 'pipeline-revision-pack', name: 'Revision Pack Builder', description: 'Create complete study packages', url: '#tools', icon: 'M16.5 3.75V16.5L12 14.25 7.5 16.5V3.75m9 0H7.5A2.25 2.25 0 005.25 6v13.5A2.25 2.25 0 007.5 21.75h9A2.25 2.25 0 0018.75 19.5V6A2.25 2.25 0 0016.5 3.75z' },
                    { id: 'pipeline-stuck-question', name: 'Stuck on a Question?', description: 'Get help with difficult problems', url: '#tools', icon: 'M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9 5.25h.008v.008H12v-.008z' },
                    { id: 'pipeline-exam-kit', name: 'Exam Builder', description: 'Build comprehensive exam preparation', url: '#tools', icon: 'M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25' },
                    { id: 'pipeline-assignment-assistant', name: 'Assignment Assistant', description: 'Get help with writing assignments', url: '#tools', icon: 'M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25z' },
                    { id: 'pipeline-study-planner', name: 'Smart Study Planner', description: 'Plan your study schedule', url: '#tools', icon: 'M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5' }
                ],

                init: function() {
                    this.loadFavourites();
                    this.setupEventListeners();
                    this.setupStarClickListeners();
                },

                loadFavourites: async function() {
                    try {
                        const response = await fetch('/api/favourites');
                        const data = await response.json();
                        if (data.success) {
                            this.favourites = data.favourites || [];
                            this.renderFavourites();
                            this.updateStarStates();
                        }
                    } catch (error) {
                        console.error('Error loading favourites:', error);
                    }
                },

                setupEventListeners: function() {
                    // Favourites toggle
                    const favouritesToggle = document.getElementById('favourites-toggle');
                    if (favouritesToggle) {
                        favouritesToggle.addEventListener('click', (e) => {
                            e.stopPropagation();
                            this.toggleFavourites();
                        });
                    }
                },

                setupStarClickListeners: function() {
                    // Add click listeners to all star elements
                    document.querySelectorAll('.tool-favourite-star').forEach(star => {
                        star.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            const toolId = star.dataset.toolId;
                            this.toggleFavourite(toolId);
                        });
                    });
                },

                toggleFavourites: function() {
                    const favouritesSection = document.querySelector('.favourites-section');
                    if (favouritesSection) {
                        favouritesSection.classList.toggle('expanded');
                    }
                },

                renderFavourites: function() {
                    const favouritesContent = document.getElementById('favourites-content');
                    if (!favouritesContent) return;

                    if (this.favourites.length === 0) {
                        favouritesContent.innerHTML = '<div class="favourites-empty">Click to add tool</div>';
                        return;
                    }

                    const favouritesHTML = this.favourites.map(fav => `
                        <div class="favourite-item" data-tool-id="${fav.tool_id}">
                            <div class="favourite-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path d="${this.getToolIcon(fav.tool_id)}"></path>
                                </svg>
                            </div>
                            <span class="favourite-name">${fav.tool_name}</span>
                            <button class="favourite-remove" data-tool-id="${fav.tool_id}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                            </button>
                        </div>
                    `).join('');

                    favouritesContent.innerHTML = favouritesHTML;

                    // Add click handlers for favourite items
                    favouritesContent.querySelectorAll('.favourite-item').forEach(item => {
                        item.addEventListener('click', (e) => {
                            if (!e.target.closest('.favourite-remove')) {
                                const toolId = item.dataset.toolId;
                                this.navigateToTool(toolId);
                            }
                        });
                    });
                },

                getToolIcon: function(toolId) {
                    const tool = this.availableTools.find(t => t.id === toolId);
                    return tool ? tool.icon : 'M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z';
                },

                navigateToTool: function(toolId) {
                    // First switch to the tools tab
                    const toolsTab = document.querySelector('[data-tab="tools"]');
                    if (toolsTab) {
                        toolsTab.click();
                    }
                    
                    // Then find and click the specific tool
                    const toolElement = document.getElementById(toolId);
                    if (toolElement) {
                        // Small delay to ensure tab switch completes
                        setTimeout(() => {
                            toolElement.click();
                        }, 100);
                    }
                },

                toggleFavourite: async function(toolId) {
                    const isFavourited = this.favourites.some(fav => fav.tool_id === toolId);
                    
                    if (isFavourited) {
                        // Remove from favourites
                        await this.removeFavourite(toolId);
                    } else {
                        // Add to favourites (check limit)
                        if (this.favourites.length >= 5) {
                            showWarning('You can only have up to 5 favourite tools!');
                            return;
                        }
                        await this.addFavourite(toolId);
                    }
                },

                addFavourite: async function(toolId) {
                    const tool = this.availableTools.find(t => t.id === toolId);
                    if (!tool) return;

                    try {
                        const response = await fetch('/api/favourites/add', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                tool_id: toolId,
                                tool_name: tool.name,
                                tool_url: tool.url
                            })
                        });

                        const data = await response.json();
                        if (data.success) {
                            this.loadFavourites(); // Reload favourites
                        } else {
                            showError('Error adding favourite: ' + (data.message || 'Unknown error'));
                        }
                    } catch (error) {
                        console.error('Error adding favourite:', error);
                        showError('Error adding favourite. Please try again.');
                    }
                },

                removeFavourite: async function(toolId) {
                    try {
                        const response = await fetch('/api/favourites/remove', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ tool_id: toolId })
                        });

                        const data = await response.json();
                        if (data.success) {
                            this.loadFavourites(); // Reload favourites
                        } else {
                            showError('Error removing favourite: ' + (data.message || 'Unknown error'));
                        }
                    } catch (error) {
                        console.error('Error removing favourite:', error);
                        showError('Error removing favourite. Please try again.');
                    }
                },

                updateStarStates: function() {
                    // Update star visual states based on favourites
                    document.querySelectorAll('.tool-favourite-star').forEach(star => {
                        const toolId = star.dataset.toolId;
                        const isFavourited = this.favourites.some(fav => fav.tool_id === toolId);
                        
                        if (isFavourited) {
                            star.classList.add('favourited');
                        } else {
                            star.classList.remove('favourited');
                        }
                    });
                }
            };

            // Initialize favourites system
            favouritesSystem.init();
    </script>

    <script>
    // Always define the Spotify Web Playback SDK ready function
    window.onSpotifyWebPlaybackSDKReady = () => {
        {% if spotify_connected %}
        // --- Player UI Elements ---
        const playerContainer = document.getElementById('spotify-player-container');
        const toggleBtn = document.getElementById('spotify-player-toggle-btn-hub');
        const playBtn = document.getElementById('sp-play-btn');
        const prevBtn = document.getElementById('sp-prev-btn');
        const nextBtn = document.getElementById('sp-next-btn');
        const volumeSlider = document.getElementById('sp-volume');
        const playlistSelect = document.getElementById('sp-playlist-select');
        const albumArt = document.getElementById('sp-album-art');
        const trackTitle = document.getElementById('sp-track-title');
        const trackArtist = document.getElementById('sp-track-artist');
        const progressBar = document.getElementById('sp-progress');
        
        const playIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="currentColor" stroke="currentColor" stroke-width="0"><path d="M8 5v14l11-7z"></path></svg>`;
        const pauseIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="currentColor" stroke="currentColor" stroke-width="0"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path></svg>`;

        let sdkDeviceId = null;
        let isPlayerReady = false;

        // --- SDK Initialization ---
        const player = new Spotify.Player({
            name: 'Foci Study Player',
            getOAuthToken: cb => {
                fetch('/spotify/access_token')
                    .then(response => response.json())
                    .then(data => {
                        if (data.access_token) {
                            cb(data.access_token);
                        } else {
                            console.error("Could not get access token from backend.");
                        }
                    });
            },
            volume: 0.8
        });

        // --- SDK Event Listeners ---
        player.addListener('ready', ({ device_id }) => {
            console.log('Ready with Device ID', device_id);
            sdkDeviceId = device_id;
            isPlayerReady = true;
            trackArtist.textContent = "Ready to play";
            loadPlaylists();
        });

        player.addListener('not_ready', ({ device_id }) => {
            console.log('Device ID has gone offline', device_id);
            isPlayerReady = false;
        });

        // --- Dynamic Background Color Function ---
        const updatePlayerBackground = (imageUrl) => {
            if (!imageUrl) return;
            
            const img = new Image();
            img.crossOrigin = 'anonymous';
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Resize for performance (max 100x100)
                const maxSize = 100;
                const scale = Math.min(maxSize / img.width, maxSize / img.height);
                canvas.width = img.width * scale;
                canvas.height = img.height * scale;
                
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                
                // Collect color data with better sampling
                let r = 0, g = 0, b = 0;
                let pixelCount = 0;
                let colorMap = {};
                
                // Sample every 5th pixel for better accuracy
                for (let i = 0; i < data.length; i += 20) {
                    const red = data[i];
                    const green = data[i + 1];
                    const blue = data[i + 2];
                    const alpha = data[i + 3];
                    
                    // Skip transparent pixels
                    if (alpha < 128) continue;
                    
                    r += red;
                    g += green;
                    b += blue;
                    pixelCount++;
                    
                    // Create color buckets for better analysis
                    const colorKey = Math.floor(red/32) + ',' + Math.floor(green/32) + ',' + Math.floor(blue/32);
                    colorMap[colorKey] = (colorMap[colorKey] || 0) + 1;
                }
                
                if (pixelCount === 0) return; // No valid pixels
                
                r = Math.floor(r / pixelCount);
                g = Math.floor(g / pixelCount);
                b = Math.floor(b / pixelCount);
                
                // Calculate more accurate metrics
                const brightness = (r + g + b) / 3;
                const maxRGB = Math.max(r, g, b);
                const minRGB = Math.min(r, g, b);
                const saturation = maxRGB === 0 ? 0 : (maxRGB - minRGB) / maxRGB;
                
                // Determine if image is grayscale
                const isGrayscale = Math.abs(r - g) < 30 && Math.abs(g - b) < 30 && Math.abs(r - b) < 30;
                
                let bgClass = 'sp-player-bg-purple'; // default
                
                // Better color analysis
                if (isGrayscale) {
                    // Handle grayscale images
                    if (brightness < 80) {
                        bgClass = 'sp-player-bg-blue'; // Dark grayscale -> blue
                    } else if (brightness < 160) {
                        bgClass = 'sp-player-bg-purple'; // Medium grayscale -> purple
                    } else {
                        bgClass = 'sp-player-bg-orange'; // Light grayscale -> warm orange
                    }
                } else {
                    // Handle colored images with more nuanced logic
                    const redDominance = r / (r + g + b + 1);
                    const greenDominance = g / (r + g + b + 1);
                    const blueDominance = b / (r + g + b + 1);
                    
                    if (brightness < 60) {
                        bgClass = 'sp-player-bg-blue'; // Very dark -> blue
                    } else if (redDominance > 0.45 && redDominance > greenDominance && redDominance > blueDominance) {
                        bgClass = 'sp-player-bg-red';
                    } else if (greenDominance > 0.4 && greenDominance > redDominance && greenDominance > blueDominance) {
                        bgClass = 'sp-player-bg-green';
                    } else if (blueDominance > 0.4 && blueDominance > redDominance && blueDominance > greenDominance) {
                        bgClass = 'sp-player-bg-blue';
                    } else if (brightness > 180 && saturation < 0.3) {
                        bgClass = 'sp-player-bg-orange'; // Light and low saturation -> warm
                    } else if (saturation > 0.6) {
                        bgClass = 'sp-player-bg-pink'; // High saturation -> vibrant
                    } else {
                        bgClass = 'sp-player-bg-purple'; // Default fallback
                    }
                }
                
                // Remove existing background classes
                playerContainer.className = playerContainer.className.replace(/sp-player-bg-\w+/g, '');
                playerContainer.classList.add(bgClass);
                
                // Debug logging (remove in production)
                console.log('Color Analysis:', {
                    rgb: [r, g, b],
                    brightness,
                    saturation,
                    isGrayscale,
                    chosenTheme: bgClass
                });
            };
            img.src = imageUrl;
        };

        player.addListener('player_state_changed', (state) => {
            if (!state) {
                trackTitle.textContent = 'Player is idle';
                trackArtist.textContent = 'Select a playlist to start';
                albumArt.src = 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=';
                playBtn.innerHTML = playIcon;
                progressBar.style.width = '0%';
                return;
            }

            const currentTrack = state.track_window.current_track;
            const progressPercent = (state.position / state.duration) * 100;
            const imageUrl = currentTrack.album.images[0]?.url || '';

            trackTitle.textContent = currentTrack.name;
            trackArtist.textContent = currentTrack.artists.map(artist => artist.name).join(', ');
            albumArt.src = imageUrl;
            progressBar.style.width = `${progressPercent}%`;
            playBtn.innerHTML = state.paused ? playIcon : pauseIcon;
            
            // Update dynamic background
            updatePlayerBackground(imageUrl);
        });
        
        player.addListener('account_error', ({ message }) => {
            console.error('Failed to validate Spotify account:', message);
            playerContainer.innerHTML = `<p style="padding: 1rem; text-align: center; color: var(--danger-color)">Account Error: ${message}. This feature requires Spotify Premium.</p>`;
        });
        
        player.addListener('authentication_error', ({ message }) => {
            console.error('Failed to authenticate:', message);
             playerContainer.innerHTML = `<p style="padding: 1rem; text-align: center;">Authentication failed. <a href="/spotify/login" style="color: var(--primary-color); font-weight: bold;">Please reconnect Spotify</a>.</p>`;
        });

        player.connect();

        // --- UI Interactions ---
        if (toggleBtn) {
            toggleBtn.addEventListener('click', () => playerContainer.classList.toggle('visible'));
        }

        async function loadPlaylists() {
            const response = await fetch('/spotify/playlists');
            const data = await response.json();
            if (data && data.items) {
                playlistSelect.innerHTML = '<option value="">Select a Playlist</option>';
                data.items.forEach(playlist => {
                    const option = new Option(playlist.name, playlist.uri);
                    playlistSelect.add(option);
                });
            }
        }

        playBtn.addEventListener('click', () => {
            player.togglePlay();
        });

        prevBtn.addEventListener('click', () => {
            player.previousTrack();
        });

        nextBtn.addEventListener('click', () => {
            player.nextTrack();
        });

        
        let volumeTimeout;
        volumeSlider.addEventListener('input', () => {
            clearTimeout(volumeTimeout);
            const volumeLevel = volumeSlider.value / 100;
            volumeTimeout = setTimeout(() => {
                player.setVolume(volumeLevel);
            }, 200);
        });
        
        playlistSelect.addEventListener('change', () => {
            if (playlistSelect.value && sdkDeviceId) {
                fetch(`/spotify/play`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        context_uri: playlistSelect.value,
                        device_id: sdkDeviceId
                    })
                });
            }
        });
        {% else %}
        // Spotify not connected - function exists but does nothing
        console.log('Spotify not connected - Web Playback SDK ready but not initialized');
        {% endif %}
        
        // Initialize animations after everything is loaded
        console.log(' Starting animation initialization...');
        setTimeout(() => {
            initializeAnimations();
            initializeEnhancedInteractions();
            
            // Add celebration effect for successful actions
            const successButtons = document.querySelectorAll('.button[data-success="true"]');
            successButtons.forEach(button => {
                button.addEventListener('click', function() {
                    setTimeout(() => {
                        createConfetti();
                    }, 500);
                });
            });
            
            console.log(' All animations and interactions initialized successfully');
        }, 100);
    };
    </script>

    <!-- *** CORRECTED ONBOARDING SCRIPT *** -->
    <script>
// Ensure onboarding DOM nodes exist (defensive)
function ensureOnboardingNodesExist() {
  if (!document.getElementById('onboarding-spotlight-overlay')) {
    const s = document.createElement('div');
    s.id = 'onboarding-spotlight-overlay';
    document.body.appendChild(s);
  }
  if (!document.getElementById('onboarding-tooltip')) {
    const t = document.createElement('div');
    t.id = 'onboarding-tooltip';
    document.body.appendChild(t);
  }
}
document.addEventListener('DOMContentLoaded', () => {
  ensureOnboardingNodesExist();
  
  // Check if we should show Task Queue tooltip after page reload
  if (sessionStorage.getItem('showTaskQueueTooltip') === '1') {
      console.log(' Task Queue tooltip flag found, showing tooltip...');
      // Clear the flag
      sessionStorage.removeItem('showTaskQueueTooltip');
      
      // Wait a bit for the page to fully load, then show the tooltip
      setTimeout(() => {
          const taskQueueSection = document.querySelector('.task-queue-section');
          console.log(' Task Queue section found:', !!taskQueueSection);
          if (taskQueueSection) {
              // Show spotlight on task queue
              const spotlight = document.getElementById('onboarding-spotlight-overlay');
              const tooltip = document.getElementById('onboarding-tooltip');
              
              if (spotlight && tooltip) {
                  // Create spotlight effect around task queue
                  taskQueueSection.classList.add('onboarding-highlight');
                  const rect = taskQueueSection.getBoundingClientRect();
                  const padding = 10;
                  const clipPath = `polygon(0% 0%, 0% 100%, ${rect.left - padding}px 100%, ${rect.left - padding}px ${rect.top - padding}px, ${rect.right + padding}px ${rect.top - padding}px, ${rect.right + padding}px ${rect.bottom + padding}px, ${rect.left - padding}px ${rect.bottom + padding}px, ${rect.left - padding}px 100%, 100% 100%, 100% 0%)`;
                  
                  spotlight.style.clipPath = clipPath;
                  spotlight.classList.add('visible');
                  
                  // Show tooltip with explanation on the right side
                  tooltip.innerHTML = `
                      <div style="display: flex; flex-direction: column; gap: 1rem;">
                          <p>Your tasks are now queuing, when they're done you'll be able to check them out!</p>
                          <button class="button button-primary" onclick="console.log(' Task Queue Ok button clicked'); this.closest('.onboarding-tooltip').classList.remove('visible'); document.getElementById('onboarding-spotlight-overlay').classList.remove('visible'); document.querySelector('.task-queue-section').classList.remove('onboarding-highlight'); showFolderContentsTooltip();" style="align-self: flex-start;">Ok</button>
                      </div>
                  `;
                  tooltip.className = 'onboarding-tooltip right';
                  const top = rect.top + (rect.bottom - rect.top) / 2;
                  const left = rect.right + 15;
                  tooltip.style.top = `${top}px`;
                  tooltip.style.left = `${left}px`;
                  tooltip.style.transform = 'translateY(-50%)';
                  tooltip.classList.add('visible');
              }
          }
      }, 1000);
  }
          
          // Initialize slider value displays
          const flashcardsSlider = document.getElementById('num-flashcards');
          const flashcardsValue = document.getElementById('num-flashcards-value');
          const quizSlider = document.getElementById('num-quiz-questions');
          const quizValue = document.getElementById('num-quiz-questions-value');
          
          if (flashcardsSlider && flashcardsValue) {
              flashcardsSlider.addEventListener('input', () => {
                  flashcardsValue.textContent = flashcardsSlider.value;
              });
          }
          
          if (quizSlider && quizValue) {
              quizSlider.addEventListener('input', () => {
                  quizValue.textContent = quizSlider.value;
              });
          }
          
          // Individual tool sliders
          const individualFlashcardsSlider = document.getElementById('individual-num-flashcards');
          const individualFlashcardsValue = document.getElementById('individual-num-flashcards-value');
          const individualQuizSlider = document.getElementById('individual-num-quiz-questions');
          const individualQuizValue = document.getElementById('individual-num-quiz-questions-value');
          
          if (individualFlashcardsSlider && individualFlashcardsValue) {
              individualFlashcardsSlider.addEventListener('input', () => {
                  individualFlashcardsValue.textContent = individualFlashcardsSlider.value;
              });
          }
          
          if (individualQuizSlider && individualQuizValue) {
              individualQuizSlider.addEventListener('input', () => {
                  individualQuizValue.textContent = individualQuizSlider.value;
              });
          }

  const isWelcomeHub = "{{ hub.name }}".includes("Welcome");
  const needsOnboarding = {{ 'true' if needs_onboarding else 'false' }};
  
  console.log(' Hub onboarding check:', {
    onboardingStep: sessionStorage.getItem('onboardingStep'),
    isWelcomeHub: isWelcomeHub,
    needsOnboarding: needsOnboarding,
    showCelebration: sessionStorage.getItem('showOnboardingCelebration')
  });
  
  // Only run onboarding if user hasn't completed it yet (server-side check)
  if (sessionStorage.getItem('onboardingStep') === 'hub_entry' && isWelcomeHub && sessionStorage.getItem('showOnboardingCelebration') !== '1' && needsOnboarding) {
      console.log(' Starting hub onboarding...');
      runHubOnboarding();
  }

  // After reload: show celebration if flagged (only during onboarding)
  if (sessionStorage.getItem('showOnboardingCelebration') === '1') {
      sessionStorage.removeItem('showOnboardingCelebration');
      sessionStorage.removeItem('onboardingGenerating'); // Clean up any remaining flags
      
      // Switch to folders tab
      const foldersTab = document.querySelector('.nav-link[data-tab="folders"]');
      if (foldersTab) foldersTab.click();
      
      // Wait for content to load, then show celebration
      setTimeout(() => {
          const firstFolder = document.querySelector('.folder-accordion-item .folder-header') || document.querySelector('.folder-header');
          if (firstFolder) firstFolder.click();
          
          // Old spotlight on generated items removed
      }, 300);
      
      // Old onboarding celebration removed
  }
});


        async function runHubOnboarding() {
            console.log(' Starting hub onboarding...');
            
            // Initialize onboarding elements
            const hubIntroModal = document.getElementById('onboarding-hub-intro-modal');
            const tutorModal = document.getElementById('onboarding-tutor-modal');
            const spotlight = document.getElementById('onboarding-spotlight-overlay');
            const tooltip = document.getElementById('onboarding-tooltip');
            
            console.log(' Onboarding elements found:', {
                hubIntroModal: !!hubIntroModal,
                tutorModal: !!tutorModal,
                spotlight: !!spotlight,
                tooltip: !!tooltip
            });
            
            // Check if all required elements exist
            if (!hubIntroModal || !tutorModal || !spotlight || !tooltip) {
                console.error(' Missing onboarding elements, cannot proceed');
                return;
            }

            // Helper functions
            function showTooltip(targetElement, text, position = 'bottom') {
                const rect = targetElement.getBoundingClientRect();
                tooltip.innerHTML = text; // Use innerHTML for HTML support
                tooltip.className = `onboarding-tooltip ${position}`;
                
                if (position === 'bottom') {
                    tooltip.style.left = `${rect.left + rect.width / 2}px`;
                    tooltip.style.top = `${rect.bottom + 10}px`;
                    tooltip.style.transform = 'translateX(-50%)';
                } else {
                    tooltip.style.left = `${rect.left + rect.width / 2}px`;
                    tooltip.style.top = `${rect.top - tooltip.offsetHeight - 10}px`;
                    tooltip.style.transform = 'translateX(-50%)';
                }
                
                tooltip.classList.add('visible');
            }

            function hideTooltip() {
                tooltip.classList.remove('visible');
            }

            function highlightElement(targetElement) {
                targetElement.classList.add('onboarding-highlight');
            }

            function removeHighlight() {
                document.querySelectorAll('.onboarding-highlight').forEach(el => el.classList.remove('onboarding-highlight'));
            }

            function showSpotlight(targetElement) {
                if (!targetElement) {
                    spotlight.classList.add('visible');
                    return;
                }
                
                targetElement.classList.add('onboarding-highlight');
                const rect = targetElement.getBoundingClientRect();
                const padding = 10;
                const clipPath = `polygon(0% 0%, 0% 100%, ${rect.left - padding}px 100%, ${rect.left - padding}px ${rect.top - padding}px, ${rect.right + padding}px ${rect.top - padding}px, ${rect.right + padding}px ${rect.bottom + padding}px, ${rect.left - padding}px ${rect.bottom + padding}px, ${rect.left - padding}px 100%, 100% 100%, 100% 0%)`;
                
                spotlight.style.clipPath = clipPath;
                spotlight.classList.add('visible');
            }

            function hideSpotlight() {
                spotlight.classList.remove('visible');
            }

            function createConfetti() {
                const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57', '#ff9ff3'];
                for (let i = 0; i < 50; i++) {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + '%';
                    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.animationDelay = Math.random() * 3 + 's';
                    confetti.style.animationDuration = (Math.random() * 3 + 2) + 's';
                    document.body.appendChild(confetti);
                    
                    setTimeout(() => confetti.remove(), 5000);
                }
            }

            // Step 1: Show hub intro
            console.log(' Showing hub intro modal...');
            hubIntroModal.classList.add('visible');

            // Wait for user to click continue
            await new Promise(resolve => {
                document.getElementById('onboarding-hub-continue-btn').addEventListener('click', resolve, { once: true });
            });

            hubIntroModal.classList.remove('visible');

            // Step 2: Spotlight Study Tools tab
            console.log(' Spotlighting Study Tools tab...');
            setTimeout(() => {
                const studyToolsTab = document.querySelector('.nav-link[data-tab="tools"]');
                console.log(' Study Tools tab found:', studyToolsTab);
                if (studyToolsTab) {
                    console.log(' Spotlighting and highlighting Study Tools tab...');
                    showSpotlight(studyToolsTab);
                    showTooltip(studyToolsTab, "Ready for some  AI magic? Click here to explore the Revision Pack Builder and create your first pack!", 'right');
                    
                    // Handle click on Study Tools tab
                    studyToolsTab.addEventListener('click', async (e) => {
                        e.preventDefault();
                        hideTooltip();
                        removeHighlight();
                        hideSpotlight();
                        
                        console.log(' User clicked Study Tools tab, switching...');
                        
                        // Switch to Study Tools tab
                        studyToolsTab.click();
                        
                        // Wait for content to load
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        
                        // Look for the Revision & Exams category button
                        const revisionCategoryBtn = document.querySelector('[data-target="revision-exams-tools"]');
                        if (revisionCategoryBtn) {
                            console.log(' Clicking Revision & Exams category...');
                            revisionCategoryBtn.click();
                            
                            // Wait for revision tools to load
                            await new Promise(resolve => setTimeout(resolve, 1000));
                            
                            // Spotlight the Revision Pack Builder tool
                            const revisionPackTool = document.querySelector('#pipeline-revision-pack');
                            if (revisionPackTool) {
                                console.log(' Spotlighting Revision Pack Builder...');
                                showSpotlight(revisionPackTool);
                                showTooltip(revisionPackTool, "Perfect! This is the Revision Pack Builder. Click here to create your first revision pack with the sample lecture.", 'bottom');
                                
                                // Handle click on revision pack tool
                                revisionPackTool.addEventListener('click', async (e) => {
                                    e.preventDefault();
                                    hideTooltip();
                                    removeHighlight();
                                    hideSpotlight();
                                    
                                    console.log(' User clicked Revision Pack Builder...');
                                    
                                    // Click the tool to open the modal
                                    revisionPackTool.click();
                                    
                                    // Wait for modal to open
                                    await new Promise(resolve => setTimeout(resolve, 1000));
                                    
                                    // Look for the revision pack modal and auto-select the sample file
                                    const revisionModal = document.querySelector('#revision-pack-modal');
                                    if (revisionModal && revisionModal.style.display !== 'none') {
                                        console.log(' Auto-selecting sample file...');
                                        
                                            // Look for the sample file checkbox and check it
                                            const sampleFileCheckbox = document.querySelector('input[value*="EC131"]') || 
                                                                     document.querySelector('input[value*="EC131_Week_9"]') ||
                                                                     document.querySelector('input[value*="machine_learning_intro"]') ||
                                                                     document.querySelector('.file-checkbox');
                                        
                                        if (sampleFileCheckbox) {
                                            sampleFileCheckbox.checked = true;
                                            sampleFileCheckbox.dispatchEvent(new Event('change'));
                                            console.log(' Sample file selected');
                                        }
                                        
                                        // Skip AI Tutor intro for now - user can explore on their own
                                        console.log(' Revision pack modal opened with sample file selected');
                                    } else {
                                        console.log(' Could not find revision modal, completing onboarding...');
                        }
                    }, { once: true });
                            } else {
                                console.log(' Could not find Revision Pack Builder tool, completing onboarding...');
                            }
                        } else {
                            console.log(' Could not find Revision & Exams category, completing onboarding...');
                        }
                    }, { once: true });
                } else {
                    console.log(' Could not find Study Tools tab, completing onboarding...');
                }
            }, 500);


        }

        // Removed payoff animation to keep onboarding simple and fast

        async function showOnboardingCompletionCelebration() {
            // Don't complete onboarding here - let the user finish the full flow
            // Keep onboardingStep for the Study Tools click handler
            hideLoadingOverlay();
            
            // Show success message first
            showSuccessMessage('Welcome to Foci! Your revision pack is ready.');
            
            // Navigate to folders
            const foldersTab = document.querySelector('.nav-link[data-tab="folders"]');
            if (foldersTab) foldersTab.click();
            
            // Wait a moment then expand the most recent/new folder if present
            setTimeout(() => {
                const firstFolder = document.querySelector('.folder-accordion-item .folder-header') || document.querySelector('.folder-header');
                if (firstFolder) firstFolder.click();
                // Old onboarding logic removed - no more confetti or banner
            }, 1000);
        }

        // Loading overlay and message functions
        function showLoadingOverlay(title = 'Processing...', subtitle = 'Please wait while we process your request.') {
            const overlay = document.createElement('div');
            overlay.id = 'loading-overlay';
            overlay.innerHTML = `
                <div class="loading-content">
                    <div class="loading-spinner">
                        <i data-lucide="loader-2" class="animate-spin"></i>
                    </div>
                    <h3>${title}</h3>
                    <p>${subtitle}</p>
                </div>
            `;
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                backdrop-filter: blur(5px);
            `;
            
            const style = document.createElement('style');
            style.textContent = `
                .loading-content {
                    background: var(--background-white);
                    padding: 3rem;
                    border-radius: 16px;
                    text-align: center;
                    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
                    max-width: 400px;
                    width: 90%;
                }
                .loading-spinner {
                    font-size: 3rem;
                    color: var(--primary-color);
                    margin-bottom: 1rem;
                }
                .loading-content h3 {
                    margin: 0 0 0.5rem 0;
                    color: var(--text-main);
                    font-size: 1.5rem;
                }
                .loading-content p {
                    margin: 0;
                    color: var(--text-secondary);
                    line-height: 1.5;
                }
                .animate-spin {
                    animation: spin 1s linear infinite;
                }
                @keyframes spin {
                    from { transform: rotate(0deg); }
                    to { transform: rotate(360deg); }
                }
            `;
            document.head.appendChild(style);
            document.body.appendChild(overlay);
            
            // Initialize Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }
        
        function hideLoadingOverlay() {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) {
                overlay.remove();
            }
        }
        
        function showSuccessMessage(message) {
            const notification = document.createElement('div');
            notification.innerHTML = `
                <div class="success-notification">
                    <i data-lucide="check-circle"></i>
                    <span>${message}</span>
                </div>
            `;
            notification.style.cssText = `
                position: fixed;
                top: 2rem;
                right: 2rem;
                z-index: 10001;
                animation: slideInRight 0.3s ease-out;
            `;
            
            const style = document.createElement('style');
            style.textContent = `
                .success-notification {
                    background: linear-gradient(135deg, #10b981, #059669);
                    color: white;
                    padding: 1rem 1.5rem;
                    border-radius: 8px;
                    display: flex;
                    align-items: center;
                    gap: 0.75rem;
                    box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
                    font-weight: 600;
                }
                .success-notification i {
                    font-size: 1.2rem;
                }
                @keyframes slideInRight {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
            `;
            document.head.appendChild(style);
            document.body.appendChild(notification);
            
            // Initialize Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 3000);
        }
        
        function showErrorMessage(message) {
            const notification = document.createElement('div');
            notification.innerHTML = `
                <div class="error-notification">
                    <i data-lucide="alert-circle"></i>
                    <span>${message}</span>
                </div>
            `;
            notification.style.cssText = `
                position: fixed;
                top: 2rem;
                right: 2rem;
                z-index: 10001;
                animation: slideInRight 0.3s ease-out;
            `;
            
            const style = document.createElement('style');
            style.textContent = `
                .error-notification {
                    background: linear-gradient(135deg, #ef4444, #dc2626);
                    color: white;
                    padding: 1rem 1.5rem;
                    border-radius: 8px;
                    display: flex;
                    align-items: center;
                    gap: 0.75rem;
                    box-shadow: 0 10px 25px rgba(239, 68, 68, 0.3);
                    font-weight: 600;
                }
                .error-notification i {
                    font-size: 1.2rem;
                }
            `;
            document.head.appendChild(style);
            document.body.appendChild(notification);
            
            // Initialize Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }

        function launchConfetti() {
            // Lightweight confetti without external deps (simple burst)
            const canvas = document.createElement('canvas');
            canvas.id = 'confetti-canvas';
            canvas.style.position = 'fixed';
            canvas.style.inset = '0';
            canvas.style.pointerEvents = 'none';
            canvas.style.zIndex = '9999';
            document.body.appendChild(canvas);
            const ctx = canvas.getContext('2d');
            const dpr = window.devicePixelRatio || 1;
            function resize(){ canvas.width = innerWidth * dpr; canvas.height = innerHeight * dpr; }
            resize(); window.addEventListener('resize', resize);
            const particles = Array.from({length: 180}).map(() => ({
                x: Math.random()*canvas.width,
                y: -Math.random()*canvas.height*0.2,
                r: 6 + Math.random()*6,
                c: `hsl(${Math.random()*360},90%,60%)`,
                vX: -2 + Math.random()*4,
                vY: 2 + Math.random()*4,
                rot: Math.random()*Math.PI,
                rotV: -0.1 + Math.random()*0.2
            }));
            let frame=0, raf;
            function tick(){
                ctx.clearRect(0,0,canvas.width,canvas.height);
                particles.forEach(p=>{
                    p.x += p.vX; p.y += p.vY; p.rot += p.rotV; p.vY += 0.05;
                    ctx.save();
                    ctx.translate(p.x, p.y); ctx.rotate(p.rot);
                    ctx.fillStyle = p.c;
                    ctx.fillRect(-p.r/2, -p.r/2, p.r, p.r);
                    ctx.restore();
                });
                frame++; if (frame < 240) { raf = requestAnimationFrame(tick); } else { cleanup(); }
            }
            function cleanup(){ cancelAnimationFrame(raf); window.removeEventListener('resize', resize); canvas.remove(); }
            tick();
        }

        function showCompletionBanner(persistent = false) {
            const container = document.createElement('div');
            container.style.position = 'fixed';
            container.style.left = '50%';
            container.style.bottom = '24px';
            container.style.transform = 'translateX(-50%)';
            container.style.zIndex = '10000';
            container.style.maxWidth = '680px';
            container.style.width = 'calc(100% - 32px)';
            container.innerHTML = `
                <div class="content-card" style="padding: 1rem 1.25rem; display:flex; gap:0.75rem; align-items:center; box-shadow: 0 8px 24px rgba(0,0,0,0.2);">
                    <div style="font-size: 1.5rem"></div>
                    <div style="flex:1;">
                        <div style="font-weight: 700; margin-bottom: 0.25rem;">You've done it!</div>
                        <div>Feel free to explore what you've generated. After, check out the other tools and create your own Study Hubs for your modules or subjects.</div>
                    </div>
                    <button class="button button-primary" id="completion-dismiss-btn">Got it</button>
                </div>`;
            document.body.appendChild(container);
            const dismiss = container.querySelector('#completion-dismiss-btn');
            if (dismiss) {
                dismiss.addEventListener('click', () => {
                    container.remove();
                    // End onboarding and clear spotlight when main banner is dismissed
                        hideOnboardingUI();
                    document.querySelectorAll('.onboarding-highlight').forEach(el => {
                        el.classList.remove('onboarding-highlight');
                    });
                    // Onboarding is already completed when the pack was generated
                });
            }
            if (!persistent) {
                setTimeout(() => { try { container.remove(); } catch(_){} }, 12000);
            }
        }

        // --- Helper functions for onboarding UI ---
        function showSpotlight(targetElement) {
            const spotlight = document.getElementById('onboarding-spotlight-overlay');
            if(!spotlight) return; 
            targetElement.classList.add('onboarding-highlight');
            const rect = targetElement.getBoundingClientRect();
            const padding = 10;
            const clipPath = `polygon(0% 0%, 0% 100%, ${rect.left - padding}px 100%, ${rect.left - padding}px ${rect.top - padding}px, ${rect.right + padding}px ${rect.top - padding}px, ${rect.right + padding}px ${rect.bottom + padding}px, ${rect.left - padding}px ${rect.bottom + padding}px, ${rect.left - padding}px 100%, 100% 100%, 100% 0%)`;
            
            spotlight.style.clipPath = clipPath;
            spotlight.classList.add('visible');
        }

        function showTooltip(targetElement, text, position = 'bottom') {
            const tooltip = document.getElementById('onboarding-tooltip');
            if(!tooltip) return;
            
            const rect = targetElement.getBoundingClientRect();
            tooltip.innerHTML = text; // This now correctly injects the HTML with the button
            tooltip.className = `onboarding-tooltip ${position}`;
            
            let top, left;
            if (position === 'bottom') {
                top = rect.bottom + 15;
                left = rect.left + rect.width / 2;
                tooltip.style.transform = 'translateX(-50%)';
            } else if (position === 'right') {
                top = rect.top + rect.height / 2;
                left = rect.right + 15;
                tooltip.style.transform = 'translateY(-50%)';
            } else { // top
                top = rect.top - 15;
                left = rect.left + rect.width / 2;
                tooltip.style.transform = 'translateX(-50%) translateY(-100%)';
            }
            
            tooltip.style.top = `${top}px`;
            tooltip.style.left = `${left}px`;
            tooltip.classList.add('visible');
        }

        // Old spotlightGeneratedItems function removed

        // Global interaction blocker functions removed - no longer needed
        
        // Function to show folder contents tooltip
        function showFolderContentsTooltip() {
            console.log(' showFolderContentsTooltip called');
            // Wait a moment for the previous tooltip to disappear
            setTimeout(() => {
                const folderSection = document.querySelector('.folder-accordion-item') || document.querySelector('.folder-content');
                console.log(' Folder section found:', !!folderSection);
                if (folderSection) {
                    const spotlight = document.getElementById('onboarding-spotlight-overlay');
                    const tooltip = document.getElementById('onboarding-tooltip');
                    
                    if (spotlight && tooltip) {
                        // Create spotlight effect around folder
                        folderSection.classList.add('onboarding-highlight');
                        const rect = folderSection.getBoundingClientRect();
                        const padding = 10;
                        const clipPath = `polygon(0% 0%, 0% 100%, ${rect.left - padding}px 100%, ${rect.left - padding}px ${rect.top - padding}px, ${rect.right + padding}px ${rect.top - padding}px, ${rect.right + padding}px ${rect.bottom + padding}px, ${rect.left - padding}px ${rect.bottom + padding}px, ${rect.left - padding}px 100%, 100% 100%, 100% 0%)`;
                        
                        spotlight.style.clipPath = clipPath;
                        spotlight.classList.add('visible');
                        
                        // Show tooltip with explanation
                        tooltip.innerHTML = `
                            <div style="display: flex; flex-direction: column; gap: 1rem;">
                                <p>Once your tasks finish processing, have a look at the generated content in this folder!</p>
                                <button class="button button-primary" onclick="console.log(' I\\'ve had a look button clicked'); this.closest('.onboarding-tooltip').classList.remove('visible'); document.getElementById('onboarding-spotlight-overlay').classList.remove('visible'); document.querySelector('.folder-accordion-item, .folder-content').classList.remove('onboarding-highlight'); guideToLectureNotes();" style="align-self: flex-start;">I've had a look, let's move on</button>
                            </div>
                        `;
                        tooltip.className = 'onboarding-tooltip right';
                        const top = rect.top + (rect.bottom - rect.top) / 2;
                        const left = rect.right + 15;
                        tooltip.style.top = `${top}px`;
                        tooltip.style.left = `${left}px`;
                        tooltip.style.transform = 'translateY(-50%)';
                        tooltip.classList.add('visible');
                    }
                }
            }, 500);
        }
        
        // Function to guide user to Study Tools tab
        window.guideToLectureNotes = function() {
            console.log(' guideToLectureNotes called');
            setTimeout(() => {
                const studyToolsTab = document.querySelector('.nav-link[data-tab="tools"]');
                console.log(' Study Tools tab found:', !!studyToolsTab);
                if (studyToolsTab) {
            const spotlight = document.getElementById('onboarding-spotlight-overlay');
                    const tooltip = document.getElementById('onboarding-tooltip');
                    
                    if (spotlight && tooltip) {
                        // Create spotlight effect around Study Tools tab
                        studyToolsTab.classList.add('onboarding-highlight');
                        const rect = studyToolsTab.getBoundingClientRect();
            const padding = 10;
                        const clipPath = `polygon(0% 0%, 0% 100%, ${rect.left - padding}px 100%, ${rect.left - padding}px ${rect.top - padding}px, ${rect.right + padding}px ${rect.top - padding}px, ${rect.right + padding}px ${rect.bottom + padding}px, ${rect.left - padding}px ${rect.bottom + padding}px, ${rect.left - padding}px 100%, 100% 100%, 100% 0%)`;
                        
            spotlight.style.clipPath = clipPath;
            spotlight.classList.add('visible');

                        // Position tooltip to the right, ensuring it stays on screen
                        const tooltipWidth = 300; // Approximate tooltip width
                        const rightEdge = rect.right + 15 + tooltipWidth;
                        const screenWidth = window.innerWidth;
                        
                        let left, transform;
                        if (rightEdge > screenWidth) {
                            // Position to the left if it would go off screen
                            left = rect.left - 15 - tooltipWidth;
                            transform = 'translateX(0)';
                        } else {
                            // Position to the right
                            left = rect.right + 15;
                            transform = 'translateX(0)';
                        }
                        
                        // Show tooltip with explanation
                        tooltip.innerHTML = `
                            <div style="display: flex; flex-direction: column; gap: 1rem;">
                                <p>Click on Study Tools to explore more features!</p>
                                <button class="button button-primary" onclick="this.closest('.onboarding-tooltip').classList.remove('visible'); document.getElementById('onboarding-spotlight-overlay').classList.remove('visible'); document.querySelector('.nav-link[data-tab=\"tools\"]').classList.remove('onboarding-highlight'); guideToInLecture();" style="align-self: flex-start;">Got it!</button>
                            </div>
                        `;
                        tooltip.className = 'onboarding-tooltip right';
                        const top = rect.top + (rect.bottom - rect.top) / 2;
                        tooltip.style.top = `${top}px`;
                        tooltip.style.left = `${left}px`;
                        tooltip.style.transform = `translateY(-50%) ${transform}`;
                        tooltip.classList.add('visible');
                    }
                }
            }, 500);
        }
        
        // Function to guide user to "In a Lecture" button
        window.guideToInLecture = function() {
            console.log(' guideToInLecture called');
            setTimeout(() => {
                // Try multiple selectors to find the "In a Lecture" button
                const inLectureButton = document.querySelector('.tool-category-button[data-target="in-lecture-tools"]') || 
                                      document.querySelector('[data-target="in-lecture-tools"]') ||
                                      document.querySelector('[data-target*="lecture"]');
                console.log(' In a Lecture button found:', !!inLectureButton);
                console.log(' Available buttons:', document.querySelectorAll('button').length);
                console.log(' Available elements with data-target:', document.querySelectorAll('[data-target]').length);
                if (inLectureButton) {
                    const spotlight = document.getElementById('onboarding-spotlight-overlay');
            const tooltip = document.getElementById('onboarding-tooltip');
                    
                    if (spotlight && tooltip) {
                        // Create spotlight effect around In a Lecture button
                        inLectureButton.classList.add('onboarding-highlight');
                        const rect = inLectureButton.getBoundingClientRect();
                        const padding = 10;
                        const clipPath = `polygon(0% 0%, 0% 100%, ${rect.left - padding}px 100%, ${rect.left - padding}px ${rect.top - padding}px, ${rect.right + padding}px ${rect.top - padding}px, ${rect.right + padding}px ${rect.bottom + padding}px, ${rect.left - padding}px ${rect.bottom + padding}px, ${rect.left - padding}px 100%, 100% 100%, 100% 0%)`;
                        
                        spotlight.style.clipPath = clipPath;
                        spotlight.classList.add('visible');
                        
                        // Position tooltip to the right, ensuring it stays on screen
                        const tooltipWidth = 300;
                        const rightEdge = rect.right + 15 + tooltipWidth;
                        const screenWidth = window.innerWidth;
                        
                        let left, transform;
                        if (rightEdge > screenWidth) {
                            left = rect.left - 15 - tooltipWidth;
                            transform = 'translateX(0)';
                        } else {
                            left = rect.right + 15;
                            transform = 'translateX(0)';
                        }
                        
                        // Show tooltip with explanation (no Got it button needed)
                        tooltip.innerHTML = `
                            <div style="display: flex; flex-direction: column; gap: 1rem;">
                                <p>Click on "In a Lecture" to see lecture-related tools!</p>
                            </div>
                        `;
                        
                        // Add click handler to the In a Lecture button to automatically continue onboarding
                        const originalClickHandler = inLectureButton.onclick;
                        inLectureButton.onclick = function(e) {
                            // Check if we're still in onboarding
                            const isOnboarding = sessionStorage.getItem('onboardingStep') === 'hub_entry';
                            console.log(' In a Lecture button clicked, is onboarding:', isOnboarding);
                            
                            if (isOnboarding) {
                                console.log(' In a Lecture button clicked during onboarding - continuing automatically');
                                
                                // Hide tooltip and spotlight
                                tooltip.classList.remove('visible');
                                spotlight.classList.remove('visible');
                                inLectureButton.classList.remove('onboarding-highlight');
                                
                                // Continue to next step
                                setTimeout(() => {
                                    guideToTakeNotes();
                                }, 500);
                            } else {
                                console.log(' In a Lecture button clicked but not in onboarding - using normal behavior');
                            }
                            
                            // Call original handler if it exists
                            if (originalClickHandler) {
                                originalClickHandler.call(this, e);
                            }
                        };
                        tooltip.className = 'onboarding-tooltip right';
                        const top = rect.top + (rect.bottom - rect.top) / 2;
            tooltip.style.top = `${top}px`;
            tooltip.style.left = `${left}px`;
                        tooltip.style.transform = `translateY(-50%) ${transform}`;
                        tooltip.classList.add('visible');
                    }
                }
            }, 500);
        }
        
        // Function to guide user to "Take notes with slides" feature
        window.guideToTakeNotes = function() {
            console.log(' guideToTakeNotes called');
            setTimeout(() => {
                const takeNotesCard = document.querySelector('#pipeline-slide-notes') || 
                                    document.querySelector('.feature-card[id="pipeline-slide-notes"]');
                console.log(' Take notes card found:', !!takeNotesCard);
                if (takeNotesCard) {
                    const spotlight = document.getElementById('onboarding-spotlight-overlay');
                    const tooltip = document.getElementById('onboarding-tooltip');
                    
                    if (spotlight && tooltip) {
                        // Create spotlight effect around Take notes with slides card
                        takeNotesCard.classList.add('onboarding-highlight');
                        const rect = takeNotesCard.getBoundingClientRect();
                        const padding = 10;
                        const clipPath = `polygon(0% 0%, 0% 100%, ${rect.left - padding}px 100%, ${rect.left - padding}px ${rect.top - padding}px, ${rect.right + padding}px ${rect.top - padding}px, ${rect.right + padding}px ${rect.bottom + padding}px, ${rect.left - padding}px ${rect.bottom + padding}px, ${rect.left - padding}px 100%, 100% 100%, 100% 0%)`;
                        
                        spotlight.style.clipPath = clipPath;
                        spotlight.classList.add('visible');
                        
                        // Position tooltip to the right, ensuring it stays on screen
                        const tooltipWidth = 300;
                        const rightEdge = rect.right + 15 + tooltipWidth;
                        const screenWidth = window.innerWidth;
                        
                        let left, transform;
                        if (rightEdge > screenWidth) {
                            left = rect.left - 15 - tooltipWidth;
                            transform = 'translateX(0)';
                        } else {
                            left = rect.right + 15;
                            transform = 'translateX(0)';
                        }
                        
                        // Show tooltip with explanation
                        tooltip.innerHTML = `
                            <div style="display: flex; flex-direction: column; gap: 1rem;">
                                <p>Click on "Take notes with slides" to start interactive note-taking!</p>
                                <button class="button button-primary" onclick="this.closest('.onboarding-tooltip').classList.remove('visible'); document.getElementById('onboarding-spotlight-overlay').classList.remove('visible'); document.querySelector('#pipeline-slide-notes').classList.remove('onboarding-highlight');" style="align-self: flex-start;">Got it!</button>
                            </div>
                        `;
                        tooltip.className = 'onboarding-tooltip right';
                        const top = rect.top + (rect.bottom - rect.top) / 2;
                        tooltip.style.top = `${top}px`;
                        tooltip.style.left = `${left}px`;
                        tooltip.style.transform = `translateY(-50%) ${transform}`;
                        tooltip.classList.add('visible');
                        
                        // Add click handler to automatically open modal during onboarding
                        const clickHandler = (e) => {
                            // Check if we're in onboarding
                            const isOnboarding = sessionStorage.getItem('onboardingStep') === 'hub_entry';
                            if (isOnboarding) {
                                console.log(' Take notes with slides clicked during onboarding, opening modal...');
                                e.preventDefault();
                                e.stopPropagation();
                                
                                // Remove the click handler
                                takeNotesCard.removeEventListener('click', clickHandler);
                                
                                // Hide tooltip and spotlight
                                tooltip.classList.remove('visible');
                                spotlight.classList.remove('visible');
                                takeNotesCard.classList.remove('onboarding-highlight');
                                
                                // Open modal with file pre-selected
                                openLectureNotesModal();
                            }
                        };
                        
                        // Add the click handler
                        takeNotesCard.addEventListener('click', clickHandler);
                    }
                }
            }, 500);
        }
        
        // Function to open lecture notes modal and auto-select file
        window.openLectureNotesModal = function() {
            console.log(' openLectureNotesModal called');
            setTimeout(() => {
                // Click the lecture notes card to open the modal
                const lectureNotesCard = document.querySelector('#pipeline-slide-notes') || 
                                       document.querySelector('.feature-card[id="pipeline-slide-notes"]');
                console.log(' Lecture notes card found:', !!lectureNotesCard);
                if (lectureNotesCard) {
                    lectureNotesCard.click();
                    
                    // Wait for modal to open, then auto-select file during onboarding
                    setTimeout(() => {
                        
                        const isOnboarding = sessionStorage.getItem('onboardingStep') === 'hub_entry';
                        if (isOnboarding) {
                            // Auto-select EC131 Week 9 file during onboarding
                            setTimeout(() => {
                                const fileCheckbox = document.querySelector('#slide-notes-files input[value*="EC131"]') || 
                                                   document.querySelector('#slide-notes-files input[value*="EC131_Week_9"]') ||
                                                   document.querySelector('#slide-notes-files input[value*="machine_learning"]') ||
                                                   document.querySelector('#slide-notes-files input[name="slide-notes-files_files"]');
                                
                                console.log(' Looking for file checkbox, found:', !!fileCheckbox);
                                console.log(' Checkbox value:', fileCheckbox ? fileCheckbox.value : 'none');
                                
                                if (fileCheckbox) {
                                    fileCheckbox.checked = true;
                                    fileCheckbox.dispatchEvent(new Event('change'));
                                    console.log(' EC131 Week 9 file auto-selected for lecture notes during onboarding, value:', fileCheckbox.value);
                                    
                                    // Show final tooltip
                                    setTimeout(() => {
                                        const modal = document.querySelector('#slide-notes-modal');
                                        if (modal) {
                                            const spotlight = document.getElementById('onboarding-spotlight-overlay');
                                            const tooltip = document.getElementById('onboarding-tooltip');
                                            
                                            if (spotlight && tooltip) {
                                                // Create spotlight effect around the modal
                                                const rect = modal.getBoundingClientRect();
                                                const padding = 10;
                                                const clipPath = `polygon(0% 0%, 0% 100%, ${rect.left - padding}px 100%, ${rect.left - padding}px ${rect.top - padding}px, ${rect.right + padding}px ${rect.top - padding}px, ${rect.right + padding}px ${rect.bottom + padding}px, ${rect.left - padding}px ${rect.bottom + padding}px, ${rect.left - padding}px 100%, 100% 100%, 100% 0%)`;
                                                
                                                spotlight.style.clipPath = clipPath;
                                                spotlight.classList.add('visible');
                                                
                                                // Show final tooltip
                                                tooltip.innerHTML = `
                                                    <div style="display: flex; flex-direction: column; gap: 1rem;">
                                                        <p>Perfect! Your EC131 Week 9 file is already selected. Just click "Start note-taking" to begin!</p>
                                                        <button class="button button-primary" onclick="this.closest('.onboarding-tooltip').classList.remove('visible'); document.getElementById('onboarding-spotlight-overlay').classList.remove('visible'); setupOnboardingCompletion();" style="align-self: flex-start;">Perfect!</button>
                                                    </div>
                                                `;
                                                // Check if there's enough space on the right side
                                                const tooltipWidth = 300; // Approximate tooltip width
                                                const rightSpace = window.innerWidth - rect.right;
                                                const leftSpace = rect.left;
                                                
                                                let position, left, top;
                                                if (rightSpace >= tooltipWidth + 50) {
                                                    // Position on the right
                                                    position = 'right';
                                                    left = rect.right + 15;
                                                } else if (leftSpace >= tooltipWidth + 50) {
                                                    // Position on the left
                                                    position = 'left';
                                                    left = rect.left - 15;
                                                } else {
                                                    // Position below if no space on sides
                                                    position = 'bottom';
                                                    left = rect.left + rect.width / 2;
                                                }
                                                
                                                tooltip.className = `onboarding-tooltip ${position}`;
                                                top = rect.top + (rect.bottom - rect.top) / 2;
                                                
                                                tooltip.style.top = `${top}px`;
                                                tooltip.style.left = `${left}px`;
                                                
                                                if (position === 'right' || position === 'left') {
                                                    tooltip.style.transform = 'translateY(-50%)';
                                                } else {
            tooltip.style.transform = 'translateX(-50%)';
                                                }
                                                
            tooltip.classList.add('visible');
                                            }
                                        }
                                    }, 500);
                                }
                            }, 500);
                        } else {
                            console.log(' Not in onboarding, file not auto-selected');
                        }
                    }, 500);
                }
            }, 500);
        }
        
        
        // Function to update form validation for slide notes
        function updateSlideNotesFormValidation() {
            const fileSelected = document.querySelector('#slide-notes-files input[name="slide-notes-files_files"]:checked');
            
            console.log(' Form validation - fileSelected:', !!fileSelected);
            
            const submitBtn = document.querySelector('#slide-notes-form button[type="submit"]');
            if (submitBtn) {
                const shouldEnable = !!fileSelected;
                console.log(' Form validation - shouldEnable:', shouldEnable);
                submitBtn.disabled = !shouldEnable;
                if (!shouldEnable) {
                    submitBtn.style.opacity = '0.5';
                    submitBtn.style.cursor = 'not-allowed';
                } else {
                    submitBtn.style.opacity = '1';
                    submitBtn.style.cursor = 'pointer';
                }
            }
        }
        
        // Function to handle slide notes form submission
        function handleSlideNotesFormSubmission(e) {
            console.log(' handleSlideNotesFormSubmission called');
            const fileSelected = document.querySelector('#slide-notes-files input[name="slide-notes-files_files"]:checked');
            
            console.log(' File selected:', !!fileSelected, fileSelected ? fileSelected.value : 'none');
            
            // Check if we're in onboarding and complete it
            const isOnboarding = sessionStorage.getItem('onboardingStep') === 'hub_entry';
            if (isOnboarding) {
                console.log(' Completing onboarding during slide notes submission...');
                
                // Complete onboarding
                fetch('/onboarding/complete', { method: 'POST' }).then(() => {
                    console.log(' Onboarding completion API called successfully');
                    
                    // Clean up onboarding flags
                    sessionStorage.removeItem('onboardingStep');
                    sessionStorage.removeItem('showOnboardingCelebration');
                    sessionStorage.removeItem('showTaskQueueTooltip');
                    
                    // Show completion modal immediately (don't wait for page reload)
                    setTimeout(() => {
                        console.log(' Showing completion modal immediately after onboarding completion');
                        showCompletionModal();
                    }, 2000); // Wait 2 seconds for the new tab to open
                    
                }).catch(e => console.error('Error completing onboarding:', e));
            }
            
            if (!fileSelected) {
                e.preventDefault();
                showNotification('Please select a document to continue.', NOTIFICATION_TYPES.ERROR);
                return;
            }
            
            // Handle file selection
            console.log(' Using selected file, preventing default and submitting manually');
            e.preventDefault();
                
                // Get the file path from the selected radio button
                const filePath = fileSelected.value;
                console.log(' Selected file path:', filePath);
                
                // Find the file data from window.hubFiles
                const hubFiles = window.hubFiles || [];
                console.log(' All hub files:', hubFiles);
                console.log(' Hub files length:', hubFiles.length);
                console.log(' Looking for file with path:', filePath);
                
                // Try different field names in case the structure is different
                let selectedFile = hubFiles.find(file => file.file_path === filePath);
                if (!selectedFile) {
                    selectedFile = hubFiles.find(file => file.path === filePath);
                }
                if (!selectedFile) {
                    selectedFile = hubFiles.find(file => file.filePath === filePath);
                }
                
                if (!selectedFile) {
                    console.error(' No file found for path:', filePath);
                    console.error(' Available file paths:', hubFiles.map(f => f.file_path || f.path || f.filePath));
                    console.error(' First file structure:', hubFiles[0]);
                    showNotification('Error: Could not find selected file.', NOTIFICATION_TYPES.ERROR);
                    return;
                }
                
                const fileName = selectedFile.original_filename || selectedFile.filename;
                console.log(' Using file path:', filePath, 'and file name:', fileName);
                
                // Create hidden inputs with the file path and name
                const form = e.target;
                const filePathInput = document.createElement('input');
                filePathInput.type = 'hidden';
                filePathInput.name = 'selected_file_path';
                filePathInput.value = filePath;
                form.appendChild(filePathInput);
                
                const fileNameInput = document.createElement('input');
                fileNameInput.type = 'hidden';
                fileNameInput.name = 'selected_file_name';
                fileNameInput.value = fileName;
                form.appendChild(fileNameInput);
                
                // Ensure the form opens in a new tab
                form.target = '_blank';
                
                console.log(' Submitting form with file path:', filePath, 'and file name:', fileName);
                // Submit the form
                form.submit();
        }
        
        // Function to setup onboarding completion
        function setupOnboardingCompletion() {
            console.log(' Setting up onboarding completion...');
            
            // Add click handler to the Start note-taking button
            const startNoteTakingBtn = document.querySelector('#slide-notes-form button[type="submit"]');
            if (startNoteTakingBtn) {
                startNoteTakingBtn.addEventListener('click', () => {
                    console.log(' Start note-taking clicked during onboarding!');
                    
                    // Close the tooltip and spotlight immediately
                    const tooltip = document.getElementById('onboarding-tooltip');
                    const spotlight = document.getElementById('onboarding-spotlight-overlay');
                    if (tooltip) tooltip.classList.remove('visible');
                    if (spotlight) spotlight.classList.remove('visible');
                    
                    // Set flag to show completion modal after redirect
                    sessionStorage.setItem('showOnboardingCompletionModal', '1');
                    
                    // Complete onboarding
                    fetch('/onboarding/complete', { method: 'POST' }).catch(e => console.error('Error completing onboarding:', e));
                    
                    // Clean up onboarding flags
                    sessionStorage.removeItem('onboardingStep');
                    sessionStorage.removeItem('showOnboardingCelebration');
                    sessionStorage.removeItem('showTaskQueueTooltip');
                }, { once: true });
            }
        }
        
        // Function to show completion modal
        function showCompletionModal() {
            console.log(' Showing onboarding completion modal...');
            const completionModal = document.getElementById('onboarding-completion-modal');
            if (completionModal) {
                completionModal.classList.add('visible');
            }
        }
        
        // Function to hide completion modal
        function hideCompletionModal() {
            const completionModal = document.getElementById('onboarding-completion-modal');
            if (completionModal) {
                completionModal.classList.remove('visible');
            }
        }

        function hideOnboardingUI() {
            const spotlight = document.getElementById('onboarding-spotlight-overlay');
            const tooltip = document.getElementById('onboarding-tooltip');
            if (spotlight) spotlight.classList.remove('visible');
            if (tooltip) tooltip.classList.remove('visible');
            document.querySelectorAll('.onboarding-highlight').forEach(el => {
                el.classList.remove('onboarding-highlight');
            });
        }

        // Edit functionality for all items
        document.addEventListener('DOMContentLoaded', function() {
            // Add event listeners to all edit buttons
            document.addEventListener('click', function(e) {
                if (e.target.closest('.edit-button')) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const button = e.target.closest('.edit-button');
                    const itemType = button.dataset.type;
                    const itemId = button.dataset.id;
                    
                    startEdit(itemType, itemId, button);
                }
            });
        });

        function startEdit(itemType, itemId, button) {
            const titleElement = document.getElementById(`${itemType}-title-${itemId}`);
            if (!titleElement) return;

            const originalTitle = titleElement.textContent;
            
            // Create input field
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'edit-input';
            input.value = originalTitle;
            input.maxLength = 100;
            
            // Create action buttons
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'edit-actions';
            
            const saveBtn = document.createElement('button');
            saveBtn.className = 'edit-save-btn';
            saveBtn.textContent = 'Save';
            
            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'edit-cancel-btn';
            cancelBtn.textContent = 'Cancel';
            
            actionsDiv.appendChild(saveBtn);
            actionsDiv.appendChild(cancelBtn);
            
            // Replace title with input and actions
            titleElement.innerHTML = '';
            titleElement.appendChild(input);
            titleElement.appendChild(actionsDiv);
            
            // Focus and select input
            input.focus();
            input.select();
            
            // Save functionality
            saveBtn.addEventListener('click', () => {
                const newTitle = input.value.trim();
                if (newTitle && newTitle !== originalTitle) {
                    saveTitle(itemType, itemId, newTitle, titleElement);
                } else {
                    cancelEdit(titleElement, originalTitle);
                }
            });
            
            // Cancel functionality
            cancelBtn.addEventListener('click', () => {
                cancelEdit(titleElement, originalTitle);
            });
            
            // Save on Enter key
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const newTitle = input.value.trim();
                    if (newTitle && newTitle !== originalTitle) {
                        saveTitle(itemType, itemId, newTitle, titleElement);
                    } else {
                        cancelEdit(titleElement, originalTitle);
                    }
                }
            });
            
            // Cancel on Escape key
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    cancelEdit(titleElement, originalTitle);
                }
            });
        }

        function cancelEdit(titleElement, originalTitle) {
            titleElement.innerHTML = originalTitle;
        }

        async function saveTitle(itemType, itemId, newTitle, titleElement) {
            try {
                const response = await fetch(`/api/${itemType}/${itemId}/update_title`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ title: newTitle })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    titleElement.innerHTML = newTitle;
                } else {
                    showError('Error updating title: ' + (result.message || 'Unknown error'));
                    // Revert to original title
                    titleElement.innerHTML = titleElement.textContent;
                }
            } catch (error) {
                console.error('Error updating title:', error);
                showError('Error updating title. Please try again.');
                // Revert to original title
                titleElement.innerHTML = titleElement.textContent;
            }
        }

        // Success modal functionality
        function showSuccessModal(title, message, callback) {
            const modal = document.createElement('div');
            modal.className = 'success-modal-overlay';
            modal.innerHTML = `
                <div class="success-modal-content">
                    <div class="success-icon"></div>
                    <h2 class="success-title">${title}</h2>
                    <p class="success-message">${message}</p>
                    <button class="success-button" onclick="closeSuccessModal(this)">Got it!</button>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Trigger animation
            setTimeout(() => {
                modal.classList.add('visible');
            }, 10);
            
            // Store callback for later use
            modal.callback = callback;
        }

        function closeSuccessModal(button) {
            const modal = button.closest('.success-modal-overlay');
            modal.classList.remove('visible');
            
            setTimeout(() => {
                if (modal.callback) {
                    modal.callback();
                }
                modal.remove();
            }, 300);
        }

        // Close modal when clicking outside of it
        document.addEventListener('click', function(e) {
            const confirmationModal = document.getElementById('custom-confirmation-modal');
            const alertModal = document.getElementById('custom-alert-modal');
            
            if (e.target === confirmationModal) {
                closeCustomModal();
            }
            if (e.target === alertModal) {
                closeCustomAlert();
            }
        });

        // Prevent modal content clicks from closing the modal
        document.addEventListener('click', function(e) {
            if (e.target.closest('.modal-content')) {
                e.stopPropagation();
            }
        });

        // Close modal with ESC key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const confirmationModal = document.getElementById('custom-confirmation-modal');
                const alertModal = document.getElementById('custom-alert-modal');
                
                if (confirmationModal.style.display === 'flex') {
                    closeCustomModal();
                }
                if (alertModal.style.display === 'flex') {
                    closeCustomAlert();
                }
            }
        });

        // Set up the confirm action button and delete button event listeners
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('confirm-action-btn').addEventListener('click', confirmAction);
            
            // File delete buttons
            document.addEventListener('click', function(e) {
                if (e.target.closest('.delete-file-btn')) {
                    e.preventDefault();
                    const deleteBtn = e.target.closest('.delete-file-btn');
                    const deleteUrl = deleteBtn.href;
                    showCustomConfirmation('Are you sure you want to delete this file?', () => {
                        window.location.href = deleteUrl;
                    }, null, 'Delete File');
                }
            });
        });

        // Override native confirm and alert functions
        window.customConfirm = showCustomConfirmation;
        window.customAlert = showCustomAlert;

        // Delete functionality
        document.addEventListener('DOMContentLoaded', function() {
            const hubId = '{{ hub.id }}';
            
            // Delete folder button
            document.addEventListener('click', function(e) {
                if (e.target.closest('.delete-folder-btn')) {
                    const button = e.target.closest('.delete-folder-btn');
                    const folderElement = button.closest('.folder-accordion-item');
                    const folderId = folderElement.dataset.folderId;
                    
                    showCustomConfirmation(
                        'Are you sure you want to delete this folder and all its contents? This action cannot be undone.',
                        (data) => deleteFolder(data.folderId, data.folderElement),
                        { folderId, folderElement },
                        'Delete Folder'
                    );
                }
                
                // Delete note button
                if (e.target.closest('.delete-note-btn')) {
                    const button = e.target.closest('.delete-note-btn');
                    const noteId = button.dataset.id;
                    
                    showCustomConfirmation(
                        'Are you sure you want to delete this note? This action cannot be undone.',
                        (data) => deleteNote(data.noteId, data.noteElement),
                        { noteId, noteElement: button.closest('.asset-item') },
                        'Delete Note'
                    );
                }
                
                // Delete activity button (flashcards, quizzes)
                if (e.target.closest('.delete-activity-btn')) {
                    const button = e.target.closest('.delete-activity-btn');
                    const activityId = button.dataset.id;
                    
                    showCustomConfirmation(
                        'Are you sure you want to delete this item? This action cannot be undone.',
                        (data) => deleteActivity(data.activityId, data.activityElement),
                        { activityId, activityElement: button.closest('.asset-item') },
                        'Delete Item'
                    );
                }
                
                // Delete folder item button
                if (e.target.closest('.delete-folder-item-btn')) {
                    const button = e.target.closest('.delete-folder-item-btn');
                    const itemId = button.dataset.id;
                    const itemType = button.dataset.type;
                    
                    showCustomConfirmation(
                        'Are you sure you want to delete this item from the folder? This action cannot be undone.',
                        (data) => deleteFolderItem(data.itemId, data.itemType, data.itemElement),
                        { itemId, itemType, itemElement: button.closest('.asset-item') },
                        'Remove Item'
                    );
                }
                
                // Delete slide note button
                if (e.target.closest('.delete-slide-note-btn')) {
                    const button = e.target.closest('.delete-slide-note-btn');
                    const slideNoteId = button.dataset.id;
                    
                    showCustomConfirmation(
                        'Are you sure you want to delete this lecture notes session? This action cannot be undone.',
                        (data) => deleteSlideNote(data.slideNoteId, data.slideNoteElement),
                        { slideNoteId, slideNoteElement: button.closest('.asset-item') },
                        'Delete Lecture Notes'
                    );
                }
            });
            
            function deleteFolder(folderId, folderElement) {
                fetch(`/folder/${folderId}/delete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        folderElement.remove();
                        showMessage('success', 'Folder deleted successfully');
                    } else {
                        showMessage('error', data.message || 'Failed to delete folder');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showMessage('error', 'Failed to delete folder');
                });
            }
            
            function deleteNote(noteId, noteElement) {
                fetch(`/note/${noteId}/delete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        noteElement.remove();
                        showMessage('success', 'Note deleted successfully');
                    } else {
                        showMessage('error', data.message || 'Failed to delete note');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showMessage('error', 'Failed to delete note');
                });
            }
            
            function deleteActivity(activityId, activityElement) {
                fetch(`/hub/${hubId}/delete_activity/${activityId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        activityElement.remove();
                        showMessage('success', 'Item deleted successfully');
                    } else {
                        showMessage('error', data.message || 'Failed to delete item');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showMessage('error', 'Failed to delete item');
                });
            }
            
            function deleteFolderItem(itemId, itemType, itemElement) {
                // For folder items, we need to determine if it's a note or activity
                if (itemType === 'note') {
                    deleteNote(itemId, itemElement);
                } else {
                    deleteActivity(itemId, itemElement);
                }
            }
            
            function deleteSlideNote(slideNoteId, slideNoteElement) {
                fetch(`/hub/${hubId}/delete_slide_note/${slideNoteId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        slideNoteElement.remove();
                        showMessage('success', 'Lecture notes deleted successfully');
                    } else {
                        showMessage('error', data.message || 'Failed to delete lecture notes');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showMessage('error', 'Failed to delete lecture notes');
                });
            }
        });
        
        // ===== FILE VIEWING FUNCTIONALITY =====
        
        // Handle file card clicks
        document.querySelectorAll('.clickable-file').forEach(fileCard => {
            fileCard.addEventListener('click', function(e) {
                // Don't trigger if clicking on buttons or links
                if (e.target.closest('.view-btn') || e.target.closest('.delete-btn')) {
                    return;
                }
                
                const filePath = this.dataset.filePath;
                const fileName = this.dataset.fileName;
                
                if (filePath) {
                    console.log(' Opening file:', fileName);
                    // Open file in new tab
                    const viewUrl = `/hub/{{ hub.id }}/view_file?file_path=${encodeURIComponent(filePath)}`;
                    window.open(viewUrl, '_blank');
                }
            });
        });
        
        // Handle view button clicks
        document.querySelectorAll('.view-btn').forEach(viewBtn => {
            viewBtn.addEventListener('click', function(e) {
                e.stopPropagation(); // Prevent card click
                
                const filePath = this.dataset.filePath;
                const fileName = this.dataset.fileName;
                
                if (filePath) {
                    console.log(' Viewing file:', fileName);
                    // Open file in new tab
                    const viewUrl = `/hub/{{ hub.id }}/view_file?file_path=${encodeURIComponent(filePath)}`;
                    window.open(viewUrl, '_blank');
                }
            });
        });
        
        // Handle delete button clicks with confirmation
        document.querySelectorAll('.delete-file-btn').forEach(deleteBtn => {
            deleteBtn.addEventListener('click', function(e) {
                e.stopPropagation(); // Prevent card click
                e.preventDefault(); // Prevent default link behavior
                
                const filePath = this.dataset.filePath;
                const fileName = this.closest('.file-item-card').dataset.fileName;
                
                if (filePath) {
                    showCustomConfirmation(
                        `Are you sure you want to delete "${fileName}"? This action cannot be undone.`,
                        function() {
                            console.log(' Deleting file:', fileName);
                            // Proceed with deletion
                            window.location.href = this.href;
                        },
                        null,
                        'Delete'
                    );
                }
            });
        });
        
    </script>

    <!-- Success Modal -->
    <div id="success-modal-overlay" class="success-modal-overlay">
        <div class="success-modal-content">
            <div class="success-icon"></div>
            <h2 class="success-title">Successfully Uploaded!</h2>
            <p class="success-message">Your folder has been shared to the community.</p>
            <button class="success-button" onclick="closeSuccessModal(this)">Got it!</button>
        </div>
    </div>

    <!-- Custom Confirmation Modal -->
    <div id="custom-confirmation-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3 id="confirmation-title"> Are you sure?</h3>
                <button class="close-btn" onclick="closeCustomModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p id="confirmation-message">Are you sure you'd like to delete this?</p>
            </div>
            <div class="modal-footer">
                <button class="button button-secondary" onclick="closeCustomModal()">Cancel</button>
                <button class="button button-danger" id="confirm-action-btn">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Custom Alert Modal -->
    <div id="custom-alert-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3 id="alert-title"> Information</h3>
                <button class="close-btn" onclick="closeCustomAlert()">&times;</button>
            </div>
            <div class="modal-body">
                <p id="alert-message">This is an alert message.</p>
            </div>
            <div class="modal-footer">
                <button class="button button-primary" onclick="closeCustomAlert()">OK</button>
            </div>
        </div>
    </div>

</body>
</html>