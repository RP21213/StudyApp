<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Study Hub Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <!-- NEW: Spotify Web Playback SDK -->
    <script src="https://sdk.scdn.co/spotify-player.js"></script>

    <style>
        :root {
            --primary-color: #4f46e5;
            --primary-hover: #4338ca;
            --danger-color: #ef4444;
            --danger-hover: #dc2626;
            --text-main: #111827;
            --text-secondary: #6b7280;
            --text-light: #9ca3af;
            --border-color: #e5e7eb;
            --background-light: #f9fafb;
            --background-white: #ffffff;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            
            /* --- NEW: Category Colors --- */
            --color-notes: #3b82f6; /* Blue */
            --color-quiz: #22c55e; /* Green */
            --color-flashcards: #ec4899; /* Pink */
            --color-pack: #f59e0b; /* Yellow/Amber */

            /* --- NEW: Accessibility Styles --- */
            font-size: 16px; /* Default font size */
        }
        
        html[data-font-size="large"] { font-size: 18px; }
        html[data-font-size="small"] { font-size: 14px; }
        html[data-high-contrast="true"] {
            --text-main: #000000;
            --text-secondary: #111111;
            --background-light: #ffffff;
            --background-white: #f0f0f0;
            --border-color: #000000;
        }


        html[data-theme="dark"] {
            --primary-color: #6366f1;
            --primary-hover: #4f46e5;
            --danger-color: #f87171;
            --danger-hover: #ef4444;
            --text-main: #f9fafb;
            --text-secondary: #9ca3af;
            --text-light: #6b7280;
            --border-color: #374151;
            --background-light: #111827;
            --background-white: #1f2937;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.15);
            --shadow-md: 0 0 0 1px rgba(255, 255, 255, 0.1);
            --shadow-lg: 0 0 0 1px rgba(255, 255, 255, 0.1);
            
            /* --- NEW: Dark Theme Category Colors --- */
            --color-notes: #60a5fa;
            --color-quiz: #4ade80;
            --color-flashcards: #f472b6;
            --color-pack: #fbbf24;
        }
        
        html[data-theme="dark"][data-high-contrast="true"] {
            --text-main: #ffffff;
            --text-secondary: #eeeeee;
            --background-light: #000000;
            --background-white: #1a1a1a;
            --border-color: #ffffff;
        }


        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--background-light);
            margin: 0;
            color: var(--text-main);
            transition: background-color 0.3s, color 0.3s;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            display: flex;
        }

        .side-panel {
            width: 260px;
            background-color: var(--background-white);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            padding: 1.5rem;
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            box-shadow: var(--shadow-sm);
            box-sizing: border-box;
        }

        .side-panel .logo {
            font-size: 1.75rem;
            font-weight: 800;
            color: var(--primary-color);
            margin-bottom: 3rem;
        }

        .side-panel .nav-tabs {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            flex-grow: 1;
        }

        .side-panel .nav-tab {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1rem;
            color: var(--text-secondary);
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .side-panel .nav-tab:hover {
            background-color: var(--background-light);
            color: var(--text-main);
        }

        .side-panel .nav-tab.active {
            color: white;
            box-shadow: var(--shadow-md);
        }
        
        /* --- NEW: Gradient Chip Styles for Active Tabs --- */
        .side-panel .nav-tab.active[data-tab="hubs"] {
            background-image: linear-gradient(to right, #8b5cf6, #4f46e5); /* purple -> indigo */
        }
        .side-panel .nav-tab.active[data-tab="progress"] {
            background-image: linear-gradient(to right, #2dd4bf, #22c55e); /* teal -> green */
        }
        .side-panel .nav-tab.active[data-tab="spaced-repetition"] {
            background-image: linear-gradient(to right, #f59e0b, #d97706); /* amber -> orange */
        }
        .side-panel .nav-tab.active[data-tab="community"] {
            background-image: linear-gradient(to right, #3b82f6, #8b5cf6); /* blue -> violet */
        }
        .side-panel .nav-tab.active[data-tab="profile"] {
            background-image: linear-gradient(to right, #ec4899, #f43f5e); /* pink -> rose */
        }
        .side-panel .nav-tab.active[data-tab="settings"] {
            background-image: linear-gradient(to right, #9ca3af, #64748b); /* gray -> slate */
        }
        .side-panel .nav-tab.active[data-tab="earn-money"] {
            background-image: linear-gradient(to right, #f59e0b, #d97706); /* amber -> orange */
        }
        
        .side-panel .nav-tab.active[data-tab="my-values"] {
            background-image: linear-gradient(to right, #3b82f6, #1d4ed8); /* blue gradient */
        }
        
        /* My Values Tab - Crisis Support */
        .values-section {
            margin-top: 2rem;
        }
        
        .crisis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }
        
        /* Flip Card Styles */
        .flip-card {
            background-color: transparent;
            width: 100%;
            height: 300px;
            perspective: 1000px;
            cursor: pointer;
        }
        
        .flip-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.6s;
            transform-style: preserve-3d;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .flip-card.flipped .flip-card-inner {
            transform: rotateY(180deg);
        }
        
        .flip-card-front, .flip-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 2rem;
            box-sizing: border-box;
        }
        
        .flip-card-front {
            background: var(--background-white);
            border: 1px solid var(--border-color);
        }
        
        .flip-card-back {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            transform: rotateY(180deg);
        }
        
        .flag-container {
            width: 120px;
            height: 80px;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #ddd;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .flag-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* Flag Designs */
        .palestine-flag {
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, 
                #000 0%, #000 33.33%,
                #fff 33.33%, #fff 66.66%,
                #009639 66.66%, #009639 100%);
            position: relative;
        }
        
        .palestine-flag::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            width: 33.33%;
            height: 100%;
            background: #ce1126;
            clip-path: polygon(0 0, 0 100%, 100% 50%);
        }
        
        .syria-flag {
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, 
                #ce1126 0%, #ce1126 33.33%,
                #fff 33.33%, #fff 66.66%,
                #000 66.66%, #000 100%);
            position: relative;
        }
        
        .syria-flag::before,
        .syria-flag::after {
            content: '';
            position: absolute;
            width: 8px;
            height: 8px;
            background: #009639;
            border-radius: 50%;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .syria-flag::before {
            left: 35%;
        }
        
        .syria-flag::after {
            right: 35%;
        }
        
        .sudan-flag {
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, 
                #d21034 0%, #d21034 33.33%,
                #fff 33.33%, #fff 66.66%,
                #000 66.66%, #000 100%);
            position: relative;
        }
        
        .sudan-flag::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            width: 33.33%;
            height: 100%;
            background: #009639;
            clip-path: polygon(0 0, 0 100%, 100% 50%);
        }
        
        .flip-card-front h3 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-main);
            margin: 0.5rem 0;
        }
        
        .flip-card-front p {
            color: var(--text-secondary);
            margin: 0;
            font-size: 0.9rem;
        }
        
        .flip-card-back h3 {
            font-size: 1.5rem;
            font-weight: 600;
            margin: 0 0 1rem 0;
            color: white;
        }
        
        .flip-card-back p {
            margin: 0 0 1rem 0;
            line-height: 1.5;
            color: rgba(255, 255, 255, 0.9);
        }
        
        .flip-card-back ul {
            margin: 0;
            padding-left: 1.5rem;
            text-align: left;
            color: rgba(255, 255, 255, 0.9);
        }
        
        .flip-card-back li {
            margin-bottom: 0.5rem;
            line-height: 1.4;
        }
        
        /* Responsive Design for My Values */
        @media (max-width: 768px) {
            .crisis-grid {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }
            
            .flip-card {
                height: 280px;
            }
            
            .flag-container {
                width: 100px;
                height: 65px;
            }
        }
        
        /* Earn Money Tab - Consistent with Site Aesthetic */
        
        /* Referral Code Section */
        .referral-code-section {
            background: var(--background-white);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid var(--border-color);
            display: flex;
            gap: 3rem;
            align-items: flex-start;
        }
        
        .referral-code-left {
            flex: 1;
            text-align: center;
        }
        
        .referral-code-right {
            flex: 1;
        }
        
        .referral-code-left h3,
        .referral-code-right h3 {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-main);
            margin-bottom: 1.5rem;
        }
        
        .referral-code-display {
            background: var(--primary-color);
            color: white;
            padding: 1rem 2rem;
            border-radius: 8px;
            font-size: 1.5rem;
            font-weight: 700;
            letter-spacing: 0.1em;
            margin: 1rem auto;
            display: block;
            font-family: 'Courier New', monospace;
            text-align: center;
            max-width: fit-content;
        }
        
        
        /* Milestones Section */
        .milestones-section {
            margin-top: 2rem;
        }
        
        .milestones-section h4 {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-main);
            margin-bottom: 1rem;
            text-align: center;
        }
        
        .milestones-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }
        
        .milestone-card {
            background: var(--background-light);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }
        
        .milestone-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .milestone-number {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }
        
        .milestone-reward {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 600;
        }
        
        .milestone-status {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .milestone-status.achieved {
            color: #10b981;
        }
        
        .claim-button {
            margin-top: 0.75rem;
        }
        
        .claim-btn {
            background: linear-gradient(45deg, #10b981, #059669);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
        }
        
        .claim-btn:hover {
            background: linear-gradient(45deg, #059669, #047857);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(16, 185, 129, 0.4);
        }
        
        .claim-btn:active {
            transform: translateY(0);
        }
        
        .loading-text {
            color: var(--text-secondary);
            font-style: italic;
        }
        
        .loading-card {
            opacity: 0.7;
        }
        
        /* Add Referral Code Section */
        .add-referral-section {
            background: var(--background-white);
            border-radius: 8px;
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-left: 3px solid #10b981;
            min-width: 280px;
            box-shadow: var(--shadow-sm);
        }
        
        .add-referral-section h4 {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-main);
            margin-bottom: 0.25rem;
            line-height: 1.2;
        }
        
        .section-description {
            color: var(--text-secondary);
            font-size: 0.75rem;
            margin-bottom: 0.5rem;
            line-height: 1.2;
        }
        
        .referral-input-group {
            display: flex;
            gap: 0.25rem;
            align-items: center;
        }
        
        .referral-input-group input {
            flex: 1;
            padding: 0.4rem 0.5rem;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            font-size: 0.75rem;
            background-color: var(--background-light);
            color: var(--text-main);
            text-align: center;
            letter-spacing: 0.05em;
            font-family: monospace;
        }
        
        .referral-input-group input:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
        }
        
        .add-referral-button {
            background: linear-gradient(45deg, #10b981, #059669);
            color: white;
            border: none;
            padding: 0.4rem 0.75rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.2rem;
            transition: all 0.2s ease;
            min-width: fit-content;
        }
        
        .add-referral-button:hover {
            background: linear-gradient(45deg, #059669, #047857);
            transform: translateY(-1px);
        }
        
        .add-referral-button:disabled {
            background: var(--text-secondary);
            cursor: not-allowed;
            transform: none;
        }
        
        .referral-status {
            margin-top: 0.5rem;
            padding: 0.4rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
            display: none;
            line-height: 1.2;
        }
        
        .referral-status.success {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid #10b981;
            color: #059669;
            display: block;
        }
        
        .referral-status.error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid #ef4444;
            color: #dc2626;
            display: block;
        }
        
        .instructions-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .instruction-item {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1rem;
            background: var(--background-light);
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
        }
        
        .instruction-item.highlight {
            background: rgba(139, 92, 246, 0.1);
            border-left-color: var(--primary-color);
        }
        
        .step-number {
            background: var(--primary-color);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
            flex-shrink: 0;
        }
        
        .instruction-item p {
            margin: 0;
            color: var(--text-main);
            line-height: 1.6;
        }
        
        /* Leaderboard Section */
        .leaderboard-section {
            margin-bottom: 2rem;
        }
        
        .leaderboard-section h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-main);
            margin-bottom: 1.5rem;
        }
        
        .leaderboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
        }
        
        .leaderboard-card {
            background: var(--background-white);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            border: 1px solid var(--border-color);
            position: relative;
        }
        
        .leaderboard-card.first-place {
            border-color: #fbbf24;
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.05), rgba(251, 191, 36, 0.1));
        }
        
        .leaderboard-card.second-place {
            border-color: #9ca3af;
            background: linear-gradient(135deg, rgba(156, 163, 175, 0.05), rgba(156, 163, 175, 0.1));
        }
        
        .leaderboard-card.third-place {
            border-color: #cd7f32;
            background: linear-gradient(135deg, rgba(205, 127, 50, 0.05), rgba(205, 127, 50, 0.1));
        }
        
        .rank-badge {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary-color);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 700;
        }
        
        .leaderboard-card.first-place .rank-badge {
            background: #fbbf24;
            color: #1f2937;
        }
        
        .leaderboard-card.second-place .rank-badge {
            background: #9ca3af;
        }
        
        .leaderboard-card.third-place .rank-badge {
            background: #cd7f32;
        }
        
        .avatar {
            font-size: 2rem;
            margin: 0.5rem 0;
        }
        
        .leaderboard-card h4 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-main);
            margin: 0.5rem 0;
        }
        
        .referrals-count {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin: 0;
        }
        
        /* Referral Stats */
        .referral-stats h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-main);
            margin-bottom: 1.5rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
        }
        
        .stat-card {
            background: var(--background-white);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            border: 1px solid var(--border-color);
            position: relative;
        }
        
        .stat-icon {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }
        
        .stat-number {
            font-size: 1.75rem;
            font-weight: 800;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            .referral-code-section {
                flex-direction: column;
                gap: 2rem;
            }
            
            .leaderboard-grid,
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .milestones-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .main-content {
            margin-left: 260px;
            flex-grow: 1;
            padding: 2rem;
            width: calc(100% - 260px);
        }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .container { max-width: 1400px; margin: 0 auto; }
        header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 3rem; padding-bottom: 2rem; border-bottom: 1px solid var(--border-color); gap: 2rem; }
        .header-text { flex-grow: 1; }
        .header-actions { display: flex; align-items: flex-start; gap: 1.5rem; flex-shrink: 0; }
        .header-text h1 { font-size: 2.25rem; font-weight: 800; margin-bottom: 0.25rem; }
        .header-text p { font-size: 1rem; color: var(--text-secondary); max-width: 650px; margin: 0; }
        
        .button {
            background: var(--primary-color); color: white; padding: 0.75rem 1.25rem;
            border-radius: 8px; border: 1px solid transparent; font-weight: 600; cursor: pointer;
            box-shadow: var(--shadow-sm); transition: all 0.2s ease; display: inline-flex;
            align-items: center; gap: 0.5rem; font-size: 1rem; text-decoration: none;
        }
        .button:hover { background: var(--primary-hover); transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .button-secondary {
            background-color: var(--background-white);
            color: var(--text-main);
            border-color: var(--border-color);
        }
        .button-secondary:hover {
            background-color: var(--background-light);
        }
        .button-danger { background-color: var(--danger-color); color: white; border-color: transparent; }
        html[data-theme="light"] .button-danger { background-color: #fee2e2; color: var(--danger-color); border-color: #fecaca; }
        .button-danger:hover { background-color: var(--danger-hover); border-color: var(--danger-hover); color: white; transform: translateY(-2px); box-shadow: var(--shadow-md); }

        .pro-badge {
            background: linear-gradient(to right, #facc15, #fb923c);
            color: #422006;
            padding: 0.5rem 1rem;
            border-radius: 99px;
            font-weight: 700;
            font-size: 0.9rem;
        }

        .hub-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 2rem; }
        .hub-card {
            background-color: var(--background-white); border-radius: 16px; border: 1px solid var(--border-color);
            box-shadow: var(--shadow-md); transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: flex; flex-direction: column; overflow: hidden;
        }
        .hub-card:hover { transform: translateY(-8px); box-shadow: var(--shadow-lg); }
        .card-header { height: 90px; position: relative; display: flex; padding: 1rem 1.5rem; align-items: flex-end; }
        .card-header h2 { font-size: 1.5rem; font-weight: 700; margin: 0; color: rgba(0, 0, 0, 0.7); }
        html[data-theme="dark"] .card-header h2 { color: rgba(255, 255, 255, 0.85); }
        .delete-btn {
            position: absolute; top: 1rem; right: 1rem; background-color: rgba(0,0,0,0.08); color: rgba(0,0,0,0.6);
            border: none; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center;
            justify-content: center; cursor: pointer; transition: all 0.2s ease; z-index: 10;
        }
        html[data-theme="dark"] .delete-btn { background-color: rgba(255,255,255,0.1); color: rgba(255,255,255,0.7); }
        .delete-btn:hover { background-color: var(--danger-color); color: white; transform: scale(1.1); }
        .hub-card-link { text-decoration: none; color: inherit; display: flex; flex-direction: column; flex-grow: 1; padding: 1.5rem; }
        .hub-card-body { flex-grow: 1; display: flex; align-items: center; justify-content: center; min-height: 80px; }
        .empty-state { text-align: center; padding: 1rem 0; color: var(--text-secondary); }
        .empty-state svg { width: 40px; height: 40px; margin-bottom: 0.5rem; }
        .empty-state p { margin: 0; font-weight: 500; font-size: 0.9rem; }
        .hub-stats { display: flex; justify-content: space-around; gap: 1.5rem; text-align: center; width: 100%; }
        .stat { display: flex; flex-direction: column; align-items: center; gap: 0.25rem; }
        .stat-value { font-weight: 700; font-size: 1.5rem; color: var(--text-main); }
        .stat-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-light); }
        
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(16, 24, 40, 0.6);
            backdrop-filter: blur(8px); display: none; justify-content: center; align-items: center;
            z-index: 1000; opacity: 0; transition: opacity 0.3s ease;
        }
        .modal-overlay.visible { display: flex; opacity: 1; }
        .modal-content {
            background: var(--background-white); padding: 2rem; border-radius: 12px;
            width: 100%; max-width: 450px; box-shadow: var(--shadow-lg); transform: scale(0.95); transition: transform 0.3s ease;
            position: relative;
            z-index: 1001;
        }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .modal-header h3 { font-size: 1.25rem; margin: 0; }
        
        /* Custom Modal Styles (separate from existing modals) */
        .custom-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(17, 24, 39, 0.8); backdrop-filter: blur(8px); 
            display: none; justify-content: center; align-items: center; z-index: 2000;
        }
        .custom-modal-content {
            background: var(--background-card); padding: 2rem; border-radius: 12px; 
            width: 90%; max-width: 400px; box-shadow: var(--shadow-lg);
        }
        .custom-modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; margin-bottom: 1.5rem; }
        .custom-modal-header h3 { margin: 0; font-family: 'Poppins', sans-serif; }
        .custom-modal-body { overflow-y: auto; padding-right: 1rem; }
        .custom-modal-footer { display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem; }
        .close-button { background: none; border: none; cursor: pointer; color: var(--text-secondary); padding: 0.5rem; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; font-weight: 500; font-size: 0.9rem; margin-bottom: 0.5rem; }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%; 
            padding: 0.75rem 1rem; 
            border-radius: 8px; 
            border: 1px solid var(--border-color);
            font-size: 1rem; 
            box-sizing: border-box; 
            background-color: var(--background-light); 
            color: var(--text-main);
            transition: border-color 0.2s ease;
        }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .form-group textarea { min-height: 80px; }
        .modal-content .button { width: 100%; justify-content: center; }
        
        /* --- UPDATED: Side Panel Footer Styles --- */
        .side-panel-footer {
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .side-panel-footer .button {
            padding: 0.6rem 0.5rem;
            font-size: 0.9rem;
            flex-grow: 1;
            justify-content: center;
        }
        
        /* Earn Money Banner */
        .earn-money-banner {
            margin: 1rem 0;
            background: linear-gradient(135deg, #fbbf24, #f59e0b, #d97706);
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 4px 12px rgba(251, 191, 36, 0.3);
            border: 1px solid rgba(251, 191, 36, 0.2);
            position: relative;
            overflow: hidden;
        }
        
        .earn-money-banner::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 50%, rgba(255, 255, 255, 0.1) 100%);
            pointer-events: none;
        }
        
        .banner-content {
            position: relative;
            z-index: 1;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .banner-text {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .banner-title {
            font-size: 1rem;
            font-weight: 700;
            color: #1f2937;
            line-height: 1.2;
        }
        
        .banner-subtitle {
            font-size: 0.8rem;
            color: #374151;
            font-weight: 500;
            opacity: 0.9;
        }
        
        .banner-button {
            background: rgba(31, 41, 55, 0.9);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0.6rem 1rem;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .banner-button:hover {
            background: rgba(31, 41, 55, 1);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        .banner-button:active {
            transform: translateY(0);
        }
        
        .banner-arrow {
            width: 18px;
            height: 18px;
            transition: transform 0.2s ease;
        }
        
        .banner-button:hover .banner-arrow {
            transform: translateX(2px);
        }

        .theme-switch {
            position: relative;
            display: inline-block;
            width: 64px;
            height: 34px;
            cursor: pointer;
            flex-shrink: 0;
        }
        .theme-switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #374151;
            border-radius: 34px;
            transition: .4s;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            border-radius: 50%;
            transition: .4s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .slider .icon-wrapper {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 26px;
            color: #111827;
            transition: opacity 0.2s ease-in-out;
            z-index: 10;
        }
        .slider .sun { left: 4px; opacity: 1; }
        .slider .moon { right: 4px; opacity: 0; color: white; }

        input:checked + .slider {
            background-color: white;
            border: 1px solid var(--border-color);
        }
        input:checked + .slider:before {
            transform: translateX(30px);
            background-color: #111827;
        }
        input:checked + .slider .sun { opacity: 0; }
        input:checked + .slider .moon { opacity: 1; }
        
        .progress-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }
        .stat-card {
            color: white;
            padding: 2rem;
            border-radius: 16px;
            position: relative;
            overflow: hidden;
        }
        .stat-card h3 {
            margin: 0 0 0.5rem 0;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.8;
        }
        .stat-card .value {
            font-size: 3.5rem;
            font-weight: 800;
        }
        .stat-card .value span {
            font-size: 1.5rem;
            opacity: 0.7;
            margin-left: 0.5rem;
        }
        .time-card { background: linear-gradient(135deg, #22c55e, #10b981); }
        .streak-card { background: linear-gradient(135deg, #f59e0b, #ef4444); }

        .chart-container, .review-container {
            background-color: var(--background-white);
            padding: 2rem;
            border-radius: 16px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
        }
        .chart-container h2, .review-container h2 {
            margin-top: 0;
            font-size: 1.5rem;
            font-weight: 700;
        }
        .review-list .review-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border-color);
        }
        .review-list .review-item:last-child {
            border-bottom: none;
        }
        .topic-details { display: flex; flex-direction: column; }
        .topic-name { font-weight: 600; font-size: 1.1rem; }
        .hub-name { font-size: 0.9rem; color: var(--text-secondary); }
        .topic-score { font-weight: 700; font-size: 1.25rem; }
        .score-low { color: var(--danger-color); }
        .score-mid { color: #f59e0b; }

        /* Spaced Repetition Styles */
        .spaced-repetition-section {
            background-color: var(--background-white);
            padding: 2rem;
            border-radius: 16px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
        }
        
        .section-header {
            margin-bottom: 2rem;
        }
        
        .section-header h2 {
            margin: 0 0 0.5rem 0;
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-main);
        }
        
        .section-header p {
            margin: 0;
            color: var(--text-secondary);
            font-size: 1rem;
        }
        
        .spaced-repetition-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        
        .sr-card {
            background: var(--background-white);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: all 0.2s ease;
        }
        
        .sr-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        .sr-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }
        
        .sr-card-header h3 {
            margin: 0;
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-main);
        }
        
        .sr-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .sr-badge.urgent {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }
        
        .sr-badge.moderate {
            background: #fef3c7;
            color: #d97706;
            border: 1px solid #fed7aa;
        }
        
        .sr-badge.low {
            background: #f0fdf4;
            color: #16a34a;
            border: 1px solid #bbf7d0;
        }
        
        .sr-card-content p {
            margin: 0 0 1rem 0;
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.5;
        }
        
        .sr-action-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
        }
        
        .sr-action-btn:hover {
            background: #3730a3;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }
        
        .sr-action-btn.secondary {
            background: var(--background-white);
            color: var(--text-main);
            border: 1px solid var(--border-color);
        }
        
        .sr-action-btn.secondary:hover {
            background: var(--background-light);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .progress-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }
        
        .progress-stat {
            text-align: center;
            padding: 1rem;
            background: var(--background-light);
            border-radius: 8px;
        }
        
        .progress-stat .stat-label {
            display: block;
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .progress-stat .stat-value {
            display: block;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .recent-sessions {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .session-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .session-item:last-child {
            border-bottom: none;
        }
        
        .session-info {
            display: flex;
            flex-direction: column;
        }
        
        .session-date {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        .session-stats {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-main);
        }
        
        .session-accuracy {
            font-size: 0.8rem;
            font-weight: 600;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
        }
        
        .session-accuracy.high {
            background: #f0fdf4;
            color: #16a34a;
        }
        
        .session-accuracy.medium {
            background: #fef3c7;
            color: #d97706;
        }
        
        .session-accuracy.low {
            background: #fef2f2;
            color: #dc2626;
        }
        
        .no-sessions {
            text-align: center;
            color: var(--text-secondary);
            font-style: italic;
            padding: 2rem 0;
        }

        .settings-container {
            max-width: 800px;
            margin: 0 auto;
        }
        .settings-card {
            background-color: var(--background-white);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            margin-bottom: 2rem;
            overflow: hidden;
        }
        .settings-card-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }
        .settings-card-header h2 {
            font-size: 1.25rem;
            margin: 0;
            font-weight: 600;
        }
        .settings-card-header p {
            margin: 0.25rem 0 0 0;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        .settings-card-body {
            padding: 1.5rem;
        }
        .settings-card-footer {
            padding: 1rem 1.5rem;
            background-color: var(--background-light);
            border-top: 1px solid var(--border-color);
            text-align: right;
        }
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border-color);
        }
        .setting-item:last-child {
            border-bottom: none;
        }
        .setting-item-content {
            flex-grow: 1;
        }
        .setting-item-content h3 {
            font-size: 1rem;
            font-weight: 500;
            margin: 0;
        }
        .setting-item-content p {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin: 0.25rem 0 0 0;
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }
        .toggle-switch input { display: none; }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--border-color);
            transition: .4s;
            border-radius: 28px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .toggle-slider {
            background-color: var(--primary-color);
        }
        input:checked + .toggle-slider:before {
            transform: translateX(22px);
        }

        /* Background Image Selection Styles */
        .background-image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
            width: 100%;
        }
        .background-image-option {
            cursor: pointer;
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        .background-image-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        .background-image-option.selected {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        .background-image-preview {
            height: 80px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            overflow: hidden;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        .background-image-name {
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
            z-index: 2;
            background: rgba(0, 0, 0, 0.3);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
        }
        .background-image-label {
            padding: 0.5rem;
            text-align: center;
            font-size: 0.8rem;
            color: var(--text-secondary);
            background-color: var(--background-white);
        }
        
        /* Default background preview */
        .default-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        /* Clean sidebar styling */
        .side-panel {
            background-color: var(--background-dark) !important;
            background-image: none !important;
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        body:not([data-background="default"]) .hub-card:hover,
        body:not([data-background="default"]) .content-card:hover,
        body:not([data-background="default"]) .community-card:hover {
            transform: translateY(-2px);
        }
        
        /* Make all sidebar tabs visible when background theme is applied */
        body:not([data-background="default"]) .side-panel .nav-tab {
            background-color: rgba(255, 255, 255, 0.1) !important;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }
        
        body:not([data-background="default"]) .side-panel .nav-tab:hover {
            background-color: rgba(255, 255, 255, 0.2) !important;
            transform: translateY(-1px);
        }
        
        body:not([data-background="default"]) .side-panel .nav-tab.active {
            background-color: rgba(255, 255, 255, 0.25) !important;
            border-color: rgba(255, 255, 255, 0.4);
        }
        
        /* --- NEW/UPDATED Community Styles --- */
        .community-toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1.5rem;
            align-items: center;
        }
        .search-bar { flex-grow: 1; position: relative; min-width: 250px; }
        .search-bar input {
            width: 100%; padding: 0.75rem 1rem 0.75rem 2.5rem; border-radius: 8px;
            border: 1px solid var(--border-color); background-color: var(--background-white);
            color: var(--text-main); box-sizing: border-box; font-size: 1rem;
        }
        .search-bar i { position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); color: var(--text-light); }
        .filter-tabs { display: flex; gap: 0.5rem; }
        .filter-tab {
            padding: 0.5rem 1rem; border-radius: 8px; font-weight: 600; cursor: pointer;
            border: 1px solid var(--border-color); background-color: var(--background-white);
            transition: all 0.2s ease;
        }
        .filter-tab:hover { background-color: var(--background-light); }
        /* --- UPDATED: Color coded filter tabs --- */
        .filter-tab.active[data-filter="all"] { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        .filter-tab.active[data-filter="Notes"] { background-color: var(--color-notes); color: white; border-color: var(--color-notes); }
        .filter-tab.active[data-filter="Quiz"] { background-color: var(--color-quiz); color: white; border-color: var(--color-quiz); }
        .filter-tab.active[data-filter="Flashcards"] { background-color: var(--color-flashcards); color: white; border-color: var(--color-flashcards); }
        .filter-tab.active[data-filter="Pack"] { background-color: var(--color-pack); color: white; border-color: var(--color-pack); }

        .sort-filter select {
            padding: 0.65rem 1rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: var(--background-white);
            color: var(--text-main);
            font-weight: 600;
            cursor: pointer;
            font-size: 0.9rem;
        }

        /* --- UPDATED Community Grid & Cards --- */
        .community-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 2rem; /* Increased spacing */
        }
        .community-card {
            background-color: var(--background-white);
            border-radius: 16px;
            border: 1px solid var(--border-color);
            border-top-width: 4px; /* Make space for color accent */
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-sm);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative; /* For positioning badges */
        }
        /* --- NEW: Add color accent based on type --- */
        .community-card.card-style-notes { border-top-color: var(--color-notes); }
        .community-card.card-style-quiz { border-top-color: var(--color-quiz); }
        .community-card.card-style-flashcards { border-top-color: var(--color-flashcards); }
        .community-card.card-style-pack { border-top-color: var(--color-pack); }
        
        .community-card:hover {
            transform: translateY(-10px); /* Enhanced hover effect */
            box-shadow: var(--shadow-lg);
        }
        
        .community-card-body {
            padding: 1.5rem; 
            flex-grow: 1;
        }

        /* --- UPDATED: Community Card Header --- */
        .community-card-header { 
            display: flex; 
            align-items: center; 
            justify-content: space-between;
            gap: 1rem;
            padding: 1.25rem 1.5rem; 
            border-bottom: 1px solid var(--border-color); 
        }
        .header-user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            min-width: 0; /* Prevents text overflow issues */
        }
        .community-card-header img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; flex-shrink: 0; }
        .user-info { flex-grow: 1; }
        .user-info h3 { margin: 0; font-size: 1.1rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .user-info p { margin: 0; font-size: 0.85rem; color: var(--text-secondary); }
        .header-actions {
            display: flex;
            gap: 0.5rem;
            flex-shrink: 0;
        }
        .header-actions .button, .header-actions .button-secondary {
            padding: 0.6rem;
            line-height: 1;
        }
        .header-actions .button i, .header-actions .button-secondary i {
            margin: 0;
        }
        
        /* --- NEW: Popular Badge --- */
        .popular-badge {
            background: linear-gradient(to right, #f97316, #f59e0b);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 99px;
            font-weight: 700;
            font-size: 0.75rem;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }

        /* --- NEW: Resource Type Badge --- */
        .card-type-badge {
            position: absolute;
            top: -14px;
            left: 1.5rem;
            padding: 0.3rem 0.8rem;
            font-weight: 600;
            font-size: 0.8rem;
            border-radius: 8px;
            color: white;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }
        .card-type-badge.badge-notes { background-color: var(--color-notes); }
        .card-type-badge.badge-quiz { background-color: var(--color-quiz); }
        .card-type-badge.badge-flashcards { background-color: var(--color-flashcards); }
        .card-type-badge.badge-pack { background-color: var(--color-pack); }

        .community-card-body h2 { margin: 0; font-size: 1.25rem; }
        .community-card-body p { margin: 0.5rem 0 1rem 0; color: var(--text-secondary); font-size: 0.9rem; }
        .tag-list { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .tag {
            font-size: 0.75rem; font-weight: 600; padding: 0.25rem 0.75rem; border-radius: 99px;
            background-color: var(--background-light); border: 1px solid var(--border-color);
        }

        .community-card-footer {
            display: flex; justify-content: space-between; align-items: center;
            border-top: 1px solid var(--border-color); padding: 1rem 1.5rem;
        }
        
        /* --- UPDATED: Stat Pills & NEW Like Button --- */
        .card-stats-pills {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        .stat-pill {
            display: flex;
            align-items: center;
            justify-content: center; /* Center content */
            gap: 0.35rem;
            font-weight: 600;
            font-size: 0.85rem;
            background-color: var(--background-light);
            border: 1px solid var(--border-color);
            padding: 0.4rem 0.8rem;
            border-radius: 99px;
            color: var(--text-secondary);
            min-width: 60px; /* Ensure pills have a consistent minimum width */
            box-sizing: border-box;
        }
        /* --- NEW: Like Button Styling --- */
        .like-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            display: inline-flex;
            align-items: center;
            font-size: 1rem;
            line-height: 1;
            transition: transform 0.2s ease, color 0.2s;
            color: var(--text-secondary);
        }
        .like-btn:hover:not(:disabled) { transform: scale(1.2); color: var(--text-main); }
        .like-btn:disabled { cursor: not-allowed; filter: grayscale(1); opacity: 0.6; }
        .like-btn.liked { 
            filter: none; 
            transform: scale(1.1); 
            color: #ef4444; /* red for liked */
        }
        .like-btn.liked:hover { transform: scale(1.25); }
        
        .section-header { margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color); }
        .section-header h2 { font-size: 1.75rem; font-weight: 700; margin: 0; }
        .section-header p { color: var(--text-secondary); margin: 0.25rem 0 0 0; }
        
        .community-empty-state {
            grid-column: 1 / -1; text-align: center; padding: 4rem 2rem;
            background-color: var(--background-white); border: 2px dashed var(--border-color); border-radius: 16px;
        }
        .community-empty-state i { color: var(--primary-color); margin-bottom: 1.5rem; }
        .community-empty-state h2 { font-size: 1.5rem; margin: 0 0 0.5rem 0; }
        .community-empty-state p { color: var(--text-secondary); max-width: 450px; margin: 0 auto 1.5rem auto; }

        .upgrade-prompt {
            text-align: center; padding: 4rem 2rem; background-color: var(--background-white);
            border-radius: 16px; border: 1px solid var(--border-color);
        }
        .upgrade-prompt i { color: var(--primary-color); margin-bottom: 1rem; }
        .upgrade-prompt h2 { font-size: 1.75rem; margin: 0 0 0.5rem 0; }
        .upgrade-prompt p { color: var(--text-secondary); max-width: 500px; margin: 0 auto 1.5rem auto; }

        /* Community Placeholder Styles */
        .community-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 400px;
            background: var(--background-white);
            border-radius: 16px;
            border: 2px dashed var(--border-color);
            margin-top: 2rem;
        }
        .placeholder-content {
            text-align: center;
            max-width: 400px;
            padding: 2rem;
        }
        .placeholder-content i {
            margin-bottom: 1.5rem;
        }
        .placeholder-content h2 {
            margin-bottom: 1rem;
            color: var(--text-main);
            font-size: 1.5rem;
        }
        .placeholder-content p {
            color: var(--text-secondary);
            line-height: 1.6;
        }

        /* Community Tabs Styles */
        .community-tabs {
            display: flex;
            gap: 0.5rem;
            margin: 2rem 0 1.5rem 0;
            border-bottom: 1px solid var(--border-color);
        }
        .community-tab {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
        }
        .community-tab:hover {
            color: var(--text-main);
            background-color: var(--background-light);
        }
        .community-tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            background-color: var(--background-light);
        }
        .community-tab i {
            width: 18px;
            height: 18px;
        }

        /* Community Tab Content */
        .community-tab-content {
            display: none;
        }
        .community-tab-content.active {
            display: block;
        }

        /* Study Groups Styles */
        .study-groups-container {
            background: var(--background-white);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
        }
        .study-groups-header {
            margin-bottom: 1.5rem;
        }
        .study-groups-header h3 {
            margin: 0 0 0.5rem 0;
            font-size: 1.25rem;
            color: var(--text-main);
        }
        .study-groups-header p {
            margin: 0;
            color: var(--text-secondary);
        }
        .study-groups-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
        }
        .study-group-card {
            background: var(--background-light);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.25rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .study-group-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: var(--primary-color);
        }
        .study-group-card h4 {
            margin: 0 0 0.5rem 0;
            color: var(--text-main);
            font-size: 1.1rem;
        }
        .study-group-card p {
            margin: 0 0 1rem 0;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        .study-group-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        .study-group-code {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            background: var(--primary-color);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
        }

        /* Study Group Modals */
        .success-content {
            text-align: center;
        }
        .study-group-code-display {
            margin: 1.5rem 0;
        }
        .study-group-code-display h3 {
            margin: 0 0 1rem 0;
            color: var(--text-main);
        }
        .code-box {
            font-family: 'Courier New', monospace;
            font-size: 2rem;
            font-weight: bold;
            background: var(--primary-color);
            color: white;
            padding: 1rem 2rem;
            border-radius: 8px;
            margin: 1rem 0;
            display: inline-block;
            letter-spacing: 0.2em;
        }
        .study-group-code-display p {
            color: var(--text-secondary);
            margin: 0;
        }

        /* Global Resources Styles */
        .global-resources-container {
            background: var(--background-white);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
        }
        .global-resources-header {
            margin-bottom: 1.5rem;
        }
        .global-resources-header h3 {
            margin: 0 0 0.5rem 0;
            font-size: 1.25rem;
            color: var(--text-main);
        }
        .global-resources-header p {
            margin: 0;
            color: var(--text-secondary);
        }
        .global-resources-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
        }
        .global-resource-card {
            background: var(--background-light);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.25rem;
            transition: all 0.3s ease;
        }
        .global-resource-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: var(--primary-color);
        }
        .global-resource-card h4 {
            margin: 0 0 0.5rem 0;
            color: var(--text-main);
            font-size: 1.1rem;
        }
        .global-resource-card p {
            margin: 0 0 1rem 0;
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.4;
        }
        .resource-author {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        .author-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--border-color);
        }
        .author-info {
            display: flex;
            flex-direction: column;
        }
        .author-name {
            font-weight: 500;
            color: var(--text-main);
            font-size: 0.9rem;
        }
        .author-time {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        .resource-preview {
            background: var(--background-body);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 1rem;
            max-height: 200px;
            overflow-y: auto;
            display: none; /* Collapsed by default */
        }
        .preview-title {
            font-weight: 600;
            color: var(--text-main);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        .preview-items {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .preview-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        .preview-item-icon {
            width: 16px;
            height: 16px;
            opacity: 0.7;
        }
        .resource-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        .preview-btn {
            background: var(--background-interactive);
            color: var(--text-main);
            border: 1px solid var(--border-color);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .preview-btn:hover {
            background: var(--background-interactive-hover);
            border-color: var(--primary-color);
        }
        .delete-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 0.5rem;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .delete-btn:hover {
            background: #dc2626;
            transform: translateY(-1px);
        }
        .global-resource-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        .global-resource-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        .global-resource-tag {
            background: var(--primary-color);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
        }
        .global-resource-actions {
            display: flex;
            gap: 0.5rem;
        }
        .import-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .import-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }
        .like-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .like-btn:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }
        .like-btn.liked {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* Import Resource Modal Styles */
        .import-resource-info {
            background: var(--background-light);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
        .import-resource-info h3 {
            margin: 0 0 0.5rem 0;
            color: var(--text-main);
            font-size: 1.1rem;
        }
        .import-resource-info p {
            margin: 0;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Radio Button Styles */
        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .radio-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 1rem;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .radio-label:hover {
            border-color: #6c757d;
            background-color: #f8f9fa;
        }

        .radio-label input[type="radio"] {
            display: none;
        }

        .radio-custom {
            width: 20px;
            height: 20px;
            border: 2px solid #6c757d;
            border-radius: 50%;
            margin-right: 1rem;
            position: relative;
            transition: all 0.2s ease;
        }

        .radio-label input[type="radio"]:checked + .radio-custom {
            border-color: #007bff;
            background-color: #007bff;
        }

        .radio-label input[type="radio"]:checked + .radio-custom::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 8px;
            height: 8px;
            background-color: white;
            border-radius: 50%;
        }

        .radio-content {
            flex: 1;
        }

        .radio-content strong {
            display: block;
            color: #495057;
            margin-bottom: 0.25rem;
        }

        .radio-content small {
            color: #6c757d;
            font-size: 0.875rem;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
        }

        /* --- Profile Tab Styles --- */
        .profile-content-card {
            background-color: var(--background-white);
            padding: 2.5rem;
            border-radius: 16px;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--border-color);
            margin-bottom: 2rem;
        }
        .profile-grid {
            display: grid;
            grid-template-columns: 150px 1fr;
            gap: 2.5rem;
            align-items: center;
        }
        .avatar-upload-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .avatar-preview {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 1rem;
            border: 4px solid var(--background-light);
            box-shadow: var(--card-shadow);
        }
        .button-style-label {
            background: var(--primary-color); color: white; padding: 0.7rem 1.2rem;
            border-radius: 8px; border: none; font-weight: 600; cursor: pointer;
            transition: all 0.2s ease; display: inline-flex;
            align-items: center; justify-content: center; gap: 0.5rem; font-size: 0.9rem;
            width: 100%; box-sizing: border-box;
        }
        .button-style-label:hover { background: var(--primary-hover); }
        .avatar-upload-section input[type="file"] { display: none; }
        
        .form-actions { text-align: right; margin-top: 1rem; }

        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; text-align: center; }
        .stat-item .value { font-size: 2.5rem; font-weight: 700; color: var(--primary-color); }
        .stat-item .label { font-size: 0.9rem; color: var(--text-secondary); }

        .courses-list .course-item {
             display: flex; justify-content: space-between; align-items: center;
             padding: 1rem; border-radius: 8px; margin-bottom: 0.5rem;
             background-color: var(--background-light);
        }
        .course-item span { font-weight: 600; }
        
        .flash-message { padding: 1rem; border-radius: 8px; margin-bottom: 1rem; font-weight: 500; }
        .flash-success { background-color: #dcfce7; color: #166534; }

        /* Universal Notification Modal Styles */
        .universal-notification-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .universal-notification-modal.visible {
            opacity: 1;
        }
        
        .universal-notification-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            max-width: 400px;
            width: 90%;
            transform: scale(0.9);
            transition: transform 0.3s ease;
            overflow: hidden;
        }
        
        .universal-notification-modal.visible .universal-notification-content {
            transform: scale(1);
        }
        
        .universal-notification-header {
            display: flex;
            align-items: center;
            padding: 1.5rem 1.5rem 1rem 1.5rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .universal-notification-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
            flex-shrink: 0;
        }
        
        .universal-notification-content.success .universal-notification-icon {
            background-color: #dcfce7;
            color: #166534;
        }
        
        .universal-notification-content.error .universal-notification-icon {
            background-color: #fee2e2;
            color: #dc2626;
        }
        
        .universal-notification-content.warning .universal-notification-icon {
            background-color: #fef3c7;
            color: #d97706;
        }
        
        .universal-notification-content.info .universal-notification-icon {
            background-color: #dbeafe;
            color: #2563eb;
        }
        
        .universal-notification-content.confirm .universal-notification-icon {
            background-color: #f3e8ff;
            color: #7c3aed;
        }
        
        .universal-notification-title {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
            flex-grow: 1;
        }
        
        .universal-notification-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #6b7280;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
            transition: color 0.2s, background-color 0.2s;
        }
        
        .universal-notification-close:hover {
            color: #374151;
            background-color: #f3f4f6;
        }
        
        .universal-notification-body {
            padding: 0 1.5rem 1rem 1.5rem;
        }
        
        .universal-notification-body p {
            margin: 0;
            color: #4b5563;
            line-height: 1.5;
        }
        
        .universal-notification-footer {
            padding: 1rem 1.5rem 1.5rem 1.5rem;
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
        }
        
        .universal-notification-footer .button {
            min-width: 80px;
        }

        /* --- ENHANCED SPOTIFY PLAYER CSS - PHASE 1 --- */
        #spotify-player-container {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 420px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3), 0 0 0 1px rgba(255, 255, 255, 0.1);
            padding: 1.5rem;
            z-index: 1001;
            transform: translateY(calc(100% + 2rem)) scale(0.95);
            transition: all 0.5s cubic-bezier(0.16, 1, 0.3, 1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        #spotify-player-container.visible {
            transform: translateY(0) scale(1);
        }
        
        /* Mini player mode */
        #spotify-player-container.mini {
            width: 300px;
            padding: 1rem;
            transform: translateY(calc(100% + 2rem)) scale(0.9);
        }
        #spotify-player-container.mini.visible {
            transform: translateY(0) scale(1);
        }
        
        /* Player state animations */
        #spotify-player-container.playing {
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3), 0 0 0 1px rgba(255, 255, 255, 0.1), 0 0 30px rgba(102, 126, 234, 0.3);
        }
        
        .sp-track-info { 
            display: flex; 
            align-items: center; 
            gap: 1rem; 
            margin-bottom: 1.5rem; 
            position: relative;
        }
        
        .sp-album-art { 
            width: 80px; 
            height: 80px; 
            border-radius: 16px; 
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4), 0 0 0 3px rgba(255, 255, 255, 0.1);
            object-fit: cover;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .sp-album-art::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.1) 50%, transparent 70%);
            transform: translateX(-100%);
            transition: transform 0.6s ease;
        }
        
        .sp-album-art.playing::before {
            transform: translateX(100%);
        }
        
        .sp-album-art:hover {
            transform: scale(1.05);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.5), 0 0 0 3px rgba(255, 255, 255, 0.2);
        }
        
        .sp-track-details { 
            flex-grow: 1; 
            min-width: 0; 
            color: white;
            animation: slideInFromRight 0.5s ease-out;
        }
        
        @keyframes slideInFromRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .sp-track-title { 
            font-weight: 700; 
            font-size: 1.1rem;
            margin: 0; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            color: white;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
            letter-spacing: 0.02em;
        }
        
        .sp-track-artist { 
            font-size: 0.95rem; 
            color: rgba(255, 255, 255, 0.85); 
            margin: 0.3rem 0 0; 
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
            font-weight: 500;
        }
        
        .sp-progress-bar { 
            width: 100%; 
            height: 8px; 
            background: rgba(255, 255, 255, 0.2); 
            border-radius: 4px; 
            cursor: pointer; 
            margin-bottom: 1.5rem;
            position: relative;
            overflow: hidden;
        }
        
        .sp-progress-bar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .sp-progress { 
            height: 100%; 
            width: 0%; 
            background: linear-gradient(90deg, #ffffff, #f0f0f0); 
            border-radius: 4px; 
            transition: width 0.2s ease;
            position: relative;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
        }
        
        .sp-controls { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 1.5rem;
        }
        
        .sp-main-controls { 
            display: flex; 
            align-items: center; 
            gap: 1rem; 
        }
        
        .sp-main-controls button { 
            background: rgba(255, 255, 255, 0.15); 
            border: none; 
            cursor: pointer; 
            color: white; 
            padding: 0.6rem; 
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }
        
        .sp-main-controls button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transform: translateX(-100%);
            transition: transform 0.6s ease;
        }
        
        .sp-main-controls button:hover::before {
            transform: translateX(100%);
        }
        
        .sp-main-controls button:hover { 
            background: rgba(255, 255, 255, 0.25);
            transform: scale(1.1);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }
        
        .sp-main-controls button:active {
            transform: scale(0.95);
        }
        
        .sp-play-btn { 
            background: white !important; 
            color: #333 !important; 
            width: 56px !important;
            height: 56px !important;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4), 0 0 0 3px rgba(255, 255, 255, 0.2);
            border: none !important;
        }
        
        .sp-play-btn:hover { 
            background: #f8f9fa !important;
            transform: scale(1.1) !important;
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.5), 0 0 0 3px rgba(255, 255, 255, 0.3) !important;
        }
        
        .sp-volume-control { 
            display: flex; 
            align-items: center; 
            gap: 0.75rem; 
            color: white;
            background: rgba(255, 255, 255, 0.1);
            padding: 0.5rem 0.75rem;
            border-radius: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .sp-volume-control svg {
            color: rgba(255, 255, 255, 0.9);
            transition: color 0.3s ease;
        }
        
        .sp-volume-control:hover svg {
            color: white;
        }
        
        .sp-volume-control input[type=range] { 
            width: 90px; 
            background: transparent;
            -webkit-appearance: none;
            appearance: none;
            height: 4px;
            border-radius: 2px;
            background: rgba(255, 255, 255, 0.3);
            outline: none;
        }
        
        .sp-volume-control input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }
        
        .sp-volume-control input[type=range]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }
        
        .sp-playlist-select { 
            margin-top: 1rem; 
            width: 100%; 
            padding: 1rem; 
            border-radius: 12px; 
            border: 1px solid rgba(255, 255, 255, 0.2); 
            background: rgba(255, 255, 255, 0.1); 
            color: white; 
            backdrop-filter: blur(10px);
            font-size: 0.95rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .sp-playlist-select:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.4);
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.1);
        }
        
        .sp-playlist-select option {
            background: #2a2a2a;
            color: white;
            padding: 0.5rem;
        }
        
        /* Study categories and mini-player styles */
        .sp-mini-toggle {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .sp-mini-toggle:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }
        
        .sp-study-categories {
            margin: 1rem 0;
        }
        
        .sp-category-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            background: rgba(255, 255, 255, 0.1);
            padding: 0.25rem;
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }
        
        .sp-category-tab {
            flex: 1;
            padding: 0.5rem 0.75rem;
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .sp-category-tab.active {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
        .sp-category-tab:hover:not(.active) {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.9);
        }
        
        .sp-shortcuts-hint {
            margin-top: 1rem;
            text-align: center;
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.8rem;
            font-style: italic;
        }
        
        /* Mini player specific styles */
        #spotify-player-container.mini .sp-study-categories,
        #spotify-player-container.mini .sp-shortcuts-hint {
            display: none;
        }
        
        #spotify-player-container.mini .sp-track-info {
            margin-bottom: 1rem;
        }
        
        #spotify-player-container.mini .sp-album-art {
            width: 60px;
            height: 60px;
        }
        
        /* Music Visualization Effects */
        .sp-visualization-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 20px;
            overflow: hidden;
            pointer-events: none;
            z-index: -1;
        }
        
        .sp-waveform {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(to top, rgba(0,0,0,0.3), transparent);
            display: flex;
            align-items: end;
            justify-content: space-around;
            padding: 0 1rem 1rem;
        }
        
        .sp-wave-bar {
            width: 3px;
            background: linear-gradient(to top, rgba(255,255,255,0.8), rgba(255,255,255,0.3));
            border-radius: 2px;
            transition: height 0.1s ease;
            animation: wavePulse 1.5s ease-in-out infinite;
        }
        
        .sp-wave-bar:nth-child(odd) {
            animation-delay: 0.1s;
        }
        
        .sp-wave-bar:nth-child(even) {
            animation-delay: 0.3s;
        }
        
        @keyframes wavePulse {
            0%, 100% { height: 8px; }
            50% { height: 24px; }
        }
        
        .sp-particles {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }
        
        .sp-particle {
            position: absolute;
            width: 2px;
            height: 2px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 50%;
            animation: floatUp 3s linear infinite;
        }
        
        @keyframes floatUp {
            0% {
                transform: translateY(100vh) scale(0);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-10vh) scale(1);
                opacity: 0;
            }
        }
        
        /* Advanced Audio Features */
        .sp-audio-controls {
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .sp-equalizer {
            display: flex;
            align-items: end;
            gap: 0.5rem;
            margin-bottom: 1rem;
            height: 60px;
        }
        
        .sp-eq-band {
            flex: 1;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            position: relative;
            height: 40px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .sp-eq-band:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .sp-eq-level {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, #667eea, #764ba2);
            border-radius: 2px;
            transition: height 0.3s ease;
        }
        
        .sp-audio-presets {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .sp-preset-btn {
            flex: 1;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }
        
        .sp-preset-btn.active {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.4);
        }
        
        .sp-preset-btn:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        /* AI Recommendations */
        .sp-recommendations {
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .sp-recommendations h4 {
            color: white;
            margin: 0 0 1rem 0;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .sp-recommendation-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 0.5rem;
        }
        
        .sp-recommendation-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .sp-rec-album-art {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            object-fit: cover;
        }
        
        .sp-rec-details {
            flex: 1;
            min-width: 0;
        }
        
        .sp-rec-title {
            color: white;
            font-size: 0.85rem;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .sp-rec-artist {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.75rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Spotify Search */
        .sp-search-container {
            margin-top: 1rem;
        }
        
        .sp-search-input {
            width: 100%;
            padding: 0.75rem;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            backdrop-filter: blur(10px);
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }
        
        .sp-search-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        
        .sp-search-input:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.4);
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.1);
        }
        
        .sp-search-results {
            max-height: 200px;
            overflow-y: auto;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
        }
        
        .sp-search-result {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .sp-search-result:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .sp-search-result:last-child {
            border-bottom: none;
        }
        
        .sp-search-album-art {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            object-fit: cover;
        }
        
        .sp-search-details {
            flex: 1;
            min-width: 0;
        }
        
        .sp-search-title {
            color: white;
            font-size: 0.9rem;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .sp-search-artist {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.8rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Dynamic background colors based on album art */
        .sp-player-bg-purple { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .sp-player-bg-blue { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .sp-player-bg-pink { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
        .sp-player-bg-green { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); }
        .sp-player-bg-orange { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); }
        .sp-player-bg-red { background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); }

        /* --- NEW: Styles for Preview Modals --- */
        #preview-modal .modal-content { max-width: 550px; }
        .preview-item-list {
            margin-top: 1.5rem;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.5rem;
            background-color: var(--background-light);
        }
        .preview-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .preview-item:hover {
            background-color: var(--border-color);
        }
        .preview-item:last-child { border-bottom: none; }
        .preview-item i { color: var(--text-secondary); }

        #item-preview-content {
            max-height: 60vh;
            overflow-y: auto;
            padding: 0.5rem;
        }
        #item-preview-content .note-content {
            white-space: pre-wrap;
            padding: 1rem;
            background-color: var(--background-light);
            border-radius: 8px;
            line-height: 1.6;
            font-size: 0.95rem;
        }
        #item-preview-content .flashcard-list .flashcard-item {
            background-color: var(--background-light);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        #item-preview-content .flashcard-list .flashcard-item .side {
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: var(--text-secondary);
            font-size: 0.8rem;
            text-transform: uppercase;
        }
        #item-preview-content .flashcard-list .flashcard-item hr {
            border: none;
            border-top: 1px dashed var(--border-color);
            margin: 0.75rem 0;
        }
        
        /* --- NEW: Comprehensive Onboarding Styles --- */
        
        /* Welcome Screen - Fullscreen Overlay */
        #onboarding-welcome-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 1001;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }
        #onboarding-welcome-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        #onboarding-welcome-content {
            text-align: center;
            color: white;
            max-width: 600px;
            padding: 2rem;
        }
        #onboarding-welcome-content h1 {
            font-size: 3.5rem;
            font-weight: 900;
            margin: 0 0 1rem 0;
            background: linear-gradient(45deg, #fff, #f0f9ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        #onboarding-welcome-content p {
            font-size: 1.3rem;
            margin: 0 0 2.5rem 0;
            opacity: 0.9;
            line-height: 1.6;
        }
        #onboarding-welcome-content .welcome-features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }
        .welcome-feature {
            background: rgba(255, 255, 255, 0.1);
            padding: 1.5rem;
            border-radius: 12px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .welcome-feature h3 {
            font-size: 1.1rem;
            margin: 0 0 0.5rem 0;
            font-weight: 600;
        }
        .welcome-feature p {
            font-size: 0.9rem;
            margin: 0;
            opacity: 0.8;
        }
        #onboarding-start-btn {
            background: linear-gradient(45deg, #ff6b6b, #ff8e8e);
            color: white;
            border: none;
            padding: 1rem 2.5rem;
            font-size: 1.2rem;
            font-weight: 600;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.3);
        }
        #onboarding-start-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(255, 107, 107, 0.4);
        }

        /* Personalization Modal */
        #onboarding-personalization-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 1002;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.4s ease;
        }
        #onboarding-personalization-modal.visible {
            opacity: 1;
            visibility: visible;
        }
        .personalization-slide {
            background: white;
            border-radius: 20px;
            padding: 3rem;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            transform: translateX(100px);
            opacity: 0;
            transition: all 0.4s ease;
        }
        .personalization-slide.active {
            transform: translateX(0);
            opacity: 1;
        }
        .personalization-slide h2 {
            font-size: 2rem;
            font-weight: 700;
            margin: 0 0 1rem 0;
            color: var(--text-main);
        }
        .personalization-slide p {
            color: var(--text-secondary);
            margin: 0 0 2rem 0;
            font-size: 1.1rem;
        }
        .personalization-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }
        .personalization-option {
            padding: 1rem;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }
        .personalization-option:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
        }
        .personalization-option.selected {
            border-color: var(--primary-color);
            background: var(--primary-color);
            color: white;
        }
        .personalization-option h4 {
            margin: 0 0 0.5rem 0;
            font-size: 1rem;
        }
        .personalization-option p {
            margin: 0;
            font-size: 0.9rem;
            opacity: 0.8;
        }
        .personalization-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 2rem;
        }
        .personalization-progress {
            display: flex;
            gap: 0.5rem;
        }
        .progress-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--border-color);
            transition: all 0.3s ease;
        }
        .progress-dot.active {
            background: var(--primary-color);
            transform: scale(1.2);
        }

        /* Dashboard Spotlight */
        #onboarding-spotlight-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(17, 24, 39, 0.8);
            backdrop-filter: blur(4px);
            z-index: 1003;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        #onboarding-spotlight-overlay.visible {
            opacity: 1;
        }
        #onboarding-tooltip {
            position: fixed;
            z-index: 1004;
            background-color: var(--background-white);
            color: var(--text-main);
            padding: 1.5rem 2rem;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            max-width: 350px;
            font-weight: 500;
            font-size: 1rem;
            line-height: 1.6;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease;
            pointer-events: auto; /* Allow interaction with the tooltip */
        }
        #onboarding-tooltip.visible {
            opacity: 1;
            transform: translateY(0);
        }
        #onboarding-tooltip::after {
            content: '';
            position: absolute;
            width: 0;
            height: 0;
            border-left: 12px solid transparent;
            border-right: 12px solid transparent;
            border-top: 12px solid var(--background-white);
            bottom: -12px;
            left: 50%;
            transform: translateX(-50%);
        }
        .onboarding-highlight {
            position: relative;
            z-index: 1004;
            pointer-events: auto !important;
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.5);
            border-radius: 8px;
            animation: onboarding-pulse 2s infinite;
            background-color: rgba(139, 92, 246, 0.1) !important;
        }
        
        .onboarding-highlight.nav-tab {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.3), rgba(124, 58, 237, 0.3)) !important;
            border: 3px solid rgba(139, 92, 246, 0.8) !important;
            transform: scale(1.08);
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.5) !important;
        }
        
        @keyframes onboarding-pulse {
            0%, 100% { 
                box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.3);
            }
            50% { 
                box-shadow: 0 0 0 8px rgba(79, 70, 229, 0.1);
            }
        }

        /* Celebration Modal */
        #onboarding-celebration-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 1005;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.6s ease;
        }
        #onboarding-celebration-modal.visible {
            opacity: 1;
            visibility: visible;
        }
        .celebration-content {
            text-align: center;
            color: white;
            max-width: 600px;
            padding: 2rem;
        }
        .celebration-content h1 {
            font-size: 3rem;
            font-weight: 900;
            margin: 0 0 1rem 0;
        }
        .celebration-content p {
            font-size: 1.2rem;
            margin: 0 0 2rem 0;
            opacity: 0.9;
        }
        .celebration-features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }
        .celebration-feature {
            background: rgba(255, 255, 255, 0.1);
            padding: 1.5rem;
            border-radius: 12px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .celebration-feature h3 {
            font-size: 1.1rem;
            margin: 0 0 0.5rem 0;
            font-weight: 600;
        }
        .celebration-feature p {
            font-size: 0.9rem;
            margin: 0;
            opacity: 0.8;
        }
        #onboarding-complete-btn {
            background: linear-gradient(45deg, #10b981, #34d399);
            color: white;
            border: none;
            padding: 1rem 2.5rem;
            font-size: 1.2rem;
            font-weight: 600;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
        }
        #onboarding-complete-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(16, 185, 129, 0.4);
        }

        /* Confetti Animation */
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: #ff6b6b;
            animation: confetti-fall 3s linear infinite;
            z-index: 1006;
        }
        @keyframes confetti-fall {
            0% {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        /* Success Modal Styles */
        .success-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(8px);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .success-modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .success-modal-content {
            background: var(--background-card);
            border-radius: 20px;
            padding: 2rem;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            transform: scale(0.8) translateY(20px);
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            max-width: 400px;
            width: 90%;
        }

        .success-modal-overlay.visible .success-modal-content {
            transform: scale(1) translateY(0);
        }

        .success-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            animation: successBounce 0.6s ease-out;
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-20px);
            }
            60% {
                transform: translateY(-10px);
            }
        }

        .success-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-main);
            margin-bottom: 0.5rem;
            animation: slideInUp 0.5s ease-out 0.2s both;
        }

        .success-message {
            color: var(--text-secondary);
            font-size: 1rem;
            margin-bottom: 1.5rem;
            animation: slideInUp 0.5s ease-out 0.3s both;
        }
        
        .pro-features-list {
            margin-bottom: 2rem;
            text-align: left;
        }
        
        .feature-item {
            font-size: 0.95rem;
            color: var(--text-main);
            margin-bottom: 0.75rem;
            padding-left: 0.5rem;
            font-weight: 500;
        }
        
        .feature-item:last-child {
            margin-bottom: 0;
        }

        .success-button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            animation: slideInUp 0.5s ease-out 0.4s both;
        }

        .success-button:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.3);
        }

        /* Animations */
        @keyframes successBounce {
            0% {
                transform: scale(0);
                opacity: 0;
            }
            50% {
                transform: scale(1.2);
                opacity: 1;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes slideInUp {
            0% {
                transform: translateY(20px);
                opacity: 0;
            }
            100% {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Pulse animation for the checkmark */
        .success-icon::before {
            content: "✅";
            display: inline-block;
            animation: pulse 1s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
        }
        
        /* Spaced Repetition Tab Styles */
        .sr-hero-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 16px;
            padding: 3rem;
            margin-bottom: 2rem;
            color: white;
        }
        
        .sr-hero-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 3rem;
            align-items: center;
        }
        
        .sr-hero-text h2 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            line-height: 1.2;
        }
        
        .sr-hero-text p {
            font-size: 1.125rem;
            opacity: 0.9;
            margin-bottom: 2rem;
            line-height: 1.6;
        }
        
        .sr-benefits {
            display: flex;
            gap: 2rem;
        }
        
        .sr-benefit {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
        }
        
        .sr-benefit-icon {
            font-size: 1.25rem;
        }
        
        .sr-visualization {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.75rem;
        }
        
        .sr-card {
            padding: 1rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            text-align: center;
            min-width: 120px;
            transition: all 0.3s ease;
        }
        
        .sr-card:hover {
            transform: scale(1.05);
        }
        
        .sr-card.new {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .sr-card.learning {
            background: rgba(255, 255, 255, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.4);
        }
        
        .sr-card.mature {
            background: rgba(255, 255, 255, 0.4);
            border: 2px solid rgba(255, 255, 255, 0.5);
        }
        
        .sr-arrow {
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 0.7;
                transform: scale(1);
            }
            50% {
                opacity: 1;
                transform: scale(1.1);
            }
        }
        
        .sr-quick-start {
            background: var(--background-white);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-sm);
        }
        
        .sr-quick-start-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .sr-quick-start-header h3 {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--text-main);
        }
        
        .sr-quick-start-header p {
            color: var(--text-secondary);
            font-size: 1.125rem;
        }
        
        .sr-stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .sr-stat-card {
            background: var(--background-white);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all 0.2s ease;
        }
        
        .sr-stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .sr-stat-card.urgent {
            border-color: #ef4444;
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
        }
        
        .sr-stat-icon {
            font-size: 2rem;
        }
        
        .sr-stat-content {
            flex: 1;
        }
        
        .sr-stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-main);
            line-height: 1;
        }
        
        .sr-stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }
        
        .sr-action-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }
        
        .sr-primary-btn, .sr-secondary-btn {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem 2rem;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
        }
        
        .sr-primary-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .sr-primary-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        
        .sr-secondary-btn {
            background: var(--background-white);
            color: var(--text-main);
            border: 2px solid var(--border-color);
        }
        
        .sr-secondary-btn:hover {
            background: var(--background-light);
            transform: translateY(-1px);
        }
        
        .sr-btn-icon {
            font-size: 1.25rem;
        }
        
        .sr-how-it-works, .sr-rating-system, .sr-tips {
            background: var(--background-white);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-sm);
        }
        
        .sr-how-it-works h3, .sr-rating-system h3, .sr-tips h3 {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: var(--text-main);
        }
        
        .sr-steps {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
        }
        
        .sr-step {
            display: flex;
            gap: 1rem;
            align-items: flex-start;
        }
        
        .sr-step-number {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.25rem;
            flex-shrink: 0;
        }
        
        .sr-step-content h4 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-main);
        }
        
        .sr-step-content p {
            color: var(--text-secondary);
            line-height: 1.6;
        }
        
        .sr-rating-system p {
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
            font-size: 1.125rem;
        }
        
        .sr-ratings {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }
        
        .sr-rating {
            display: flex;
            gap: 1rem;
            align-items: flex-start;
        }
        
        .sr-rating-color {
            width: 1rem;
            height: 1rem;
            border-radius: 50%;
            flex-shrink: 0;
            margin-top: 0.25rem;
        }
        
        .sr-rating-color.again {
            background: #ef4444;
        }
        
        .sr-rating-color.hard {
            background: #f59e0b;
        }
        
        .sr-rating-color.good {
            background: #10b981;
        }
        
        .sr-rating-color.easy {
            background: #3b82f6;
        }
        
        .sr-rating-content h4 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: var(--text-main);
        }
        
        .sr-rating-content p {
            color: var(--text-secondary);
            font-size: 0.875rem;
            line-height: 1.5;
        }
        
        .sr-tips-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }
        
        .sr-tip {
            display: flex;
            gap: 1rem;
            align-items: flex-start;
        }
        
        .sr-tip-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }
        
        .sr-tip-content h4 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-main);
        }
        
        .sr-tip-content p {
            color: var(--text-secondary);
            font-size: 0.875rem;
            line-height: 1.5;
        }
        
        @media (max-width: 768px) {
            .sr-hero-content {
                grid-template-columns: 1fr;
                gap: 2rem;
            }
            
            .sr-hero-text h2 {
                font-size: 2rem;
            }
            
            .sr-benefits {
                flex-direction: column;
                gap: 1rem;
            }
            
            .sr-stats-overview {
                grid-template-columns: 1fr;
            }
            
            .sr-action-buttons {
                flex-direction: column;
            }
            
            .sr-steps, .sr-ratings, .sr-tips-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
    <script>
        // UPDATED SCRIPT: Initialize theme and accessibility settings from localStorage
        (function() {
            const theme = localStorage.getItem('theme');
            if (theme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
            }
            const fontSize = localStorage.getItem('fontSize');
            if (fontSize) {
                 document.documentElement.setAttribute('data-font-size', fontSize);
            }
            const highContrast = localStorage.getItem('highContrast');
            if (highContrast === 'true') {
                 document.documentElement.setAttribute('data-high-contrast', 'true');
            }
        })();
    </script>

    <!-- Custom Modal Functions -->
    <script>
        // Custom confirmation and alert modals
        let confirmationCallback = null;
        let confirmationData = null;

        function getEmojiForMessage(message) {
            const msg = message.toLowerCase();
            if (msg.includes('delete') || msg.includes('remove')) return '🗑️';
            if (msg.includes('upload') || msg.includes('ready')) return '✅';
            if (msg.includes('error') || msg.includes('failed')) return '❌';
            if (msg.includes('warning') || msg.includes('careful')) return '⚠️';
            if (msg.includes('success') || msg.includes('complete')) return '🎉';
            if (msg.includes('info') || msg.includes('information')) return 'ℹ️';
            if (msg.includes('question') || msg.includes('ask')) return '❓';
            if (msg.includes('pro') || msg.includes('upgrade')) return '⭐';
            if (msg.includes('password') || msg.includes('security')) return '🔒';
            if (msg.includes('calendar') || msg.includes('schedule')) return '📅';
            if (msg.includes('study') || msg.includes('learn')) return '📚';
            if (msg.includes('file') || msg.includes('document')) return '📄';
            if (msg.includes('flashcard') || msg.includes('quiz')) return '🃏';
            return '⚠️'; // Default
        }

        function showCustomConfirmation(message, callback, data = null, buttonText = 'Confirm') {
            // Wait for DOM to be ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => showCustomConfirmation(message, callback, data, buttonText));
                return;
            }
            
            const emoji = getEmojiForMessage(message);
            const confirmationModal = document.getElementById('custom-confirmation-modal');
            const confirmationTitle = document.getElementById('confirmation-title');
            const confirmationMessage = document.getElementById('confirmation-message');
            const confirmActionBtn = document.getElementById('confirm-action-btn');
            
            if (!confirmationModal || !confirmationTitle || !confirmationMessage || !confirmActionBtn) {
                console.error('Modal elements not found');
                return;
            }
            
            confirmationTitle.textContent = `${emoji} Are you sure?`;
            confirmationMessage.textContent = message;
            confirmActionBtn.textContent = buttonText;
            confirmationCallback = callback;
            confirmationData = data;
            confirmationModal.style.display = 'flex';
        }

        function showCustomAlert(message, title = 'Information') {
            // Wait for DOM to be ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => showCustomAlert(message, title));
                return;
            }
            
            const emoji = getEmojiForMessage(message);
            const alertModal = document.getElementById('custom-alert-modal');
            const alertTitle = document.getElementById('alert-title');
            const alertMessage = document.getElementById('alert-message');
            
            if (!alertModal || !alertTitle || !alertMessage) {
                console.error('Alert modal elements not found');
                return;
            }
            
            alertTitle.textContent = `${emoji} ${title}`;
            alertMessage.textContent = message;
            alertModal.style.display = 'flex';
        }

        function closeCustomModal() {
            document.getElementById('custom-confirmation-modal').style.display = 'none';
            confirmationCallback = null;
            confirmationData = null;
        }

        function closeCustomAlert() {
            document.getElementById('custom-alert-modal').style.display = 'none';
        }
        
        // ==============================================================================
        // UNIVERSAL NOTIFICATION SYSTEM
        // ==============================================================================
        
        // Universal notification types
        const NOTIFICATION_TYPES = {
            SUCCESS: 'success',
            ERROR: 'error', 
            WARNING: 'warning',
            INFO: 'info',
            CONFIRM: 'confirm'
        };
        
        // Universal notification function
        function showNotification(message, type = NOTIFICATION_TYPES.INFO, title = null, options = {}) {
            // Wait for DOM to be ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => showNotification(message, type, title, options));
                return;
            }
            
            // Auto-generate title based on type if not provided
            if (!title) {
                switch(type) {
                    case NOTIFICATION_TYPES.SUCCESS: title = 'Success!'; break;
                    case NOTIFICATION_TYPES.ERROR: title = 'Error'; break;
                    case NOTIFICATION_TYPES.WARNING: title = 'Warning'; break;
                    case NOTIFICATION_TYPES.CONFIRM: title = 'Confirm Action'; break;
                    default: title = 'Information'; break;
                }
            }
            
            const modal = document.createElement('div');
            modal.className = 'universal-notification-modal';
            modal.innerHTML = `
                <div class="universal-notification-content ${type}">
                    <div class="universal-notification-header">
                        <div class="universal-notification-icon">
                            ${getNotificationIcon(type)}
                        </div>
                        <h3 class="universal-notification-title">${title}</h3>
                        <button class="universal-notification-close" onclick="closeUniversalNotification(this)">×</button>
                    </div>
                    <div class="universal-notification-body">
                        <p>${message}</p>
                    </div>
                    <div class="universal-notification-footer">
                        ${getNotificationButtons(type, options)}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Show modal with animation
            setTimeout(() => {
                modal.classList.add('visible');
            }, 10);
            
            // Store callback for later use
            modal.callback = options.callback;
            modal.confirmCallback = options.confirmCallback;
            modal.cancelCallback = options.cancelCallback;
            
            // Auto-close for non-confirm types after delay
            if (type !== NOTIFICATION_TYPES.CONFIRM && options.autoClose !== false) {
                setTimeout(() => {
                    if (modal.parentNode) {
                        closeUniversalNotification(modal.querySelector('.universal-notification-close'));
                    }
                }, options.autoCloseDelay || 5000);
            }
        }
        
        function getNotificationIcon(type) {
            switch(type) {
                case NOTIFICATION_TYPES.SUCCESS:
                    return '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22,4 12,14.01 9,11.01"></polyline></svg>';
                case NOTIFICATION_TYPES.ERROR:
                    return '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>';
                case NOTIFICATION_TYPES.WARNING:
                    return '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>';
                case NOTIFICATION_TYPES.CONFIRM:
                    return '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><path d="M9,12l2,2l4,-4"></path></svg>';
                default:
                    return '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><path d="M12,16v-4"></path><path d="M12,8h.01"></path></svg>';
            }
        }
        
        function getNotificationButtons(type, options) {
            if (type === NOTIFICATION_TYPES.CONFIRM) {
                return `
                    <button class="button button-secondary" onclick="handleNotificationAction(this, 'cancel')">Cancel</button>
                    <button class="button button-primary" onclick="handleNotificationAction(this, 'confirm')">Confirm</button>
                `;
            } else {
                return `<button class="button button-primary" onclick="closeUniversalNotification(this)">OK</button>`;
            }
        }
        
        function handleNotificationAction(button, action) {
            const modal = button.closest('.universal-notification-modal');
            if (action === 'confirm' && modal.confirmCallback) {
                modal.confirmCallback();
            } else if (action === 'cancel' && modal.cancelCallback) {
                modal.cancelCallback();
            }
            closeUniversalNotification(button);
        }
        
        function closeUniversalNotification(button) {
            const modal = button.closest('.universal-notification-modal');
            modal.classList.remove('visible');
            setTimeout(() => {
                if (modal.parentNode) {
                    modal.parentNode.removeChild(modal);
                }
            }, 300);
        }
        
        // Convenience functions for different notification types
        function showSuccess(message, title = null, options = {}) {
            showNotification(message, NOTIFICATION_TYPES.SUCCESS, title, options);
        }
        
        function showError(message, title = null, options = {}) {
            showNotification(message, NOTIFICATION_TYPES.ERROR, title, options);
        }
        
        function showWarning(message, title = null, options = {}) {
            showNotification(message, NOTIFICATION_TYPES.WARNING, title, options);
        }
        
        function showInfo(message, title = null, options = {}) {
            showNotification(message, NOTIFICATION_TYPES.INFO, title, options);
        }
        
        function showConfirm(message, title = null, options = {}) {
            showNotification(message, NOTIFICATION_TYPES.CONFIRM, title, options);
        }
        
        // Replace window.alert globally
        window.alert = function(message) {
            showInfo(message, 'Information');
        };

        function confirmAction() {
            if (confirmationCallback) {
                confirmationCallback(confirmationData);
            }
            closeCustomModal();
        }
    </script>
</head>
<body>
    
    <!-- NEW: Comprehensive Onboarding System -->
    
    <!-- 1. Welcome Screen - Fullscreen Overlay -->
    <div id="onboarding-welcome-overlay">
        <div id="onboarding-welcome-content">
            <h1>Welcome to FociAI! 🚀</h1>
            <p>Your AI-powered study companion that transforms lectures, notes, and assignments into powerful learning tools.</p>
            
            <div class="welcome-features">
                <div class="welcome-feature">
                    <h3>🎯 Smart Study Hubs</h3>
                    <p>Organize your modules with AI-powered study tools</p>
                </div>
                <div class="welcome-feature">
                    <h3>🧠 AI Tutor</h3>
                    <p>Ask questions and get instant explanations</p>
                </div>
                <div class="welcome-feature">
                    <h3>📚 Auto Flashcards</h3>
                    <p>Generate revision materials from your content</p>
                </div>
            </div>
            
            <button id="onboarding-start-btn">Let's Begin 🚀</button>
        </div>
    </div>

    <!-- 2. Personalization Modal -->
    <div id="onboarding-personalization-modal">
        <div class="personalization-slide active" data-slide="1">
            <h2>What's your main study goal? 🎯</h2>
            <p>This helps us personalize your experience</p>
            <div class="personalization-options">
                <div class="personalization-option" data-value="exam-prep">
                    <h4>📝 Exam Prep</h4>
                    <p>Focus on test preparation</p>
                </div>
                <div class="personalization-option" data-value="understanding">
                    <h4>🧠 Deep Understanding</h4>
                    <p>Master complex concepts</p>
                </div>
                <div class="personalization-option" data-value="efficiency">
                    <h4>⚡ Study Efficiency</h4>
                    <p>Optimize learning time</p>
                </div>
            </div>
            <div class="personalization-nav">
                <div class="personalization-progress">
                    <div class="progress-dot active"></div>
                    <div class="progress-dot"></div>
                    <div class="progress-dot"></div>
                </div>
                <button class="button personalization-next-btn" data-slide="1">Next</button>
            </div>
        </div>
        
        <div class="personalization-slide" data-slide="2">
            <h2>What's your study style? 📚</h2>
            <p>Choose what works best for you</p>
            <div class="personalization-options">
                <div class="personalization-option" data-value="visual">
                    <h4>👁️ Visual Learner</h4>
                    <p>Diagrams, charts, images</p>
                </div>
                <div class="personalization-option" data-value="textual">
                    <h4>📖 Text-Based</h4>
                    <p>Notes, summaries, text</p>
                </div>
                <div class="personalization-option" data-value="interactive">
                    <h4>🎮 Interactive</h4>
                    <p>Quizzes, flashcards, games</p>
                </div>
            </div>
            <div class="personalization-nav">
                <div class="personalization-progress">
                    <div class="progress-dot active"></div>
                    <div class="progress-dot active"></div>
                    <div class="progress-dot"></div>
                </div>
                <button class="button personalization-next-btn" data-slide="2">Next</button>
            </div>
        </div>
        
        <div class="personalization-slide" data-slide="3">
            <h2>How often do you study? ⏰</h2>
            <p>This helps us optimize your schedule</p>
            <div class="personalization-options">
                <div class="personalization-option" data-value="daily">
                    <h4>📅 Daily</h4>
                    <p>Every day, consistent</p>
                </div>
                <div class="personalization-option" data-value="weekly">
                    <h4>📆 Weekly</h4>
                    <p>Few times per week</p>
                </div>
                <div class="personalization-option" data-value="intensive">
                    <h4>🔥 Intensive</h4>
                    <p>Before exams only</p>
                </div>
            </div>
            <div class="personalization-nav">
                <div class="personalization-progress">
                    <div class="progress-dot active"></div>
                    <div class="progress-dot active"></div>
                    <div class="progress-dot active"></div>
                </div>
                <button class="button" id="personalization-complete">Complete Setup</button>
            </div>
        </div>
    </div>

    <!-- 3. Dashboard Spotlight Elements -->
    <div id="onboarding-spotlight-overlay"></div>
    <div id="onboarding-tooltip"></div>

    <!-- 4. Celebration Modal -->
    <div id="onboarding-celebration-modal">
        <div class="celebration-content">
            <h1>🎓 Well done!</h1>
            <p>You've just taken your first steps with FociAI — from flashcards to live AI tutoring.</p>
            
            <div class="celebration-features">
                <div class="celebration-feature">
                    <h3>✅ Create Study Hubs</h3>
                    <p>Organize your modules with AI-powered tools</p>
                </div>
                <div class="celebration-feature">
                    <h3>✅ Upload Lectures</h3>
                    <p>Transform slides into interactive content</p>
                </div>
                <div class="celebration-feature">
                    <h3>✅ Build Revision Packs</h3>
                    <p>Generate flashcards and quizzes instantly</p>
                </div>
                <div class="celebration-feature">
                    <h3>✅ Ask Your Tutor</h3>
                    <p>Get instant help with any question</p>
                </div>
            </div>
            
            <button id="onboarding-complete-btn">Create My First Hub 🚀</button>
        </div>
    </div>
    
    <aside class="side-panel">
        <div class="logo">Foci</div>
        <nav class="nav-tabs">
            <a href="#" class="nav-tab active" data-tab="hubs">
                <span>📝 Hubs</span>
            </a>
            <a href="#" class="nav-tab" data-tab="progress">
                <span>📈 Progress</span>
            </a>
            <a href="#" class="nav-tab" data-tab="spaced-repetition">
                <span>🧠 Spaced Repetition</span>
            </a>
            <a href="#" class="nav-tab" data-tab="community">
                <span>🌍 Community</span>
            </a>
            <a href="#" class="nav-tab" data-tab="earn-money">
                <span>💰 Earn Money</span>
            </a>
            <a href="#" class="nav-tab" data-tab="my-values">
                <span>💙 My Values</span>
            </a>
            <a href="#" class="nav-tab" data-tab="profile">
                <span>😎 Profile</span>
            </a>
            <a href="#" class="nav-tab" data-tab="settings">
                <span>⚙️ Settings</span>
            </a>
        </nav>
        
        <!-- Earn Money Banner -->
        <div class="earn-money-banner">
            <div class="banner-content">
                <div class="banner-text">
                    <span class="banner-title">💰 Earn up to £300!</span>
                    <span class="banner-subtitle">Refer friends & get rewards</span>
                </div>
                <button class="banner-button" onclick="goToEarnMoney()">
                    <span class="banner-button-text">Go to</span>
                    <svg class="banner-arrow" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"></path></svg>
                </button>
            </div>
        </div>
        
        <div class="side-panel-footer">
            <button id="spotify-player-toggle-btn" class="button button-secondary" style="flex-grow: 1; justify-content: center;" data-spotify-connected="{{ spotify_connected|lower }}">
                {% if spotify_connected %}
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>
                    <span>Music</span>
                {% else %}
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.42 1.56-.299.421-1.02.599-1.559.3z"/>
                    </svg>
                    <span>Connect Music</span>
                {% endif %}
            </button>
            <label class="theme-switch" for="theme-toggle-input">
                <input type="checkbox" id="theme-toggle-input" />
                <div class="slider">
                    <div class="icon-wrapper sun">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                    </div>
                     <div class="icon-wrapper moon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                    </div>
                </div>
            </label>
        </div>
    </aside>

    <main class="main-content">
        <div id="hubs" class="tab-content active">
            <div class="container">
                <header>
                    <div class="header-text">
                        <h1>Your Study Hub Dashboard ✨</h1>
                        <p>All your courses, notes, and AI-powered tools in one place.</p>
                    </div>
                    <div class="header-actions">
                        {% if current_user.subscription_tier == 'free' %}
                        <form action="/create-checkout-session" method="POST" id="upgrade-form">
                            <input type="hidden" name="price_id" value="price_1SAIiIGskVGPwTrbk2GMvwoG">
                            <button type="submit" class="button" id="upgrade-button">
                                🚀 Upgrade to Pro - <span id="price-display">£5.99</span>
                            </button>
                        </form>
                        {% elif current_user.subscription_tier == 'pro' %}
                            <div class="pro-badge"><span>PRO</span></div>
                        {% endif %}

                        <a href="{{ url_for('logout') }}" class="button button-danger">Sign Out</a>
                        <a href="{{ url_for('delete_all_hubs') }}" class="button button-danger" id="delete-all-hubs-btn">Delete All Hubs</a>

                        <button class="button" id="open-modal-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                            Create New Hub
                        </button>
                    </div>
                </header>

                <div class="hub-grid">
                    {% for hub in hubs %}
                    <article class="hub-card" data-hub-id="{{ hub.id }}" data-hub-name="{{ hub.name }}">
                        <div class="card-header" style="background-color: {{ hub.header_color }}; background-image: url('{{ hub.header_pattern_url }}');">
                            <h2>{{ hub.name }}</h2>
                            <a href="{{ url_for('delete_hub', hub_id=hub.id) }}" 
                               class="delete-btn delete-hub-btn" title="Delete Hub" data-hub-id="{{ hub.id }}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                            </a>
                        </div>
                        
                        <a href="{{ url_for('hub_page', hub_id=hub.id) }}" class="hub-card-link">
                            <div class="hub-card-body">
                                {% if hub.files|length == 0 %}
                                <div class="empty-state">
                                     <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" y1="18" x2="12" y2="12"></line><line x1="9" y1="15" x2="15" y2="15"></line></svg>
                                    <p>Upload documents to get started!</p>
                                </div>
                                {% else %}
                                <div class="hub-stats">
                                    <div class="stat">
                                        <span class="stat-value">{{ hub.files|length }}</span>
                                        <span class="stat-label">Files</span>
                                    </div>
                                    <div class="stat">
                                        <span class="stat-value">{{ hub.flashcard_count }}</span>
                                        <span class="stat-label">Flashcards</span>
                                    </div>
                                    <div class="stat">
                                        <span class="stat-value">{{ hub.notes_count }}</span>
                                        <span class="stat-label">Notes</span>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </a>
                    </article>
                    {% else %}
                    <p style="text-align:center; color: var(--text-secondary); font-size: 1rem; grid-column: 1 / -1;">No study hubs yet. Create your first one!</p>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <div id="progress" class="tab-content">
            <div class="container">
                <header>
                    <div class="header-text">
                        <h1>Overall Progress 📈</h1>
                        <p>An overview of your study habits and performance across all your hubs.</p>
                    </div>
                </header>

                <div class="progress-grid">
                    <div class="stat-card time-card">
                        <h3>Total Study Time</h3>
                        <div class="value">{{ total_study_hours }}<span>hours</span></div>
                    </div>
                    <div class="stat-card streak-card">
                        <h3>Longest Study Streak</h3>
                        <div class="value">{{ longest_streak }}<span>days</span></div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <h2>Quiz Score Trends</h2>
                    <canvas id="quizScoresChart"></canvas>
                </div>

                <div class="review-container" style="margin-top: 2rem;">
                    <h2>Areas for Review</h2>
                    <div class="review-list">
                        {% for topic in weak_topics %}
                        <div class="review-item">
                            <div class="topic-details">
                                <span class="topic-name">{{ topic.topic }}</span>
                                <span class="hub-name">From Hub: {{ topic.hub_name }}</span>
                            </div>
                            <div class="topic-score {{ 'score-low' if topic.score < 50 else 'score-mid' }}">
                                {{ "%.0f"|format(topic.score) }}%
                            </div>
                        </div>
                        {% else %}
                        <p style="padding: 1rem 0; color: var(--text-secondary);">No specific weaknesses identified yet. Keep taking quizzes to get feedback!</p>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <div id="spaced-repetition" class="tab-content">
            <div class="container">
                <header>
                    <div class="header-text">
                        <h1>🧠 Spaced Repetition</h1>
                        <p>The scientifically-proven method to maximize your learning efficiency and long-term retention.</p>
                    </div>
                </header>

                <!-- Hero Section -->
                <div class="sr-hero-section">
                    <div class="sr-hero-content">
                        <div class="sr-hero-text">
                            <h2>Transform Your Learning with Spaced Repetition</h2>
                            <p>Our advanced algorithm shows you flashcards at the perfect intervals to maximize retention. Based on the same science that powers Anki, this system adapts to your performance and optimizes your study schedule.</p>
                            <div class="sr-benefits">
                                <div class="sr-benefit">
                                    <span class="sr-benefit-icon">⚡</span>
                                    <span>3x Faster Learning</span>
                                </div>
                                <div class="sr-benefit">
                                    <span class="sr-benefit-icon">🧠</span>
                                    <span>Long-term Retention</span>
                                </div>
                                <div class="sr-benefit">
                                    <span class="sr-benefit-icon">📊</span>
                                    <span>Adaptive Algorithm</span>
                                </div>
                            </div>
                        </div>
                        <div class="sr-hero-visual">
                            <div class="sr-visualization">
                                <div class="sr-card new">New</div>
                                <div class="sr-arrow">↓</div>
                                <div class="sr-card learning">Learning</div>
                                <div class="sr-arrow">↓</div>
                                <div class="sr-card mature">Mature</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Start Section -->
                <div class="sr-quick-start">
                    <div class="sr-quick-start-header">
                        <h3>🚀 Quick Start</h3>
                        <p>Ready to supercharge your learning? Start reviewing your flashcards now!</p>
                        <div class="sr-migration-notice" style="background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 8px; padding: 1rem; margin: 1rem 0; color: #0c4a6e;">
                            <strong>📝 Note:</strong> If you have flashcards created before the spaced repetition system, they will be automatically migrated when you start your first session. This is a one-time process.
                        </div>
                    </div>
                    <div class="sr-quick-start-content">
                        <div class="sr-stats-overview">
                            <div class="sr-stat-card urgent">
                                <div class="sr-stat-icon">🔥</div>
                                <div class="sr-stat-content">
                                    <div class="sr-stat-number" id="sr-due-cards">0</div>
                                    <div class="sr-stat-label">Due for Review</div>
                                </div>
                            </div>
                            <div class="sr-stat-card">
                                <div class="sr-stat-icon">🆕</div>
                                <div class="sr-stat-content">
                                    <div class="sr-stat-number" id="sr-new-cards">0</div>
                                    <div class="sr-stat-label">New Cards</div>
                                </div>
                            </div>
                            <div class="sr-stat-card">
                                <div class="sr-stat-icon">📚</div>
                                <div class="sr-stat-content">
                                    <div class="sr-stat-number" id="sr-learning-cards">0</div>
                                    <div class="sr-stat-label">Learning</div>
                                </div>
                            </div>
                            <div class="sr-stat-card">
                                <div class="sr-stat-icon">🎯</div>
                                <div class="sr-stat-content">
                                    <div class="sr-stat-number" id="sr-mature-cards">0</div>
                                    <div class="sr-stat-label">Mature</div>
                                </div>
                            </div>
                        </div>
                        <div class="sr-action-buttons">
                            <button class="sr-primary-btn" onclick="startSpacedRepetitionSession()">
                                <span class="sr-btn-icon">🎯</span>
                                <span>Start Review Session</span>
                            </button>
                            <button class="sr-secondary-btn" onclick="showSpacedRepetitionTutorial()">
                                <span class="sr-btn-icon">📖</span>
                                <span>How It Works</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- How It Works Section -->
                <div class="sr-how-it-works">
                    <h3>🔬 How Spaced Repetition Works</h3>
                    <div class="sr-steps">
                        <div class="sr-step">
                            <div class="sr-step-number">1</div>
                            <div class="sr-step-content">
                                <h4>New Cards</h4>
                                <p>Fresh flashcards waiting for their first review. These appear immediately after creation.</p>
                            </div>
                        </div>
                        <div class="sr-step">
                            <div class="sr-step-number">2</div>
                            <div class="sr-step-content">
                                <h4>Learning Phase</h4>
                                <p>Cards you're actively learning. They appear frequently (every few minutes to hours) until you demonstrate mastery.</p>
                            </div>
                        </div>
                        <div class="sr-step">
                            <div class="sr-step-number">3</div>
                            <div class="sr-step-content">
                                <h4>Mature Cards</h4>
                                <p>Cards you've mastered. They appear less frequently (days to weeks) for long-term retention.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Rating System Explanation -->
                <div class="sr-rating-system">
                    <h3>⭐ Rating System</h3>
                    <p>Rate your performance on each card to help the algorithm optimize your learning schedule:</p>
                    <div class="sr-ratings">
                        <div class="sr-rating">
                            <div class="sr-rating-color again"></div>
                            <div class="sr-rating-content">
                                <h4>Again (0-1 days)</h4>
                                <p>Complete blackout. You didn't remember the answer at all.</p>
                            </div>
                        </div>
                        <div class="sr-rating">
                            <div class="sr-rating-color hard"></div>
                            <div class="sr-rating-content">
                                <h4>Hard (1 day)</h4>
                                <p>Incorrect response; correct one remembered with difficulty.</p>
                            </div>
                        </div>
                        <div class="sr-rating">
                            <div class="sr-rating-color good"></div>
                            <div class="sr-rating-content">
                                <h4>Good (1+ days)</h4>
                                <p>Correct response after a hesitation of ~10 seconds.</p>
                            </div>
                        </div>
                        <div class="sr-rating">
                            <div class="sr-rating-color easy"></div>
                            <div class="sr-rating-content">
                                <h4>Easy (4+ days)</h4>
                                <p>Perfect response. You knew it immediately.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tips Section -->
                <div class="sr-tips">
                    <h3>💡 Pro Tips</h3>
                    <div class="sr-tips-grid">
                        <div class="sr-tip">
                            <div class="sr-tip-icon">📅</div>
                            <div class="sr-tip-content">
                                <h4>Daily Reviews</h4>
                                <p>Review your cards every day, even if just for 10-15 minutes. Consistency is key!</p>
                            </div>
                        </div>
                        <div class="sr-tip">
                            <div class="sr-tip-icon">🎯</div>
                            <div class="sr-tip-content">
                                <h4>Focus on Learning Cards</h4>
                                <p>Cards in the learning phase need the most attention. Prioritize these!</p>
                            </div>
                        </div>
                        <div class="sr-tip">
                            <div class="sr-tip-icon">🧠</div>
                            <div class="sr-tip-content">
                                <h4>Trust the Algorithm</h4>
                                <p>The system knows when to show you each card. Trust the process!</p>
                            </div>
                        </div>
                        <div class="sr-tip">
                            <div class="sr-tip-icon">📊</div>
                            <div class="sr-tip-content">
                                <h4>Track Your Progress</h4>
                                <p>Watch your mature cards grow - this is your knowledge foundation!</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="community" class="tab-content">
            <div class="container">
                <header>
                    <div class="header-text">
                        <h1>Community Library 🌍</h1>
                        <p>Share your study materials with the community and discover resources from other students.</p>
                    </div>
                    <div class="header-actions">
                         <button class="button" id="share-folder-btn">
                            <i data-lucide="share-2"></i> Share a Folder
                        </button>
                        <button class="button button-secondary" id="create-study-group-btn">
                            <i data-lucide="users-plus"></i> Create a Study Group
                        </button>
                        <button class="button button-secondary" id="join-study-group-btn">
                            <i data-lucide="user-plus"></i> Join a Study Group
                        </button>
                    </div>
                </header>
                
                <!-- Community Tabs -->
                <div class="community-tabs">
                    <button class="community-tab active" data-tab="global">
                        <i data-lucide="globe"></i>
                        <span>Global</span>
                    </button>
                    <button class="community-tab" data-tab="study-groups">
                        <i data-lucide="users"></i>
                        <span>Study Groups</span>
                    </button>
                </div>

                <!-- Global Tab Content -->
                <div id="global-tab" class="community-tab-content active">
                    <div class="global-resources-container">
                        <div class="global-resources-header">
                            <h3>Global Community Resources</h3>
                            <p>Discover and import study materials shared by students worldwide.</p>
                    </div>
                        <div class="global-resources-list" id="global-resources-list">
                            <!-- Global resources will be dynamically loaded here -->
                    </div>
                    </div>
                </div>

                <!-- Study Groups Tab Content -->
                <div id="study-groups-tab" class="community-tab-content">
                    <div class="study-groups-container">
                        <div class="study-groups-header">
                            <h3>Your Study Groups</h3>
                            <p>Join study groups to share materials with specific groups of students.</p>
                        </div>
                        <div class="study-groups-list" id="study-groups-list">
                            <!-- Study groups will be dynamically loaded here -->
                                </div>
                            </div>
                </div>
            </div>
        </div>

        <div id="earn-money" class="tab-content">
            <div class="container">
                <header>
                    <div class="header-text">
                        <h1>💰 Earn Money</h1>
                        <p>Refer friends and earn rewards! Share your referral code and climb the leaderboard.</p>
                            </div>
                            <div class="header-actions">
                        <!-- Add Referral Code Section (for users who didn't use one during signup) -->
                        <div class="add-referral-section" id="add-referral-section" style="display: none;">
                            <h4>Add Referral Code</h4>
                            <p class="section-description">Support a friend!</p>
                            <div class="referral-input-group">
                                <input type="text" id="add-referral-code" placeholder="Enter 6-digit code" maxlength="6" pattern="[0-9]{6}">
                                <button id="add-referral-btn" class="add-referral-button" onclick="addReferralCode()">
                                    <i data-lucide="plus"></i> Add
                                </button>
                            </div>
                            <div id="referral-status" class="referral-status"></div>
                        </div>
                    </div>
                </header>

                <!-- Referral Code Section -->
                <div class="referral-code-section">
                    <div class="referral-code-left">
                        <h3>Your Referral Code</h3>
                        <div class="referral-code-display" id="referral-code">
                            <span class="loading-text">Loading...</span>
                                </div>
                        
                        <!-- Milestones -->
                        <div class="milestones-section">
                            <h4>Referral Milestones</h4>
                            <div class="milestones-grid" id="milestones-grid">
                                <div class="milestone-card" data-milestone="4">
                                    <div class="milestone-number">4</div>
                                    <div class="milestone-reward">£10 Amazon giftcard</div>
                                    <div class="milestone-status" id="milestone-4-status">❌</div>
                                    <div class="claim-button" id="claim-4-button" style="display: none;">
                                        <button class="claim-btn" onclick="claimReward(4)">Claim</button>
                                    </div>
                             </div>
                                <div class="milestone-card" data-milestone="10">
                                    <div class="milestone-number">10</div>
                                    <div class="milestone-reward">£20 Amazon giftcard</div>
                                    <div class="milestone-status" id="milestone-10-status">❌</div>
                                    <div class="claim-button" id="claim-10-button" style="display: none;">
                                        <button class="claim-btn" onclick="claimReward(10)">Claim</button>
                                    </div>
                             </div>
                                <div class="milestone-card" data-milestone="20">
                                    <div class="milestone-number">20</div>
                                    <div class="milestone-reward">£50 Amazon giftcard</div>
                                    <div class="milestone-status" id="milestone-20-status">❌</div>
                                    <div class="claim-button" id="claim-20-button" style="display: none;">
                                        <button class="claim-btn" onclick="claimReward(20)">Claim</button>
                                    </div>
                        </div>
                                <div class="milestone-card" data-milestone="50">
                                    <div class="milestone-number">50</div>
                                    <div class="milestone-reward">£100 Amazon giftcard</div>
                                    <div class="milestone-status" id="milestone-50-status">❌</div>
                                    <div class="claim-button" id="claim-50-button" style="display: none;">
                                        <button class="claim-btn" onclick="claimReward(50)">Claim</button>
                                    </div>
                            </div>
                        </div>
                    </div>
                    </div>

                    
                    <div class="referral-code-right">
                        <h3>How to refer a friend?</h3>
                        <div class="instructions-list">
                            <div class="instruction-item">
                                <span class="step-number">1</span>
                                <p>When your friend is purchasing the pro subscription, make sure they enter your referral code.</p>
                </div>
                            <div class="instruction-item">
                                <span class="step-number">2</span>
                                <p>If they do, your friend will receive 50% off their Pro subscription!</p>
                </div>
                            <div class="instruction-item">
                                <span class="step-number">3</span>
                                <p>Reach referral milestones to unlock rewards like cash prizes, giftcards and more!</p>
                             </div>
                            <div class="instruction-item highlight">
                                <span class="step-number">4</span>
                                <p>The top 3 individuals with the most referrals by the end of every month receive a cash prize.</p>
                        </div>
                            </div>
                        </div>
                    </div>

                <!-- Referrals Leaderboard -->
                <div class="leaderboard-section">
                    <h2>Referrals Leaderboard - The top three referees every month win a HUGE cash prize</h2>
                    <div class="leaderboard-grid" id="leaderboard-grid">
                        <div class="leaderboard-card loading-card">
                            <div class="avatar">⏳</div>
                            <h4>Loading...</h4>
                            <p class="referrals-count">Fetching leaderboard</p>
                    </div>
                </div>
                </div>

                <!-- Referral Stats -->
                <div class="referral-stats">
                    <h2>Your Stats</h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">👥</div>
                            <div class="stat-number" id="total-referrals">0</div>
                            <div class="stat-label">Pro Referrals</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">💰</div>
                            <div class="stat-number" id="total-earnings">£0</div>
                            <div class="stat-label">Earnings</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">🎯</div>
                            <div class="stat-number" id="milestones-reached">0/4</div>
                            <div class="stat-label">Milestones</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="my-values" class="tab-content">
            <div class="container">
                <header>
                    <div class="header-text">
                        <h1>💙 My Values</h1>
                        <p>This site was built during a time of global crisis. It is important that we remember and acknowledge those currently suffering around the world. 10% of all proceeds from this site goes towards supporting those in crisis.</p>
                    </div>
                </header>
                
                <!-- Crisis Support Section -->
                <div class="values-section">
                    <div class="crisis-grid">
                        <!-- Palestine -->
                        <div class="flip-card" onclick="flipCard(this)">
                            <div class="flip-card-inner">
                                <div class="flip-card-front">
                                    <div class="flag-container">
                                        <div class="palestine-flag"></div>
                                    </div>
                                    <h3>Palestine</h3>
                                    <p>Click to see charities</p>
                                </div>
                                <div class="flip-card-back">
                                    <h3>Palestine</h3>
                                    <p>Supporting humanitarian aid and relief efforts through donations to:</p>
                                    <ul>
                                        <li>Palestinian Red Crescent Society</li>
                                        <li>UNRWA (UN Relief and Works Agency)</li>
                                        <li>Medical Aid for Palestinians</li>
                                        <li>Palestine Children's Relief Fund</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Syria -->
                        <div class="flip-card" onclick="flipCard(this)">
                            <div class="flip-card-inner">
                                <div class="flip-card-front">
                                    <div class="flag-container">
                                        <div class="syria-flag"></div>
                                    </div>
                                    <h3>Syria</h3>
                                    <p>Click to see charities</p>
                                </div>
                                <div class="flip-card-back">
                                    <h3>Syria</h3>
                                    <p>Supporting refugees and displaced families through donations to:</p>
                                    <ul>
                                        <li>UNHCR (UN Refugee Agency)</li>
                                        <li>Syrian American Medical Society</li>
                                        <li>International Rescue Committee</li>
                                        <li>Save the Children Syria</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Sudan -->
                        <div class="flip-card" onclick="flipCard(this)">
                            <div class="flip-card-inner">
                                <div class="flip-card-front">
                                    <div class="flag-container">
                                        <div class="sudan-flag"></div>
                                    </div>
                                    <h3>Sudan</h3>
                                    <p>Click to see charities</p>
                                </div>
                                <div class="flip-card-back">
                                    <h3>Sudan</h3>
                                    <p>Supporting emergency relief and medical aid through donations to:</p>
                                    <ul>
                                        <li>Doctors Without Borders Sudan</li>
                                        <li>UNICEF Sudan</li>
                                        <li>World Food Programme Sudan</li>
                                        <li>International Committee of the Red Cross Sudan</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="profile" class="tab-content">
            <div class="container">
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        <script>
                            document.addEventListener('DOMContentLoaded', function() {
                        {% for category, message in messages %}
                                    {% if category == 'success' %}
                                        showSuccess('{{ message|e }}');
                                    {% elif category == 'error' %}
                                        showError('{{ message|e }}');
                                    {% elif category == 'warning' %}
                                        showWarning('{{ message|e }}');
                                    {% else %}
                                        showInfo('{{ message|e }}');
                                    {% endif %}
                        {% endfor %}
                            });
                        </script>
                    {% endif %}
                {% endwith %}

                <div class="profile-content-card">
                    <form method="POST" enctype="multipart/form-data" action="{{ url_for('profile') }}">
                        <div class="profile-grid">
                            <div class="avatar-upload-section">
                                <img src="{{ current_user.avatar_url }}" alt="Profile Picture" id="avatar-preview" class="avatar-preview">
                                <label for="avatar-upload" class="button-style-label">
                                   <i data-lucide="triangle"></i> Upload
                                </label>
                                <input type="file" id="avatar-upload" name="avatar" accept="image/png, image/jpeg">
                            </div>
                            <div class="profile-form-fields">
                                <div class="form-group">
                                    <label for="display_name">Display Name</label>
                                    <input type="text" id="display_name" name="display_name" value="{{ current_user.display_name }}">
                                </div>
                                <div class="form-group">
                                    <label for="bio">Bio / Intro</label>
                                    <textarea id="bio" name="bio" placeholder="e.g., Computer Science student specializing in AI.">{{ current_user.bio }}</textarea>
                                </div>
                                <div class="form-actions">
                                    <button type="submit" class="button">Save Changes</button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>

                <div class="profile-content-card">
                    <h2>Learning & Progress</h2>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="value">{{ stats.total_study_hours }}</div>
                            <div class="label">Hours Studied</div>
                        </div>
                        <div class="stat-item">
                            <div class="value">{{ stats.hubs|length }}</div>
                            <div class="label">Courses / Hubs</div>
                        </div>
                        <div class="stat-item">
                            <div class="value">{{ stats.longest_streak }}</div>
                            <div class="label">Longest Streak</div>
                        </div>
                    </div>
                </div>

                <div class="profile-content-card">
                    <h2>Current Courses / Hubs</h2>
                    <div class="courses-list">
                        {% for hub in stats.hubs %}
                        <div class="course-item">
                            <span>{{ hub.name }}</span>
                            <a href="{{ url_for('hub_page', hub_id=hub.id) }}" style="text-decoration: none; font-weight: 500; color: var(--primary-color);">View Hub →</a>
                        </div>
                        {% else %}
                        <p>You haven't created any study hubs yet.</p>
                        {% endfor %}
                    </div>
                </div>

                 <div class="profile-content-card">
                    <h2>Achievements</h2>
                    <p style="color: var(--text-secondary);">Achievement badges and milestones will appear here as you complete study goals. Coming soon!</p>
                </div>
            </div>
        </div>

        <div id="settings" class="tab-content">
            <div class="settings-container">
                <header style="border-bottom: none; margin-bottom: 2rem;">
                    <div class="header-text">
                        <h1>Settings</h1>
                        <p>Manage your account, privacy, and application preferences.</p>
                    </div>
                </header>

                <!-- Account Settings Card -->
                <div class="settings-card">
                    <div class="settings-card-header">
                        <h2>Account</h2>
                        <p>Update your login credentials and linked accounts.</p>
                    </div>
                    <div class="settings-card-body">
                        <div class="form-group">
                            <label for="email">Email Address</label>
                            <input type="email" id="email" name="email" value="{{ current_user.email }}" disabled>
                        </div>
                        <div class="form-group">
                            <label for="password">New Password</label>
                            <input type="password" id="new_password" name="new_password" placeholder="Enter new password">
                        </div>
                        <div class="form-group">
                            <label for="confirm_password">Confirm New Password</label>
                            <input type="password" id="confirm_password" name="confirm_password" placeholder="Confirm new password">
                        </div>
                    </div>
                    <div class="settings-card-footer">
                        <button class="button" id="save-password-btn">Save Password</button>
                    </div>
                </div>
                
                <!-- Privacy Controls Card -->
                <div class="settings-card">
                    <div class="settings-card-header">
                        <h2>Privacy Controls</h2>
                        <p>Control who can see your profile and activity.</p>
                    </div>
                    <div class="settings-card-body">
                        <div class="setting-item">
                            <div class="setting-item-content">
                                <h3>Profile Visibility</h3>
                                <p>Allow other users to find your profile via search.</p>
                            </div>
                            <div class="setting-item-action">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="profile-visible-toggle" {% if current_user.profile_visible %}checked{% endif %}>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        <div class="setting-item">
                            <div class="setting-item-content">
                                <h3>Activity Visibility</h3>
                                <p>Show your study streaks and badges on your public profile.</p>
                            </div>
                            <div class="setting-item-action">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="activity-visible-toggle" {% if current_user.activity_visible %}checked{% endif %}>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Theme & Accessibility Card -->
                <div class="settings-card">
                    <div class="settings-card-header">
                        <h2>Theme & Accessibility</h2>
                        <p>Customize the app's appearance and behavior.</p>
                    </div>
                    <div class="settings-card-body">
                        <div class="setting-item">
                            <div class="setting-item-content">
                                <h3>Font Size</h3>
                                <p>Adjust the text size across the application.</p>
                            </div>
                             <div class="setting-item-action">
                                <select id="font-size-select" class="button button-secondary" style="padding-right: 2rem;">
                                    <option value="small" {% if current_user.font_size_preference == 'small' %}selected{% endif %}>Small</option>
                                    <option value="default" {% if current_user.font_size_preference == 'default' %}selected{% endif %}>Default</option>
                                    <option value="large" {% if current_user.font_size_preference == 'large' %}selected{% endif %}>Large</option>
                                </select>
                            </div>
                        </div>
                         <div class="setting-item">
                            <div class="setting-item-content">
                                <h3>High Contrast Mode</h3>
                                <p>Increase text contrast for better readability.</p>
                            </div>
                            <div class="setting-item-action">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="high-contrast-toggle" {% if current_user.high_contrast_mode %}checked{% endif %}>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Background Images Section -->
                        <div class="setting-item" style="flex-direction: column; align-items: stretch;">
                            <div class="setting-item-content" style="margin-bottom: 1rem;">
                                <h3>Background Themes</h3>
                                <p>Choose from beautiful background images to personalize your study experience.</p>
                            </div>
                            <div class="background-image-grid" style="width: 100%;">
                                <div class="background-image-option" data-background="default">
                                    <div class="background-image-preview default-bg">
                                        <div class="background-image-name">Default</div>
                                    </div>
                                    <div class="background-image-label">Clean & Simple</div>
                                </div>
                                <div class="background-image-option" data-background="citynight">
                                    <div class="background-image-preview" style="background-image: url('/static/background-images/citynight.jpg');">
                                        <div class="background-image-name">City Night</div>
                                    </div>
                                    <div class="background-image-label">Urban Skyline</div>
                                </div>
                <div class="background-image-option" data-background="darkcity">
                    <div class="background-image-preview" style="background-image: url('/static/background-images/darkcity.jpg');">
                        <div class="background-image-name">Dark City</div>
                    </div>
                    <div class="background-image-label">Urban Night</div>
                </div>
                <div class="background-image-option" data-background="sky">
                    <div class="background-image-preview" style="background-image: url('/static/background-images/sky.jpg');">
                        <div class="background-image-name">Sky</div>
                    </div>
                    <div class="background-image-label">Cloudy Skies</div>
                </div>
                <div class="background-image-option" data-background="space">
                    <div class="background-image-preview" style="background-image: url('/static/background-images/space.jpg');">
                        <div class="background-image-name">Space</div>
                    </div>
                    <div class="background-image-label">Cosmic View</div>
                </div>
                <div class="background-image-option" data-background="sunset">
                    <div class="background-image-preview" style="background-image: url('/static/background-images/sunset.png');">
                        <div class="background-image-name">Sunset</div>
                    </div>
                    <div class="background-image-label">Golden Hour</div>
                </div>
                <div class="background-image-option" data-background="night">
                    <div class="background-image-preview" style="background-image: url('/static/background-images/night.png_large');">
                        <div class="background-image-name">Night</div>
                    </div>
                    <div class="background-image-label">Starry Night</div>
                </div>
                                <div class="background-image-option" data-background="mountains">
                                    <div class="background-image-preview" style="background-image: url('/static/background-images/mountains.png');">
                                        <div class="background-image-name">Mountains</div>
                                    </div>
                                    <div class="background-image-label">Mountain Peaks</div>
                                </div>
                                <div class="background-image-option" data-background="nature">
                                    <div class="background-image-preview" style="background-image: url('/static/background-images/nature.png');">
                                        <div class="background-image-name">Nature</div>
                                    </div>
                                    <div class="background-image-label">Natural Beauty</div>
                                </div>
                                <div class="background-image-option" data-background="sea">
                                    <div class="background-image-preview" style="background-image: url('/static/background-images/sea.png');">
                                        <div class="background-image-name">Sea</div>
                                    </div>
                                    <div class="background-image-label">Ocean Waves</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                 <!-- Help & Support Card -->
                <div class="settings-card">
                    <div class="settings-card-header">
                        <h2>Help & Support</h2>
                        <p>Find answers or get in touch.</p>
                    </div>
                    <div class="settings-card-body">
                         <div class="setting-item">
                            <div class="setting-item-content">
                                <h3>Help Center</h3>
                                <p>Browse FAQs, tutorials, and guides.</p>
                            </div>
                            <div class="setting-item-action">
                                <a href="{{ url_for('help_center') }}" class="button button-secondary">Visit Help Center</a>
                            </div>
                        </div>
                        <div class="setting-item">
                            <div class="setting-item-content">
                                <h3>Report a Bug</h3>
                                <p>Encountered an issue? Let us know so we can fix it.</p>
                            </div>
                            <div class="setting-item-action">
                                 <a href="mailto:support@fociapp.com" class="button button-secondary">Report Bug</a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Development & Testing Card -->
                <div class="settings-card">
                    <div class="settings-card-header">
                        <h2>Development & Testing</h2>
                        <p>Tools for developers and testers.</p>
                    </div>
                    <div class="settings-card-body">
                        <div class="setting-item">
                            <div class="setting-item-content">
                                <h3>Restart Onboarding</h3>
                                <p>Reset your onboarding status to test the new user experience.</p>
                            </div>
                            <div class="setting-item-action">
                                <button id="restart-onboarding-btn" class="button button-secondary">Restart Onboarding</button>
                            </div>
                        </div>
                        <div class="setting-item">
                            <div class="setting-item-content">
                                <h3>Clear Demo Data</h3>
                                <p>Remove demo hubs and content created during onboarding.</p>
                            </div>
                            <div class="setting-item-action">
                                <button id="clear-demo-data-btn" class="button button-secondary">Clear Demo Data</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Account Management Card -->
                <div class="settings-card">
                    <div class="settings-card-header">
                        <h2>Account Management</h2>
                        <p>Export your data or delete your account.</p>
                    </div>
                    <div class="settings-card-body">
                        <div class="setting-item">
                            <div class="setting-item-content">
                                <h3>Download Your Data</h3>
                                <p>Export all your notes, flashcards, and hub data.</p>
                            </div>
                            <div class="setting-item-action">
                                <button class="button button-secondary" id="request-data-btn">Request Data</button>
                            </div>
                        </div>
                        <div class="setting-item">
                            <div class="setting-item-content">
                                <h3>Delete Your Account</h3>
                                <p>Permanently delete your account and all associated data.</p>
                            </div>
                            <div class="setting-item-action">
                                <button class="button button-danger" id="delete-account-btn">Delete Account</button>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <!-- Create Hub Modal -->
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create New Hub</h3>
                <button class="close-button" id="close-modal-btn">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <form action="{{ url_for('add_hub') }}" method="POST">
                <div class="form-group">
                    <label for="hub_name">Hub Name</label>
                    <input type="text" id="hub_name" name="hub_name" placeholder="e.g., Quantum Physics" required>
                </div>
                <button type="submit" class="button">Create Hub</button>
            </form>
        </div>
    </div>

    <!-- Share Folder Modal -->
    <div class="modal-overlay" id="share-folder-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Share a Folder</h3>
                <button class="close-button" id="close-share-modal-btn">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <form id="share-folder-form">
                <div class="form-group">
                    <label for="folder-select">Select a Folder to Share</label>
                    <select id="folder-select" name="folder_id" required>
                        <option value="" disabled selected>-- Choose a folder --</option>
                        {% for folder in all_user_folders %}
                            <option value="{{ folder.id }}" data-hub-id="{{ folder.hub_id }}">{{ folder.hub_name }} / {{ folder.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="share-destination">Share to:</label>
                    <div class="radio-group">
                        <label class="radio-label">
                            <input type="radio" name="share_destination" value="global" checked>
                            <span class="radio-custom"></span>
                            <div class="radio-content">
                                <strong>Global Community</strong>
                                <small>Share with all users worldwide</small>
                            </div>
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="share_destination" value="study_group">
                            <span class="radio-custom"></span>
                            <div class="radio-content">
                                <strong>Study Group</strong>
                                <small>Share with a specific study group</small>
                            </div>
                        </label>
                    </div>
                </div>

                <div class="form-group" id="study-group-selection" style="display: none;">
                    <label for="study-group-select">Select Study Group</label>
                    <select id="study-group-select" name="study_group_id">
                        <option value="" disabled selected>-- Choose a study group --</option>
                        <!-- Study groups will be loaded dynamically -->
                    </select>
                </div>
                
                 <div class="form-group">
                    <label for="folder-title">Share Title</label>
                    <input type="text" id="folder-title" name="title" required placeholder="Enter a public title for this folder">
                </div>
                
                 <div class="form-group">
                    <label for="folder-description">Description</label>
                    <textarea id="folder-description" name="description" required placeholder="Briefly describe what's in this folder. e.g., Lecture notes and quizzes for the final exam."></textarea>
                </div>
                
                 <div class="form-group">
                    <label for="folder-tags">Tags (comma-separated)</label>
                    <input type="text" id="folder-tags" name="tags" placeholder="e.g., physics, quantum mechanics, exam prep">
                </div>
                
                <div class="form-actions">
                    <button type="button" class="button button-secondary" id="cancel-share-folder">Cancel</button>
                    <button type="submit" class="button" id="share-folder-submit">Share Folder</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal to select a hub for importing -->
    <div class="modal-overlay" id="import-hub-select-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Select a Hub</h3>
                <button class="close-button" id="close-import-modal-btn"><i data-lucide="x"></i></button>
            </div>
            <p style="margin-top:0; color: var(--text-secondary);">Choose which hub you'd like to import this folder into.</p>
            <div id="hub-list-container">
                <!-- Hubs will be dynamically inserted here by JS -->
            </div>
        </div>
    </div>

    <!-- NEW: Folder Contents Preview Modal -->
    <div class="modal-overlay" id="preview-modal">
        <div class="modal-content" id="preview-modal-content">
            <div class="modal-header">
                <h3 id="preview-title">Folder Preview</h3>
                <button class="close-button" id="close-preview-modal-btn"><i data-lucide="x"></i></button>
            </div>
            <p id="preview-description" style="color: var(--text-secondary);"></p>
            <div class="preview-item-list" id="preview-item-list">
                <!-- Preview items will be dynamically inserted here by JS -->
            </div>
        </div>
    </div>

    <!-- NEW: Item Content Preview Modal -->
    <div class="modal-overlay" id="item-preview-modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3 id="item-preview-title">Item Preview</h3>
                <button class="close-button" id="close-item-preview-modal-btn"><i data-lucide="x"></i></button>
            </div>
            <div id="item-preview-content">
                <!-- Content will be injected by JS -->
            </div>
        </div>
    </div>


    {% if spotify_connected %}
    <div id="spotify-player-container">
        <!-- Music Visualization Effects -->
        <div class="sp-visualization-container">
            <div class="sp-waveform" id="sp-waveform">
                <!-- Wave bars will be generated dynamically -->
            </div>
            <div class="sp-particles" id="sp-particles">
                <!-- Particles will be generated dynamically -->
            </div>
        </div>
        
        <!-- Mini player toggle button -->
        <button id="sp-mini-toggle" class="sp-mini-toggle" title="Toggle Mini Player">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path>
            </svg>
        </button>
        
        <div class="sp-track-info">
            <img id="sp-album-art" src="" alt="Album Art" class="sp-album-art">
            <div class="sp-track-details">
                <p id="sp-track-title">Connecting to Spotify...</p>
                <p id="sp-track-artist">Please wait</p>
            </div>
        </div>
        
        <div class="sp-progress-bar"><div id="sp-progress" class="sp-progress"></div></div>
        
        <div class="sp-controls">
            <div class="sp-main-controls">
                <button id="sp-prev-btn"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="19 20 9 12 19 4 19 20"></polygon><line x1="5" y1="19" x2="5" y2="5"></line></svg></button>
                <button id="sp-play-btn" class="sp-play-btn"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="0"><path d="M8 5v14l11-7z"></path></svg></button>
                <button id="sp-next-btn"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 4 15 12 5 20 5 4"></polygon><line x1="19" y1="5" x2="19" y2="19"></line></svg></button>
            </div>
            <div class="sp-volume-control">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon></svg>
                <input type="range" id="sp-volume" min="0" max="100" value="80">
            </div>
        </div>
        
        <!-- Advanced Audio Features -->
        <div class="sp-audio-controls">
            <div class="sp-equalizer" id="sp-equalizer">
                <div class="sp-eq-band" data-freq="60">
                    <div class="sp-eq-level" style="height: 50%"></div>
                </div>
                <div class="sp-eq-band" data-freq="170">
                    <div class="sp-eq-level" style="height: 60%"></div>
                </div>
                <div class="sp-eq-band" data-freq="310">
                    <div class="sp-eq-level" style="height: 70%"></div>
                </div>
                <div class="sp-eq-band" data-freq="600">
                    <div class="sp-eq-level" style="height: 80%"></div>
                </div>
                <div class="sp-eq-band" data-freq="1000">
                    <div class="sp-eq-level" style="height: 90%"></div>
                </div>
                <div class="sp-eq-band" data-freq="3000">
                    <div class="sp-eq-level" style="height: 75%"></div>
                </div>
                <div class="sp-eq-band" data-freq="6000">
                    <div class="sp-eq-level" style="height: 65%"></div>
                </div>
                <div class="sp-eq-band" data-freq="12000">
                    <div class="sp-eq-level" style="height: 55%"></div>
                </div>
            </div>
            
            <div class="sp-audio-presets">
                <button class="sp-preset-btn active" data-preset="flat">Flat</button>
                <button class="sp-preset-btn" data-preset="study">Study</button>
                <button class="sp-preset-btn" data-preset="bass">Bass</button>
                <button class="sp-preset-btn" data-preset="treble">Treble</button>
            </div>
        </div>
        
        <!-- Study-focused playlist categories -->
        <div class="sp-study-categories">
            <div class="sp-category-tabs">
                <button class="sp-category-tab active" data-category="all">All Playlists</button>
                <button class="sp-category-tab" data-category="focus">Focus</button>
                <button class="sp-category-tab" data-category="relax">Relax</button>
                <button class="sp-category-tab" data-category="energy">Energy</button>
            </div>
        </div>
        
        <!-- Spotify Search -->
        <div class="sp-search-container">
            <input type="text" id="sp-search-input" class="sp-search-input" placeholder="Search your Spotify library...">
            <div class="sp-search-results" id="sp-search-results" style="display: none;">
                <!-- Search results will be populated dynamically -->
            </div>
        </div>
        
        <select id="sp-playlist-select" class="sp-playlist-select">
            <option value="">Select a Playlist</option>
        </select>
        
        <!-- AI Recommendations -->
        <div class="sp-recommendations" id="sp-recommendations" style="display: none;">
            <h4>🎵 Similar to this track</h4>
            <div id="sp-recommendations-list">
                <!-- Recommendations will be populated dynamically -->
            </div>
        </div>
        
        <!-- Keyboard shortcuts hint -->
        <div class="sp-shortcuts-hint">
            <small>Press Space to play/pause • ← → to skip tracks • M for mini mode</small>
        </div>
    </div>
    {% endif %}

    <script>
        // Global functions for referral system
        async function addReferralCode() {
            console.log('addReferralCode function called');
            const codeInput = document.getElementById('add-referral-code');
            const addButton = document.getElementById('add-referral-btn');
            const statusDiv = document.getElementById('referral-status');
            
            console.log('Elements found:', { codeInput, addButton, statusDiv });
            
            const code = codeInput.value.trim();
            console.log('Code entered:', code);
            
            if (!code) {
                showReferralStatus('Please enter a referral code', 'error');
                return;
            }
            
            if (code.length !== 6 || !/^\d{6}$/.test(code)) {
                showReferralStatus('Please enter a valid 6-digit referral code', 'error');
                return;
            }
            
            // Disable button and show loading
            addButton.disabled = true;
            addButton.innerHTML = '<i data-lucide="loader-2" class="animate-spin"></i> Adding...';
            
            try {
                const response = await fetch('/api/referrals/add-code', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ code: code })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    codeInput.value = '';
                    
                    // Hide the add referral section immediately
                    document.getElementById('add-referral-section').style.display = 'none';
                    
                    // Show success modal
                    showReferralSuccessModal();
                    
                    // Refresh stats to show updated data
                    setTimeout(() => {
                        fetchUserStats();
                    }, 1000);
                    
                } else {
                    showReferralStatus(data.message || 'Failed to add referral code', 'error');
                }
                
            } catch (error) {
                console.error('Error adding referral code:', error);
                showReferralStatus('Failed to add referral code. Please try again.', 'error');
            } finally {
                // Re-enable button
                addButton.disabled = false;
                addButton.innerHTML = '<i data-lucide="plus"></i> Add Code';
            }
        }

        // Show referral success modal
        function showReferralSuccessModal() {
            const modal = document.getElementById('referral-success-modal');
            if (modal) {
                modal.classList.add('visible');
                
                // Add animation delay for the icon
                setTimeout(() => {
                    const icon = modal.querySelector('.success-icon');
                    if (icon) {
                        icon.style.animation = 'bounce 0.6s ease-in-out';
                    }
                }, 200);
            }
        }

        // Redirect to upgrade when user clicks the button
        function redirectToUpgrade() {
            const upgradeForm = document.getElementById('upgrade-form');
            if (upgradeForm) {
                upgradeForm.submit();
            } else {
                // Fallback: redirect to dashboard and scroll to upgrade button
                window.location.href = '#hubs';
                setTimeout(() => {
                    const upgradeButton = document.querySelector('#upgrade-button');
                    if (upgradeButton) {
                        upgradeButton.scrollIntoView({ behavior: 'smooth' });
                    }
                }, 100);
            }
        }

        // Show Pro upgrade success modal
        function showProUpgradeSuccessModal() {
            console.log('showProUpgradeSuccessModal called');
            const modal = document.getElementById('pro-upgrade-success-modal');
            console.log('Modal element found:', modal);
            
            if (modal) {
                modal.classList.add('visible');
                console.log('Modal made visible');
                
                // Add animation delay for the icon
                setTimeout(() => {
                    const icon = modal.querySelector('.success-icon');
                    if (icon) {
                        icon.style.animation = 'bounce 0.6s ease-in-out';
                        console.log('Bounce animation applied to icon');
                    }
                }, 200);
            } else {
                console.error('Pro upgrade success modal element not found');
            }
        }

        // Close Pro upgrade modal
        function closeProUpgradeModal() {
            const modal = document.getElementById('pro-upgrade-success-modal');
            if (modal) {
                modal.classList.remove('visible');
            }
        }

        // Flip card function for My Values tab
        function flipCard(card) {
            card.classList.toggle('flipped');
        }
        
        // Go to Earn Money tab function
        function goToEarnMoney() {
            // Switch to earn money tab
            const tabs = document.querySelectorAll('.nav-tab');
            const tabContents = document.querySelectorAll('.tab-content');
            
            // Remove active class from all tabs
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Add active class to earn-money tab
            const earnMoneyTab = document.querySelector('.nav-tab[data-tab="earn-money"]');
            if (earnMoneyTab) {
                earnMoneyTab.classList.add('active');
            }
            
            // Hide all tab contents and show earn-money content
            tabContents.forEach(content => {
                content.classList.remove('active');
                if (content.id === 'earn-money') {
                    content.classList.add('active');
                }
            });
        }
        
        // Global claim reward function
        function claimReward(milestone) {
            const rewards = {
                4: '£10 Amazon giftcard',
                10: '£20 Amazon giftcard',
                20: '£50 Amazon giftcard',
                50: '£100 Amazon giftcard'
            };
            
            const reward = rewards[milestone];
            const emailSubject = `Claim Reward - ${reward} (${milestone} referrals)`;
            const emailBody = `Hi Raihan,

I have reached the milestone of ${milestone} referrals and would like to claim my reward of ${reward}.

Please find proof of my referrals below:
[Please attach screenshots or provide details of your referrals]

Thank you for your time.

Best regards,
[Your name]`;

            const mailtoLink = `mailto:raihanpetkar123@gmail.com?subject=${encodeURIComponent(emailSubject)}&body=${encodeURIComponent(emailBody)}`;
            
            // Show confirmation modal
            showCustomConfirmation(
                `To claim your ${reward}, you'll need to email raihanpetkar123@gmail.com with proof of your ${milestone} referrals. You'll receive a response within 48 hours.`,
                () => {
                    window.open(mailtoLink, '_blank');
                },
                null,
                'Open Email'
            );
        }

        function showReferralStatus(message, type) {
            console.log('showReferralStatus called:', message, type);
            const statusDiv = document.getElementById('referral-status');
            console.log('Status div found:', statusDiv);
            
            if (statusDiv) {
                statusDiv.textContent = message;
                statusDiv.className = `referral-status ${type}`;
                statusDiv.style.display = 'block';
                
                // Auto-hide after 5 seconds
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            } else {
                console.error('Status div not found!');
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            // Modal functionality
            const openModalBtn = document.getElementById('open-modal-btn');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const modalOverlay = document.getElementById('modal-overlay');

            if (openModalBtn) openModalBtn.addEventListener('click', () => modalOverlay.classList.add('visible'));
            if(closeModalBtn) closeModalBtn.addEventListener('click', () => modalOverlay.classList.remove('visible'));
            if(modalOverlay) modalOverlay.addEventListener('click', e => { if (e.target === modalOverlay) modalOverlay.classList.remove('visible'); });

            // Share Folder Modal functionality
            const shareModalOverlay = document.getElementById('share-folder-modal');
            const folderSelect = document.getElementById('folder-select');
            const folderTitleInput = document.getElementById('folder-title');

            function openShareModal() {
                shareModalOverlay.classList.add('visible');
            }
            // Share folder button will be handled in the community tab section
            
            if (folderSelect && folderTitleInput) {
                folderSelect.addEventListener('change', () => {
                    const selectedOption = folderSelect.options[folderSelect.selectedIndex];
                    const folderName = selectedOption.text.split(' / ')[1];
                    if (folderName) {
                        folderTitleInput.value = folderName;
                    }
                });
            }

            // Import Folder Modal functionality
            const importModal = document.getElementById('import-hub-select-modal');
            const hubListContainer = document.getElementById('hub-list-container');
            const closeImportModalBtn = document.getElementById('close-import-modal-btn');
            let folderToImportId = null;

            document.querySelectorAll('.import-btn').forEach(button => {
                button.addEventListener('click', function() {
                    folderToImportId = this.dataset.sharedFolderId;
                    hubListContainer.innerHTML = '';
                    const userHubs = {{ hubs_for_json|tojson }};
                    if (userHubs && userHubs.length > 0) {
                        userHubs.forEach(hub => {
                            const hubButton = document.createElement('button');
                            hubButton.textContent = hub.name;
                            hubButton.classList.add('button');
                            hubButton.style.width = '100%';
                            hubButton.style.marginBottom = '0.5rem';
                            hubButton.dataset.hubId = hub.id;
                            hubButton.addEventListener('click', handleImportConfirm);
                            hubListContainer.appendChild(hubButton);
                        });
                    } else {
                        hubListContainer.innerHTML = `<p>You need to create a Hub before you can import a folder. <a href="#" id="create-hub-link">Create one now</a>.</p>`;
                    }
                    importModal.classList.add('visible');
                });
            });

            function handleImportConfirm(event) {
                const targetHubId = event.target.dataset.hubId;
                if (!folderToImportId || !targetHubId) return;

                fetch(`/folder/import/${folderToImportId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ hub_id: targetHubId }),
                })
                .then(response => response.json())
                .then(data => {
                    showError(data.message);
                    if (data.success) {
                        window.location.reload(); // Reload to reflect changes
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showError('An error occurred during the import process.');
                });
                
                importModal.classList.remove('visible');
            }
            
            if(closeImportModalBtn) closeImportModalBtn.addEventListener('click', () => importModal.classList.remove('visible'));
            if(importModal) importModal.addEventListener('click', e => { if (e.target === importModal) importModal.classList.remove('visible'); });


            // Universal Theme toggle functionality
            const themeToggle = document.getElementById('theme-toggle-input');
            if (localStorage.getItem('theme') === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
                if (themeToggle) themeToggle.checked = true;
            } else {
                 document.documentElement.removeAttribute('data-theme');
                 if (themeToggle) themeToggle.checked = false;
            }

            if (themeToggle) {
                themeToggle.addEventListener('change', () => {
                    if (themeToggle.checked) {
                        document.documentElement.setAttribute('data-theme', 'dark');
                        localStorage.setItem('theme', 'dark');
                    } else {
                        document.documentElement.removeAttribute('data-theme');
                        localStorage.setItem('theme', 'light');
                    }
                });
            }

            // Referral System API Functions (moved before tab handler)
            async function fetchUserStats() {
                try {
                    const response = await fetch('/api/referrals/user-stats');
                    const data = await response.json();
                    
                    console.log('Fetched referral stats:', data);
                    
                    if (data.success) {
                        updateReferralDisplay(data.stats);
                        updateMilestones(data.stats.milestones);
                        updateStats(data.stats);
                    }
                } catch (error) {
                    console.error('Error fetching user stats:', error);
                    showError('Failed to load referral stats');
                }
            }

            // Tab functionality
            const tabs = document.querySelectorAll('.nav-tab');
            const tabContents = document.querySelectorAll('.tab-content');

            tabs.forEach(tab => {
                if (tab.hasAttribute('data-tab')) {
                    tab.addEventListener('click', (e) => {
                        e.preventDefault();
                        
                        tabs.forEach(item => item.classList.remove('active'));
                        tab.classList.add('active');
                        
                        const targetId = tab.getAttribute('data-tab');
                        tabContents.forEach(content => {
                            content.classList.remove('active');
                            if (content.id === targetId) {
                                content.classList.add('active');
                            }
                        });
                        history.pushState(null, '', '#' + targetId);
                        
                        // Special handling for earn-money tab
                        if (targetId === 'earn-money') {
                            setTimeout(() => {
                                fetchUserStats();
                                fetchLeaderboard();
                            }, 100);
                        }
                    });
                }
            });

            // Earn Money Tab Functions
            function generateReferralCode() {
                const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
                let result = '';
                for (let i = 0; i < 6; i++) {
                    result += characters.charAt(Math.floor(Math.random() * characters.length));
                }
                return result;
            }

            function copyReferralCode() {
                const referralCodeElement = document.getElementById('referral-code');
                const referralCode = referralCodeElement.textContent.trim();
                const button = document.querySelector('.copy-code-button');
                
                // Check if we have a valid referral code (not "Loading..." or "Generating...")
                if (!referralCode || referralCode === 'Loading...' || referralCode === 'Generating...' || referralCode.length !== 6) {
                    showWarning('Referral code is not ready yet. Please wait a moment and try again.');
                    return;
                }
                
                navigator.clipboard.writeText(referralCode).then(() => {
                    // Show success feedback
                    const originalText = button.innerHTML;
                    button.innerHTML = '✅ Copied!';
                    button.style.background = 'linear-gradient(45deg, #10b981, #059669)';
                    
                    setTimeout(() => {
                        button.innerHTML = originalText;
                        button.style.background = 'linear-gradient(45deg, #fbbf24, #f59e0b)';
                    }, 2000);
                }).catch(err => {
                    console.error('Failed to copy referral code: ', err);
                    showError('Failed to copy referral code. Please try again.');
                });
            }

            
            async function fetchLeaderboard() {
                try {
                    const response = await fetch('/api/referrals/leaderboard');
                    const data = await response.json();
                    
                    if (data.success) {
                        updateLeaderboard(data.leaderboard);
                    }
                } catch (error) {
                    console.error('Error fetching leaderboard:', error);
                    showError('Failed to load leaderboard');
                }
            }
            
            function updateReferralDisplay(stats) {
                const referralCodeElement = document.getElementById('referral-code');
                if (referralCodeElement) {
                    referralCodeElement.textContent = stats.referral_code || 'Generating...';
                }
                
                // Show/hide add referral section based on whether user was referred
                const addReferralSection = document.getElementById('add-referral-section');
                if (addReferralSection) {
                    // Show the section if user wasn't referred (referred_by is null/empty)
                    if (!stats.referred_by) {
                        addReferralSection.style.display = 'block';
                    } else {
                        addReferralSection.style.display = 'none';
                    }
                }
            }
            
            function updateMilestones(milestones) {
                console.log('Updating milestones with data:', milestones);
                Object.keys(milestones).forEach(milestone => {
                    const statusElement = document.getElementById(`milestone-${milestone}-status`);
                    const claimButton = document.getElementById(`claim-${milestone}-button`);
                    
                    console.log(`Milestone ${milestone}:`, milestones[milestone]);
                    
                    if (statusElement) {
                        if (milestones[milestone].reached) {
                            console.log(`Milestone ${milestone} is reached - showing claim button`);
                            statusElement.textContent = '✅';
                            statusElement.classList.add('achieved');
                            
                            // Show claim button for achieved milestones
                            if (claimButton) {
                                claimButton.style.display = 'block';
                            }
                        } else {
                            console.log(`Milestone ${milestone} is not reached`);
                            statusElement.textContent = '❌';
                            statusElement.classList.remove('achieved');
                            
                            // Hide claim button for unachieved milestones
                            if (claimButton) {
                                claimButton.style.display = 'none';
                            }
                        }
                    }
                });
            }
            
            function updateStats(stats) {
                document.getElementById('total-referrals').textContent = stats.pro_referral_count;
                document.getElementById('total-earnings').textContent = `£${stats.referral_earnings.toFixed(2)}`;
                
                // Count achieved milestones
                const achievedMilestones = Object.values(stats.milestones).filter(m => m.reached).length;
                document.getElementById('milestones-reached').textContent = `${achievedMilestones}/4`;
            }
            
            function updateLeaderboard(leaderboard) {
                const leaderboardGrid = document.getElementById('leaderboard-grid');
                if (!leaderboardGrid) return;
                
                if (leaderboard.length === 0) {
                    leaderboardGrid.innerHTML = `
                        <div class="leaderboard-card">
                            <div class="avatar">📊</div>
                            <h4>No data yet</h4>
                            <p class="referrals-count">Be the first to refer someone!</p>
                        </div>
                    `;
                    return;
                }
                
                leaderboardGrid.innerHTML = leaderboard.map((user, index) => {
                    const rankClass = index === 0 ? 'first-place' : index === 1 ? 'second-place' : index === 2 ? 'third-place' : '';
                    const rankBadge = index < 3 ? `${index + 1}${index === 0 ? 'st' : index === 1 ? 'nd' : 'rd'}` : `${index + 1}`;
                    const avatar = index === 0 ? '£100' : index === 1 ? '£50' : index === 2 ? '£25' : '🏆';
                    
                    return `
                        <div class="leaderboard-card ${rankClass}">
                            <div class="rank-badge">${rankBadge}</div>
                            <div class="avatar">${avatar}</div>
                            <h4>${user.display_name}</h4>
                            <p class="referrals-count">${user.pro_referral_count} referrals</p>
                        </div>
                    `;
                }).join('');
            }
            
            function showError(message) {
                console.error(message);
                // You can add a toast notification here if you have one
            }
            
            
            
            // Check referral discount status and update price display
            async function checkReferralDiscountStatus() {
                try {
                    const response = await fetch('/api/referral-discount-status');
                    const data = await response.json();
                    
                    if (data.success && data.eligible_for_discount) {
                        const priceDisplay = document.getElementById('price-display');
                        if (priceDisplay) {
                            priceDisplay.innerHTML = `<span style="text-decoration: line-through; color: #9ca3af;">£${data.original_price}</span> <span style="color: #10b981; font-weight: bold;">£${data.discounted_price}</span>`;
                        }
                        
                        // Add a small indicator that discount is applied
                        const upgradeButton = document.getElementById('upgrade-button');
                        if (upgradeButton) {
                            upgradeButton.innerHTML = `🚀 Upgrade to Pro - <span id="price-display"><span style="text-decoration: line-through; color: #9ca3af;">£${data.original_price}</span> <span style="color: #10b981; font-weight: bold;">£${data.discounted_price}</span></span> <span style="background: #10b981; color: white; padding: 0.2rem 0.4rem; border-radius: 4px; font-size: 0.7rem; margin-left: 0.5rem;">50% OFF</span>`;
                        }
                    }
                } catch (error) {
                    console.error('Error checking referral discount status:', error);
                }
            }

            // Check if user just upgraded to Pro and show success modal
            async function checkProUpgradeStatus() {
                try {
                    // Check URL parameters for successful upgrade
                    const urlParams = new URLSearchParams(window.location.search);
                    const sessionId = urlParams.get('session_id');
                    
                    if (sessionId) {
                        console.log('Session ID detected:', sessionId);
                        
                        // User came from Stripe checkout - check if they're now Pro
                        // We'll show the modal for any successful checkout session
                        showProUpgradeSuccessModal();
                        
                        // Clean up URL to remove session_id parameter
                        window.history.replaceState({}, document.title, window.location.pathname);
                        console.log('Pro upgrade success modal shown');
                    }
                } catch (error) {
                    console.error('Error checking Pro upgrade status:', error);
                }
            }

            // Test function to check if modal exists and can be shown
            function testProModal() {
                console.log('🧪 Testing Pro modal...');
                const modal = document.getElementById('pro-upgrade-success-modal');
                console.log('Modal element:', modal);
                if (modal) {
                    console.log('Modal classes:', modal.className);
                    console.log('Modal style:', modal.style.cssText);
                }
            }

            // Run test immediately
            testProModal();

            // Simple test: if there's a session_id in URL, show modal after 2 seconds
            const urlParams = new URLSearchParams(window.location.search);
            const sessionId = urlParams.get('session_id');
            if (sessionId) {
                console.log('🎯 Session ID detected, will test modal in 2 seconds...');
                setTimeout(() => {
                    console.log('🎯 Testing modal display...');
                    showProUpgradeSuccessModal();
                }, 2000);
            }

            // Initialize referral system on page load
            document.addEventListener('DOMContentLoaded', function() {
                // Load referral data if already on earn-money tab
                if (window.location.hash === '#earn-money') {
                    setTimeout(() => {
                        fetchUserStats();
                        fetchLeaderboard();
                    }, 100);
                }
                
                // Check discount status on page load
                checkReferralDiscountStatus();
                
                // Check if user just upgraded to Pro
                console.log('Checking Pro upgrade status...');
                checkProUpgradeStatus();
            });
            
            const currentHash = window.location.hash.substring(1);
            if (currentHash) {
                const tabToActivate = document.querySelector(`.nav-tab[data-tab="${currentHash}"]`);
                if (tabToActivate) tabToActivate.click();
            } else {
                 document.querySelector('.nav-tab[data-tab="hubs"]').classList.add('active');
                 document.getElementById('hubs').classList.add('active');
            }
            
            // Chart.js functionality
            const ctx = document.getElementById('quizScoresChart');
            if (ctx) {
                const quizData = {{ quiz_scores_json|safe }};
                new Chart(ctx.getContext('2d'), {
                    type: 'line',
                    data: {
                        datasets: [{
                            label: 'Quiz Score',
                            data: quizData,
                            borderColor: 'rgba(79, 70, 229, 1)',
                            backgroundColor: 'rgba(79, 70, 229, 0.1)',
                            fill: true,
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            x: { type: 'time', time: { unit: 'day', tooltipFormat: 'MMM dd, yyyy' }, title: { display: true, text: 'Date' } },
                            y: { beginAtZero: true, max: 100, title: { display: true, text: 'Score (%)' } }
                        },
                        plugins: { legend: { display: false } }
                    }
                });
            }

            // ==========================================================
            // --- UPDATED: COMMUNITY INTERACTION LISTENERS ---
            // ==========================================================
            const communityTab = document.getElementById('community');
            if (communityTab) {
                // Filtering logic
                const filterTabs = communityTab.querySelector('#community-filter-tabs');
                const searchInput = communityTab.querySelector('#community-search-input');
                const communityGrid = communityTab.querySelector('#community-grid-main');
                const allCards = communityGrid ? Array.from(communityGrid.querySelectorAll('.community-card')) : [];
                
                function applyFilters() {
                    const activeFilter = filterTabs.querySelector('.filter-tab.active').dataset.filter;
                    const searchTerm = searchInput.value.toLowerCase();
                    
                    allCards.forEach(card => {
                        const typeMatch = (activeFilter === 'all') || (card.dataset.folderType === activeFilter);
                        const searchMatch = card.dataset.searchContent.toLowerCase().includes(searchTerm);
                        
                        if (typeMatch && searchMatch) {
                            card.style.display = 'flex';
                        } else {
                            card.style.display = 'none';
                        }
                    });
                }

                if(filterTabs) {
                    filterTabs.addEventListener('click', (e) => {
                        if (e.target.classList.contains('filter-tab')) {
                            filterTabs.querySelector('.active').classList.remove('active');
                            e.target.classList.add('active');
                            applyFilters();
                        }
                    });
                }
                
                if(searchInput) {
                    searchInput.addEventListener('input', applyFilters);
                }

                // Sorting Logic
                const sortSelect = document.getElementById('community-sort-select');
                if (sortSelect) {
                    const urlParams = new URLSearchParams(window.location.search);
                    const currentSort = urlParams.get('sort');
                    if (currentSort) {
                        sortSelect.value = currentSort;
                    }

                    sortSelect.addEventListener('change', (e) => {
                        const sortBy = e.target.value;
                        const currentUrl = new URL(window.location);
                        currentUrl.searchParams.set('sort', sortBy);
                        window.location.href = currentUrl.href;
                    });
                }
                
                // --- NEW: Preview Modal Logic ---
                const previewModal = document.getElementById('preview-modal');
                const previewTitle = document.getElementById('preview-title');
                const previewDesc = document.getElementById('preview-description');
                const previewList = document.getElementById('preview-item-list');
                const closePreviewBtn = document.getElementById('close-preview-modal-btn');
                
                document.querySelectorAll('.preview-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const card = this.closest('.community-card');
                        const title = card.dataset.previewTitle;
                        const desc = card.dataset.previewDescription;
                        const items = JSON.parse(card.dataset.previewItems || '[]');

                        previewTitle.textContent = "Preview: " + title;
                        previewDesc.textContent = desc;
                        previewList.innerHTML = ''; // Clear previous items

                        if (items && items.length > 0) {
                            items.forEach(item => {
                                const itemEl = document.createElement('div');
                                itemEl.className = 'preview-item';
                                let icon = 'file-question';
                                if(item.type === 'Note') icon = 'notebook-tabs';
                                if(item.type === 'Quiz') icon = 'clipboard-list';
                                if(item.type === 'Flashcards') icon = 'layers-3';

                                itemEl.innerHTML = `<i data-lucide="${icon}"></i> <span>${item.title}</span>`;
                                
                                // Attach data and event listener for second-level preview
                                itemEl.dataset.itemData = JSON.stringify(item);
                                itemEl.addEventListener('click', showItemPreview);

                                previewList.appendChild(itemEl);
                            });
                        } else {
                            previewList.innerHTML = `<p style="padding: 1rem; text-align: center; color: var(--text-secondary);">This pack is empty.</p>`;
                        }
                        
                        lucide.createIcons();
                        previewModal.classList.add('visible');
                    });
                });
                if(closePreviewBtn) closePreviewBtn.addEventListener('click', () => previewModal.classList.remove('visible'));
                if(previewModal) previewModal.addEventListener('click', e => { if (e.target === previewModal) previewModal.classList.remove('visible'); });

                // --- NEW & UPDATED: Item Preview Modal & Content Fetching ---
                const itemPreviewModal = document.getElementById('item-preview-modal');
                const closeItemPreviewBtn = document.getElementById('close-item-preview-modal-btn');
                const itemPreviewTitle = document.getElementById('item-preview-title');
                const itemPreviewContent = document.getElementById('item-preview-content');
                
                if(closeItemPreviewBtn) closeItemPreviewBtn.addEventListener('click', () => itemPreviewModal.classList.remove('visible'));
                if(itemPreviewModal) itemPreviewModal.addEventListener('click', e => { if (e.target === itemPreviewModal) itemPreviewModal.classList.remove('visible'); });

                async function showItemPreview(event) {
                    const itemEl = event.currentTarget;
                    const item = JSON.parse(itemEl.dataset.itemData);
                    
                    itemPreviewTitle.textContent = item.title;
                    itemPreviewContent.innerHTML = '<p>Loading content...</p>'; // Show loading state
                    itemPreviewModal.classList.add('visible');

                    // --- THIS IS THE KEY CHANGE: FETCH THE REAL CONTENT ---
                    try {
                        const response = await fetch(`/api/item_content/${item.id}`);
                        const data = await response.json();
                        
                        if (data.success) {
                            itemPreviewContent.innerHTML = ''; // Clear loading message
                            
                            if (item.type === 'Note') {
                                const noteEl = document.createElement('div');
                                noteEl.className = 'note-content';
                                noteEl.innerHTML = data.content; // Use innerHTML to render HTML content
                                itemPreviewContent.appendChild(noteEl);
                            } else if (item.type === 'Flashcards' && Array.isArray(data.content)) {
                                const listEl = document.createElement('div');
                                listEl.className = 'flashcard-list';
                                data.content.forEach(card => {
                                    const cardEl = document.createElement('div');
                                    cardEl.className = 'flashcard-item';
                                    cardEl.innerHTML = `
                                        <div><div class="side">FRONT</div>${card.front}</div>
                                        <hr>
                                        <div><div class="side">BACK</div>${card.back}</div>
                                    `;
                                    listEl.appendChild(cardEl);
                                });
                                itemPreviewContent.appendChild(listEl);
                            } else {
                                itemPreviewContent.innerHTML = `<p style="padding: 1rem; color: var(--text-secondary)">${data.content}</p>`;
                            }
                        } else {
                            itemPreviewContent.innerHTML = `<p style="padding: 1rem; color: var(--danger-color)">Error: ${data.message}</p>`;
                        }
                    } catch (error) {
                        console.error("Failed to fetch item content:", error);
                        itemPreviewContent.innerHTML = `<p style="padding: 1rem; color: var(--danger-color)">Could not load content. Please try again.</p>`;
                    }
                }


                // --- NEW: Like Button Logic ---
                document.querySelectorAll('.like-btn').forEach(button => {
                    button.addEventListener('click', function(e) {
                        e.preventDefault();
                        const folderId = this.dataset.folderId;
                        
                        fetch(`/folder/like/${folderId}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' }
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                const countSpan = document.getElementById(`like-count-${folderId}`);
                                countSpan.textContent = data.count;
                                if (data.action === 'liked') {
                                    button.classList.add('liked');
                                } else {
                                    button.classList.remove('liked');
                                }
                            } else {
                                showError(data.message);
                            }
                        })
                        .catch(err => console.error('Like action failed:', err));
                    });
                });
            }
            
            // --- Profile Tab Functionality ---
            const profileTab = document.getElementById('profile');
            if (profileTab) {
                const avatarUpload = document.getElementById('avatar-upload');
                const avatarPreview = document.getElementById('avatar-preview');

                avatarUpload.addEventListener('change', function(event) {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            avatarPreview.src = e.target.result;
                        }
                        reader.readAsDataURL(file);
                    }
                });
            }

            // ==========================================================
            // --- SETTINGS FUNCTIONALITY ---
            // ==========================================================
            const settingsTab = document.getElementById('settings');
            if(settingsTab) {
                
                // --- Helper function to update a setting via API ---
                const updateSetting = async (key, value) => {
                    try {
                        const response = await fetch('{{ url_for("update_settings") }}', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ [key]: value })
                        });
                        const result = await response.json();
                        if (!result.success) {
                            showError('Error saving setting: ' + result.message);
                        }
                    } catch (error) {
                        console.error('Failed to update setting:', error);
                        showError('An error occurred. Please try again.');
                    }
                };

                // --- 1. Account: Password Change ---
                const savePasswordBtn = document.getElementById('save-password-btn');
                savePasswordBtn.addEventListener('click', async () => {
                    const newPassword = document.getElementById('new_password').value;
                    const confirmPassword = document.getElementById('confirm_password').value;

                    if (!newPassword || newPassword !== confirmPassword) {
                        showWarning('Passwords do not match or are empty.');
                        return;
                    }
                    
                    try {
                        const response = await fetch('{{ url_for("update_password") }}', {
                             method: 'POST',
                             headers: { 'Content-Type': 'application/json' },
                             body: JSON.stringify({ new_password: newPassword })
                        });
                        const result = await response.json();
                        showInfo(result.message);
                        if(result.success) {
                             document.getElementById('new_password').value = '';
                             document.getElementById('confirm_password').value = '';
                        }
                    } catch(error) {
                        console.error(error);
                        showError('An error occurred while changing password.');
                    }
                });

                // --- 2. Privacy Toggles ---
                document.getElementById('profile-visible-toggle').addEventListener('change', (e) => {
                    updateSetting('profile_visible', e.target.checked);
                });
                document.getElementById('activity-visible-toggle').addEventListener('change', (e) => {
                    updateSetting('activity_visible', e.target.checked);
                });

                // --- 3. Accessibility ---
                const fontSizeSelect = document.getElementById('font-size-select');
                fontSizeSelect.addEventListener('change', (e) => {
                    const newSize = e.target.value;
                    document.documentElement.setAttribute('data-font-size', newSize);
                    localStorage.setItem('fontSize', newSize);
                    updateSetting('font_size_preference', newSize);
                });

                const highContrastToggle = document.getElementById('high-contrast-toggle');
                highContrastToggle.addEventListener('change', (e) => {
                    const isEnabled = e.target.checked;
                    document.documentElement.setAttribute('data-high-contrast', isEnabled);
                    localStorage.setItem('highContrast', isEnabled);
                    updateSetting('high_contrast_mode', isEnabled);
                });

                // --- Background Image Selection ---
                const backgroundImageOptions = document.querySelectorAll('.background-image-option');
                let currentBackgroundImage = '{{ current_user.background_preference or "default" }}';
                
                console.log('Background images loaded:', backgroundImageOptions.length);
                console.log('Current background from template:', currentBackgroundImage);
                console.log('User background preference:', '{{ current_user.background_preference }}');
                
                // Fallback to localStorage if template value is not working
                if (currentBackgroundImage === 'default' || !currentBackgroundImage) {
                    const savedBackground = localStorage.getItem('background_preference');
                    if (savedBackground) {
                        currentBackgroundImage = savedBackground;
                        console.log('Using saved background from localStorage:', currentBackgroundImage);
                    }
                }
                
                // Initialize background image selection
                function initializeBackgroundImageSelection() {
                    backgroundImageOptions.forEach(option => {
                        const backgroundName = option.dataset.background;
                        if (backgroundName === currentBackgroundImage) {
                            option.classList.add('selected');
                        }
                        
                        option.addEventListener('click', () => {
                            // Remove selected class from all options
                            backgroundImageOptions.forEach(opt => opt.classList.remove('selected'));
                            // Add selected class to clicked option
                            option.classList.add('selected');
                            
                            // Update background preference
                            currentBackgroundImage = backgroundName;
                            updateSetting('background_preference', backgroundName);
                            
                            // Save to localStorage for immediate persistence
                            localStorage.setItem('background_preference', backgroundName);
                            
                            // Apply the background immediately
                            applyBackgroundImage(backgroundName);
                        });
                    });
                }
                
            // Apply background image
            function applyBackgroundImage(backgroundName) {
                // Set data attribute for CSS targeting
                document.body.setAttribute('data-background', backgroundName);
                
                if (backgroundName === 'default') {
                    // Remove any background styling from all elements
                    document.body.style.backgroundImage = '';
                    document.body.style.backgroundAttachment = '';
                    document.body.style.backgroundSize = '';
                    document.body.style.backgroundPosition = '';
                    document.body.style.backgroundRepeat = '';
                    
                    const mainContent = document.querySelector('.main-content');
                    
                    if (mainContent) {
                        mainContent.style.backgroundImage = '';
                        mainContent.style.backgroundAttachment = '';
                        mainContent.style.backgroundSize = '';
                        mainContent.style.backgroundPosition = '';
                        mainContent.style.backgroundRepeat = '';
                    }
                    return;
                }
                    
                // Apply background image with proper file extension
                const imageExtensions = {
                    'citynight': 'citynight.jpg',
                    'darkcity': 'darkcity.jpg',
                    'sky': 'sky.jpg',
                    'space': 'space.jpg',
                    'sunset': 'sunset.png',
                    'night': 'night.png_large',
                    'mountains': 'mountains.png',
                    'nature': 'nature.png',
                    'sea': 'sea.png'
                };
                    
                    const imageFile = imageExtensions[backgroundName] || backgroundName;
                    
                    // Apply to body and all main containers
                    document.body.style.backgroundImage = `url('/static/background-images/${imageFile}')`;
                    document.body.style.backgroundAttachment = 'fixed';
                    document.body.style.backgroundSize = 'cover';
                    document.body.style.backgroundPosition = 'center';
                    document.body.style.backgroundRepeat = 'no-repeat';
                    
                    // Apply to main content area only (keep sidebar clean)
                    const mainContent = document.querySelector('.main-content');
                    
                    if (mainContent) {
                        mainContent.style.backgroundImage = `url('/static/background-images/${imageFile}')`;
                        mainContent.style.backgroundAttachment = 'fixed';
                        mainContent.style.backgroundSize = 'cover';
                        mainContent.style.backgroundPosition = 'center';
                        mainContent.style.backgroundRepeat = 'no-repeat';
                    }
                }
                
                // Initialize on page load
                initializeBackgroundImageSelection();
                
                // Apply current background on page load
                applyBackgroundImage(currentBackgroundImage);

                // --- 4. Account Management ---
                const requestDataBtn = document.getElementById('request-data-btn');
                requestDataBtn.addEventListener('click', () => {
                    requestDataBtn.textContent = 'Preparing...';
                    requestDataBtn.disabled = true;
                    window.location.href = '{{ url_for("request_data") }}';
                    setTimeout(() => {
                        requestDataBtn.textContent = 'Request Data';
                        requestDataBtn.disabled = false;
                    }, 3000);
                });

                const deleteAccountBtn = document.getElementById('delete-account-btn');
                deleteAccountBtn.addEventListener('click', () => {
                    const confirmation = prompt("This action is irreversible. To confirm, please type 'DELETE' in the box below:");
                    if (confirmation === 'DELETE') {
                        showCustomConfirmation("Are you absolutely sure? All your hubs, notes, and data will be permanently deleted.", () => {
                             fetch('{{ url_for("delete_account") }}', { method: 'POST' })
                                .then(response => response.json())
                                .then(data => {
                                    showCustomAlert(data.message, 'Account Deletion');
                                    if(data.success) {
                                        window.location.href = '{{ url_for("index") }}';
                                    }
                                });
                        }, null, 'Delete Account');
                    } else {
                        showCustomAlert("Deletion cancelled. You must type 'DELETE' to proceed.", 'Cancelled');
                    }
                });

                // --- 5. Development & Testing ---
                const restartOnboardingBtn = document.getElementById('restart-onboarding-btn');
                if (restartOnboardingBtn) {
                    restartOnboardingBtn.addEventListener('click', async () => {
                        const confirmed = confirm("This will restart the onboarding process. You'll see the welcome screen and personalization flow again. Continue?");
                        if (confirmed) {
                            try {
                                restartOnboardingBtn.textContent = 'Restarting...';
                                restartOnboardingBtn.disabled = true;
                                
                                const response = await fetch('/onboarding/restart', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' }
                                });
                                
                                const result = await response.json();
                                
                                if (result.success) {
                                    showInfo(result.message);
                                    // Clear any onboarding state from sessionStorage
                                    sessionStorage.removeItem('onboardingStep');
                                    sessionStorage.removeItem('onboardingData');
                                    // Reload the page to trigger onboarding
                                    setTimeout(() => {
                                        window.location.reload();
                                    }, 1500);
                                } else {
                                    showError(result.message);
                                }
                            } catch (error) {
                                console.error('Error restarting onboarding:', error);
                                showError('An error occurred while restarting onboarding.');
                            } finally {
                                restartOnboardingBtn.textContent = 'Restart Onboarding';
                                restartOnboardingBtn.disabled = false;
                            }
                        }
                    });
                }

                const clearDemoDataBtn = document.getElementById('clear-demo-data-btn');
                if (clearDemoDataBtn) {
                    clearDemoDataBtn.addEventListener('click', async () => {
                        const confirmed = confirm("This will delete all demo hubs and content created during onboarding. This action cannot be undone. Continue?");
                        if (confirmed) {
                            try {
                                clearDemoDataBtn.textContent = 'Clearing...';
                                clearDemoDataBtn.disabled = true;
                                
                                const response = await fetch('/onboarding/clear_demo_data', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' }
                                });
                                
                                const result = await response.json();
                                
                                if (result.success) {
                                    showInfo(result.message);
                                    // Reload the page to refresh the hub list
                                    setTimeout(() => {
                                        window.location.reload();
                                    }, 1500);
                                } else {
                                    showError(result.message);
                                }
                            } catch (error) {
                                console.error('Error clearing demo data:', error);
                                showError('An error occurred while clearing demo data.');
                            } finally {
                                clearDemoDataBtn.textContent = 'Clear Demo Data';
                                clearDemoDataBtn.disabled = false;
                            }
                        }
                    });
                }
            }


            lucide.createIcons();
        });
    </script>
    
    <script>
    // --- Music Button Handler (Always Available) ---
    document.addEventListener('DOMContentLoaded', function() {
        const toggleBtn = document.getElementById('spotify-player-toggle-btn');
        const isSpotifyConnected = toggleBtn ? toggleBtn.dataset.spotifyConnected === 'true' : false;
        
        if (toggleBtn) {
            toggleBtn.addEventListener('click', function() {
                if (isSpotifyConnected) {
                    // Toggle the Spotify player
                    const playerContainer = document.getElementById('spotify-player-container');
                    if (playerContainer) {
                        playerContainer.classList.toggle('visible');
                    }
                } else {
                    // Redirect to Spotify login
                    window.location.href = "{{ url_for('spotify_login') }}";
                }
            });
        }
    });

    // Define Spotify Web Playback SDK ready function globally
    window.onSpotifyWebPlaybackSDKReady = () => {
        // Only initialize if Spotify is connected
        {% if spotify_connected %}
        // --- Player UI Elements ---
        const playerContainer = document.getElementById('spotify-player-container');
        const toggleBtn = document.getElementById('spotify-player-toggle-btn');
        const miniToggleBtn = document.getElementById('sp-mini-toggle');
        const playBtn = document.getElementById('sp-play-btn');
        const prevBtn = document.getElementById('sp-prev-btn');
        const nextBtn = document.getElementById('sp-next-btn');
        const volumeSlider = document.getElementById('sp-volume');
        const playlistSelect = document.getElementById('sp-playlist-select');
        const albumArt = document.getElementById('sp-album-art');
        const trackTitle = document.getElementById('sp-track-title');
        const trackArtist = document.getElementById('sp-track-artist');
        const progressBar = document.getElementById('sp-progress');
        const categoryTabs = document.querySelectorAll('.sp-category-tab');
        
        // Phase 2 Elements
        const waveform = document.getElementById('sp-waveform');
        const particles = document.getElementById('sp-particles');
        const equalizer = document.getElementById('sp-equalizer');
        const presetBtns = document.querySelectorAll('.sp-preset-btn');
        const searchInput = document.getElementById('sp-search-input');
        const searchResults = document.getElementById('sp-search-results');
        const recommendations = document.getElementById('sp-recommendations');
        const recommendationsList = document.getElementById('sp-recommendations-list');
        
        const playIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="0"><path d="M8 5v14l11-7z"></path></svg>`;
        const pauseIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="0"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path></svg>`;

        let sdkDeviceId = null;
        let isPlayerReady = false;
        let isMiniMode = false;
        let currentCategory = 'all';
        let allPlaylists = [];
        let isPlaying = false;
        
        // Phase 2 Variables
        let currentTrack = null;
        let waveformAnimation = null;
        let particleAnimation = null;
        let searchTimeout = null;
        let audioContext = null;
        let analyser = null;
        let audioPresets = {
            flat: [50, 50, 50, 50, 50, 50, 50, 50],
            study: [40, 45, 50, 55, 60, 55, 50, 45],
            bass: [70, 65, 50, 40, 35, 30, 25, 20],
            treble: [20, 25, 30, 35, 40, 50, 65, 70]
        };
        let currentPreset = 'flat';

        // --- SDK Initialization ---
        const player = new Spotify.Player({
            name: 'Foci Study Player',
            getOAuthToken: cb => {
                // This function securely fetches the token from our backend
                fetch('/spotify/access_token')
                    .then(response => response.json())
                    .then(data => {
                        if (data.access_token) {
                            cb(data.access_token);
                        } else {
                            console.error("Could not get access token from backend.");
                        }
                    });
            },
            volume: 0.8
        });

        // --- SDK Event Listeners ---
        player.addListener('ready', ({ device_id }) => {
            console.log('Ready with Device ID', device_id);
            sdkDeviceId = device_id;
            isPlayerReady = true;
            trackArtist.textContent = "Ready to play";
            loadPlaylists();
            initializePhase2Features();
        });

        player.addListener('not_ready', ({ device_id }) => {
            console.log('Device ID has gone offline', device_id);
            isPlayerReady = false;
        });

        // --- Dynamic Background Color Function ---
        const updatePlayerBackground = (imageUrl) => {
            if (!imageUrl) return;
            
            const img = new Image();
            img.crossOrigin = 'anonymous';
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Resize for performance (max 100x100)
                const maxSize = 100;
                const scale = Math.min(maxSize / img.width, maxSize / img.height);
                canvas.width = img.width * scale;
                canvas.height = img.height * scale;
                
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                
                // Collect color data with better sampling
                let r = 0, g = 0, b = 0;
                let pixelCount = 0;
                let colorMap = {};
                
                // Sample every 5th pixel for better accuracy
                for (let i = 0; i < data.length; i += 20) {
                    const red = data[i];
                    const green = data[i + 1];
                    const blue = data[i + 2];
                    const alpha = data[i + 3];
                    
                    // Skip transparent pixels
                    if (alpha < 128) continue;
                    
                    r += red;
                    g += green;
                    b += blue;
                    pixelCount++;
                    
                    // Create color buckets for better analysis
                    const colorKey = Math.floor(red/32) + ',' + Math.floor(green/32) + ',' + Math.floor(blue/32);
                    colorMap[colorKey] = (colorMap[colorKey] || 0) + 1;
                }
                
                if (pixelCount === 0) return; // No valid pixels
                
                r = Math.floor(r / pixelCount);
                g = Math.floor(g / pixelCount);
                b = Math.floor(b / pixelCount);
                
                // Calculate more accurate metrics
                const brightness = (r + g + b) / 3;
                const maxRGB = Math.max(r, g, b);
                const minRGB = Math.min(r, g, b);
                const saturation = maxRGB === 0 ? 0 : (maxRGB - minRGB) / maxRGB;
                
                // Determine if image is grayscale
                const isGrayscale = Math.abs(r - g) < 30 && Math.abs(g - b) < 30 && Math.abs(r - b) < 30;
                
                let bgClass = 'sp-player-bg-purple'; // default
                
                // Better color analysis
                if (isGrayscale) {
                    // Handle grayscale images
                    if (brightness < 80) {
                        bgClass = 'sp-player-bg-blue'; // Dark grayscale -> blue
                    } else if (brightness < 160) {
                        bgClass = 'sp-player-bg-purple'; // Medium grayscale -> purple
                    } else {
                        bgClass = 'sp-player-bg-orange'; // Light grayscale -> warm orange
                    }
                } else {
                    // Handle colored images with more nuanced logic
                    const redDominance = r / (r + g + b + 1);
                    const greenDominance = g / (r + g + b + 1);
                    const blueDominance = b / (r + g + b + 1);
                    
                    if (brightness < 60) {
                        bgClass = 'sp-player-bg-blue'; // Very dark -> blue
                    } else if (redDominance > 0.45 && redDominance > greenDominance && redDominance > blueDominance) {
                        bgClass = 'sp-player-bg-red';
                    } else if (greenDominance > 0.4 && greenDominance > redDominance && greenDominance > blueDominance) {
                        bgClass = 'sp-player-bg-green';
                    } else if (blueDominance > 0.4 && blueDominance > redDominance && blueDominance > greenDominance) {
                        bgClass = 'sp-player-bg-blue';
                    } else if (brightness > 180 && saturation < 0.3) {
                        bgClass = 'sp-player-bg-orange'; // Light and low saturation -> warm
                    } else if (saturation > 0.6) {
                        bgClass = 'sp-player-bg-pink'; // High saturation -> vibrant
                    } else {
                        bgClass = 'sp-player-bg-purple'; // Default fallback
                    }
                }
                
                // Remove existing background classes
                playerContainer.className = playerContainer.className.replace(/sp-player-bg-\w+/g, '');
                playerContainer.classList.add(bgClass);
                
                // Debug logging (remove in production)
                console.log('Color Analysis:', {
                    rgb: [r, g, b],
                    brightness,
                    saturation,
                    isGrayscale,
                    chosenTheme: bgClass
                });
            };
            img.src = imageUrl;
        };

        player.addListener('player_state_changed', (state) => {
            if (!state) {
                trackTitle.textContent = 'Player is idle';
                trackArtist.textContent = 'Select a playlist to start';
                albumArt.src = 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=';
                playBtn.innerHTML = playIcon;
                progressBar.style.width = '0%';
                isPlaying = false;
                playerContainer.classList.remove('playing');
                albumArt.classList.remove('playing');
                return;
            }

            const currentTrack = state.track_window.current_track;
            const progressPercent = (state.position / state.duration) * 100;
            const imageUrl = currentTrack.album.images[0]?.url || '';

            trackTitle.textContent = currentTrack.name;
            trackArtist.textContent = currentTrack.artists.map(artist => artist.name).join(', ');
            albumArt.src = imageUrl;
            progressBar.style.width = `${progressPercent}%`;
            playBtn.innerHTML = state.paused ? playIcon : pauseIcon;
            
            // Update playing state and animations
            isPlaying = !state.paused;
            if (isPlaying) {
                playerContainer.classList.add('playing');
                albumArt.classList.add('playing');
                startWaveformAnimation();
                startParticleAnimation();
            } else {
                playerContainer.classList.remove('playing');
                albumArt.classList.remove('playing');
                stopWaveformAnimation();
                stopParticleAnimation();
            }
            
            // Update current track for Phase 2 features
            currentTrack = currentTrack;
            
            // Load AI recommendations for new track
            if (currentTrack.id) {
                loadRecommendations(currentTrack.id);
            }
            
            // Update dynamic background
            updatePlayerBackground(imageUrl);
        });
        
        player.addListener('account_error', ({ message }) => {
            console.error('Failed to validate Spotify account:', message);
            playerContainer.innerHTML = `<p style="padding: 1rem; text-align: center; color: var(--danger-color)">Account Error: ${message}. This feature requires Spotify Premium.</p>`;
        });
        
        player.addListener('authentication_error', ({ message }) => {
            console.error('Failed to authenticate:', message);
             playerContainer.innerHTML = `<p style="padding: 1rem; text-align: center;">Authentication failed. <a href="/spotify/login" style="color: var(--primary-color); font-weight: bold;">Please reconnect Spotify</a>.</p>`;
        });

        player.connect();

        // --- Enhanced UI Interactions ---
        // Note: toggleBtn event listener is handled in the main DOMContentLoaded event above

        // Mini player toggle
        if (miniToggleBtn) {
            miniToggleBtn.addEventListener('click', () => {
                isMiniMode = !isMiniMode;
                playerContainer.classList.toggle('mini');
                miniToggleBtn.title = isMiniMode ? 'Expand Player' : 'Mini Player';
            });
        }

        // Study category tabs
        categoryTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                categoryTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentCategory = tab.dataset.category;
                filterPlaylists();
            });
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Only handle shortcuts when player is visible and not in input fields
            if (!playerContainer.classList.contains('visible') || 
                e.target.tagName === 'INPUT' || 
                e.target.tagName === 'TEXTAREA' || 
                e.target.isContentEditable) {
                return;
            }

            switch(e.code) {
                case 'Space':
                    e.preventDefault();
                    if (isPlayerReady) {
                        player.togglePlay();
                    }
                    break;
                case 'ArrowLeft':
                    e.preventDefault();
                    if (isPlayerReady) {
                        player.previousTrack();
                    }
                    break;
                case 'ArrowRight':
                    e.preventDefault();
                    if (isPlayerReady) {
                        player.nextTrack();
                    }
                    break;
                case 'KeyM':
                    e.preventDefault();
                    if (miniToggleBtn) {
                        miniToggleBtn.click();
                    }
                    break;
            }
        });

        async function loadPlaylists() {
            const response = await fetch('/spotify/playlists');
            const data = await response.json();
            if (data && data.items) {
                allPlaylists = data.items;
                filterPlaylists();
            }
        }

        function filterPlaylists() {
                playlistSelect.innerHTML = '<option value="">Select a Playlist</option>';
            
            let filteredPlaylists = allPlaylists;
            
            // Filter by study category
            if (currentCategory !== 'all') {
                filteredPlaylists = allPlaylists.filter(playlist => {
                    const name = playlist.name.toLowerCase();
                    const description = (playlist.description || '').toLowerCase();
                    
                    switch(currentCategory) {
                        case 'focus':
                            return name.includes('focus') || name.includes('study') || name.includes('concentration') || 
                                   name.includes('ambient') || name.includes('instrumental') || name.includes('classical');
                        case 'relax':
                            return name.includes('relax') || name.includes('chill') || name.includes('calm') || 
                                   name.includes('peaceful') || name.includes('meditation') || name.includes('zen');
                        case 'energy':
                            return name.includes('energy') || name.includes('upbeat') || name.includes('motivation') || 
                                   name.includes('workout') || name.includes('pump') || name.includes('energize');
                        default:
                            return true;
                    }
                });
            }
            
            });
        }

        // --- Phase 2 Functions ---
        
        // Initialize Phase 2 features
        function initializePhase2Features() {
            initializeWaveform();
            initializeEqualizer();
            initializeSearch();
            initializeRecommendations();
        }
        
        // Music Visualization Effects
        function initializeWaveform() {
            // Create waveform bars
            for (let i = 0; i < 20; i++) {
                const bar = document.createElement('div');
                bar.className = 'sp-wave-bar';
                bar.style.height = Math.random() * 20 + 8 + 'px';
                waveform.appendChild(bar);
            }
            
            // Start waveform animation
            startWaveformAnimation();
        }
        
        function startWaveformAnimation() {
            if (waveformAnimation) return;
            
            waveformAnimation = setInterval(() => {
                if (!isPlaying) return;
                
                const bars = waveform.querySelectorAll('.sp-wave-bar');
                bars.forEach(bar => {
                    const newHeight = Math.random() * 30 + 8;
                    bar.style.height = newHeight + 'px';
                });
            }, 150);
        }
        
        function stopWaveformAnimation() {
            if (waveformAnimation) {
                clearInterval(waveformAnimation);
                waveformAnimation = null;
            }
        }
        
        function createParticle() {
            const particle = document.createElement('div');
            particle.className = 'sp-particle';
            particle.style.left = Math.random() * 100 + '%';
            particle.style.animationDuration = (Math.random() * 3 + 2) + 's';
            particle.style.animationDelay = Math.random() * 2 + 's';
            particles.appendChild(particle);
            
            setTimeout(() => {
                if (particle.parentNode) {
                    particle.parentNode.removeChild(particle);
                }
            }, 5000);
        }
        
        function startParticleAnimation() {
            if (particleAnimation) return;
            
            particleAnimation = setInterval(() => {
                if (!isPlaying) return;
                createParticle();
            }, 300);
        }
        
        function stopParticleAnimation() {
            if (particleAnimation) {
                clearInterval(particleAnimation);
                particleAnimation = null;
            }
        }
        
        // Advanced Audio Features
        function initializeEqualizer() {
            const eqBands = equalizer.querySelectorAll('.sp-eq-band');
            
            eqBands.forEach((band, index) => {
                band.addEventListener('click', (e) => {
                    const rect = band.getBoundingClientRect();
                    const clickY = e.clientY - rect.top;
                    const percentage = Math.max(0, Math.min(100, 100 - (clickY / rect.height) * 100));
                    
                    const level = band.querySelector('.sp-eq-level');
                    level.style.height = percentage + '%';
                    
                    // Update preset to custom
                    presetBtns.forEach(btn => btn.classList.remove('active'));
                    currentPreset = 'custom';
                });
            });
            
            // Preset buttons
            presetBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    presetBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentPreset = btn.dataset.preset;
                    applyAudioPreset(currentPreset);
                });
            });
        }
        
        function applyAudioPreset(preset) {
            if (!audioPresets[preset]) return;
            
            const eqBands = equalizer.querySelectorAll('.sp-eq-band');
            const levels = audioPresets[preset];
            
            eqBands.forEach((band, index) => {
                const level = band.querySelector('.sp-eq-level');
                level.style.height = levels[index] + '%';
            });
        }
        
        // Spotify Search
        function initializeSearch() {
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.trim();
                
                clearTimeout(searchTimeout);
                
                if (query.length < 2) {
                    searchResults.style.display = 'none';
                    return;
                }
                
                searchTimeout = setTimeout(() => {
                    searchSpotify(query);
                }, 300);
            });
        }
        
        async function searchSpotify(query) {
            try {
                const response = await fetch(`/spotify/search?q=${encodeURIComponent(query)}`);
                const data = await response.json();
                
                if (data.tracks && data.tracks.items) {
                    displaySearchResults(data.tracks.items);
                }
            } catch (error) {
                console.error('Search error:', error);
            }
        }
        
        function displaySearchResults(tracks) {
            searchResults.innerHTML = '';
            searchResults.style.display = 'block';
            
            tracks.slice(0, 5).forEach(track => {
                const result = document.createElement('div');
                result.className = 'sp-search-result';
                result.innerHTML = `
                    <img src="${track.album.images[0]?.url || ''}" alt="Album Art" class="sp-search-album-art">
                    <div class="sp-search-details">
                        <div class="sp-search-title">${track.name}</div>
                        <div class="sp-search-artist">${track.artists.map(a => a.name).join(', ')}</div>
                        <div class="sp-search-type">Track</div>
                    </div>
                `;
                
                result.addEventListener('click', () => {
                    playTrack(track.uri);
                    searchResults.style.display = 'none';
                    searchInput.value = '';
                });
                
                searchResults.appendChild(result);
            });
        }
        
        async function playTrack(trackUri) {
            try {
                await fetch('/spotify/play', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        uris: [trackUri],
                        device_id: sdkDeviceId
                    })
                });
            } catch (error) {
                console.error('Play track error:', error);
            }
        }
        
        // AI Recommendations
        function initializeRecommendations() {
            // This will be called when a track starts playing
        }
        
        async function loadRecommendations(trackId) {
            try {
                const response = await fetch(`/spotify/recommendations?seed_tracks=${trackId}`);
                const data = await response.json();
                
                if (data.tracks && data.tracks.length > 0) {
                    displayRecommendations(data.tracks);
                }
            } catch (error) {
                console.error('Recommendations error:', error);
            }
        }
        
        function displayRecommendations(tracks) {
            recommendationsList.innerHTML = '';
            recommendations.style.display = 'block';
            
            tracks.slice(0, 3).forEach(track => {
                const item = document.createElement('div');
                item.className = 'sp-recommendation-item';
                item.innerHTML = `
                    <img src="${track.album.images[0]?.url || ''}" alt="Album Art" class="sp-rec-album-art">
                    <div class="sp-rec-details">
                        <div class="sp-rec-title">${track.name}</div>
                        <div class="sp-rec-artist">${track.artists.map(a => a.name).join(', ')}</div>
                    </div>
                `;
                
                item.addEventListener('click', () => {
                    playTrack(track.uri);
                });
                
                recommendationsList.appendChild(item);
            });
        }

        playBtn.addEventListener('click', () => {
            player.togglePlay();
        });

        prevBtn.addEventListener('click', () => {
            player.previousTrack();
        });

        nextBtn.addEventListener('click', () => {
            player.nextTrack();
        });
        
        let volumeTimeout;
        volumeSlider.addEventListener('input', () => {
            clearTimeout(volumeTimeout);
            const volumeLevel = volumeSlider.value / 100;
            volumeTimeout = setTimeout(() => {
                player.setVolume(volumeLevel);
            }, 200);
        });
        
        playlistSelect.addEventListener('change', () => {
            if (playlistSelect.value && sdkDeviceId) {
                fetch(`/spotify/play`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        context_uri: playlistSelect.value,
                        device_id: sdkDeviceId
                    })
                });
            }
        });
        {% else %}
        // Spotify not connected - function exists but does nothing
        console.log('Spotify not connected - Web Playback SDK ready but not initialized');
        {% endif %}
    };
    </script>

{% if needs_onboarding %}
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize onboarding system
            const welcomeOverlay = document.getElementById('onboarding-welcome-overlay');
            const personalizationModal = document.getElementById('onboarding-personalization-modal');
            const spotlight = document.getElementById('onboarding-spotlight-overlay');
            const tooltip = document.getElementById('onboarding-tooltip');
            const celebrationModal = document.getElementById('onboarding-celebration-modal');
            
            let currentSlide = 1;
            let personalizationData = {};

            // --- Helper Functions ---
            function showTooltip(targetElement, text, position = 'bottom') {
                const rect = targetElement.getBoundingClientRect();
                tooltip.innerHTML = text; // Use innerHTML instead of textContent to support HTML
                tooltip.className = `onboarding-tooltip ${position}`;
                
                if (position === 'bottom') {
                    tooltip.style.left = `${rect.left + rect.width / 2}px`;
                    tooltip.style.top = `${rect.bottom + 10}px`;
                    tooltip.style.transform = 'translateX(-50%)';
                } else if (position === 'right') {
                    tooltip.style.left = `${rect.right + 10}px`;
                    tooltip.style.top = `${rect.top + rect.height / 2}px`;
                    tooltip.style.transform = 'translateY(-50%)';
                } else {
                    tooltip.style.left = `${rect.left + rect.width / 2}px`;
                    tooltip.style.top = `${rect.top - tooltip.offsetHeight - 10}px`;
                    tooltip.style.transform = 'translateX(-50%)';
                }
                
                tooltip.classList.add('visible');
            }

            function hideTooltip() {
                tooltip.classList.remove('visible');
            }

            function highlightElement(targetElement) {
                targetElement.classList.add('onboarding-highlight');
            }

            function removeHighlight() {
                document.querySelectorAll('.onboarding-highlight').forEach(el => el.classList.remove('onboarding-highlight'));
            }

            function createConfetti() {
                const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57', '#ff9ff3'];
                for (let i = 0; i < 50; i++) {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + '%';
                    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.animationDelay = Math.random() * 3 + 's';
                    confetti.style.animationDuration = (Math.random() * 3 + 2) + 's';
                    document.body.appendChild(confetti);
                    
                    setTimeout(() => confetti.remove(), 5000);
                }
            }

            // --- Welcome Screen ---
            welcomeOverlay.classList.add('visible');

            document.getElementById('onboarding-start-btn').addEventListener('click', () => {
                welcomeOverlay.classList.remove('visible');
                setTimeout(() => {
                    personalizationModal.classList.add('visible');
                }, 300);
            });

            // --- Personalization Flow ---
            const personalizationOptions = document.querySelectorAll('.personalization-option');
            const completeBtn = document.getElementById('personalization-complete');

            personalizationOptions.forEach(option => {
                option.addEventListener('click', () => {
                    // Remove selection from siblings
                    option.parentElement.querySelectorAll('.personalization-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    // Select current option
                    option.classList.add('selected');
                    
                    // Store selection
                    const slide = option.closest('.personalization-slide');
                    const slideNumber = slide.dataset.slide;
                    personalizationData[`slide${slideNumber}`] = option.dataset.value;
                });
            });

            function nextSlide() {
                const currentSlideEl = document.querySelector(`[data-slide="${currentSlide}"]`);
                const nextSlideEl = document.querySelector(`[data-slide="${currentSlide + 1}"]`);
                
                if (nextSlideEl) {
                    currentSlideEl.classList.remove('active');
                    nextSlideEl.classList.add('active');
                    currentSlide++;
                    
                    // Update progress dots
                    document.querySelectorAll('.progress-dot').forEach((dot, index) => {
                        dot.classList.toggle('active', index < currentSlide);
                    });
                }
            }

            // Add event listeners to all Next buttons
            document.querySelectorAll('.personalization-next-btn').forEach(btn => {
                btn.addEventListener('click', nextSlide);
            });
            
            completeBtn.addEventListener('click', () => {
                // Save personalization data
                fetch('/onboarding/personalization', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(personalizationData)
                }).catch(e => console.error('Error saving personalization:', e));
                
                // Hide personalization modal
                personalizationModal.classList.remove('visible');
                
                // Start dashboard spotlight
                setTimeout(() => {
                    startDashboardSpotlight();
                }, 300);
            });

            // --- Dashboard Spotlight ---
            function startDashboardSpotlight() {
                console.log('Starting dashboard spotlight...');
                spotlight.classList.add('visible');
                
                // Highlight the entire side panel
                const sidePanel = document.querySelector('.side-panel');
                console.log('Side panel found:', !!sidePanel);
                if (sidePanel) {
                    highlightElement(sidePanel);
                    
                    // Show tooltip explaining the dashboard
                    showTooltip(sidePanel, "💡 This is your dashboard — explore all the tabs to see your AI study tools. Click on 'Hubs' to continue!", 'right');
                }
                
                // Also highlight individual navigation tabs for better visibility
                const navTabs = document.querySelectorAll('.nav-tab');
                console.log('Found nav tabs:', navTabs.length);
                navTabs.forEach(tab => {
                    highlightElement(tab);
                });
                
                // Set onboarding step for hub entry
                sessionStorage.setItem('onboardingStep', 'hub_entry');
                
                // Add special click handler for hubs tab during onboarding
                const hubsTab = document.querySelector('[data-tab="hubs"]');
                if (hubsTab) {
                    const originalClickHandler = hubsTab.onclick;
                    hubsTab.onclick = function(e) {
                        e.preventDefault();
                        console.log('Hubs tab clicked during onboarding...');
                        hideTooltip();
                        removeHighlight();
                        hideSpotlight();
                        // Set onboarding step for hub entry
                        sessionStorage.setItem('onboardingStep', 'hub_entry');
                        createDemoHubAndShowCelebration();
                        return false;
                    };
                }
                
                // Add a "Continue" button to the tooltip for better UX
                setTimeout(() => {
                    const tooltip = document.getElementById('onboarding-tooltip');
                    if (tooltip && !tooltip.querySelector('.onboarding-continue-btn')) {
                        const continueBtn = document.createElement('button');
                        continueBtn.className = 'onboarding-continue-btn';
                        continueBtn.textContent = 'Continue to Hubs →';
                        continueBtn.style.cssText = `
                            margin-top: 1rem;
                            padding: 0.75rem 1.5rem;
                            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
                            color: white;
                            border: none;
                            border-radius: 8px;
                            font-weight: 600;
                            cursor: pointer;
                            transition: all 0.3s ease;
                        `;
                        continueBtn.addEventListener('click', () => {
                            hideTooltip();
                            removeHighlight();
                            hideSpotlight();
                            // Show loading state
                            continueBtn.textContent = 'Creating your hub...';
                            continueBtn.disabled = true;
                            // Set onboarding step for hub entry
                            sessionStorage.setItem('onboardingStep', 'hub_entry');
                            // Create demo hub and show celebration instead of direct redirect
                            createDemoHubAndShowCelebration();
                        });
                        tooltip.appendChild(continueBtn);
                    }
                }, 500);
            }

            // Function to create demo hub and show celebration
            async function createDemoHubAndShowCelebration() {
                console.log('Creating demo hub and showing celebration...');
                try {
                    const response = await fetch('/onboarding/create_demo_hub', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    console.log('Demo hub creation response:', result);
                    
                    if (result.success) {
                        console.log('Demo hub created successfully:', result.hub_id);
                        // Store hub ID for later redirect
                        sessionStorage.setItem('createdDemoHubId', result.hub_id);
                        // Show celebration modal
                        showCelebrationModal();
                    } else {
                        console.error('Failed to create demo hub:', result.message);
                        // Fallback: just redirect to hubs tab
                        switchToHubsTab();
                    }
                } catch (error) {
                    console.error('Error creating demo hub:', error);
                    // Fallback: just redirect to hubs tab
                    switchToHubsTab();
                }
            }
            
            // Function to show celebration modal
            function showCelebrationModal() {
                console.log('Showing celebration modal...');
                // Create confetti
                createConfetti();
                
                // Show celebration modal
                celebrationModal.classList.add('visible');
                
                // Set onboarding step for celebration
                sessionStorage.setItem('onboardingStep', 'celebration');
            }
            
            // Function to create demo hub and redirect (for fallback)
            async function createDemoHubAndRedirect() {
                console.log('Creating demo hub and redirecting...');
                try {
                    const response = await fetch('/onboarding/create_demo_hub', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    console.log('Demo hub creation response:', result);
                    
                    if (result.success) {
                        console.log('Redirecting to demo hub:', result.hub_id);
                        // Redirect to the demo hub
                        window.location.href = `/hub/${result.hub_id}`;
                    } else {
                        console.error('Failed to create demo hub:', result.message);
                        // Fallback: just redirect to hubs tab
                        switchToHubsTab();
                    }
                } catch (error) {
                    console.error('Error creating demo hub:', error);
                    // Fallback: just redirect to hubs tab
                    switchToHubsTab();
                }
            }
            
            // Helper function to switch to hubs tab
            function switchToHubsTab() {
                console.log('Switching to hubs tab as fallback...');
                const hubsTab = document.querySelector('[data-tab="hubs"]');
                if (hubsTab) {
                    // Ensure the tab is active and content is shown
                    document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    hubsTab.classList.add('active');
                    const hubsContent = document.getElementById('hubs');
                    if (hubsContent) {
                        hubsContent.classList.add('active');
                    }
                    console.log('Successfully switched to hubs tab');
                } else {
                    console.error('Could not find hubs tab element');
                }
            }

            function hideSpotlight() {
                spotlight.classList.remove('visible');
            }

            // Remove the old event listener - we now handle this through the continue button

            // --- Celebration Modal ---
            document.getElementById('onboarding-complete-btn').addEventListener('click', () => {
                // Hide celebration modal
                celebrationModal.classList.remove('visible');
                
                // Redirect to the created demo hub
                const demoHubId = sessionStorage.getItem('createdDemoHubId');
                if (demoHubId) {
                    console.log('Redirecting to demo hub:', demoHubId);
                    // Set onboarding step for hub entry
                    sessionStorage.setItem('onboardingStep', 'hub_entry');
                    window.location.href = `/hub/${demoHubId}`;
                } else {
                    console.log('No demo hub ID found, switching to hubs tab');
                    switchToHubsTab();
                }
                
                // Clean up
                setTimeout(() => {
                    spotlight.classList.remove('visible');
                    removeHighlight();
                    hideTooltip();
                    sessionStorage.removeItem('createdDemoHubId');
                }, 1000);
            });

            // --- Auto-show celebration if coming from hub creation ---
            if (sessionStorage.getItem('onboardingStep') === 'celebration') {
                celebrationModal.classList.add('visible');
                createConfetti();
                sessionStorage.removeItem('onboardingStep');
            }
            
            // --- Auto-show celebration if coming from hub creation (alternative check) ---
            if (sessionStorage.getItem('showOnboardingCelebration') === '1') {
                celebrationModal.classList.add('visible');
                createConfetti();
                sessionStorage.removeItem('showOnboardingCelebration');
            }
        });
    </script>
{% endif %}

    <!-- Community Tab Functionality -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Community tab functionality initializing...');
            
            const communityTabs = document.querySelectorAll('.community-tab');
            const communityTabContents = document.querySelectorAll('.community-tab-content');

            console.log('Found community tabs:', communityTabs.length);
            console.log('Found community tab contents:', communityTabContents.length);

            communityTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const targetTab = tab.dataset.tab;
                    console.log('Switching to tab:', targetTab);
                    
                    // Update active tab
                    communityTabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    // Update active content
                    communityTabContents.forEach(content => {
                        content.classList.remove('active');
                    });
                    const targetContent = document.getElementById(`${targetTab}-tab`);
                    if (targetContent) {
                        targetContent.classList.add('active');
                    } else {
                        console.error('Target content not found:', `${targetTab}-tab`);
                    }
                });
            });

            // Study Group Modals
            const createStudyGroupBtn = document.getElementById('create-study-group-btn');
            const joinStudyGroupBtn = document.getElementById('join-study-group-btn');
            const createStudyGroupModal = document.getElementById('create-study-group-modal');
            const joinStudyGroupModal = document.getElementById('join-study-group-modal');
            const studyGroupCreatedModal = document.getElementById('study-group-created-modal');

            console.log('Create study group btn:', createStudyGroupBtn);
            console.log('Join study group btn:', joinStudyGroupBtn);
            console.log('Create study group modal:', createStudyGroupModal);
            console.log('Join study group modal:', joinStudyGroupModal);

            // Open modals
            if (createStudyGroupBtn && createStudyGroupModal) {
                createStudyGroupBtn.addEventListener('click', () => {
                    console.log('Opening create study group modal');
                    createStudyGroupModal.classList.add('visible');
                });
            } else {
                console.error('Create study group button or modal not found');
            }

            if (joinStudyGroupBtn && joinStudyGroupModal) {
                joinStudyGroupBtn.addEventListener('click', () => {
                    console.log('Opening join study group modal');
                    joinStudyGroupModal.classList.add('visible');
                });
            } else {
                console.error('Join study group button or modal not found');
            }

            // Close modals
            const closeCreateModal = document.getElementById('close-create-study-group-modal');
            const closeJoinModal = document.getElementById('close-join-study-group-modal');
            const closeCreatedModal = document.getElementById('close-study-group-created-modal');
            const cancelCreate = document.getElementById('cancel-create-study-group');
            const cancelJoin = document.getElementById('cancel-join-study-group');
            const closeCreated = document.getElementById('close-study-group-created');

            if (closeCreateModal) {
                closeCreateModal.addEventListener('click', () => {
                    createStudyGroupModal.classList.remove('visible');
                });
            }

            if (closeJoinModal) {
                closeJoinModal.addEventListener('click', () => {
                    joinStudyGroupModal.classList.remove('visible');
                });
            }

            if (closeCreatedModal) {
                closeCreatedModal.addEventListener('click', () => {
                    studyGroupCreatedModal.classList.remove('visible');
                });
            }

            if (cancelCreate) {
                cancelCreate.addEventListener('click', () => {
                    createStudyGroupModal.classList.remove('visible');
                });
            }

            if (cancelJoin) {
                cancelJoin.addEventListener('click', () => {
                    joinStudyGroupModal.classList.remove('visible');
                });
            }

            if (closeCreated) {
                closeCreated.addEventListener('click', () => {
                    studyGroupCreatedModal.classList.remove('visible');
                });
            }

            // Close modals when clicking outside
            if (createStudyGroupModal) {
                createStudyGroupModal.addEventListener('click', (e) => {
                    if (e.target === createStudyGroupModal) {
                        createStudyGroupModal.classList.remove('visible');
                    }
                });
            }

            if (joinStudyGroupModal) {
                joinStudyGroupModal.addEventListener('click', (e) => {
                    if (e.target === joinStudyGroupModal) {
                        joinStudyGroupModal.classList.remove('visible');
                    }
                });
            }

            if (studyGroupCreatedModal) {
                studyGroupCreatedModal.addEventListener('click', (e) => {
                    if (e.target === studyGroupCreatedModal) {
                        studyGroupCreatedModal.classList.remove('visible');
                    }
                });
            }

            // Generate random 5-digit code
            function generateStudyGroupCode() {
                return Math.floor(10000 + Math.random() * 90000).toString();
            }

            // Create Study Group Form
            const createForm = document.getElementById('create-study-group-form');
            if (createForm) {
                createForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const formData = new FormData(e.target);
                    const name = formData.get('name');
                    const description = formData.get('description');

                    try {
                        const response = await fetch('/api/study-groups/create', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ name, description })
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            // Show success modal with generated code
                            document.getElementById('generated-study-group-code').textContent = result.code;
                            createStudyGroupModal.classList.remove('visible');
                            studyGroupCreatedModal.classList.add('visible');
                            
                            // Reset form
                            e.target.reset();
                            
                            // Refresh study groups list
                            loadStudyGroups();
                        } else {
                            showError(result.message || 'Error creating study group. Please try again.');
                        }
                        
                    } catch (error) {
                        console.error('Error creating study group:', error);
                        showError('Error creating study group. Please try again.');
                    }
                });
            }

            // Join Study Group Form
            const joinForm = document.getElementById('join-study-group-form');
            if (joinForm) {
                joinForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const formData = new FormData(e.target);
                    const code = formData.get('code');

                    try {
                        const response = await fetch('/api/study-groups/join', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ code })
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            showSuccess('Successfully joined study group!');
                            joinStudyGroupModal.classList.remove('visible');
                            
                            // Reset form
                            e.target.reset();
                            
                            // Refresh study groups list
                            loadStudyGroups();
                        } else {
                            showError(result.message || 'Invalid study group code. Please check and try again.');
                        }
                        
                    } catch (error) {
                        console.error('Error joining study group:', error);
                        showError('Error joining study group. Please try again.');
                    }
                });
            }

            // Copy study group code
            const copyCodeBtn = document.getElementById('copy-study-group-code');
            if (copyCodeBtn) {
                copyCodeBtn.addEventListener('click', () => {
                    const code = document.getElementById('generated-study-group-code').textContent;
                    navigator.clipboard.writeText(code).then(() => {
                        showSuccess('Study group code copied to clipboard!');
                    });
                });
            }

            // Load study groups from backend
            async function loadStudyGroups() {
                const studyGroupsList = document.getElementById('study-groups-list');
                if (!studyGroupsList) return;

                try {
                    const response = await fetch('/api/study-groups');
                    const result = await response.json();
                    
                    if (result.success) {
                        if (result.study_groups.length === 0) {
                            studyGroupsList.innerHTML = `
                                <div class="study-group-card" style="text-align: center; grid-column: 1 / -1;">
                                    <h4>No Study Groups Yet</h4>
                                    <p>Create or join a study group to start collaborating with other students!</p>
                                </div>
                            `;
                        } else {
                            studyGroupsList.innerHTML = result.study_groups.map(group => `
                                <div class="study-group-card" data-group-id="${group.id}">
                                    <h4>${group.name}</h4>
                                    <p>${group.description || 'No description provided'}</p>
                                    <div class="study-group-meta">
                                        <span>${group.member_count} member${group.member_count !== 1 ? 's' : ''}</span>
                                        <span class="study-group-code">${group.code}</span>
                                    </div>
                                </div>
                            `).join('');
                            
                            // Add click handlers to study group cards
                            studyGroupsList.querySelectorAll('.study-group-card[data-group-id]').forEach(card => {
                                card.addEventListener('click', () => {
                                    const groupId = card.dataset.groupId;
                                    viewStudyGroupResources(groupId);
                                });
                            });
                        }
                    } else {
                        studyGroupsList.innerHTML = `
                            <div class="study-group-card" style="text-align: center; grid-column: 1 / -1;">
                                <h4>Error Loading Study Groups</h4>
                                <p>Please try refreshing the page.</p>
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error('Error loading study groups:', error);
                    studyGroupsList.innerHTML = `
                        <div class="study-group-card" style="text-align: center; grid-column: 1 / -1;">
                            <h4>Error Loading Study Groups</h4>
                            <p>Please try refreshing the page.</p>
                        </div>
                    `;
                }
            }

            // View study group resources
            async function viewStudyGroupResources(studyGroupId) {
                try {
                    const response = await fetch(`/api/study-groups/${studyGroupId}/resources`);
                    const result = await response.json();
                    
                    if (result.success) {
                        // Switch to study groups tab
                        document.querySelectorAll('.community-tab').forEach(tab => tab.classList.remove('active'));
                        document.querySelector('[data-tab="study-groups"]').classList.add('active');
                        
                        document.querySelectorAll('.community-tab-content').forEach(content => content.classList.remove('active'));
                        document.getElementById('study-groups-tab').classList.add('active');
                        
                        // Display resources in the study groups tab
                        displayStudyGroupResources(result.resources, studyGroupId);
                    } else {
                        showError(result.message || 'Error loading study group resources');
                    }
                } catch (error) {
                    console.error('Error loading study group resources:', error);
                    showError('Error loading study group resources');
                }
            }

            // Display study group resources
            function displayStudyGroupResources(resources, studyGroupId) {
                const studyGroupsList = document.getElementById('study-groups-list');
                if (!studyGroupsList) return;

                if (resources.length === 0) {
                    studyGroupsList.innerHTML = `
                        <div class="study-group-card" style="text-align: center; grid-column: 1 / -1;">
                            <h4>No Resources Yet</h4>
                            <p>No resources have been shared in this study group yet.</p>
                            <button class="button" id="back-to-study-groups-empty">Back to Study Groups</button>
                        </div>
                    `;
                } else {
                    studyGroupsList.innerHTML = `
                        <div class="study-group-card" style="grid-column: 1 / -1; margin-bottom: 1rem;">
                            <h4>Study Group Resources</h4>
                            <p>Resources shared in this study group</p>
                            <button class="button button-secondary" id="back-to-study-groups">Back to Study Groups</button>
                        </div>
                        ${resources.map(resource => `
                            <div class="study-group-card" data-resource-id="${resource.id}">
                                <h4>${resource.title}</h4>
                                <p>${resource.description || 'No description provided'}</p>
                                <div class="study-group-meta">
                                    <span>${resource.likes} like${resource.likes !== 1 ? 's' : ''}</span>
                                    <span>${resource.imports} import${resource.imports !== 1 ? 's' : ''}</span>
                                </div>
                                ${resource.tags && resource.tags.length > 0 ? `
                                    <div class="global-resource-tags">
                                        ${resource.tags.map(tag => `<span class="global-resource-tag">${tag}</span>`).join('')}
                                    </div>
                                ` : ''}
                                <div class="global-resource-actions">
                                    <button class="import-btn" data-resource-id="${resource.id}">
                                        <i data-lucide="download"></i> Import
                                    </button>
                                    <button class="like-btn" data-resource-id="${resource.id}">
                                        <i data-lucide="heart"></i> ${resource.likes} 👍
                                    </button>
                                    ${resource.owner_id === '{{ current_user.id }}' ? `<button class="delete-btn" onclick="deleteResource('${resource.id}')" title="Delete resource">❌</button>` : ''}
                                </div>
                            </div>
                        `).join('')}
                    `;
                    
                    // Add click handlers to import and like buttons
                    studyGroupsList.querySelectorAll('.import-btn').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const resourceId = btn.dataset.resourceId;
                            importResource(resourceId);
                        });
                    });
                    
                    studyGroupsList.querySelectorAll('.like-btn').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const resourceId = btn.dataset.resourceId;
                            likeResource(resourceId, btn);
                        });
                    });
                }
                
                // Add event listeners for back buttons
                const backBtn = document.getElementById('back-to-study-groups');
                const backBtnEmpty = document.getElementById('back-to-study-groups-empty');
                
                if (backBtn) {
                    backBtn.addEventListener('click', loadStudyGroups);
                }
                
                if (backBtnEmpty) {
                    backBtnEmpty.addEventListener('click', loadStudyGroups);
                }
            }

            // Initialize study groups on page load
            loadStudyGroups();

            // Load global resources on page load
            loadGlobalResources();

            // Load global resources from backend
            async function loadGlobalResources() {
                const globalResourcesList = document.getElementById('global-resources-list');
                if (!globalResourcesList) return;

                try {
                    const response = await fetch('/api/resources/global');
                    const result = await response.json();
                    
                    if (result.success) {
                        if (result.resources.length === 0) {
                            globalResourcesList.innerHTML = `
                                <div class="global-resource-card" style="text-align: center; grid-column: 1 / -1;">
                                    <h4>No Resources Yet</h4>
                                    <p>Be the first to share a folder to the global community!</p>
                                </div>
                            `;
                        } else {
                            globalResourcesList.innerHTML = result.resources.map(resource => `
                                <div class="global-resource-card" data-resource-id="${resource.id}">
                                    <div class="resource-author">
                                        <img src="${resource.owner_avatar || '/static/images/default-avatar.svg'}" alt="${resource.owner_name}" class="author-avatar" onerror="this.src='/static/images/default-avatar.svg'">
                                        <div class="author-info">
                                            <div class="author-name">${resource.owner_name}</div>
                                            <div class="author-time">${new Date(resource.created_at).toLocaleDateString()}</div>
                                        </div>
                                    </div>
                                    <h4>${resource.title}</h4>
                                    <p>${resource.description || 'No description provided'}</p>
                                    ${resource.folder_contents && resource.folder_contents.length > 0 ? `
                                        <div class="resource-preview">
                                            <div class="preview-title">Folder Contents:</div>
                                            <div class="preview-items">
                                                ${resource.folder_contents.map(item => `
                                                    <div class="preview-item">
                                                        <span class="preview-item-icon">${item.icon}</span>
                                                        <span>${item.title}</span>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    ` : ''}
                                    <div class="global-resource-meta">
                                        <span>${resource.likes} like${resource.likes !== 1 ? 's' : ''}</span>
                                        <span>${resource.imports} import${resource.imports !== 1 ? 's' : ''}</span>
                                    </div>
                                    ${resource.tags && resource.tags.length > 0 ? `
                                        <div class="global-resource-tags">
                                            ${resource.tags.map(tag => `<span class="global-resource-tag">${tag}</span>`).join('')}
                                        </div>
                                    ` : ''}
                                    <div class="resource-actions">
                                        <button class="preview-btn" onclick="previewResource('${resource.id}')">Preview</button>
                                        <button class="import-btn" data-resource-id="${resource.id}">
                                            <i data-lucide="download"></i> Import
                                        </button>
                                        <button class="like-btn" data-resource-id="${resource.id}">
                                            <i data-lucide="heart"></i> ${resource.likes} 👍
                                        </button>
                                        ${resource.owner_id === '{{ current_user.id }}' ? `<button class="delete-btn" onclick="deleteResource('${resource.id}')" title="Delete resource">❌</button>` : ''}
                                    </div>
                                </div>
                            `).join('');
                            
                            // Add click handlers to import and like buttons
                            globalResourcesList.querySelectorAll('.import-btn').forEach(btn => {
                                btn.addEventListener('click', () => {
                                    const resourceId = btn.dataset.resourceId;
                                    importResource(resourceId);
                                });
                            });
                            
                            globalResourcesList.querySelectorAll('.like-btn').forEach(btn => {
                                btn.addEventListener('click', () => {
                                    const resourceId = btn.dataset.resourceId;
                                    likeResource(resourceId, btn);
                                });
                            });
                        }
                    } else {
                        globalResourcesList.innerHTML = `
                            <div class="global-resource-card" style="text-align: center; grid-column: 1 / -1;">
                                <h4>Error Loading Resources</h4>
                                <p>Please try refreshing the page.</p>
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error('Error loading global resources:', error);
                    globalResourcesList.innerHTML = `
                        <div class="global-resource-card" style="text-align: center; grid-column: 1 / -1;">
                            <h4>Error Loading Resources</h4>
                            <p>Please try refreshing the page.</p>
                        </div>
                    `;
                }
            }

            // Import a resource - show modal first
            async function importResource(resourceId) {
                // Get resource details first
                try {
                    const response = await fetch(`/api/resources/${resourceId}`);
                    const result = await response.json();
                    
                    if (result.success) {
                        // Show import modal with resource details
                        showImportModal(result.resource);
                    } else {
                        showError('Error loading resource details. Please try again.');
                    }
                } catch (error) {
                    console.error('Error loading resource details:', error);
                    showError('Error loading resource details. Please try again.');
                }
            }

            // Show import modal
            function showImportModal(resource) {
                const importModal = document.getElementById('import-resource-modal');
                const titleElement = document.getElementById('import-resource-title');
                const descriptionElement = document.getElementById('import-resource-description');
                const hubSelect = document.getElementById('import-hub-select');
                
                if (importModal && titleElement && descriptionElement && hubSelect) {
                    // Set resource details
                    titleElement.textContent = resource.title;
                    descriptionElement.textContent = resource.description || 'No description provided';
                    
                    // Load user's hubs
                    loadHubsForImport();
                    
                    // Show modal
                    importModal.classList.add('visible');
                    
                    // Store resource ID for later use
                    importModal.dataset.resourceId = resource.id;
                }
            }

            // Load user's hubs for import selection
            async function loadHubsForImport() {
                const hubSelect = document.getElementById('import-hub-select');
                if (!hubSelect) return;

                try {
                    // Get user's hubs from the page data (they're already loaded)
                    const hubsData = {{ hubs_for_json|tojson }};
                    
                    hubSelect.innerHTML = '<option value="" disabled selected>-- Choose a hub --</option>';
                    
                    if (!hubsData || hubsData.length === 0) {
                        hubSelect.innerHTML += '<option value="" disabled>No hubs available</option>';
                    } else {
                        hubsData.forEach(hub => {
                            const option = document.createElement('option');
                            option.value = hub.id;
                            option.textContent = hub.name;
                            hubSelect.appendChild(option);
                        });
                    }
                } catch (error) {
                    console.error('Error loading hubs for import:', error);
                    hubSelect.innerHTML = '<option value="" disabled>Error loading hubs</option>';
                }
            }

            // Confirm import
            async function confirmImport(resourceId, hubId) {
                try {
                    const response = await fetch(`/api/resources/${resourceId}/import`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ hub_id: hubId })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        // Close import modal
                        document.getElementById('import-resource-modal').classList.remove('visible');
                        
                        // Show success modal
                        showSuccessModal(
                            'Successfully Imported!',
                            'The resource has been added to your hub.',
                            () => {
                                // Refresh the resources list after modal closes
                                loadGlobalResources();
                                loadStudyGroups(); // Also refresh study groups in case we're viewing them
                            }
                        );
                    } else {
                        showError(result.message || 'Error importing resource. Please try again.');
                    }
                    
                } catch (error) {
                    console.error('Error importing resource:', error);
                    showError('Error importing resource. Please try again.');
                }
            }

            // Like a resource
            async function likeResource(resourceId, button) {
                try {
                    const response = await fetch(`/api/resources/${resourceId}/like`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        // Update the button and count
                        const isLiked = result.liked;
                        const newCount = result.likes;
                        
                        if (isLiked) {
                            button.classList.add('liked');
                        } else {
                            button.classList.remove('liked');
                        }
                        
                        button.innerHTML = `<i data-lucide="heart"></i> ${newCount}`;
                        
                        // Refresh the global resources list to update all counts
                        loadGlobalResources();
                    } else {
                        showError(result.message || 'Error liking resource. Please try again.');
                    }
                    
                } catch (error) {
                    console.error('Error liking resource:', error);
                    showError('Error liking resource. Please try again.');
                }
            }

            // Share folder button functionality
            const shareFolderBtn = document.getElementById('share-folder-btn');
            const shareFolderBtnEmpty = document.getElementById('share-folder-btn-empty');
            const shareModalOverlay = document.getElementById('share-folder-modal');
            const shareForm = document.getElementById('share-folder-form');
            const shareDestinationRadios = document.querySelectorAll('input[name="share_destination"]');
            const studyGroupSelection = document.getElementById('study-group-selection');
            const studyGroupSelect = document.getElementById('study-group-select');

            function openShareModal() {
                if (shareModalOverlay) {
                    shareModalOverlay.classList.add('visible');
                    loadStudyGroupsForSharing();
                    
                    // Debug: Check if form elements are accessible
                    const titleInput = document.getElementById('folder-title');
                    const descInput = document.getElementById('folder-description');
                    const tagsInput = document.getElementById('folder-tags');
                    
                    console.log('Title input:', titleInput);
                    console.log('Description input:', descInput);
                    console.log('Tags input:', tagsInput);
                    
                    // Test if inputs are disabled
                    if (titleInput) {
                        console.log('Title input disabled:', titleInput.disabled);
                        console.log('Title input readonly:', titleInput.readOnly);
                    }
                }
            }

            // Handle radio button changes
            shareDestinationRadios.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    if (e.target.value === 'study_group') {
                        studyGroupSelection.style.display = 'block';
                        studyGroupSelect.required = true;
                    } else {
                        studyGroupSelection.style.display = 'none';
                        studyGroupSelect.required = false;
                    }
                });
            });

            // Load study groups for sharing dropdown
            async function loadStudyGroupsForSharing() {
                try {
                    const response = await fetch('/api/study-groups');
                    const result = await response.json();
                    
                    if (result.success && studyGroupSelect) {
                        studyGroupSelect.innerHTML = '<option value="" disabled selected>-- Choose a study group --</option>';
                        
                        if (result.study_groups.length === 0) {
                            studyGroupSelect.innerHTML += '<option value="" disabled>No study groups available</option>';
                        } else {
                            result.study_groups.forEach(group => {
                                const option = document.createElement('option');
                                option.value = group.id;
                                option.textContent = group.name;
                                studyGroupSelect.appendChild(option);
                            });
                        }
                    }
                } catch (error) {
                    console.error('Error loading study groups for sharing:', error);
                }
            }

            // Handle share folder form submission
            if (shareForm) {
                shareForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const formData = new FormData(e.target);
                    const folderId = formData.get('folder_id');
                    const title = formData.get('title');
                    const description = formData.get('description');
                    const tags = formData.get('tags');
                    const shareDestination = formData.get('share_destination');
                    const studyGroupId = formData.get('study_group_id');

                    // Get hub_id from selected folder
                    const folderSelect = document.getElementById('folder-select');
                    const selectedOption = folderSelect.options[folderSelect.selectedIndex];
                    const hubId = selectedOption.getAttribute('data-hub-id');
                    
                    // Debug: Check if hub_id was found
                    console.log('Selected option:', selectedOption);
                    console.log('Hub ID from data-hub-id:', hubId);
                    console.log('All data attributes:', selectedOption.dataset);

                    // Debug: Log all form values
                    console.log('Form validation debug:');
                    console.log('folderId:', folderId);
                    console.log('title:', title);
                    console.log('description:', description);
                    console.log('hubId:', hubId);
                    console.log('tags:', tags);
                    console.log('shareDestination:', shareDestination);
                    console.log('studyGroupId:', studyGroupId);

                    // Validate form
                    if (!folderId || !title || !description || !hubId) {
                        console.log('Validation failed - missing required fields');
                        showWarning('Please fill in all required fields.');
                        return;
                    }

                    if (shareDestination === 'study_group' && !studyGroupId) {
                        showWarning('Please select a study group.');
                        return;
                    }

                    // Debug: Log the data being sent
                    const shareData = {
                        resource_type: 'folder',
                        resource_id: folderId,
                        hub_id: hubId,
                        title: title,
                        description: description,
                        tags: tags ? tags.split(',').map(tag => tag.trim()) : [],
                        share_to: shareDestination === 'study_group' ? studyGroupId : 'global'
                    };
                    console.log('Sharing data:', shareData);

                    try {
                        const response = await fetch('/api/resources/share', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(shareData)
                        });
                        
                        const result = await response.json();
                        console.log('Server response:', result);
                        
                        if (result.success) {
                            // Close the share modal
                            shareModalOverlay.classList.remove('visible');
                            shareForm.reset();
                            studyGroupSelection.style.display = 'none';
                            studyGroupSelect.required = false;
                            
                            // Show success modal
                            const destination = shareDestination === 'study_group' ? 'study group' : 'global community';
                            showSuccessModal(
                                'Successfully Uploaded!',
                                `Your folder has been shared to the ${destination}.`,
                                () => {
                                    // Optional callback after modal closes
                                    console.log('Success modal closed');
                                }
                            );
                        } else {
                            showError(result.message || 'Error sharing folder. Please try again.');
                        }
                        
                    } catch (error) {
                        console.error('Error sharing folder:', error);
                        showError('Error sharing folder. Please try again.');
                    }
                });
            }

            // Close button
            const closeShareBtn = document.getElementById('close-share-modal-btn');
            if (closeShareBtn) {
                closeShareBtn.addEventListener('click', () => {
                    shareModalOverlay.classList.remove('visible');
                    shareForm.reset();
                    studyGroupSelection.style.display = 'none';
                    studyGroupSelect.required = false;
                });
            }

            // Cancel button
            const cancelShareBtn = document.getElementById('cancel-share-folder');
            if (cancelShareBtn) {
                cancelShareBtn.addEventListener('click', () => {
                    shareModalOverlay.classList.remove('visible');
                    shareForm.reset();
                    studyGroupSelection.style.display = 'none';
                    studyGroupSelect.required = false;
                });
            }

            // Close modal when clicking outside
            if (shareModalOverlay) {
                shareModalOverlay.addEventListener('click', (e) => {
                    if (e.target === shareModalOverlay) {
                        shareModalOverlay.classList.remove('visible');
                        shareForm.reset();
                        studyGroupSelection.style.display = 'none';
                        studyGroupSelect.required = false;
                    }
                });
            }

            if (shareFolderBtn) {
                shareFolderBtn.addEventListener('click', openShareModal);
                console.log('Share folder button event listener added');
            } else {
                console.error('Share folder button not found');
            }

            if (shareFolderBtnEmpty) {
                shareFolderBtnEmpty.addEventListener('click', openShareModal);
            }

            // Import Resource Modal Event Listeners
            const importModal = document.getElementById('import-resource-modal');
            const importForm = document.getElementById('import-resource-form');
            const closeImportModal = document.getElementById('close-import-resource-modal');
            const cancelImportBtn = document.getElementById('cancel-import-resource');

            // Close modal
            if (closeImportModal) {
                closeImportModal.addEventListener('click', () => {
                    importModal.classList.remove('visible');
                });
            }

            if (cancelImportBtn) {
                cancelImportBtn.addEventListener('click', () => {
                    importModal.classList.remove('visible');
                });
            }

            // Close modal when clicking outside
            if (importModal) {
                importModal.addEventListener('click', (e) => {
                    if (e.target === importModal) {
                        importModal.classList.remove('visible');
                    }
                });
            }

            // Handle form submission
            if (importForm) {
                importForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const formData = new FormData(e.target);
                    const hubId = formData.get('hub_id');
                    const resourceId = importModal.dataset.resourceId;

                    if (!hubId || !resourceId) {
                        showWarning('Please select a hub to import to.');
                        return;
                    }

                    await confirmImport(resourceId, hubId);
                });
            }
        });

        // Success modal functionality
        function showSuccessModal(title, message, callback) {
            const modal = document.createElement('div');
            modal.className = 'success-modal-overlay';
            modal.innerHTML = `
                <div class="success-modal-content">
                    <div class="success-icon"></div>
                    <h2 class="success-title">${title}</h2>
                    <p class="success-message">${message}</p>
                    <button class="success-button" onclick="closeSuccessModal(this)">Got it!</button>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Trigger animation
            setTimeout(() => {
                modal.classList.add('visible');
            }, 10);
            
            // Store callback for later use
            modal.callback = callback;
        }

        function closeSuccessModal(button) {
            const modal = button.closest('.success-modal-overlay');
            modal.classList.remove('visible');
            
            setTimeout(() => {
                if (modal.callback) {
                    modal.callback();
                }
                modal.remove();
            }, 300);
        }

        // Preview resource functionality
        function previewResource(resourceId) {
            // Find the resource card
            const resourceCard = document.querySelector(`[data-resource-id="${resourceId}"]`);
            if (!resourceCard) return;

            const previewDiv = resourceCard.querySelector('.resource-preview');
            if (!previewDiv) return;

            // Toggle preview visibility
            if (previewDiv.style.display === 'none' || previewDiv.style.display === '') {
                previewDiv.style.display = 'block';
                // Smooth scroll to the preview section
                setTimeout(() => {
                    previewDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }, 100);
            } else {
                previewDiv.style.display = 'none';
            }
        }

        // Delete resource functionality
        async function deleteResource(resourceId) {
            if (!confirm('Are you sure you want to delete this resource? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`/api/resources/${resourceId}/delete`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Remove the resource card from the DOM
                    const resourceCard = document.querySelector(`[data-resource-id="${resourceId}"]`);
                    if (resourceCard) {
                        resourceCard.remove();
                    }
                    
                    // Show success message
                    showSuccessModal(
                        'Resource Deleted!',
                        'The resource has been successfully removed from the community.',
                        () => {
                            // Refresh the resources list
                            loadGlobalResources();
                        }
                    );
                } else {
                    showError(result.message || 'Error deleting resource. Please try again.');
                }
            } catch (error) {
                console.error('Error deleting resource:', error);
                showError('Error deleting resource. Please try again.');
            }
        }
    </script>

    <!-- Study Group Modals -->
    <!-- Create Study Group Modal -->
    <div class="modal-overlay" id="create-study-group-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Create a Study Group</h2>
                <button class="modal-close" id="close-create-study-group-modal">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="create-study-group-form">
                    <div class="form-group">
                        <label for="study-group-name">Study Group Name</label>
                        <input type="text" id="study-group-name" name="name" placeholder="e.g., CS101 Study Group" required>
                    </div>
                    <div class="form-group">
                        <label for="study-group-description">Description (Optional)</label>
                        <textarea id="study-group-description" name="description" placeholder="Describe what this study group is about..."></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="button button-secondary" id="cancel-create-study-group">Cancel</button>
                        <button type="submit" class="button">Create Study Group</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Join Study Group Modal -->
    <div class="modal-overlay" id="join-study-group-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Join a Study Group</h2>
                <button class="modal-close" id="close-join-study-group-modal">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="join-study-group-form">
                    <div class="form-group">
                        <label for="study-group-code">Study Group Code</label>
                        <input type="text" id="study-group-code" name="code" placeholder="Enter 5-digit code" maxlength="5" required>
                        <small>Ask the study group creator for the 5-digit code</small>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="button button-secondary" id="cancel-join-study-group">Cancel</button>
                        <button type="submit" class="button">Join Study Group</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Study Group Created Success Modal -->
    <div class="modal-overlay" id="study-group-created-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Study Group Created! 🎉</h2>
                <button class="modal-close" id="close-study-group-created-modal">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="success-content">
                    <div class="study-group-code-display">
                        <h3>Your Study Group Code:</h3>
                        <div class="code-box" id="generated-study-group-code">12345</div>
                        <p>Share this code with others so they can join your study group!</p>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="button" id="copy-study-group-code">Copy Code</button>
                        <button type="button" class="button button-secondary" id="close-study-group-created">Got it</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Import Resource Modal -->
    <div class="modal-overlay" id="import-resource-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Import Resource</h2>
                <button class="modal-close" id="close-import-resource-modal">
                    <i data-lucide="x"></i>
                </button>
            </div>

            <div class="modal-body">
                <div class="import-resource-info">
                    <h3 id="import-resource-title">Resource Title</h3>
                    <p id="import-resource-description">Resource description</p>
                </div>
                <form id="import-resource-form">
                    <div class="form-group">
                        <label for="import-hub-select">Select Hub to Import To:</label>
                        <select id="import-hub-select" name="hub_id" required>
                            <option value="" disabled selected>-- Choose a hub --</option>
                            <!-- Hubs will be loaded dynamically -->
                        </select>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="button button-secondary" id="cancel-import-resource">Cancel</button>
                        <button type="submit" class="button" id="confirm-import-resource">Import Resource</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Referral Success Modal -->
    <div class="success-modal-overlay" id="referral-success-modal">
        <div class="success-modal-content">
            <div class="success-icon">🔓</div>
            <h2 class="success-title">Well done!</h2>
            <p class="success-message">By using a referral code, your first month Pro subscription is 50% off!</p>
            <button class="button success-button" onclick="redirectToUpgrade()">
                Upgrade to Pro
            </button>
        </div>
    </div>

    <!-- Pro Upgrade Success Modal -->
    <div class="success-modal-overlay" id="pro-upgrade-success-modal">
        <div class="success-modal-content">
            <div class="success-icon">😊</div>
            <h2 class="success-title">Amazing!</h2>
            <p class="success-message">You have now unlocked the following:</p>
            <div class="pro-features-list">
                <div class="feature-item">Unlimited uses of all tools</div>
                <div class="feature-item">Unlimited study hubs</div>
                <div class="feature-item">All premium features</div>
                <div class="feature-item">No rate limits</div>
                <div class="feature-item">Faster customer support</div>
            </div>
            <button class="button success-button" onclick="closeProUpgradeModal()">
                Get Started
            </button>
        </div>
    </div>

    <!-- Custom Confirmation Modal -->
    <div id="custom-confirmation-modal" class="custom-modal-overlay" style="display: none;">
        <div class="custom-modal-content" style="max-width: 400px;">
            <div class="custom-modal-header">
                <h3 id="confirmation-title">⚠️ Are you sure?</h3>
                <button class="close-btn" onclick="closeCustomModal()">&times;</button>
            </div>
            <div class="custom-modal-body">
                <p id="confirmation-message">Are you sure you'd like to delete this?</p>
            </div>
            <div class="custom-modal-footer">
                <button class="button button-secondary" onclick="closeCustomModal()">Cancel</button>
                <button class="button button-danger" id="confirm-action-btn">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Custom Alert Modal -->
    <div id="custom-alert-modal" class="custom-modal-overlay" style="display: none;">
        <div class="custom-modal-content" style="max-width: 400px;">
            <div class="custom-modal-header">
                <h3 id="alert-title">ℹ️ Information</h3>
                <button class="close-btn" onclick="closeCustomAlert()">&times;</button>
            </div>
            <div class="custom-modal-body">
                <p id="alert-message">This is an alert message.</p>
            </div>
            <div class="custom-modal-footer">
                <button class="button button-primary" onclick="closeCustomAlert()">OK</button>
            </div>
        </div>
    </div>

    <script>
        // Close modal when clicking outside of it
        document.addEventListener('click', function(e) {
            const confirmationModal = document.getElementById('custom-confirmation-modal');
            const alertModal = document.getElementById('custom-alert-modal');
            
            if (e.target === confirmationModal) {
                closeCustomModal();
            }
            if (e.target === alertModal) {
                closeCustomAlert();
            }
        });

        // Prevent modal content clicks from closing the modal
        document.addEventListener('click', function(e) {
            if (e.target.closest('.custom-modal-content')) {
                e.stopPropagation();
            }
        });

        // Close modal with ESC key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const confirmationModal = document.getElementById('custom-confirmation-modal');
                const alertModal = document.getElementById('custom-alert-modal');
                
                if (confirmationModal.style.display === 'flex') {
                    closeCustomModal();
                }
                if (alertModal.style.display === 'flex') {
                    closeCustomAlert();
                }
            }
        });

        // Set up the confirm action button and delete button event listeners
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('confirm-action-btn').addEventListener('click', confirmAction);
            
            // Delete All Hubs button
            const deleteAllHubsBtn = document.getElementById('delete-all-hubs-btn');
            if (deleteAllHubsBtn) {
                deleteAllHubsBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const deleteUrl = this.href;
                    showCustomConfirmation('Are you sure you want to delete ALL hubs? This cannot be undone.', () => {
                        window.location.href = deleteUrl;
                    }, null, 'Delete All Hubs');
                });
            }
            
            // Individual hub delete buttons
            document.addEventListener('click', function(e) {
                if (e.target.closest('.delete-hub-btn')) {
                    e.preventDefault();
                    const deleteBtn = e.target.closest('.delete-hub-btn');
                    const deleteUrl = deleteBtn.href;
                    showCustomConfirmation('Are you sure you want to delete this hub?', () => {
                        window.location.href = deleteUrl;
                    }, null, 'Delete Hub');
                }
            });
            
            // Load spaced repetition data when progress tab is active
            loadSpacedRepetitionData();
            
            // Check if returning from a spaced repetition session
            const urlParams = new URLSearchParams(window.location.search);
            const sessionCompleted = urlParams.get('session_completed');
            const refresh = urlParams.get('refresh');
            
            if (sessionCompleted === '1' || refresh === '1') {
                console.log('🔄 Returning from spaced repetition session - refreshing stats');
                // Longer delay when returning from session to ensure data is processed
                setTimeout(() => {
                    refreshSpacedRepetitionStats();
                }, 2000);
                
                // Clean up URL parameters
                const newUrl = window.location.pathname;
                window.history.replaceState({}, document.title, newUrl);
            } else {
                // Normal refresh with standard delay
                setTimeout(() => {
                    refreshSpacedRepetitionStats();
                }, 1000);
            }
        });
        
        // Refresh stats when page becomes visible (user switches back to tab)
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                refreshSpacedRepetitionStats();
            }
        });
        
        // Spaced Repetition Functions
        async function refreshSpacedRepetitionStats() {
            // Only run if we're on the dashboard page
            if (!window.location.pathname.includes('/dashboard')) {
                return;
            }
            
            console.log('🔄 Refreshing spaced repetition stats...');
            // Force refresh stats by calling the API again
            await loadSpacedRepetitionData();
            console.log('✅ Stats refreshed');
        }
        
        async function loadSpacedRepetitionData() {
            try {
                // Only run if we're on the dashboard page
                if (!window.location.pathname.includes('/dashboard')) {
                    return;
                }
                
                console.log('📊 Loading spaced repetition data...');
                
                // Check if Firebase is available by testing a simple endpoint
                let firebaseAvailable = false;
                try {
                    const testResponse = await fetch('/api/spaced_repetition/system_health', {
                        credentials: 'include' // Include cookies for authentication
                    });
                    firebaseAvailable = testResponse.ok;
                    
                    if (!firebaseAvailable) {
                        console.log('🔍 API call failed - checking response:', testResponse.status);
                        // If we get a 401/403, user might not be authenticated
                        if (testResponse.status === 401 || testResponse.status === 403) {
                            console.log('🔍 User not authenticated - skipping spaced repetition data');
                            return;
                        }
                    }
                } catch (error) {
                    console.log('🔍 Firebase not available - running in development mode');
                    firebaseAvailable = false;
                }
                
                if (!firebaseAvailable) {
                    console.log('ℹ️ Firebase not available - showing demo data');
                    updateSpacedRepetitionUI({
                        totalDueCards: 0,
                        totalCards: 0,
                        totalNewCards: 0,
                        totalLearningCards: 0,
                        totalMatureCards: 0,
                        recentSessions: [],
                        firebaseAvailable: false
                    });
                    return;
                }
                
                // Use existing hubs data from the template
                const hubsData = { success: true, hubs: {{ hubs_for_json|tojson }} };
                
                if (!hubsData.success || !hubsData.hubs) {
                    console.error('Failed to load hubs');
                    return;
                }
                
                console.log(`Found ${hubsData.hubs.length} hubs`);
                
                let totalDueCards = 0;
                let totalCards = 0;
                let totalNewCards = 0;
                let totalLearningCards = 0;
                let totalMatureCards = 0;
                let allRecentSessions = [];
                
                // Get data for each hub
                for (const hub of hubsData.hubs) {
                    try {
                        // Get due cards
                        const dueResponse = await fetch(`/api/spaced_repetition/due_cards/${hub.id}`, {
                            credentials: 'include'
                        });
                        if (dueResponse.ok) {
                            const dueData = await dueResponse.json();
                            if (dueData.success) {
                                totalDueCards += dueData.total_due;
                            }
                        } else if (dueResponse.status === 401 || dueResponse.status === 403) {
                            console.log('🔍 Authentication required for due cards - skipping');
                            continue;
                        }
                        
                        // Get learning progress
                        const progressResponse = await fetch(`/api/spaced_repetition/learning_progress/${hub.id}`, {
                            credentials: 'include'
                        });
                        if (progressResponse.ok) {
                            const progressData = await progressResponse.json();
                            if (progressData.success) {
                                totalCards += progressData.progress.total_cards;
                                totalNewCards += progressData.progress.new_cards;
                                totalLearningCards += progressData.progress.learning_cards;
                                totalMatureCards += progressData.progress.mature_cards;
                            }
                        } else if (progressResponse.status === 401 || progressResponse.status === 403) {
                            console.log('🔍 Authentication required for learning progress - skipping');
                            continue;
                        }
                        
                        // Get recent sessions
                        const sessionsResponse = await fetch(`/api/spaced_repetition/recent_sessions/${hub.id}`, {
                            credentials: 'include'
                        });
                        if (sessionsResponse.ok) {
                            const sessionsData = await sessionsResponse.json();
                            if (sessionsData.success) {
                                allRecentSessions = allRecentSessions.concat(sessionsData.sessions.map(session => ({
                                    ...session,
                                    hub_name: hub.name
                                })));
                            }
                        } else if (sessionsResponse.status === 401 || sessionsResponse.status === 403) {
                            console.log('🔍 Authentication required for recent sessions - skipping');
                            continue;
                        }
                    } catch (error) {
                        console.error(`Error loading data for hub ${hub.id}:`, error);
                    }
                }
                
                // Update UI
                updateSpacedRepetitionUI({
                    totalDueCards,
                    totalCards,
                    totalNewCards,
                    totalLearningCards,
                    totalMatureCards,
                    recentSessions: allRecentSessions.slice(0, 5) // Show only 5 most recent
                });
                
            } catch (error) {
                console.error('Error loading spaced repetition data:', error);
            }
        }
        
        function updateSpacedRepetitionUI(data) {
            // Handle case when Firebase is not available
            if (data.firebaseAvailable === false) {
                console.log('🔧 Firebase not available - showing demo data');
                // Update the dedicated spaced repetition tab with demo data
                updateSpacedRepetitionTabStats({
                    totalDueCards: 0,
                    totalNewCards: 0,
                    totalLearningCards: 0,
                    totalMatureCards: 0
                });
                return;
            }
            
            // Update the dedicated spaced repetition tab
            updateSpacedRepetitionTabStats(data);
        }
        
        // New Spaced Repetition Tab Functions
        function startSpacedRepetitionSession() {
            console.log('🎯 Starting spaced repetition session...');
            
            // Show loading message
            const startBtn = document.querySelector('.sr-primary-btn');
            if (startBtn) {
                startBtn.innerHTML = '<span class="sr-btn-icon">⏳</span><span>Starting session...</span>';
                startBtn.disabled = true;
            }
            
            // Get the first available hub with flashcards
            const hubsData = { success: true, hubs: {{ hubs_for_json|tojson }} };
            
            if (!hubsData.success || !hubsData.hubs || hubsData.hubs.length === 0) {
                alert('⚠️ No study hubs found. Create a hub and add flashcards first!');
                resetButton();
                return;
            }
            
            // Debug: Log all hub data
            console.log('🔍 All hubs data:', hubsData.hubs);
            
            // Find a hub with flashcards - check multiple possible fields
            let targetHub = null;
            for (const hub of hubsData.hubs) {
                // Check various possible flashcard count fields
                const flashcardCount = hub.flashcard_count || hub.flashcards_count || hub.card_count || hub.total_cards || 0;
                console.log(`🔍 Checking hub ${hub.id}: flashcard_count=${hub.flashcard_count}, total_cards=${hub.total_cards}, flashcardCount=${flashcardCount}`);
                
                if (flashcardCount > 0) {
                    targetHub = hub;
                    break;
                }
            }
            
            // If no hub found by count, just use the first hub (the migration will handle it)
            if (!targetHub && hubsData.hubs.length > 0) {
                targetHub = hubsData.hubs[0];
                console.log(`🔍 Using first available hub: ${targetHub.id}`);
            }
            
            console.log('🔍 Selected target hub:', targetHub);
            
            if (!targetHub) {
                alert('⚠️ No study hubs found. Create a hub and add flashcards first!');
                resetButton();
                return;
            }
            
            // Start the session
            const sessionUrl = `/spaced_repetition/review?hub_id=${targetHub.id}&max_cards=20`;
            console.log(`🚀 Starting session with hub: ${targetHub.id}`);
            window.location.href = sessionUrl;
        }
        
        function resetButton() {
            const startBtn = document.querySelector('.sr-primary-btn');
            if (startBtn) {
                startBtn.innerHTML = '<span class="sr-btn-icon">🎯</span><span>Start Review Session</span>';
                startBtn.disabled = false;
            }
        }
        
        function showSpacedRepetitionTutorial() {
            alert('🧠 How Spaced Repetition Works:\n\nSpaced repetition uses scientifically-proven intervals to maximize your learning efficiency. The system shows you cards at the perfect time - not too soon (wasteful) and not too late (you forget).\n\nThis method is used by medical students, language learners, and professionals worldwide to master complex information efficiently.');
        }
        
        // Update spaced repetition stats in the dedicated tab
        function updateSpacedRepetitionTabStats(data) {
            // Update the stats in the spaced repetition tab
            const dueCardsElement = document.getElementById('sr-due-cards');
            const newCardsElement = document.getElementById('sr-new-cards');
            const learningCardsElement = document.getElementById('sr-learning-cards');
            const matureCardsElement = document.getElementById('sr-mature-cards');
            
            if (dueCardsElement) dueCardsElement.textContent = data.totalDueCards || 0;
            if (newCardsElement) newCardsElement.textContent = data.totalNewCards || 0;
            if (learningCardsElement) learningCardsElement.textContent = data.totalLearningCards || 0;
            if (matureCardsElement) matureCardsElement.textContent = data.totalMatureCards || 0;
            
            // Update the urgent styling for due cards
            const dueCardElement = document.querySelector('.sr-stat-card.urgent');
            if (dueCardElement && data.totalDueCards > 0) {
                dueCardElement.style.borderColor = data.totalDueCards > 20 ? '#ef4444' : data.totalDueCards > 5 ? '#f59e0b' : '#10b981';
            }
        }
        
        function startSpacedRepetitionReview() {
            // Redirect to spaced repetition review page
            window.location.href = '/spaced_repetition/review';
        }
        
        function openSpacedRepetitionSettings() {
            // Open the dedicated settings page
            window.open('/spaced_repetition/settings', '_blank');
        }
    </script>
</body>
</html>