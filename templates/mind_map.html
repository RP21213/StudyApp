<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ note.title }}</title>
    <script src="https://unpkg.com/cytoscape/dist/cytoscape.min.js"></script>
    <script src="https://unpkg.com/dagre@0.8.5/dist/dagre.min.js"></script>
    <script src="https://unpkg.com/cytoscape-dagre@2.5.0/cytoscape-dagre.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4f46e5;
            --primary-dark: #3730a3;
            --secondary-color: #10b981;
            --tertiary-color: #f59e0b;
            --border-color: #e5e7eb;
            --background-body: #f9fafb;
            --text-main: #1f2937;
            --text-secondary: #6b7280;
        }
        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            background-color: var(--background-body);
            overflow: hidden;
            display: flex;
        }
        #cy {
            width: 100%;
            height: 100vh;
            display: block;
            flex-grow: 1;
        }
        .header {
            position: absolute;
            top: 1.5rem;
            left: 1.5rem;
            z-index: 10;
            background: white;
            padding: 0.75rem 1.25rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        .header h1 {
            font-size: 1.25rem;
            margin: 0;
        }
        .header a {
            text-decoration: none;
            color: var(--primary-color);
            font-weight: 600;
        }

        /* --- Details Panel --- */
        #details-panel {
            width: 350px;
            flex-shrink: 0;
            height: 100vh;
            background-color: white;
            border-left: 1px solid var(--border-color);
            padding: 1.5rem;
            box-sizing: border-box;
            box-shadow: -5px 0 15px -5px rgba(0,0,0,0.05);
            transition: transform 0.3s ease-in-out;
            transform: translateX(100%); /* Hidden by default */
        }
        #details-panel.visible {
            transform: translateX(0);
        }
        #details-panel h3 {
            margin: 0 0 0.5rem 0;
            font-size: 1.25rem;
            color: var(--text-main);
        }
        #details-panel p {
            margin: 0;
            font-size: 0.95rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }
        #close-details-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>{{ note.title }}</h1>
        <a href="{{ url_for('hub_page', hub_id=note.hub_id) }}">‚Üê Back to Hub</a>
    </div>

    <div id="cy"></div>

    <aside id="details-panel">
        <button id="close-details-btn">&times;</button>
        <h3 id="details-label"></h3>
        <p id="details-content"></p>
    </aside>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const mindMapData = {{ mind_map_data | tojson | safe }};
            const elements = [];
            let idCounter = 0;

            function traverse(node, parentId) {
                const currentId = `n${idCounter++}`;
                elements.push({
                    data: {
                        id: currentId,
                        label: node.label,
                        level: node.level,
                        details: node.details || "No details available."
                    }
                });

                if (parentId) {
                    elements.push({
                        data: {
                            id: `e${parentId}-${currentId}`,
                            source: parentId,
                            target: currentId
                        }
                    });
                }
                if (node.children && node.children.length > 0) {
                    node.children.forEach(child => traverse(child, currentId));
                }
            }

            if (mindMapData && mindMapData.label) {
                traverse(mindMapData, null);
            }

            const cy = cytoscape({
                container: document.getElementById('cy'),
                elements: elements,
                style: [
                    {
                        selector: 'node',
                        style: {
                            'label': 'data(label)',
                            'color': 'white',
                            'text-valign': 'center',
                            'text-halign': 'center',
                            'padding': '12px',
                            'shape': 'round-rectangle',
                            'width': 'label',
                            'height': 'label',
                            'text-wrap': 'wrap',
                            'text-max-width': '180px',
                            'font-size': '14px',
                            'border-width': 2,
                            'box-shadow': '3px 3px 8px rgba(0,0,0,0.2)'
                        }
                    },
                    {
                        selector: 'node[level = 0]',
                        style: {
                            'background-color': '#1f2937',
                            'border-color': '#000000',
                            'font-size': '18px',
                            'font-weight': 'bold',
                            'padding': '16px'
                        }
                    },
                    {
                        selector: 'node[level = 1]',
                        style: {
                            'background-color': 'var(--primary-color)',
                            'border-color': 'var(--primary-dark)',
                            'font-size': '16px'
                        }
                    },
                    {
                        selector: 'node[level = 2]',
                        style: {
                            'background-color': 'var(--secondary-color)',
                            'border-color': '#059669'
                        }
                    },
                    {
                        selector: 'node[level >= 3]',
                        style: {
                            'background-color': 'var(--tertiary-color)',
                            'border-color': '#d97706'
                        }
                    },
                    {
                        selector: 'edge',
                        style: {
                            'width': 3,
                            'line-color': '#cbd5e1',
                            'target-arrow-color': '#cbd5e1',
                            'target-arrow-shape': 'triangle',
                            'curve-style': 'bezier'
                        }
                    }
                ],
                layout: {
                    name: 'dagre',
                    rankDir: 'LR',
                    spacingFactor: 1.3,
                    padding: 40
                }
            });

            const detailsPanel = document.getElementById('details-panel');
            const detailsLabel = document.getElementById('details-label');
            const detailsContent = document.getElementById('details-content');
            const closeDetailsBtn = document.getElementById('close-details-btn');

            cy.on('tap', 'node', function(evt){
                const nodeData = evt.target.data();
                detailsLabel.textContent = nodeData.label;
                detailsContent.textContent = nodeData.details;
                detailsPanel.classList.add('visible');
            });

            closeDetailsBtn.addEventListener('click', () => {
                detailsPanel.classList.remove('visible');
            });
        });
    </script>
</body>
</html>