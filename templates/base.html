<!DOCTYPE html>
<html lang="en" class="{% if current_user and current_user.theme_preference == 'dark' %}dark{% else %}light{% endif %}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <title>{% block title %}My Study Hub{% endblock %}</title>

    {% block head %}{% endblock %}
</head>
<body class="{% if current_user and current_user.theme_preference == 'dark' %}bg-gray-900 text-white{% else %}bg-white text-gray-900{% endif %}">

    {% block content %}{% endblock %}


    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-analytics.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
    apiKey: "AIzaSyA9sJphhDtaoH1S0IgyAzGJP9zvaP7nVho",
    authDomain: "ai-study-hub-f3040.firebaseapp.com",
    projectId: "ai-study-hub-f3040",
    storageBucket: "ai-study-hub-f3040.firebasestorage.app",
    messagingSenderId: "340868632748",
    appId: "1:340868632748:web:57a66c54719aac4d60cf09",
    measurementId: "G-GJR0ZBZ3M7"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
</script>

    {% block scripts %}{% endblock %}
    
    <!-- Enhanced Sidebar Tab Visibility for Background Themes -->
    <style>
        /* Make all sidebar tabs visible when background theme is applied */
        body:not([data-background="default"]) .side-panel .nav-tab {
            background-color: rgba(255, 255, 255, 0.1) !important;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }
        
        body:not([data-background="default"]) .side-panel .nav-tab:hover {
            background-color: rgba(255, 255, 255, 0.2) !important;
            transform: translateY(-1px);
        }
        
        body:not([data-background="default"]) .side-panel .nav-tab.active {
            background-color: rgba(255, 255, 255, 0.25) !important;
            border-color: rgba(255, 255, 255, 0.4);
        }
    </style>

    <!-- Global Background Image Support -->
    <script>
        // Initialize background image on all pages
        function initializeGlobalBackground() {
            let currentBackground = '{{ current_user.background_preference or "default" }}';
            
            console.log('Base - Current background from template:', currentBackground);
            console.log('Base - User background preference:', '{{ current_user.background_preference }}');
            
            // Fallback to localStorage if template value is not working
            if (currentBackground === 'default' || !currentBackground) {
                const savedBackground = localStorage.getItem('background_preference');
                if (savedBackground) {
                    currentBackground = savedBackground;
                    console.log('Base - Using saved background from localStorage:', currentBackground);
                }
            }
            
            applyGlobalBackground(currentBackground);
        }
        
        // Apply background image globally
        function applyGlobalBackground(backgroundName) {
            // Set data attribute for CSS targeting
            document.body.setAttribute('data-background', backgroundName);
            
            if (backgroundName === 'default') {
                // Remove any background styling from all elements
                document.body.style.backgroundImage = '';
                document.body.style.backgroundAttachment = '';
                document.body.style.backgroundSize = '';
                document.body.style.backgroundPosition = '';
                document.body.style.backgroundRepeat = '';
                
                const mainContent = document.querySelector('.main-content');
                
                if (mainContent) {
                    mainContent.style.backgroundImage = '';
                    mainContent.style.backgroundAttachment = '';
                    mainContent.style.backgroundSize = '';
                    mainContent.style.backgroundPosition = '';
                    mainContent.style.backgroundRepeat = '';
                }
                return;
            }
            
            // Apply background image with proper file extension
            const imageExtensions = {
                'citynight': 'citynight.jpg',
                'darkcity': 'darkcity.jpg',
                'sky': 'sky.jpg',
                'space': 'space.jpg',
                'sunset': 'sunset.png',
                'night': 'night.png_large',
                'mountains': 'mountains.png',
                'nature': 'nature.png',
                'sea': 'sea.png'
            };
            
            const imageFile = imageExtensions[backgroundName] || backgroundName;
            
            // Apply to body and all main containers
            document.body.style.backgroundImage = `url('/static/background-images/${imageFile}')`;
            document.body.style.backgroundAttachment = 'fixed';
            document.body.style.backgroundSize = 'cover';
            document.body.style.backgroundPosition = 'center';
            document.body.style.backgroundRepeat = 'no-repeat';
            
            // Apply to main content area only (keep sidebar clean)
            const mainContent = document.querySelector('.main-content');
            
            if (mainContent) {
                mainContent.style.backgroundImage = `url('/static/background-images/${imageFile}')`;
                mainContent.style.backgroundAttachment = 'fixed';
                mainContent.style.backgroundSize = 'cover';
                mainContent.style.backgroundPosition = 'center';
                mainContent.style.backgroundRepeat = 'no-repeat';
            }
        }
        
        // Initialize background when page loads
        document.addEventListener('DOMContentLoaded', initializeGlobalBackground);
        
        // Theme toggle functionality
        function toggleTheme() {
            const currentTheme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            // Update the HTML class
            document.documentElement.classList.remove('dark', 'light');
            document.documentElement.classList.add(newTheme);
            
            // Update body classes
            document.body.classList.remove('bg-gray-900', 'text-white', 'bg-white', 'text-gray-900');
            if (newTheme === 'dark') {
                document.body.classList.add('bg-gray-900', 'text-white');
            } else {
                document.body.classList.add('bg-white', 'text-gray-900');
            }
            
            // Save to server
            fetch('/api/theme/update', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ theme: newTheme })
            }).catch(error => {
                console.error('Error updating theme:', error);
            });
        }
    </script>
    
    <!-- Theme Toggle Button -->
    <button onclick="toggleTheme()" class="fixed bottom-4 right-4 bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-full shadow-lg transition-colors z-50">
        <i class="fas fa-moon dark:hidden"></i>
        <i class="fas fa-sun hidden dark:block"></i>
    </button>

</body>
</html>